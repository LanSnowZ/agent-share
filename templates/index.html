<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Experience Chat</title>
  <!-- ÂºïÂÖ•marked.jsÁî®‰∫éMarkdownÊ∏≤Êüì -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <!-- ÂºïÂÖ•highlight.jsÁî®‰∫é‰ª£Á†ÅÈ´ò‰∫Æ -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', Arial, sans-serif;
      background: #f7f8fa;
      height: 100vh;
      overflow: hidden;
    }

    .app-container {
      display: flex;
      height: 100vh;
      background: #f7f8fa;
    }

    /* Â∑¶‰æßËæπÊ†è */
    .sidebar {
      width: 280px;
      background: #ffffff;
      border-right: 1px solid #e5e7eb;
      display: flex;
      flex-direction: column;
      height: 100vh;
      position: relative;
    }

    .sidebar-header {
      padding: 20px;
      border-bottom: 1px solid #e5e7eb;
    }

    .new-chat-btn {
      width: 100%;
      padding: 12px 16px;
      background: #165dff;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .new-chat-btn:hover {
      background: #0f4cd1;
    }

    .new-chat-btn svg {
      width: 16px;
      height: 16px;
    }

    .chat-history {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }

    .chat-history-item {
      padding: 12px 16px;
      margin-bottom: 8px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid transparent;
      position: relative;
    }

    .chat-history-item:hover {
      background: #f3f4f6;
    }

    .chat-history-item.active {
      background: #eef2ff;
      border-color: #165dff;
      border-width: 2px;
      box-shadow: 0 2px 8px rgba(22, 93, 255, 0.2);
      transform: translateX(2px);
    }

    .chat-history-item.active .chat-history-item-title {
      color: #165dff;
      font-weight: 600;
    }

    .chat-history-item.active .chat-history-item-time {
      color: #165dff;
      font-weight: 500;
    }

    .chat-history-item-title {
      font-size: 14px;
      font-weight: 500;
      color: #1f2937;
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .chat-history-item-time {
      font-size: 12px;
      color: #6b7280;
    }

    .chat-history-item-actions {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      opacity: 0;
      transition: opacity 0.2s;
    }

    .chat-history-item:hover .chat-history-item-actions {
      opacity: 1;
    }

    .chat-history-flag {
      position: absolute;
      right: 40px;
      top: 50%;
      transform: translateY(-50%);
      color: #f59e0b;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: help;
    }

    .chat-history-flag svg {
      width: 16px;
      height: 16px;
      fill: currentColor;
      stroke: currentColor;
    }

    .chat-history-item:hover .chat-history-flag {
      color: #f97316;
    }

    .delete-btn {
      background: none;
      border: none;
      color: #ef4444;
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
    }

    .delete-btn:hover {
      background: #fef2f2;
    }

    /* ‰∏ªËÅäÂ§©Âå∫Âüü */
    .chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      height: 100vh;
      position: relative;
    }

    .floating-header-actions {
      position: fixed;
      top: 5px;
      right: 24px;
      display: flex;
      align-items: center;
      gap: 12px;
      z-index: 100;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 12px;
      padding: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(229, 231, 235, 0.5);
    }

    .settings-btn {
      width: 40px;
      height: 40px;
      border: none;
      background: #f3f4f6;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .settings-btn:hover {
      background: #e5e7eb;
    }

    .settings-btn svg {
      width: 20px;
      height: 20px;
      color: #6b7280;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 24px 24px 24px 24px;
      background: #f7f8fa;
      margin-top: 40px;
    }

    .message {
      margin-bottom: 24px;
      display: flex;
      gap: 12px;
      flex-wrap: wrap; /* ÂÖÅËÆ∏Êç¢Ë°å */
    }

    .message.user {
      flex-direction: row-reverse;
    }

    .message-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 600;
      flex-shrink: 0;
    }

    .message.user .message-avatar {
      background: #165dff;
      color: white;
    }

    .message.assistant .message-avatar {
      background: #10b981;
      color: white;
    }

    /* Âä†ËΩΩÂä®ÁîªÊ†∑Âºè */
    .loading-avatar {
      background: #10b981 !important;
      color: white !important;
      position: relative;
      overflow: hidden;
    }

    .loading-avatar::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.6), transparent);
      animation: loading-shimmer 2s infinite;
    }

    @keyframes loading-shimmer {
      0% {
        left: -100%;
      }
      100% {
        left: 100%;
      }
    }

    /* ËÑâÂÜ≤Âä®Áîª */
    .loading-avatar {
      animation: loading-pulse 2s infinite ease-in-out;
    }

    @keyframes loading-pulse {
      0%, 100% {
        transform: scale(1);
        opacity: 1;
      }
      50% {
        transform: scale(1.05);
        opacity: 0.8;
      }
    }

    .loading-dots {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 3px;
    }

    .loading-dots::before,
    .loading-dots::after {
      content: '';
      width: 5px;
      height: 5px;
      border-radius: 50%;
      background: currentColor;
      animation: loading-bounce 1.4s infinite ease-in-out both;
    }

    .loading-dots::before {
      animation-delay: -0.32s;
    }

    .loading-dots::after {
      animation-delay: -0.16s;
    }

    @keyframes loading-bounce {
      0%, 80%, 100% {
        transform: scale(0);
        opacity: 0.5;
      }
      40% {
        transform: scale(1);
        opacity: 1;
      }
    }

    /* ÊÄùËÄÉÂä®Áîª - ÁÇπÁÇπÂä®Áîª */
    .thinking-dots {
      display: inline-block;
      animation: thinking-blink 1.4s infinite;
    }

    @keyframes thinking-blink {
      0%, 20% { opacity: 0.2; }
      40% { opacity: 1; }
      60%, 100% { opacity: 0.2; }
    }

    /* Âä†ËΩΩÊ∂àÊÅØÁöÑÊ†∑Âºè */
    .loading-message .message-content {
      background: #f3f4f6;
      color: #6b7280;
      font-style: italic;
    }

    .message-content {
      max-width: 75%;
      padding: 12px 16px;
      border-radius: 12px;
      font-size: 14px;
      line-height: 1.5;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }

    .message.assistant .message-content {
      max-width: 80%;
    }

    .message.user .message-content {
      background: #165dff;
      color: white;
      border-bottom-right-radius: 4px;
    }

    .message.assistant .message-content {
      background: #ffffff;
      color: #1f2937;
      border: 1px solid #e5e7eb;
      border-bottom-left-radius: 4px;
    }

    /* Ê∂àÊÅØ‰∏ãÊñπÊìç‰ΩúÂå∫ÔºàÂ§çÂà∂Á≠âÔºâ */
    .message-actions {
      margin-top: 6px;
      margin-left: 44px; /* ‰∏éavatarÂØπÈΩê */
      display: flex;
      gap: 8px;
      align-items: center;
      width: fit-content;
    }

    .message.user .message-actions {
      margin-left: 0;
      margin-right: 44px;
      justify-content: flex-end;
    }

    .copy-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      font-size: 12px;
      color: #374151;
      background: #f3f4f6;
      border: 1px solid #e5e7eb;
      border-radius: 999px;
      cursor: pointer;
      user-select: none;
      transition: background 0.2s, border-color 0.2s;
    }

    .copy-btn:hover {
      background: #eef2ff;
      border-color: #c7d2fe;
    }

    .copy-btn svg {
      width: 14px;
      height: 14px;
    }

    .share-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      font-size: 12px;
      color: #374151;
      background: #f3f4f6;
      border: 1px solid #e5e7eb;
      border-radius: 999px;
      cursor: pointer;
      user-select: none;
      transition: background 0.2s, border-color 0.2s;
    }

    .share-btn:hover {
      background: #eef2ff;
      border-color: #c7d2fe;
    }

    .share-btn svg {
      width: 14px;
      height: 14px;
    }

    /* ËÆ∞ÂøÜÊ†áËÆ∞Ê†∑Âºè */
    .message-memory-tags {
      margin-top: 8px;
      margin-left: 44px; /* ‰∏éÊ∂àÊÅØavatarÂÆΩÂ∫¶ÂØπÈΩê (32px avatar + 12px gap) */
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      width: fit-content;
      flex-basis: 100%; /* Âº∫Âà∂Êç¢Ë°åÂà∞Êñ∞Ë°å */
    }

    .message.user .message-memory-tags {
      margin-left: 0;
      margin-right: 44px;
      justify-content: flex-end;
    }


    .memory-tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 500;
      line-height: 1;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      cursor: pointer;
    }

    .memory-tag.enabled {
      background: #f1f5ff;
      color: #1e40af;
      border-color: #c7d2fe;
    }

    .memory-tag.disabled {
      background: #f3f4f6;
      color: #6b7280;
    }

    .memory-tag svg {
      width: 12px;
      height: 12px;
    }

    /* ËÆ∞ÂøÜÂÜÖÂÆπÈù¢ÊùøÊ†∑Âºè */
    .memory-content-panel {
      position: fixed;
      right: 0;
      top: 0;
      width: 450px;
      height: 100vh;
      background: #ffffff;
      border-left: 1px solid #e5e7eb;
      box-shadow: -4px 0 20px rgba(0, 0, 0, 0.15);
      transform: translateX(100%);
      transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 1000;
      overflow-y: auto;
      backdrop-filter: blur(10px);
      display: none; /* ÈªòËÆ§ÈöêËóè */
    }

    /* ÂΩìËÆ∞ÂøÜÈù¢ÊùøÊâìÂºÄÊó∂ÔºåÈöêËóè‰æßËæπÊ†è */
    .app-container.memory-panel-open .sidebar {
      display: none;
      transition: opacity 0.3s ease;
    }

    /* ÂΩìËÆ∞ÂøÜÈù¢ÊùøÊâìÂºÄÊó∂ÔºåË∞ÉÊï¥ËÅäÂ§©ÂÆπÂô®‰∏∫GridÂ∏ÉÂ±Ä */
    .app-container.memory-panel-open .chat-container {
      display: grid;
      grid-template-columns: 1fr 450px;
      grid-template-rows: auto 1fr auto;
      grid-template-areas: 
        "messages memory"
        "messages memory"
        "input memory";
      flex: 1;
      min-width: 0;
      position: relative;
    }

    /* ÂΩìËÆ∞ÂøÜÈù¢ÊùøÊâìÂºÄÊó∂ÔºåÊµÆÂä®Â§¥ÈÉ®ÊåâÈíÆ‰ΩçÁΩÆÔºàÂè™Ë¶ÜÁõñÊ∂àÊÅØÂå∫ÂüüÔºâ */
    .app-container.memory-panel-open .floating-header-actions {
      right: calc(450px + 24px);
      position: fixed;
    }

    /* ÂΩìËÆ∞ÂøÜÈù¢ÊùøÊâìÂºÄÊó∂ÔºåËÅäÂ§©Ê∂àÊÅØÂå∫ÂüüÂç†ÊçÆÂ∑¶‰æß */
    .app-container.memory-panel-open .chat-messages {
      grid-area: messages;
      flex: 1;
      min-width: 0;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }

    /* ÂΩìËÆ∞ÂøÜÈù¢ÊùøÊâìÂºÄÊó∂ÔºåËÆ∞ÂøÜÈù¢ÊùøÂç†ÊçÆÂè≥‰æßÂπ∂ÊéíÊòæÁ§∫ */
    .app-container.memory-panel-open .memory-content-panel {
      grid-area: memory;
      position: relative;
      display: flex;
      flex-direction: column;
      width: 450px;
      flex-shrink: 0;
      transform: translateX(0);
      box-shadow: none;
      z-index: 1;
      transition: none; /* Âπ∂ÊéíÂ∏ÉÂ±ÄÊó∂‰∏çÈúÄË¶ÅËøáÊ∏°Âä®Áîª */
    }

    /* ÂΩìËÆ∞ÂøÜÈù¢ÊùøÊâìÂºÄÊó∂ÔºåËæìÂÖ•Ê°ÜÂÆπÂô®Âè™Âú®ËÅäÂ§©Âå∫Âüü */
    .app-container.memory-panel-open .chat-input-container {
      grid-area: input;
      width: 100%;
      flex-shrink: 0;
      /* Á°Æ‰øùËæìÂÖ•Ê°ÜÂú®ËÅäÂ§©Âå∫ÂüüÂ∫ïÈÉ®Ôºå‰∏çË∑®Ë∂äÂà∞ËÆ∞ÂøÜÈù¢Êùø */
    }

    .memory-content-header {
      padding: 20px 24px;
      border-bottom: 1px solid #e5e7eb;
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .memory-content-title {
      font-size: 18px;
      font-weight: 700;
      color: #1e293b;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .memory-content-title svg {
      width: 20px;
      height: 20px;
      color: #3b82f6;
    }

    .memory-content-close {
      background: none;
      border: none;
      cursor: pointer;
      padding: 8px;
      border-radius: 8px;
      color: #6b7280;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .memory-content-close:hover {
      background: #f3f4f6;
      color: #374151;
      transform: scale(1.05);
    }

    .memory-content-close svg {
      width: 18px;
      height: 18px;
    }

    .memory-content-body {
      padding: 24px;
      background: #ffffff;
    }

    .memory-item {
      padding: 20px;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      margin-bottom: 16px;
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      transition: all 0.2s ease;
      position: relative;
      overflow: hidden;
    }

    .memory-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 4px;
      height: 100%;
      background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
    }

    .memory-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
      border-color: #3b82f6;
    }

    .memory-item:last-child {
      margin-bottom: 0;
    }

    .memory-item-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid #f1f5f9;
    }

    .memory-item-user {
      font-size: 13px;
      color: #3b82f6;
      font-weight: 600;
      background: #eff6ff;
      padding: 4px 8px;
      border-radius: 6px;
    }

    .memory-item-time {
      font-size: 12px;
      color: #64748b;
      font-weight: 500;
    }

    .memory-item-content {
      font-size: 14px;
      line-height: 1.6;
      color: #334155;
      background: #f8fafc;
      padding: 12px;
      border-radius: 8px;
      border-left: 3px solid #3b82f6;
    }

    .memory-loading {
      text-align: center;
      padding: 60px 20px;
      color: #64748b;
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      border-radius: 12px;
      margin: 20px 0;
    }

    .memory-loading svg {
      width: 32px;
      height: 32px;
      margin-bottom: 16px;
      color: #3b82f6;
      animation: spin 2s linear infinite;
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    .memory-empty {
      text-align: center;
      padding: 60px 20px;
      color: #64748b;
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      border-radius: 12px;
      margin: 20px 0;
      border: 2px dashed #cbd5e1;
    }

    .memory-empty svg {
      width: 48px;
      height: 48px;
      margin-bottom: 16px;
      opacity: 0.6;
      color: #94a3b8;
    }

    .memory-empty p {
      font-size: 16px;
      font-weight: 500;
      margin: 0;
    }

    /* MarkdownÊ†∑Âºè */
    .message-content h1,
    .message-content h2,
    .message-content h3,
    .message-content h4,
    .message-content h5,
    .message-content h6 {
      margin-top: 16px;
      margin-bottom: 8px;
      font-weight: 600;
      line-height: 1.25;
    }

    .message-content h1 {
      font-size: 1.5em;
      border-bottom: 2px solid #e5e7eb;
      padding-bottom: 8px;
    }

    .message-content h2 {
      font-size: 1.3em;
      border-bottom: 1px solid #e5e7eb;
      padding-bottom: 6px;
    }

    .message-content h3 {
      font-size: 1.15em;
    }

    .message-content ul,
    .message-content ol {
      margin: 12px 0;
      padding-left: 24px;
    }

    .message-content li {
      margin: 6px 0;
      line-height: 1.6;
    }

    .message-content p {
      margin: 8px 0;
      line-height: 1.6;
    }

    .message-content code {
      background: #f3f4f6;
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
      font-size: 0.9em;
      color: #e83e8c;
    }

    .message-content pre {
      background: #f6f8fa;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      padding: 12px;
      margin: 12px 0;
      overflow-x: auto;
    }

    .message-content pre code {
      background: transparent;
      padding: 0;
      color: inherit;
      font-size: 0.875em;
      line-height: 1.5;
    }

    .message-content blockquote {
      border-left: 4px solid #165dff;
      padding-left: 12px;
      margin: 12px 0;
      color: #6b7280;
      font-style: italic;
    }

    .message-content a {
      color: #165dff;
      text-decoration: none;
    }

    .message-content a:hover {
      text-decoration: underline;
    }

    .message-content strong {
      font-weight: 600;
      color: #1f2937;
    }

    .message-content em {
      font-style: italic;
    }

    .message-content table {
      border-collapse: collapse;
      width: 100%;
      margin: 12px 0;
    }

    .message-content table th,
    .message-content table td {
      border: 1px solid #e5e7eb;
      padding: 8px 12px;
      text-align: left;
    }

    .message-content table th {
      background: #f3f4f6;
      font-weight: 600;
    }

    .message-content hr {
      border: none;
      border-top: 2px solid #e5e7eb;
      margin: 16px 0;
    }

    /* ‰ºòÂåñÈ¶ñÂ∞æÂÖÉÁ¥†ËæπË∑ù */
    .message-content > *:first-child {
      margin-top: 0 !important;
    }

    .message-content > *:last-child {
      margin-bottom: 0 !important;
    }

    /* ‰ª£Á†ÅÂ§çÂà∂ÊåâÈíÆÊ†∑Âºè */
    .message-content pre {
      position: relative;
    }

    .chat-input-container {
      padding: 20px 24px;
      background: #ffffff;
      border-top: 1px solid #e5e7eb;
      transition: all 0.3s ease;
    }

    .chat-input-container.centered {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 90%;
      max-width: 800px;
      background: transparent;
      border-top: none;
      z-index: 10;
    }

    .chat-input-container.centered::before {
      content: "ÁôæÂÆ∂AIÁªèÈ™åÊêúÁ¥¢: ÈõÜ‰ºó‰∫∫‰πãÊô∫";
      display: block;
      text-align: center;
      font-size: 24px;
      font-weight: 700;
      color: #165dff;
      margin-bottom: 16px;
      letter-spacing: 2px;
    }

    .chat-input-container.centered .chat-input {
      background: #ffffff;
      border: 2px solid #e5e7eb;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .chat-input-container.centered .chat-input:focus {
      border-color: #165dff;
      box-shadow: 0 0 0 3px rgba(22, 93, 255, 0.1), 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .chat-input-wrapper {
      position: relative;
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }


    .model-label {
      font-size: 12px;
      color: #6b7280;
      font-weight: 500;
    }

    .ai-model-selector {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      padding: 6px 10px;
      font-size: 12px;
      color: #374151;
      cursor: pointer;
      transition: all 0.2s;
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      min-width: 100px;
      font-weight: 500;
    }

    .ai-model-selector:hover {
      background: #e5e7eb;
      border-color: #9ca3af;
    }

    .ai-model-selector:focus {
      outline: none;
      border-color: #165dff;
      box-shadow: 0 0 0 2px rgba(22, 93, 255, 0.1);
    }

    .shared-memory-btn {
      background: #f9fafb;
      color: #374151;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      padding: 6px 12px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
    }

    .shared-memory-btn:hover {
      background: #e5e7eb;
      border-color: #9ca3af;
    }

    .shared-memory-btn:focus {
      outline: none;
      border-color: #165dff;
      box-shadow: 0 0 0 2px rgba(22, 93, 255, 0.1);
    }

    .shared-memory-btn.active {
      background: #dbeafe;
      color: #1e40af;
      border-color: #93c5fd;
    }

    .shared-memory-btn.active:hover {
      background: #bfdbfe;
      border-color: #60a5fa;
    }

    /* MCP Â∑•ÂÖ∑Ë∞ÉÁî®ÊåâÈíÆÊ†∑Âºè */
    .mcp-tools-btn {
      background: #f9fafb;
      color: #374151;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      padding: 6px 12px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
    }

    .mcp-tools-btn:hover {
      background: #e5e7eb;
      border-color: #9ca3af;
    }

    .mcp-tools-btn:focus {
      outline: none;
      border-color: #f59e0b;
      box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.1);
    }

    .mcp-tools-btn.active {
      background: #fef3c7;
      color: #92400e;
      border-color: #fbbf24;
    }

    .mcp-tools-btn.active:hover {
      background: #fde68a;
      border-color: #f59e0b;
    }

    .mcp-tools-btn svg {
      width: 14px;
      height: 14px;
    }

    /* Â∑•ÂÖ∑Ë∞ÉÁî®Áä∂ÊÄÅÊåáÁ§∫Âô® */
    .tool-call-indicator {
      display: none;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: #fffbeb;
      border: 1px solid #fbbf24;
      border-radius: 6px;
      font-size: 12px;
      color: #92400e;
      margin-top: 8px;
    }

    .tool-call-indicator.active {
      display: flex;
    }

    .tool-call-indicator .spinner {
      width: 14px;
      height: 14px;
      border: 2px solid #fbbf24;
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .chat-input {
      flex: 1;
      min-height: 120px;
      max-height: 250px;
      padding: 16px 16px 70px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 16px;
      font-size: 16px;
      line-height: 1.6;
      resize: vertical;
      outline: none;
      transition: all 0.3s;
      font-family: inherit;
      background: #ffffff;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      width: 100%;
    }

    .chat-input:focus {
      border-color: #165dff;
      box-shadow: 0 0 0 3px rgba(22, 93, 255, 0.1), 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .input-bottom-controls {
      position: absolute;
      bottom: 12px;
      left: 12px;
      right: 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 8px;
      padding: 8px 12px;
      border: 1px solid rgba(229, 231, 235, 0.5);
    }

    .input-controls-inner {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .send-btn, .stop-btn {
      width: 36px;
      height: 36px;
      border: none;
      color: white;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      flex-shrink: 0;
    }

    .send-btn {
      background: #165dff;
      box-shadow: 0 2px 8px rgba(22, 93, 255, 0.3);
    }
    
    .stop-btn {
      background: #ef4444;
      box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
      display: none;
    }
    
    .stop-btn.show {
      display: flex;
    }
    
    /* ÂΩìÂèëÈÄÅÊåâÈíÆÈöêËóèÊó∂ÔºàAIÂõûÂ§çËøáÁ®ã‰∏≠Ôºâ */
    .send-btn.hidden {
      display: none;
    }

    .send-btn:hover {
      background: #0f4cd1;
    }
    
    .stop-btn:hover {
      background: #dc2626;
    }

    .send-btn:disabled {
      background: #d1d5db;
      cursor: not-allowed;
      opacity: 0.5;
    }
    
    .send-btn:disabled:hover {
      background: #d1d5db;
    }

    .send-btn svg, .stop-btn svg {
      width: 16px;
      height: 16px;
    }

    /* ÁôªÂΩïÂºπÁ™ó */
    .login-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      backdrop-filter: blur(8px);
    }

    .login-modal.show {
      display: flex;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    .login-content {
      background: white;
      border-radius: 16px;
      width: 90%;
      max-width: 420px;
      padding: 40px;
      box-shadow: 0 24px 48px rgba(0, 0, 0, 0.2);
      animation: slideUp 0.4s ease;
    }

    @keyframes slideUp {
      from {
        transform: translateY(30px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .login-header {
      text-align: center;
      margin-bottom: 32px;
    }

    .login-logo {
      width: 64px;
      height: 64px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 16px;
      margin: 0 auto 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
    }

    .login-title {
      font-size: 24px;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 8px;
    }

    .login-subtitle {
      font-size: 14px;
      color: #6b7280;
    }

    .login-form {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .login-input-group {
      position: relative;
      margin-bottom: 16px;
    }

    .login-input {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      font-size: 15px;
      transition: all 0.3s;
      background: #f9fafb;
    }

    .login-input:focus {
      outline: none;
      border-color: #667eea;
      background: white;
      box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
    }

    .login-input::placeholder {
      color: #9ca3af;
    }

    .login-btn {
      width: 100%;
      padding: 14px 16px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      margin-top: 8px;
    }

    .send-code-btn {
      transition: all 0.3s;
      font-size: 14px;
    }
    
    .send-code-btn:hover:not(:disabled) {
      background: #5568d3;
      transform: translateY(-1px);
    }
    
    .send-code-btn:disabled {
      background: #9ca3af;
      cursor: not-allowed;
      opacity: 0.7;
    }
    
    .login-switch a {
      transition: all 0.2s;
    }
    
    .login-switch a:hover {
      color: #5568d3;
      text-decoration: underline;
    }

    .login-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(102, 126, 234, 0.4);
    }

    .login-btn:active {
      transform: translateY(0);
    }

    .login-footer {
      text-align: center;
      margin-top: 24px;
      font-size: 13px;
      color: #6b7280;
    }

    /* ËÆæÁΩÆÂºπÁ™ó */
    .settings-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .settings-modal.show {
      display: flex;
    }

    /* ÂàÜ‰∫´ÂºπÁ™ó */
    .share-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .share-modal.show {
      display: flex;
    }

    .share-content {
      background: white;
      border-radius: 12px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    }

    .share-header {
      padding: 24px 24px 0 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid #e5e7eb;
      margin-bottom: 24px;
    }

    .share-title {
      font-size: 20px;
      font-weight: 600;
      color: #1f2937;
    }

    .share-body {
      padding: 0 24px 24px 24px;
    }

    .share-link-container {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }

    .share-link-input {
      flex: 1;
      padding: 10px 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 14px;
      font-family: monospace;
      background: #f9fafb;
    }

    .share-link-input:focus {
      outline: none;
      border-color: #165dff;
      box-shadow: 0 0 0 3px rgba(22, 93, 255, 0.1);
    }

    .copy-link-btn {
      padding: 10px 16px;
      background: #165dff;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .copy-link-btn:hover {
      background: #0f4cd1;
    }

    .share-note {
      font-size: 12px;
      color: #6b7280;
      line-height: 1.5;
    }

    .settings-content {
      background: white;
      border-radius: 12px;
      width: 90%;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    }

    .settings-header {
      padding: 24px 24px 0 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid #e5e7eb;
      margin-bottom: 24px;
    }

    .settings-title {
      font-size: 20px;
      font-weight: 600;
      color: #1f2937;
    }

    .close-btn {
      width: 32px;
      height: 32px;
      border: none;
      background: #f3f4f6;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .close-btn:hover {
      background: #e5e7eb;
    }

    .settings-body {
      padding: 0 24px 24px 24px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #374151;
      margin-bottom: 8px;
    }

    .form-input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 14px;
      transition: border-color 0.2s;
    }

    .form-input:focus {
      outline: none;
      border-color: #165dff;
      box-shadow: 0 0 0 3px rgba(22, 93, 255, 0.1);
    }

    .slider-container {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .slider {
      flex: 1;
      height: 4px;
      background: #d1d5db;
      border-radius: 2px;
      outline: none;
      -webkit-appearance: none;
    }

    .slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 16px;
      height: 16px;
      background: #165dff;
      border-radius: 50%;
      cursor: pointer;
    }

    .slider::-moz-range-thumb {
      width: 16px;
      height: 16px;
      background: #165dff;
      border-radius: 50%;
      cursor: pointer;
      border: none;
    }

    .slider-value {
      min-width: 40px;
      text-align: center;
      font-weight: 500;
      color: #165dff;
    }

    .save-btn {
      width: 100%;
      padding: 12px;
      background: #165dff;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }

    .save-btn:hover {
      background: #0f4cd1;
    }
    
    #logoutBtn:hover {
      background: #dc2626 !important;
    }

    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: #6b7280;
      text-align: center;
    }

    .empty-state svg {
      width: 64px;
      height: 64px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .empty-state h3 {
      font-size: 18px;
      font-weight: 500;
      margin-bottom: 8px;
    }

    .empty-state p {
      font-size: 14px;
    }

    /* ËÆ∞ÂøÜÂºπÁ™óÊ†∑Âºè */
    .memory-tabs {
      display: flex;
      border-bottom: 1px solid #e5e7eb;
      margin-bottom: 20px;
    }

    .memory-tab {
      flex: 1;
      padding: 12px 16px;
      background: none;
      border: none;
      border-bottom: 2px solid transparent;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      color: #6b7280;
      transition: all 0.2s;
    }

    .memory-tab.active {
      color: #165dff;
      border-bottom-color: #165dff;
    }

    .memory-tab:hover {
      color: #165dff;
    }

    .memory-panel {
      display: none;
    }

    .memory-panel.active {
      display: block;
    }

    .memory-list {
      max-height: 400px;
      overflow-y: auto;
    }

    .memory-item {
      padding: 16px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      margin-bottom: 12px;
      background: #f9fafb;
    }

    .memory-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .memory-item-time {
      font-size: 12px;
      color: #6b7280;
    }

    .memory-item-conversation {
      font-size: 12px;
      color: #165dff;
      background: #eef2ff;
      padding: 2px 8px;
      border-radius: 4px;
    }

    .memory-item-content {
      margin-bottom: 8px;
    }

    .memory-item-user {
      font-weight: 500;
      color: #1f2937;
      margin-bottom: 4px;
    }

    .memory-item-assistant {
      color: #4b5563;
      line-height: 1.5;
    }

    /* ËÆ∞ÂøÜÁ±ªÂûãÈÄâÊã©Âô®Ê†∑Âºè */
    .memory-type-selector {
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .memory-type-selector label {
      font-size: 14px;
      font-weight: 500;
      color: #374151;
    }

    .memory-type-select {
      padding: 8px 12px;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      background: #ffffff;
      font-size: 14px;
      color: #374151;
      cursor: pointer;
      transition: all 0.2s;
      min-width: 120px;
    }

    .memory-type-select:hover {
      border-color: #9ca3af;
    }

    .memory-type-select:focus {
      outline: none;
      border-color: #165dff;
      box-shadow: 0 0 0 2px rgba(22, 93, 255, 0.1);
    }

    /* ÂìçÂ∫îÂºèËÆæËÆ° */
    @media (max-width: 768px) {
      .sidebar {
        width: 100%;
        position: absolute;
        z-index: 100;
        transform: translateX(-100%);
        transition: transform 0.3s;
      }

      .sidebar.open {
        transform: translateX(0);
      }

      .chat-container {
        width: 100%;
      }

      .message-content {
        max-width: 85%;
      }
    }
  </style>
  <script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?a96829078f110de9737d670712e925a5";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
</head>
<body>
  <div class="app-container">
    <!-- Â∑¶‰æßËæπÊ†è -->
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <button class="new-chat-btn" id="newChatBtn">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 5v14M5 12h14"/>
          </svg>
          Êñ∞Âª∫ÂØπËØù
        </button>
      </div>
      <div class="chat-history" id="chatHistory">
        <!-- ÂéÜÂè≤ËÅäÂ§©ÂàóË°®Â∞ÜÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàê -->
      </div>
    </div>

    <!-- ‰∏ªËÅäÂ§©Âå∫Âüü -->
    <div class="chat-container">
      <!-- ËÆ∞ÂøÜÂÜÖÂÆπÈù¢Êùø -->
      <div class="memory-content-panel" id="memoryContentPanel">
        <div class="memory-content-header">
          <div class="memory-content-title">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
              <circle cx="9" cy="7" r="4"/>
              <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
              <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
            </svg>
            ‰ΩøÁî®ÁöÑÂÖ±‰∫´ËÆ∞ÂøÜ
          </div>
          <button class="memory-content-close" id="memoryContentClose">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"/>
              <line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
          </button>
        </div>
        <div class="memory-content-body" id="memoryContentBody">
          <div class="memory-loading">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <path d="M12 6v6l4 2"/>
            </svg>
            <p>Ê≠£Âú®Âä†ËΩΩËÆ∞ÂøÜÂÜÖÂÆπ...</p>
          </div>
        </div>
      </div>
      
      <!-- ÊÇ¨ÊµÆÁöÑÂ§¥ÈÉ®ÊåâÈíÆ -->
      <div class="floating-header-actions">
        <button class="settings-btn" id="memoryBtn" title="ËÆ∞ÂøÜ‰ª™Ë°®Áõò">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 12l2 2 4-4"/>
            <path d="M21 12c.552 0 1-.448 1-1V5c0-.552-.448-1-1-1H3c-.552 0-1 .448-1 1v6c0 .552.448 1 1 1h18z"/>
            <path d="M3 12v6c0 .552.448 1 1 1h16c.552 0 1-.448 1-1v-6H3z"/>
          </svg>
        </button>
        <button class="settings-btn" id="settingsBtn" title="ËÆæÁΩÆ">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="3"/>
            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1 1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
          </svg>
        </button>
      </div>

      <div class="chat-messages" id="chatMessages">
        <div class="empty-state">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
          </svg>
          <h3>ÂºÄÂßãÊñ∞ÁöÑÂØπËØù</h3>
          <p>Âú®‰∏ãÊñπËæìÂÖ•Ê°Ü‰∏≠ËæìÂÖ•ÊÇ®ÁöÑÈóÆÈ¢òÔºåÂºÄÂßã‰∏éExperience ChatÂØπËØù</p>
        </div>
      </div>

      <div class="chat-input-container">
        <div class="chat-input-wrapper">
          <div style="position: relative;">
            <textarea 
              class="chat-input" 
              id="chatInput" 
              placeholder="Â∞ΩÁÆ°ÈóÆ..."
              rows="4"
            ></textarea>
            <div class="input-bottom-controls">
              <div class="input-controls-inner">
                <label class="model-label" for="aiModelSelector">AIÊ®°Âûã:</label>
                <select class="ai-model-selector" id="aiModelSelector">
                  <option value="gpt-5-chat-latest">GPT-5 Chat</option>
                  <option value="ark-deepseek-r1-250528">DeepSeek R1</option>
                  <option value="ark-kimi-k2-250711">Kimi K2</option>
                  <option value="ark-doubao-seed-1.6-vision-250815">Doubao Seed 1.6</option>
                  <option value="TA/Qwen/Qwen2.5-72B-Instruct-Turbo">Qwen2.5-72B-Instruct-Turbo</option>
                  <option value="gpt-4o-mini">GPT-4o Mini</option>
                  
                  
                </select>
                <button class="shared-memory-btn" id="sharedMemoryBtn">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                    <circle cx="9" cy="7" r="4"/>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                  </svg>
                  ÂºÄÂêØËÆ∞ÂøÜ
                </button>
                <button class="mcp-tools-btn" id="mcpToolsBtn" title="ÂêØÁî® MCP Â∑•ÂÖ∑Ë∞ÉÁî®ÔºàÁΩëÈ°µÁà¨Âèñ„ÄÅÊñá‰ª∂Êìç‰ΩúÁ≠âÔºâ">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>
                  </svg>
                  Â∑•ÂÖ∑Ë∞ÉÁî®
                </button>
              </div>
              <!-- Â∑•ÂÖ∑Ë∞ÉÁî®Áä∂ÊÄÅÊåáÁ§∫Âô® -->
              <div class="tool-call-indicator" id="toolCallIndicator">
                <div class="spinner"></div>
                <span id="toolCallStatus">Â∑•ÂÖ∑Ë∞ÉÁî®‰∏≠...</span>
              </div>
              <button class="send-btn" id="sendBtn">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="22" y1="2" x2="11" y2="13"/>
                  <polygon points="22,2 15,22 11,13 2,9 22,2"/>
                </svg>
              </button>
              <button class="stop-btn" id="stopBtn">
                <svg viewBox="0 0 24 24" fill="currentColor">
                  <rect x="6" y="6" width="12" height="12" rx="1"/>
                </svg>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ÁôªÂΩïÂºπÁ™ó -->
  <div class="login-modal" id="loginModal">
    <div class="login-content">
      <div class="login-header">
        <div class="login-logo">üß†</div>
        <h2 class="login-title" id="loginTitle">Ê¨¢Ëøé‰ΩøÁî® Experience Chat</h2>
        <p class="login-subtitle" id="loginSubtitle">ËØ∑ËæìÂÖ•ÈÇÆÁÆ±ÂíåÂØÜÁ†ÅÁôªÂΩï</p>
      </div>
      
      <!-- ÁôªÂΩïË°®Âçï -->
      <form class="login-form" id="loginForm" style="display: block;">
        <div class="login-input-group">
          <input 
            type="email" 
            class="login-input" 
            id="loginUsername" 
            placeholder="ËØ∑ËæìÂÖ•ÈÇÆÁÆ±"
            autocomplete="email"
            required
          />
        </div>
        <div class="login-input-group">
          <input 
            type="password" 
            class="login-input" 
            id="loginPassword" 
            placeholder="ËØ∑ËæìÂÖ•ÂØÜÁ†Å"
            autocomplete="current-password"
            required
          />
        </div>
        <button type="submit" class="login-btn" id="loginSubmitBtn">
          ÁôªÂΩï
        </button>
        <div class="login-switch" style="text-align: center; margin-top: 16px; display: flex; justify-content: center; gap: 16px;">
          <a href="#" id="switchToRegister" style="color: #667eea; text-decoration: none; font-weight: 600;">Á´ãÂç≥Ê≥®ÂÜå</a>
          <a href="#" id="switchToEmailLogin" style="color: #667eea; text-decoration: none; font-weight: 600;">ÂøòËÆ∞ÂØÜÁ†Å</a>
        </div>
      </form>
      
      <!-- ÂøòËÆ∞ÂØÜÁ†ÅË°®ÂçïÔºàÈÇÆÁÆ±+È™åËØÅÁ†Å+Êñ∞ÂØÜÁ†ÅÔºâ -->
      <form class="login-form" id="emailLoginForm" style="display: none;">
        <div class="login-input-group">
          <input 
            type="email" 
            class="login-input" 
            id="emailLoginEmail" 
            placeholder="ËØ∑ËæìÂÖ•Ê≥®ÂÜåÈÇÆÁÆ±"
            autocomplete="email"
            required
          />
        </div>
        <div class="login-input-group" style="display: flex; gap: 8px;">
          <input 
            type="text" 
            class="login-input" 
            id="emailLoginCode" 
            placeholder="ËØ∑ËæìÂÖ•È™åËØÅÁ†Å"
            style="flex: 1;"
            required
          />
          <button type="button" class="send-code-btn" id="emailLoginSendCodeBtn" style="white-space: nowrap; padding: 14px 20px; background: #667eea; color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 14px; font-weight: 600;">
            ÂèëÈÄÅÈ™åËØÅÁ†Å
          </button>
        </div>
        <div class="login-input-group">
          <input 
            type="password" 
            class="login-input" 
            id="emailResetNewPassword" 
            placeholder="ËØ∑ËæìÂÖ•Êñ∞ÂØÜÁ†ÅÔºàËá≥Â∞ë6‰ΩçÔºâ"
            autocomplete="new-password"
            required
          />
        </div>
        <div class="login-input-group">
          <input 
            type="password" 
            class="login-input" 
            id="emailResetConfirmPassword" 
            placeholder="ËØ∑ÂÜçÊ¨°ËæìÂÖ•Êñ∞ÂØÜÁ†Å"
            autocomplete="new-password"
            required
          />
        </div>
        <button type="submit" class="login-btn" id="emailLoginSubmitBtn">
          ÈáçÁΩÆÂØÜÁ†Å
        </button>
        <div class="login-switch" style="text-align: center; margin-top: 16px;">
          <a href="#" id="switchToPasswordLogin" style="color: #667eea; text-decoration: none; font-weight: 600; margin-left: 4px;">ËøîÂõûÁôªÂΩï</a>
        </div>
      </form>
      
      <!-- Ê≥®ÂÜåË°®Âçï -->
      <form class="login-form" id="registerForm" style="display: none;">
        <div class="login-input-group">
          <input 
            type="text" 
            class="login-input" 
            id="registerUsername" 
            placeholder="ËØ∑ËæìÂÖ•Áî®Êà∑Âêç"
            autocomplete="username"
            required
          />
        </div>
        <div class="login-input-group">
          <input 
            type="email" 
            class="login-input" 
            id="registerEmail" 
            placeholder="ËØ∑ËæìÂÖ•ÈÇÆÁÆ±Âú∞ÂùÄ"
            autocomplete="email"
            required
          />
        </div>
        <div class="login-input-group" style="display: flex; gap: 8px;">
          <input 
            type="text" 
            class="login-input" 
            id="registerCode" 
            placeholder="ËØ∑ËæìÂÖ•È™åËØÅÁ†Å"
            style="flex: 1;"
            required
          />
          <button type="button" class="send-code-btn" id="sendCodeBtn" style="white-space: nowrap; padding: 14px 20px; background: #667eea; color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 14px; font-weight: 600;">
            ÂèëÈÄÅÈ™åËØÅÁ†Å
          </button>
        </div>
        <div class="login-input-group">
          <input 
            type="password" 
            class="login-input" 
            id="registerPassword" 
            placeholder="ËØ∑ËÆæÁΩÆÂØÜÁ†ÅÔºàËá≥Â∞ë6‰ΩçÔºâ"
            autocomplete="new-password"
            required
          />
        </div>
        <div class="login-input-group">
          <input 
            type="password" 
            class="login-input" 
            id="registerPasswordConfirm" 
            placeholder="ËØ∑ÂÜçÊ¨°ËæìÂÖ•ÂØÜÁ†Å"
            autocomplete="new-password"
            required
          />
        </div>
        <button type="submit" class="login-btn" id="registerSubmitBtn">
          Ê≥®ÂÜå
        </button>
        <div class="login-switch" style="text-align: center; margin-top: 16px;">
          <span style="color: #6b7280;">Â∑≤ÊúâË¥¶Âè∑Ôºü</span>
          <a href="#" id="switchToLogin" style="color: #667eea; text-decoration: none; font-weight: 600; margin-left: 4px;">Á´ãÂç≥ÁôªÂΩï</a>
        </div>
      </form>
      
      <div class="login-footer" id="loginError" style="color: #ef4444; display: none; margin-top: 12px; text-align: center;">
      </div>
      <div class="login-footer" id="registerError" style="color: #ef4444; display: none; margin-top: 12px; text-align: center;">
      </div>
      <div class="login-footer" id="registerSuccess" style="color: #10b981; display: none; margin-top: 12px; text-align: center;">
      </div>

    </div>
  </div>

  <!-- ËÆæÁΩÆÂºπÁ™ó -->
  <div class="settings-modal" id="settingsModal">
    <div class="settings-content">
      <div class="settings-header">
        <h2 class="settings-title">ËÆæÁΩÆ</h2>
        <button class="close-btn" id="closeSettingsBtn">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>
      <div class="settings-body">
        <!-- ÂΩìÂâçÁî®Êà∑‰ø°ÊÅØ -->
        <div class="form-group" style="background: #f9fafb; padding: 12px 16px; border-radius: 8px; margin-bottom: 20px;">
          <label class="form-label" style="margin-bottom: 8px;">ÂΩìÂâçÁôªÂΩïÁî®Êà∑</label>
          <div id="currentUserDisplay" style="font-size: 16px; font-weight: 600; color: #667eea;">
            Âä†ËΩΩ‰∏≠...
          </div>
        </div>
        <!-- È¢ùÂ∫¶ÊòæÁ§∫ -->
        <div class="form-group" id="quotaGroup" style="margin-bottom: 20px;">
          <label class="form-label" id="quotaLabel">Â∑≤Áî®È¢ùÂ∫¶ <span id="quotaStatus" style="color: #6b7280;">ÔºàÂÖçË¥πÈ¢ùÂ∫¶Ôºâ</span></label>
          <div id="quotaText" style="font-size: 14px; color: #374151; margin-bottom: 8px;">0/100000</div>
          <div class="progress" style="height: 10px; background: #f3f4f6; border-radius: 999px; overflow: hidden;">
            <div id="quotaBar" style="height: 100%; width: 0%; background: linear-gradient(90deg, #60a5fa, #818cf8);"></div>
          </div>
        </div>
        
        <form id="settingsForm">
          <div class="form-group" id="openaiKeyGroup">
            <label class="form-label" for="openaiApiKey">OpenAI API Key</label>
            <input type="password" class="form-input" id="openaiApiKey" name="openai_api_key" placeholder="ËØ∑ËæìÂÖ•OpenAI API Key" />
          </div>
          
          <div class="form-group" id="openaiBaseUrlGroup">
            <label class="form-label" for="openaiBaseUrl">OpenAI Base URL</label>
            <input type="text" class="form-input" id="openaiBaseUrl" name="openai_base_url" placeholder="https://api.openai.com/v1" />
          </div>
          
          <button type="submit" class="save-btn" id="saveSettingsBtn">‰øùÂ≠òËÆæÁΩÆ</button>
        </form>
        
        <!-- ÈÄÄÂá∫ÁôªÂΩïÊåâÈíÆ -->
        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e5e7eb;">
          <button type="button" class="save-btn" id="logoutBtn" style="background: #ef4444;">
            ÈÄÄÂá∫ÁôªÂΩï
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ÂàÜ‰∫´ÂºπÁ™ó -->
  <div class="share-modal" id="shareModal">
    <div class="share-content">
      <div class="share-header">
        <h2 class="share-title">ÂàÜ‰∫´ÂØπËØù</h2>
        <button class="close-btn" id="closeShareBtn">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>
      <div class="share-body">
        <div class="share-link-container">
          <input type="text" class="share-link-input" id="shareLinkInput" readonly>
          <button class="copy-link-btn" id="copyShareLinkBtn">Â§çÂà∂ÈìæÊé•</button>
        </div>
        <div class="share-note">
          ÂÖ∂‰ªñ‰∫∫ÂèØ‰ª•ÈÄöËøáÊ≠§ÈìæÊé•Êü•ÁúãËøôÊù°ÂõûÂ§çÔºåÂπ∂ÁªßÁª≠ÂØπËØù„ÄÇ
        </div>
      </div>
    </div>
  </div>

  <!-- ËÆ∞ÂøÜÊü•ÁúãÂºπÁ™ó -->
  <div class="settings-modal" id="memoryModal">
    <div class="settings-content">
      <div class="settings-header">
        <h2 class="settings-title">ËÆ∞ÂøÜÊü•Áúã</h2>
        <button class="close-btn" id="closeMemoryBtn">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>
      <div class="settings-body">
        <div class="memory-tabs">
          <button class="memory-tab active" id="personalMemoryTab">‰∏™‰∫∫ËÆ∞ÂøÜ</button>
          <button class="memory-tab" id="sharedMemoryTab">ÂÖ±‰∫´ËÆ∞ÂøÜ</button>
        </div>
        <div class="memory-content">
          <div id="personalMemoryContent" class="memory-panel active">
            <div class="memory-type-selector">
              <label for="memoryTypeSelect">ËÆ∞ÂøÜÁ±ªÂûãÔºö</label>
              <select id="memoryTypeSelect" class="memory-type-select">
                <option value="short">Áü≠ÊúüËÆ∞ÂøÜ</option>
                <option value="mid">‰∏≠ÊúüËÆ∞ÂøÜ</option>
                <option value="long">ÈïøÊúüËÆ∞ÂøÜ</option>
              </select>
            </div>
            <div class="memory-list" id="personalMemoryList">
              <!-- ‰∏™‰∫∫ËÆ∞ÂøÜÂàóË°®Â∞ÜÂú®ËøôÈáåÊòæÁ§∫ -->
            </div>
          </div>
          <div id="sharedMemoryContent" class="memory-panel">
            <div class="memory-list" id="sharedMemoryList">
              <!-- ÂÖ±‰∫´ËÆ∞ÂøÜÊöÇÊó∂‰∏∫Á©∫ -->
              <div class="empty-state">ÂÖ±‰∫´ËÆ∞ÂøÜÂäüËÉΩÊöÇÊú™ÂºÄÊîæ</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>


  <script>
    // ÂÖ®Â±ÄÂèòÈáè
    let currentChatId = null;
    let chatHistory = [];
    let currentUsername = null;
    let selectedModel = 'gpt-4o-mini';
    let sharedMemoryEnabled = true;  // ÈªòËÆ§ÂºÄÂêØÂÖ±‰∫´ËÆ∞ÂøÜ
    let personalMemoryEnabled = true;  // ‰∏™‰∫∫ËÆ∞ÂøÜÈªòËÆ§ÂêØÁî®
    let mcpToolsEnabled = false;  // MCP Â∑•ÂÖ∑Ë∞ÉÁî®ÈªòËÆ§ÂÖ≥Èó≠
    let currentAbortController = null;  // Áî®‰∫éÁªàÊ≠¢ÂΩìÂâçËØ∑Ê±Ç
    let backendUrl = 'https://baijia.online/agent-share/'; // ÂêéÁ´ØURL

    // ÊµÅÂºèMarkdownÂ¢ûÈáèÊ∏≤ÊüìËäÇÊµÅÁä∂ÊÄÅ
    let lastMarkdownRenderAt = 0;
    let markdownRenderScheduled = false;
    let pendingRenderTimer = null;  // üî• ‰øùÂ≠òpendingÁöÑÊ∏≤Êüì‰ªªÂä°ID
    const MARKDOWN_RENDER_INTERVAL_MS = 80; // ËäÇÊµÅÈó¥ÈöîÔºåÂπ≥Ë°°ÊµÅÁïÖÂ∫¶‰∏éÊÄßËÉΩ

    // DOMÂÖÉÁ¥†
    const sidebar = document.getElementById('sidebar');
    const chatHistoryContainer = document.getElementById('chatHistory');
    const chatMessages = document.getElementById('chatMessages');
    const chatInput = document.getElementById('chatInput');
    const sendBtn = document.getElementById('sendBtn');
    const stopBtn = document.getElementById('stopBtn');
    const newChatBtn = document.getElementById('newChatBtn');
    const settingsBtn = document.getElementById('settingsBtn');
    const settingsModal = document.getElementById('settingsModal');
    const mcpToolsBtn = document.getElementById('mcpToolsBtn');
    const toolCallIndicator = document.getElementById('toolCallIndicator');
    const toolCallStatus = document.getElementById('toolCallStatus');
    const closeSettingsBtn = document.getElementById('closeSettingsBtn');
    const settingsForm = document.getElementById('settingsForm');
    const aiModelSelector = document.getElementById('aiModelSelector');
    const memoryBtn = document.getElementById('memoryBtn');
    const memoryModal = document.getElementById('memoryModal');
    const shareModal = document.getElementById('shareModal');
    const closeShareBtn = document.getElementById('closeShareBtn');
    const shareLinkInput = document.getElementById('shareLinkInput');
    const copyShareLinkBtn = document.getElementById('copyShareLinkBtn');
    const closeMemoryBtn = document.getElementById('closeMemoryBtn');
    const personalMemoryTab = document.getElementById('personalMemoryTab');
    const sharedMemoryTab = document.getElementById('sharedMemoryTab');
    const memoryTypeSelect = document.getElementById('memoryTypeSelect');
    const personalMemoryContent = document.getElementById('personalMemoryContent');
    const sharedMemoryContent = document.getElementById('sharedMemoryContent');
    const personalMemoryList = document.getElementById('personalMemoryList');
    const sharedMemoryList = document.getElementById('sharedMemoryList');
    const sharedMemoryBtn = document.getElementById('sharedMemoryBtn');
    const loginModal = document.getElementById('loginModal');
    const loginForm = document.getElementById('loginForm');
    const emailLoginForm = document.getElementById('emailLoginForm');
    const loginUsername = document.getElementById('loginUsername');
    const loginPassword = document.getElementById('loginPassword');
    const switchToEmailLogin = document.getElementById('switchToEmailLogin');
    const switchToPasswordLogin = document.getElementById('switchToPasswordLogin');
    const emailLoginEmail = document.getElementById('emailLoginEmail');
    const emailLoginCode = document.getElementById('emailLoginCode');
    const emailLoginSendCodeBtn = document.getElementById('emailLoginSendCodeBtn');
    const emailLoginSubmitBtn = document.getElementById('emailLoginSubmitBtn');
    const registerForm = document.getElementById('registerForm');
    const registerUsername = document.getElementById('registerUsername');
    const registerEmail = document.getElementById('registerEmail');
    const registerCode = document.getElementById('registerCode');
    const registerPassword = document.getElementById('registerPassword');
    const registerPasswordConfirm = document.getElementById('registerPasswordConfirm');
    const sendCodeBtn = document.getElementById('sendCodeBtn');
    const registerSubmitBtn = document.getElementById('registerSubmitBtn');
    const switchToRegister = document.getElementById('switchToRegister');
    const switchToLogin = document.getElementById('switchToLogin');
    const loginTitle = document.getElementById('loginTitle');
    const loginSubtitle = document.getElementById('loginSubtitle');
    const loginError = document.getElementById('loginError');
    const registerError = document.getElementById('registerError');
    const registerSuccess = document.getElementById('registerSuccess');
    const loginSubmitBtn = document.getElementById('loginSubmitBtn');
    
    // ÂèëÈÄÅÈ™åËØÅÁ†ÅÂÄíËÆ°Êó∂Áä∂ÊÄÅ
    let sendCodeCountdown = 0;
    let sendCodeTimer = null;

    // üîí ÁôªÂΩïÁä∂ÊÄÅÊ†áÂøó
    let isLoggedIn = false;

    // ÂàùÂßãÂåñMarkdownÊ∏≤ÊüìÂô®
    function initializeMarkdown() {
      if (typeof marked !== 'undefined') {
        marked.setOptions({
          breaks: true,
          gfm: true,
          headerIds: false,
          mangle: false,
          sanitize: false
        });
      }
      
      if (typeof hljs !== 'undefined') {
      }
    }

    // ÂàùÂßãÂåñ
    document.addEventListener('DOMContentLoaded', async function() {
      initializeMarkdown();
      await checkLoginStatus(); // üîí ÂÖàÁ°Æ‰øùÊãøÂà∞ÁôªÂΩïÊÄÅ
      // Â¶ÇÊûúÊòØÂàÜ‰∫´ÈìæÊé•ÔºåcheckLoginStatus ‰∏≠Â∑≤ÁªèÂ§ÑÁêÜ‰∫ÜÔºåËøôÈáå‰∏çÈúÄË¶ÅÂÜçË∞ÉÁî® initializeApp
      const shareToken = getShareTokenFromURL();
      if (!shareToken) {
        initializeApp();
      }
      initializeSharedMemoryButton();
      setupEventListeners();
      setupLoginHandlers(); // üîí ËÆæÁΩÆÁôªÂΩïÁõ∏ÂÖ≥‰∫ã‰ª∂
    });

    // üîí Ê£ÄÊü•ÁôªÂΩïÁä∂ÊÄÅ
    async function checkLoginStatus() {
      // ÂÖàÊ£ÄÊü•ÊòØÂê¶ÊòØÂàÜ‰∫´ÈìæÊé•ÔºåÂ¶ÇÊûúÊòØÔºåÂç≥‰ΩøÊú™ÁôªÂΩï‰πüË¶ÅÂä†ËΩΩ
      const shareToken = getShareTokenFromURL();
      if (shareToken) {
        // Â¶ÇÊûúÊòØÂàÜ‰∫´ÈìæÊé•ÔºåÂÖàÂ∞ùËØïÂä†ËΩΩÂàÜ‰∫´Ê∂àÊÅØÔºà‰∏çÈúÄË¶ÅÁôªÂΩïÔºâ
        await loadSharedMessage(shareToken);
        // Âä†ËΩΩÂÆåÂàÜ‰∫´Ê∂àÊÅØÂêéÔºåÁªßÁª≠Ê£ÄÊü•ÁôªÂΩïÁä∂ÊÄÅÔºàÂ¶ÇÊûúÂ∑≤ÁôªÂΩïÔºå‰ºöÊòæÁ§∫Áî®Êà∑ËÅäÂ§©ÂéÜÂè≤Ôºâ
      }
      
      try {
        const resp = await fetch(`${backendUrl}/api/me`, { credentials: 'include' });
        if (resp.ok) {
          const data = await resp.json();
          if (data.authenticated) {
            currentUsername = data.username || localStorage.getItem('username');
            if (currentUsername) localStorage.setItem('username', currentUsername);
            isLoggedIn = true;
            hideLoginModal();
            
            // Â¶ÇÊûúÂ∑≤ÁôªÂΩï‰∏îÊòØÂàÜ‰∫´ÈìæÊé•ÔºåÈáçÊñ∞Âä†ËΩΩÂàÜ‰∫´Ê∂àÊÅØÔºàËøôÊ¨°‰ºöÊòæÁ§∫Áî®Êà∑ËÅäÂ§©ÂéÜÂè≤Ôºâ
            if (shareToken) {
              await loadSharedMessage(shareToken);
            }
            
            return;
          }
        }
        // Êú™ÁôªÂΩïÊó∂ÔºåÂ¶ÇÊûúÊòØÂàÜ‰∫´ÈìæÊé•Ôºå‰∏çÊòæÁ§∫ÁôªÂΩïÂºπÁ™óÔºàÂÖÅËÆ∏Êü•ÁúãÂàÜ‰∫´ÂÜÖÂÆπÔºâ
        if (!shareToken) {
          showLoginModal();
        }
      } catch (e) {
        // Âá∫ÈîôÊó∂ÔºåÂ¶ÇÊûúÊòØÂàÜ‰∫´ÈìæÊé•Ôºå‰∏çÊòæÁ§∫ÁôªÂΩïÂºπÁ™óÔºàÂÖÅËÆ∏Êü•ÁúãÂàÜ‰∫´ÂÜÖÂÆπÔºâ
        if (!shareToken) {
          showLoginModal();
        }
      }
    }

    // üîí ÊòæÁ§∫ÁôªÂΩïÂºπÁ™ó
    function showLoginModal() {
      loginModal.classList.add('show');
      loginUsername.focus();
    }

    // üîí ÈöêËóèÁôªÂΩïÂºπÁ™ó
    function hideLoginModal() {
      loginModal.classList.remove('show');
    }

    // üîí Â§ÑÁêÜÁôªÂΩï
    async function handleLogin(username, password) {
      if (!username || username.trim() === '') {
        showLoginError('ËØ∑ËæìÂÖ•ÈÇÆÁÆ±');
        return false;
      }
      
      if (!password || password.trim() === '') {
        showLoginError('ËØ∑ËæìÂÖ•ÂØÜÁ†Å');
        return false;
      }
      
      // Á¶ÅÁî®ÁôªÂΩïÊåâÈíÆÔºåÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
      loginSubmitBtn.disabled = true;
      loginSubmitBtn.textContent = 'ÁôªÂΩï‰∏≠...';
      hideLoginError();
      
      try {
        // Ë∞ÉÁî®ÂêéÁ´ØÈ™åËØÅAPI
        const response = await fetch(`${backendUrl}/api/login`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          credentials: 'include',
          body: JSON.stringify({
            email: username.trim(),
            password: password.trim()
          })
        });
        
        const data = await response.json();
        
        if (data.success) {
          // ÁôªÂΩïÊàêÂäü
          currentUsername = data.username || username.trim();
          // ‰ªÖÁî®‰∫éÂ±ïÁ§∫Áî®Êà∑ÂêçÔºå‰∏ç‰Ωú‰∏∫ËÆ§ËØÅ‰æùÊçÆ
          localStorage.setItem('username', currentUsername);
          isLoggedIn = true;
          
          hideLoginModal();
          
          // Ê£ÄÊü•ÊòØÂê¶ÊòØÂàÜ‰∫´ÈìæÊé•È°µÈù¢
          const shareToken = getShareTokenFromURL();
          if (shareToken) {
            // Â¶ÇÊûúÊòØÂàÜ‰∫´ÈìæÊé•ÔºåÈáçÊñ∞Âä†ËΩΩÂàÜ‰∫´Ê∂àÊÅØÔºàËøôÊ¨°‰ºöÊòæÁ§∫Áî®Êà∑ËÅäÂ§©ÂéÜÂè≤Ôºâ
            await loadSharedMessage(shareToken);
          } else {
            // ÁôªÂΩïÊàêÂäüÂêéÂàùÂßãÂåñÂ∫îÁî®
            loadUserConfig();
            loadChatHistory();
            showNewChatInterface();
          }
          
          
          // ÈáçÁΩÆË°®Âçï
          loginUsername.value = '';
          loginPassword.value = '';
          
          return true;
        } else {
          // ÁôªÂΩïÂ§±Ë¥•
          showLoginError(data.error || 'ÁôªÂΩïÂ§±Ë¥•');
          loginPassword.value = ''; // Ê∏ÖÁ©∫ÂØÜÁ†Å
          loginPassword.focus();
          return false;
        }
      } catch (error) {
        showLoginError('ÁΩëÁªúÈîôËØØÔºåËØ∑Á®çÂêéÈáçËØï');
        return false;
      } finally {
        // ÊÅ¢Â§çÁôªÂΩïÊåâÈíÆÁä∂ÊÄÅ
        loginSubmitBtn.disabled = false;
        loginSubmitBtn.textContent = 'ÁôªÂΩï';
      }
    }
    
    // üîí ÊòæÁ§∫ÁôªÂΩïÈîôËØØ
    function showLoginError(message) {
      loginError.textContent = message;
      loginError.style.display = 'block';
    }
    
    // üîí ÈöêËóèÁôªÂΩïÈîôËØØ
    function hideLoginError() {
      loginError.style.display = 'none';
      loginError.textContent = '';
    }
    
    // üîí ÊòæÁ§∫Ê≥®ÂÜåÈîôËØØ
    function showRegisterError(message) {
      registerError.textContent = message;
      registerError.style.display = 'block';
      registerSuccess.style.display = 'none';
    }
    
    // üîí ÈöêËóèÊ≥®ÂÜåÈîôËØØ
    function hideRegisterError() {
      registerError.style.display = 'none';
      registerError.textContent = '';
    }
    
    // üîí ÊòæÁ§∫Ê≥®ÂÜåÊàêÂäü
    function showRegisterSuccess(message) {
      registerSuccess.textContent = message;
      registerSuccess.style.display = 'block';
      registerError.style.display = 'none';
    }
    
    // üîí ÂàáÊç¢Âà∞Ê≥®ÂÜåË°®Âçï
    function switchToRegisterForm() {
      loginForm.style.display = 'none';
      registerForm.style.display = 'block';
      loginTitle.textContent = 'Ê≥®ÂÜåË¥¶Âè∑';
      loginSubtitle.textContent = 'ËØ∑ËæìÂÖ•Áî®Êà∑ÂêçÂíåÈÇÆÁÆ±ËøõË°åÊ≥®ÂÜå';
      hideLoginError();
      hideRegisterError();
      registerSuccess.style.display = 'none';
      registerUsername.focus();
    }
    
    // üîí ÂàáÊç¢Âà∞ÁôªÂΩïË°®Âçï
    function switchToLoginForm() {
      registerForm.style.display = 'none';
      emailLoginForm.style.display = 'none';
      loginForm.style.display = 'block';
      loginTitle.textContent = 'Ê¨¢Ëøé‰ΩøÁî® Experience Chat';
      loginSubtitle.textContent = 'ËØ∑ËæìÂÖ•ÈÇÆÁÆ±ÂíåÂØÜÁ†ÅÁôªÂΩï';
      hideLoginError();
      hideRegisterError();
      registerSuccess.style.display = 'none';
      // Ê∏ÖÁ©∫Ê≥®ÂÜåË°®Âçï
      registerUsername.value = '';
      registerEmail.value = '';
      registerCode.value = '';
      registerPassword.value = '';
      registerPasswordConfirm.value = '';
      loginUsername.focus();
    }

    // üîí ÂàáÊç¢Âà∞ÂøòËÆ∞ÂØÜÁ†Å
    function switchToEmailLoginForm() {
      loginForm.style.display = 'none';
      registerForm.style.display = 'none';
      emailLoginForm.style.display = 'block';
      loginTitle.textContent = 'ÂøòËÆ∞ÂØÜÁ†Å';
      loginSubtitle.textContent = 'ËØ∑ËæìÂÖ•Ê≥®ÂÜåÈÇÆÁÆ±„ÄÅÈ™åËØÅÁ†ÅÂíåÊñ∞ÂØÜÁ†Å‰ª•ÈáçÁΩÆ';
      hideLoginError();
      emailLoginEmail.focus();
    }
    
    // üîí ÂèëÈÄÅÈ™åËØÅÁ†Å
    async function sendVerificationCode() {
      const username = registerUsername.value.trim();
      const email = registerEmail.value.trim();
      
      if (!username) {
        showRegisterError('ËØ∑ËæìÂÖ•Áî®Êà∑Âêç');
        return;
      }
      
      if (!email) {
        showRegisterError('ËØ∑ËæìÂÖ•ÈÇÆÁÆ±Âú∞ÂùÄ');
        return;
      }
      
      // ÁÆÄÂçïÁöÑÈÇÆÁÆ±Ê†ºÂºèÈ™åËØÅ
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        showRegisterError('ÈÇÆÁÆ±Ê†ºÂºè‰∏çÊ≠£Á°Æ');
        return;
      }
      
      // Á¶ÅÁî®ÂèëÈÄÅÊåâÈíÆÔºåÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
      sendCodeBtn.disabled = true;
      sendCodeBtn.textContent = 'ÂèëÈÄÅ‰∏≠...';
      hideRegisterError();
      
      try {
        const response = await fetch(`${backendUrl}/api/send_verification_code`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            username: username,
            email: email
          })
        });
        
        const data = await response.json();
        
        if (data.success) {
          showRegisterSuccess(data.message || 'È™åËØÅÁ†ÅÂ∑≤ÂèëÈÄÅÔºåËØ∑Êü•Êî∂ÈÇÆ‰ª∂');
          // ÂºÄÂßãÂÄíËÆ°Êó∂Ôºà60ÁßíÔºâ
          startSendCodeCountdown(60);
        } else {
          showRegisterError(data.error || 'È™åËØÅÁ†ÅÂèëÈÄÅÂ§±Ë¥•');
          sendCodeBtn.disabled = false;
          sendCodeBtn.textContent = 'ÂèëÈÄÅÈ™åËØÅÁ†Å';
        }
      } catch (error) {
        showRegisterError('ÁΩëÁªúÈîôËØØÔºåËØ∑Á®çÂêéÈáçËØï');
        sendCodeBtn.disabled = false;
        sendCodeBtn.textContent = 'ÂèëÈÄÅÈ™åËØÅÁ†Å';
      }
    }
    
    // üîí ÂºÄÂßãÂèëÈÄÅÈ™åËØÅÁ†ÅÂÄíËÆ°Êó∂
    function startSendCodeCountdown(seconds) {
      sendCodeCountdown = seconds;
      sendCodeBtn.disabled = true;
      
      if (sendCodeTimer) {
        clearInterval(sendCodeTimer);
      }
      
      sendCodeBtn.textContent = `${sendCodeCountdown}ÁßíÂêéÈáçËØï`;
      
      sendCodeTimer = setInterval(() => {
        sendCodeCountdown--;
        if (sendCodeCountdown > 0) {
          sendCodeBtn.textContent = `${sendCodeCountdown}ÁßíÂêéÈáçËØï`;
        } else {
          clearInterval(sendCodeTimer);
          sendCodeTimer = null;
          sendCodeBtn.disabled = false;
          sendCodeBtn.textContent = 'ÂèëÈÄÅÈ™åËØÅÁ†Å';
        }
      }, 1000);
    }
    
    // üîí Â§ÑÁêÜÊ≥®ÂÜå
    async function handleRegister() {
      const username = registerUsername.value.trim();
      const email = registerEmail.value.trim();
      const code = registerCode.value.trim();
      const password = registerPassword.value;
      const passwordConfirm = registerPasswordConfirm.value;
      
      if (!username) {
        showRegisterError('ËØ∑ËæìÂÖ•Áî®Êà∑Âêç');
        return false;
      }
      
      if (!email) {
        showRegisterError('ËØ∑ËæìÂÖ•ÈÇÆÁÆ±Âú∞ÂùÄ');
        return false;
      }
      
      if (!code) {
        showRegisterError('ËØ∑ËæìÂÖ•È™åËØÅÁ†Å');
        return false;
      }

      if (!password || password.length < 6) {
        showRegisterError('ËØ∑ËÆæÁΩÆËá≥Â∞ë6‰ΩçÂØÜÁ†Å');
        return false;
      }

      if (password !== passwordConfirm) {
        showRegisterError('‰∏§Ê¨°ËæìÂÖ•ÁöÑÂØÜÁ†Å‰∏ç‰∏ÄËá¥');
        return false;
      }
      
      // Á¶ÅÁî®Ê≥®ÂÜåÊåâÈíÆÔºåÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
      registerSubmitBtn.disabled = true;
      registerSubmitBtn.textContent = 'Ê≥®ÂÜå‰∏≠...';
      hideRegisterError();
      
      try {
        const response = await fetch(`${backendUrl}/api/register`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            username: username,
            email: email,
            verification_code: code,
            password: password
          })
        });
        
        const data = await response.json();
        
        if (data.success) {
          showRegisterSuccess(data.message || 'Ê≥®ÂÜåÊàêÂäüÔºÅ');
          // 2ÁßíÂêéËá™Âä®ÂàáÊç¢Âà∞ÁôªÂΩïË°®Âçï
          setTimeout(() => {
            switchToLoginForm();
            // Âú®ÁôªÂΩïË°®Âçï‰∏≠Â°´ÂÖÖÁî®Êà∑Âêç
            loginUsername.value = username;
            // ËΩªÊèêÁ§∫
            showLoginError('Ê≥®ÂÜåÊàêÂäüÔºÅËØ∑‰ΩøÁî®ÂàöËÆæÁΩÆÁöÑÂØÜÁ†ÅÁôªÂΩï');
          }, 2000);
          return true;
        } else {
          showRegisterError(data.error || 'Ê≥®ÂÜåÂ§±Ë¥•');
          registerCode.value = ''; // Ê∏ÖÁ©∫È™åËØÅÁ†Å
          registerCode.focus();
          return false;
        }
      } catch (error) {
        showRegisterError('ÁΩëÁªúÈîôËØØÔºåËØ∑Á®çÂêéÈáçËØï');
        return false;
      } finally {
        // ÊÅ¢Â§çÊ≥®ÂÜåÊåâÈíÆÁä∂ÊÄÅ
        registerSubmitBtn.disabled = false;
        registerSubmitBtn.textContent = 'Ê≥®ÂÜå';
      }
    }

    // üîí ËÆæÁΩÆÁôªÂΩïÁõ∏ÂÖ≥‰∫ã‰ª∂Â§ÑÁêÜ
    function setupLoginHandlers() {
      // ÁôªÂΩïË°®ÂçïÊèê‰∫§
      loginForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const username = loginUsername.value;
        const password = loginPassword.value;
        await handleLogin(username, password);
      });
      
      // Ê≥®ÂÜåË°®ÂçïÊèê‰∫§
      registerForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        await handleRegister();
      });
      
      // ÂàáÊç¢Âà∞Ê≥®ÂÜåË°®Âçï
      switchToRegister.addEventListener('click', function(e) {
        e.preventDefault();
        switchToRegisterForm();
      });
      
      // ÂàáÊç¢Âà∞ÁôªÂΩïË°®Âçï
      switchToLogin.addEventListener('click', function(e) {
        e.preventDefault();
        switchToLoginForm();
      });

      // ÂàáÊç¢Âà∞ÈÇÆÁÆ±È™åËØÅÁ†ÅÁôªÂΩï
      switchToEmailLogin.addEventListener('click', function(e) {
        e.preventDefault();
        switchToEmailLoginForm();
      });

      // ÂàáÊç¢ÂõûË¥¶Âè∑ÂØÜÁ†ÅÁôªÂΩï
      switchToPasswordLogin.addEventListener('click', function(e) {
        e.preventDefault();
        switchToLoginForm();
      });

      // ÂèëÈÄÅÂøòËÆ∞ÂØÜÁ†ÅÈ™åËØÅÁ†Å
      emailLoginSendCodeBtn.addEventListener('click', async function(e) {
        e.preventDefault();
        const email = emailLoginEmail.value.trim();
        if (!email) {
          showLoginError('ËØ∑ËæìÂÖ•Ê≥®ÂÜåÈÇÆÁÆ±');
          return;
        }
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
          showLoginError('ÈÇÆÁÆ±Ê†ºÂºè‰∏çÊ≠£Á°Æ');
          return;
        }
        // ÁÆÄÂçïÈò≤ÈáçÂ§çÁÇπÂáª
        emailLoginSendCodeBtn.disabled = true;
        emailLoginSendCodeBtn.textContent = 'ÂèëÈÄÅ‰∏≠...';
        hideLoginError();
        try {
          const resp = await fetch(`${backendUrl}/api/send_reset_code`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email })
          });
          const data = await resp.json();
          if (data.success) {
            showLoginError('È™åËØÅÁ†ÅÂ∑≤ÂèëÈÄÅÔºåËØ∑Êü•Êî∂ÈÇÆÁÆ±');
            // ÁÆÄÊòìÂÄíËÆ°Êó∂
            let left = 60;
            const timer = setInterval(() => {
              left--;
              if (left > 0) {
                emailLoginSendCodeBtn.textContent = `${left}ÁßíÂêéÈáçËØï`;
              } else {
                clearInterval(timer);
                emailLoginSendCodeBtn.disabled = false;
                emailLoginSendCodeBtn.textContent = 'ÂèëÈÄÅÈ™åËØÅÁ†Å';
              }
            }, 1000);
          } else {
            showLoginError(data.error || 'ÂèëÈÄÅÈ™åËØÅÁ†ÅÂ§±Ë¥•');
            emailLoginSendCodeBtn.disabled = false;
            emailLoginSendCodeBtn.textContent = 'ÂèëÈÄÅÈ™åËØÅÁ†Å';
          }
        } catch (err) {
          showLoginError('ÁΩëÁªúÈîôËØØÔºåËØ∑Á®çÂêéÈáçËØï');
          emailLoginSendCodeBtn.disabled = false;
          emailLoginSendCodeBtn.textContent = 'ÂèëÈÄÅÈ™åËØÅÁ†Å';
        }
      });

      // Êèê‰∫§ÈáçÁΩÆÂØÜÁ†Å
      emailLoginForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const email = emailLoginEmail.value.trim();
        const code = emailLoginCode.value.trim();
        const newPassword = emailResetNewPassword.value.trim();
        const confirmPassword = emailResetConfirmPassword.value.trim();
        if (!email || !code || !newPassword || !confirmPassword) {
          showLoginError('ËØ∑ËæìÂÖ•ÈÇÆÁÆ±„ÄÅÈ™åËØÅÁ†ÅÂíåÊñ∞ÂØÜÁ†Å');
          return;
        }
        if (newPassword.length < 6) {
          showLoginError('ÂØÜÁ†ÅÈïøÂ∫¶ÈúÄËá≥Â∞ë6‰Ωç');
          return;
        }
        if (newPassword !== confirmPassword) {
          showLoginError('‰∏§Ê¨°ËæìÂÖ•ÁöÑÊñ∞ÂØÜÁ†Å‰∏ç‰∏ÄËá¥');
          return;
        }
        emailLoginSubmitBtn.disabled = true;
        emailLoginSubmitBtn.textContent = 'Êèê‰∫§‰∏≠...';
        hideLoginError();
        try {
          const resp = await fetch(`${backendUrl}/api/reset_password`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, verification_code: code, new_password: newPassword, confirm_password: confirmPassword })
          });
          const data = await resp.json();
          if (data.success) {
            showLoginError('ÂØÜÁ†ÅÂ∑≤ÈáçÁΩÆÔºåËØ∑‰ΩøÁî®Êñ∞ÂØÜÁ†ÅÁôªÂΩï');
            switchToLoginForm();
          } else {
            showLoginError(data.error || 'ÈáçÁΩÆÂØÜÁ†ÅÂ§±Ë¥•');
          }
        } catch (err) {
          showLoginError('ÁΩëÁªúÈîôËØØÔºåËØ∑Á®çÂêéÈáçËØï');
        } finally {
          emailLoginSubmitBtn.disabled = false;
          emailLoginSubmitBtn.textContent = 'ÈáçÁΩÆÂØÜÁ†Å';
        }
      });
      
      // ÂèëÈÄÅÈ™åËØÅÁ†ÅÊåâÈíÆ
      sendCodeBtn.addEventListener('click', function(e) {
        e.preventDefault();
        sendVerificationCode();
      });

      // ÈòªÊ≠¢ÁÇπÂáªËÉåÊôØÂÖ≥Èó≠ÁôªÂΩïÂºπÁ™ó
      loginModal.addEventListener('click', function(e) {
        if (e.target === loginModal && !isLoggedIn) {
          // Êú™ÁôªÂΩïÊó∂‰∏çÂÖÅËÆ∏ÂÖ≥Èó≠
          if (loginForm.style.display !== 'none') {
            loginUsername.focus();
          } else {
            registerUsername.focus();
          }
        }
      });
    }

    // üîí Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÁôªÂΩïÔºàÂäüËÉΩÊã¶Êà™Ôºâ
    function requireLogin() {
      if (!isLoggedIn) {
        showLoginModal();
        return false;
      }
      return true;
    }
    
    // üîí Â§ÑÁêÜÈÄÄÂá∫ÁôªÂΩï
    async function handleLogout() {
      if (confirm('Á°ÆÂÆöË¶ÅÈÄÄÂá∫ÁôªÂΩïÂêóÔºü')) {
        try {
          await fetch(`${backendUrl}/api/logout`, { method: 'POST', credentials: 'include' });
        } catch (e) { }
        // Ê∏ÖÈô§Êú¨Âú∞Â±ïÁ§∫Áî®Áî®Êà∑Âêç
        localStorage.removeItem('username');
        currentUsername = null;
        isLoggedIn = false;
        closeSettings();
        location.reload();
      }
    }

    // ÂàùÂßãÂåñÂ∫îÁî®
    async function initializeApp() {
      // Ê£ÄÊü•ÊòØÂê¶ÊòØÂàÜ‰∫´ÈìæÊé•
      const shareToken = getShareTokenFromURL();
      if (shareToken) {
        // Â¶ÇÊûúÊòØÂàÜ‰∫´ÈìæÊé•ÔºåÂä†ËΩΩÂàÜ‰∫´ÁöÑÊ∂àÊÅØÔºà‰ºöÊ£ÄÊü•ÁôªÂΩïÁä∂ÊÄÅÔºâ
        await loadSharedMessage(shareToken);
        return;
      }
      
      // Âè™ÊúâÁôªÂΩïÂêéÊâçÊâßË°å
      if (!isLoggedIn) {
        return;
      }
      
      // Âä†ËΩΩÁî®Êà∑ÈÖçÁΩÆÂíåËÅäÂ§©ÂéÜÂè≤
      loadUserConfig();
      loadChatHistory();
      
      // Ê£ÄÊü•Áî®Êà∑ÈÖçÁΩÆ
      checkUserConfig();
    }

    // ‰ªé URL Ëé∑ÂèñÂàÜ‰∫´‰ª§Áâå
    function getShareTokenFromURL() {
      const path = window.location.pathname;
      // Ê£ÄÊü•ÊòØÂê¶ÊòØÂàÜ‰∫´ÈìæÊé•Ê†ºÂºè: /{chat_id}{timestamp_numeric} Êàñ /agent-share/{chat_id}{timestamp_numeric}
      // ÂÖàÂ∞ùËØïÂåπÈÖçÂ∏¶ /agent-share ÂâçÁºÄÁöÑË∑ØÂæÑ
      let match = path.match(/^\/agent-share\/(chat_\d+\d{14})$/);
      if (match) {
        return match[1];
      }
      // ÂÜçÂ∞ùËØïÂåπÈÖç‰∏çÂ∏¶ÂâçÁºÄÁöÑË∑ØÂæÑÔºàÂÖºÂÆπÊóßÊ†ºÂºèÔºâ
      match = path.match(/^\/(chat_\d+\d{14})$/);
      if (match) {
        return match[1];
      }
      return null;
    }

    // Âä†ËΩΩÂàÜ‰∫´ÁöÑÊ∂àÊÅØÔºà‰∏çÈúÄË¶ÅÁôªÂΩïÂç≥ÂèØÊü•ÁúãÔºâ
    async function loadSharedMessage(shareToken) {
      try {
        // Ê∏ÖÈô§ÂΩìÂâçÂØπËØù
        chatMessages.innerHTML = '';
        currentChatId = null;
        
        // Ë∞ÉÁî® API Ëé∑ÂèñÂàÜ‰∫´ÁöÑÊ∂àÊÅØÔºà‰∏çÈúÄË¶ÅÁôªÂΩïÔºâ
        const response = await fetch(`${backendUrl}/api/get_shared_message?share_token=${encodeURIComponent(shareToken)}`);
        const data = await response.json();
        
        if (!data.success) {
          alert('Âä†ËΩΩÂàÜ‰∫´Ê∂àÊÅØÂ§±Ë¥•: ' + (data.error || 'Êú™Áü•ÈîôËØØ'));
          // Ë∑≥ËΩ¨Âà∞‰∏ªÈ°µ
          window.location.href = '/';
          return;
        }
        
        const sharedMessage = data.message;
        const model = data.model;
        
        // ‰øùÂ≠òÂàÜ‰∫´‰ø°ÊÅØÔºåÁî®‰∫éÂêéÁª≠ÂØπËØù
        window.shareToken = shareToken;
        window.originalUsername = data.original_username;
        // ‰øùÂ≠òÂéüÂßãÂàÜ‰∫´ÈìæÊé•ÔºàÁ°Æ‰øùÂåÖÂê´ /agent-share ÂâçÁºÄÔºâ
        const basePath = window.location.pathname.includes('/agent-share') ? '/agent-share' : '';
        window.originalShareLink = `${window.location.origin}${basePath}/${shareToken}`;
        window.sharedMessageSaved = false; // Ê†áËÆ∞ÂàÜ‰∫´Ê∂àÊÅØÊòØÂê¶Â∑≤‰øùÂ≠òÂà∞Áî®Êà∑ÂØπËØù‰∏≠
        
        // ÊòæÁ§∫ÂàÜ‰∫´ÁöÑÊ∂àÊÅØÔºà‰Ωú‰∏∫Á¨¨‰∏ÄÊù° AI Ê∂àÊÅØÔºâ
        const messageDiv = addMessageToUI(
          'assistant',
          sharedMessage.content,
          sharedMessage.shared_memory_enabled || null,
          sharedMessage.used_shared_memories || [],
          sharedMessage.timestamp
        );
        
        // Âú®Ê∂àÊÅØdiv‰∏ä‰øùÂ≠òÂéüÂßãÂàÜ‰∫´ÈìæÊé•‰ø°ÊÅØ
        if (messageDiv) {
          messageDiv.dataset.originalShareLink = window.originalShareLink;
          messageDiv.dataset.isSharedMessage = 'true';
        }
        
        // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁôªÂΩï
        if (isLoggedIn && currentUsername) {
          // Â∑≤ÁôªÂΩïÔºöÂä†ËΩΩÁî®Êà∑ÁöÑËÅäÂ§©ÂéÜÂè≤ÔºàÂú®‰æßËæπÊ†èÊòæÁ§∫Ôºâ
          await loadUserChatHistory();
        } else {
          // Êú™ÁôªÂΩïÔºöÊòæÁ§∫ÊèêÁ§∫
          const noticeDiv = document.createElement('div');
          noticeDiv.style.cssText = 'padding: 12px; margin: 16px; background: #fef3c7; border: 1px solid #fbbf24; border-radius: 8px; color: #92400e; font-size: 14px;';
          noticeDiv.textContent = 'üí° ÊèêÁ§∫ÔºöËøôÊòØÂàÜ‰∫´ÁöÑÂØπËØùÂÜÖÂÆπ„ÄÇÁôªÂΩïÂêéÂèØÊü•ÁúãÊÇ®ÁöÑËÅäÂ§©ÂéÜÂè≤Âπ∂ÁªßÁª≠ÂØπËØù„ÄÇ';
          chatMessages.appendChild(noticeDiv);
        }
        
        // ÊªöÂä®Âà∞Â∫ïÈÉ®
        setTimeout(() => {
          if (chatMessages) {
            chatMessages.scrollTop = chatMessages.scrollHeight;
          }
        }, 100);
        
        // ËÆæÁΩÆÂΩìÂâçÊ®°Âûã
        selectedModel = model;
        if (aiModelSelector) {
          aiModelSelector.value = model;
        }
        
        // ÊÅ¢Â§çËæìÂÖ•Ê°ÜÂà∞Ê≠£Â∏∏‰ΩçÁΩÆ
        restoreInputBox();
        clearEmptyState();
        
      } catch (error) {
        alert('Âä†ËΩΩÂàÜ‰∫´Ê∂àÊÅØÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
        window.location.href = '/';
      }
    }

    // Âä†ËΩΩÁî®Êà∑ÁöÑËÅäÂ§©ÂéÜÂè≤Ôºà‰ªÖÂú®Â∑≤ÁôªÂΩïÊó∂Ë∞ÉÁî®Ôºâ
    async function loadUserChatHistory() {
      if (!isLoggedIn || !currentUsername) {
        return;
      }
      
      try {
        // Âä†ËΩΩÁî®Êà∑ÈÖçÁΩÆÂíåËÅäÂ§©ÂéÜÂè≤Ôºà‰∏ç‰ºöËß¶ÂèëÁôªÂΩïÊã¶Êà™ÔºåÂõ†‰∏∫Â∑≤ÁªèÁôªÂΩïÔºâ
        await loadUserConfig();
        
        // Áõ¥Êé•Ë∞ÉÁî®Âä†ËΩΩËÅäÂ§©ÂéÜÂè≤ÁöÑÈÄªËæëÔºåÈÅøÂÖç requireLogin Ê£ÄÊü•
        try {
          const response = await fetch(`${backendUrl}/get_chat_conversations`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            credentials: 'include',
            body: JSON.stringify({
              username: currentUsername
            })
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();
          
          if (data.success) {
            chatHistory = data.conversations;
            chatHistoryContainer.innerHTML = '';
            
            data.conversations.forEach(chat => {
              const chatItem = document.createElement('div');
              chatItem.className = 'chat-history-item';
              if (chat.id === currentChatId) {
                chatItem.classList.add('active');
              }
              const starHtml = chat.contributed_shared_memory
                ? `
                <span class="chat-history-flag" title="Êú¨Ê¨°ÂØπËØùÂèÇ‰∏éÊûÑÂª∫ÂÖ±‰∫´ËÆ∞ÂøÜ">
                  <svg viewBox="0 0 24 24" stroke="none">
                    <path d="M12 2l2.91 5.88 6.49.94-4.7 4.58 1.11 6.46L12 17.77l-5.81 3.06 1.11-6.46-4.7-4.58 6.49-.94L12 2z"/>
                  </svg>
                </span>
              `
                : '';

              chatItem.innerHTML = `
                <div class="chat-history-item-title">${chat.title || 'Êñ∞ÂØπËØù'}</div>
                <div class="chat-history-item-time">${formatTime(chat.updated_at)}</div>
                ${starHtml}
                <div class="chat-history-item-actions">
                  <button class="delete-btn" onclick="deleteChat('${chat.id}')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polyline points="3,6 5,6 21,6"/>
                      <path d="M19,6v14a2,2 0 0,1 -2,2H7a2,2 0 0,1 -2,-2V6m3,0V4a2,2 0 0,1 2,-2h4a2,2 0 0,1 2,2v2"/>
                    </svg>
                  </button>
                </div>
              `;
              
              chatItem.addEventListener('click', function() {
                loadChat(chat.id, this);
              });
              chatHistoryContainer.appendChild(chatItem);
            });
            
          } else {
          }
        } catch (error) {
        }
      } catch (error) {
      }
    }
    
    // Ê£ÄÊü•Áî®Êà∑ÈÖçÁΩÆÔºàÂ∑≤Êîπ‰∏∫‰∏çÊã¶Êà™Êñ∞Áî®Êà∑Ôºå‰∏çÂºπÂá∫ËÆæÁΩÆÂºπÁ™óÔºâ
    async function checkUserConfig() {
      return; // ‰ΩøÁî®Âπ≥Âè∞ÂÖ¨ÂÖ±È¢ùÂ∫¶Êó∂Êó†ÈúÄÂº∫Âà∂ÊèêÁ§∫ÈÖçÁΩÆ
    }

    // ËÆæÁΩÆ‰∫ã‰ª∂ÁõëÂê¨Âô®
    function setupEventListeners() {
      // ÂèëÈÄÅÊ∂àÊÅØÔºàÂâçÁΩÆÈ¢ùÂ∫¶Ê£ÄÊü•Ôºâ
      sendBtn.addEventListener('click', async function() {
        const ok = await checkQuotaBeforeSend();
        if (!ok) return;
        sendMessage();
      });
      
      // ÂÅúÊ≠¢ÁîüÊàê
      stopBtn.addEventListener('click', stopGeneration);
      
      // ËæìÂÖ•Ê°ÜÁÑ¶ÁÇπÊã¶Êà™
      chatInput.addEventListener('focus', function(e) {
        if (!requireLogin()) {
          e.target.blur(); // ÁßªÈô§ÁÑ¶ÁÇπ
        }
      });

      chatInput.addEventListener('keydown', async function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          const ok = await checkQuotaBeforeSend();
          if (!ok) return;
          sendMessage();
        }
      });

      // Êñ∞Âª∫ÂØπËØù
      newChatBtn.addEventListener('click', createNewChat);

      // ËÆæÁΩÆÁõ∏ÂÖ≥
      settingsBtn.addEventListener('click', openSettings);
      closeSettingsBtn.addEventListener('click', closeSettings);
      settingsModal.addEventListener('click', function(e) {
        if (e.target === settingsModal) {
          closeSettings();
        }
      });

      // ÂàÜ‰∫´ÂºπÁ™óÁõ∏ÂÖ≥
      closeShareBtn.addEventListener('click', closeShareModal);
      shareModal.addEventListener('click', function(e) {
        if (e.target === shareModal) {
          closeShareModal();
        }
      });
      copyShareLinkBtn.addEventListener('click', async function() {
        const link = shareLinkInput.value;
        try {
          await navigator.clipboard.writeText(link);
          const oldText = copyShareLinkBtn.textContent;
          copyShareLinkBtn.textContent = 'Â∑≤Â§çÂà∂';
          setTimeout(() => {
            copyShareLinkBtn.textContent = oldText;
          }, 1600);
        } catch (e) {
          alert('Â§çÂà∂Â§±Ë¥•ÔºåËØ∑ÊâãÂä®Â§çÂà∂');
        }
      });

      // ËÆ∞ÂøÜÁõ∏ÂÖ≥ - Ë∑≥ËΩ¨Âà∞dashboardÈ°µÈù¢
      memoryBtn.addEventListener('click', function() {
        // üîí ÁôªÂΩïÊã¶Êà™
        if (!requireLogin()) return;
        
        // Á°Æ‰øùÁî®Êà∑ÂêçÂ∑≤‰øùÂ≠òÂà∞ localStorage
        localStorage.setItem('username', currentUsername);
        // Âú®Êñ∞Á™óÂè£‰∏≠ÊâìÂºÄ dashboard
        window.open('dashboard', '_blank');
      });

      // ËÆ∞ÂøÜÊ†áÁ≠æÈ°µÂàáÊç¢
      personalMemoryTab.addEventListener('click', () => switchMemoryTab('personal'));
      sharedMemoryTab.addEventListener('click', () => switchMemoryTab('shared'));
      
      // ËÆ∞ÂøÜÁ±ªÂûãÈÄâÊã©Âô®
      memoryTypeSelect.addEventListener('change', loadPersonalMemory);

      // Ë°®ÂçïÊèê‰∫§
      settingsForm.addEventListener('submit', saveSettings);

      // AIÊ®°ÂûãÈÄâÊã©Âô®
      aiModelSelector.addEventListener('change', function() {
        selectedModel = this.value;
      });

      // ÂÖ±‰∫´ËÆ∞ÂøÜÊåâÈíÆ
      sharedMemoryBtn.addEventListener('click', toggleSharedMemory);

      // MCP Â∑•ÂÖ∑Ë∞ÉÁî®ÊåâÈíÆ
      mcpToolsBtn.addEventListener('click', toggleMcpTools);

      // ÈÄÄÂá∫ÁôªÂΩïÊåâÈíÆ
      const logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', handleLogout);
      }

      // ËÆ∞ÂøÜÂÜÖÂÆπÈù¢ÊùøÂÖ≥Èó≠ÊåâÈíÆ
      const memoryContentClose = document.getElementById('memoryContentClose');
      if (memoryContentClose) {
        memoryContentClose.addEventListener('click', closeMemoryContentPanel);
      }
    }

    // ÂÅúÊ≠¢ÁîüÊàê
    function stopGeneration() {
      if (currentAbortController) {
        currentAbortController.abort();
        currentAbortController = null;
        
        // Á´ãÂç≥Ê∏ÖÁêÜÊâÄÊúâÁõ∏ÂÖ≥Áä∂ÊÄÅ
        sendBtn.classList.remove('hidden');
        sendBtn.disabled = false;
        stopBtn.classList.remove('show');
        chatInput.focus();
        
        // Ê∑ªÂä†‰∏ÄÊù°ÊèêÁ§∫Ê∂àÊÅØ
        const lastMessage = chatMessages.lastElementChild;
        if (lastMessage && lastMessage.classList.contains('assistant')) {
          const messageContent = lastMessage.querySelector('.message-content');
          if (messageContent) {
            messageContent.innerHTML += '\n\n<em style="color: #6b7280; font-size: 0.9em;">ÔºàÂõûÂ§çÂ∑≤Ë¢´Áî®Êà∑ÁªàÊ≠¢Ôºâ</em>';
          }
        }
        
        // Á°Æ‰øùUIÁä∂ÊÄÅÂÆåÂÖ®ÊÅ¢Â§çÔºåÂÖÅËÆ∏Á´ãÂç≥ÂàáÊç¢ÂØπËØù
      }
    }

    // ÂèëÈÄÅÂâçÊ£ÄÊü•È¢ùÂ∫¶ÔºåÂ∑≤Êª°ÂàôÊâìÂºÄËÆæÁΩÆÂπ∂ÈòªÊ≠¢ÂèëÈÄÅ
    async function checkQuotaBeforeSend() {
      if (!currentUsername) return false;
      try {
        const resp = await fetch(`${backendUrl}/api/get_quota?username=${encodeURIComponent(currentUsername)}`, { credentials: 'include' });
        const data = await resp.json();
        if (!data.success) return true; // Ëé∑ÂèñÂ§±Ë¥•‰∏çÊã¶Êà™
        const total = Number(data.quota_total || 100000);
        const used = Number(data.quota_used || 0);
        if (used >= total) {
          // È¢ùÂ∫¶Â∑≤Êª°Êó∂ÔºåÊ£ÄÊü•ÊòØÂê¶Â∑≤‰øùÂ≠ò‰∏™‰∫∫ OpenAI API KeyÔºåÂ¶ÇÊûúÂ∑≤ÈÖçÁΩÆÂàôÊîæË°å
          try {
            const cfgResp = await fetch(`${backendUrl}/chat/users/${encodeURIComponent(currentUsername)}/config.json`, { credentials: 'include' });
            if (cfgResp.ok) {
              const cfg = await cfgResp.json();
              if (cfg && cfg.openai_api_key && String(cfg.openai_api_key).trim() !== '') {
                return true; // Â∑≤ÈÖçÁΩÆ‰∏™‰∫∫KeyÔºåÂÖÅËÆ∏ÂèëÈÄÅ
              }
            }
          } catch (e) {
          }

          alert('È¢ùÂ∫¶Â∑≤Áî®Êª°ÔºåËØ∑Âú®ËÆæÁΩÆ‰∏≠ÈÖçÁΩÆ‰∏™‰∫∫ OpenAI API Key ÂêéÁªßÁª≠‰ΩøÁî®');
          openSettings();
          return false;
        }
        return true;
      } catch (e) {
        return true; // Â§±Ë¥•‰∏çÊã¶Êà™
      }
    }

    // ÂèëÈÄÅÊ∂àÊÅØ
    async function sendMessage() {
      // üîí ÁôªÂΩïÊã¶Êà™
      if (!requireLogin()) return;
      
      // üö´ Èò≤Ê≠¢Âú®AIÂõûÂ§çÊó∂ÈáçÂ§çÂèëÈÄÅÔºàÊ£ÄÊü•ÂèëÈÄÅÊåâÈíÆÁä∂ÊÄÅÔºâ
      if (sendBtn.disabled) {
        return;
      }
      
      const message = chatInput.value.trim();
      if (!message) return;

      // Ëé∑ÂèñÈÄâÊã©ÁöÑÊ®°Âûã
      selectedModel = aiModelSelector.value;

      // Ê£ÄÊü•ÊòØÂê¶ÊòØ‰ªéÂàÜ‰∫´ÈìæÊé•ËÆøÈóÆÔºå‰∏îÊòØÁ¨¨‰∏ÄÊ¨°ÂèëÈÄÅÊ∂àÊÅØ
      const isFromShare = window.shareToken && !currentChatId;
      
      // Âè™ÊúâÂú®Ê≤°ÊúâÂΩìÂâçÂØπËØùÊó∂ÊâçÂàõÂª∫Êñ∞ÂØπËØùÔºàÈÄöÂ∏∏ÂèëÁîüÂú®È¶ñÊ¨°‰ΩøÁî®ÊàñÊâãÂä®ÁÇπÂáªÊñ∞Âª∫ÂØπËØùÂêéÔºâ
      const isNewChat = !currentChatId;
      if (!currentChatId) {
        currentChatId = 'chat_' + Date.now();
      }
      
      // Â¶ÇÊûúÊòØ‰ªéÂàÜ‰∫´ÈìæÊé•ËÆøÈóÆÔºåÂú®ÂèëÈÄÅÊ∂àÊÅØÊó∂ÔºåÈúÄË¶ÅÂÖà‰øùÂ≠òÂàÜ‰∫´ÁöÑAIÊ∂àÊÅØ
      // ÈÄöËøáÊ∑ªÂä†‰∏Ä‰∏™ÁâπÊÆäÁöÑÊ†áËÆ∞ÔºåËÆ©ÂêéÁ´ØÁü•ÈÅìÈúÄË¶ÅÂÖà‰øùÂ≠òÂàÜ‰∫´Ê∂àÊÅØ
      if (isFromShare && window.shareToken) {
        // Ëé∑ÂèñÂΩìÂâçÊòæÁ§∫ÁöÑÁ¨¨‰∏ÄÊù°AIÊ∂àÊÅØÔºàÂàÜ‰∫´ÁöÑÊ∂àÊÅØÔºâ
        const firstAssistantMsg = chatMessages.querySelector('.message.assistant');
        if (firstAssistantMsg) {
          const messageContent = firstAssistantMsg.querySelector('.message-content');
          const timestamp = firstAssistantMsg.dataset.timestamp;
          const memoryTag = firstAssistantMsg.querySelector('.memory-tag');
          const memoryEnabled = memoryTag && memoryTag.classList.contains('enabled');
          
          if (messageContent && timestamp) {
            // Âú®ËØ∑Ê±Ç‰∏≠Ê∑ªÂä†ÂàÜ‰∫´Ê∂àÊÅØ‰ø°ÊÅØÔºåËÆ©ÂêéÁ´ØÂÖà‰øùÂ≠òÂàÜ‰∫´Ê∂àÊÅØ
            window.pendingSharedMessage = {
              content: messageContent.innerText,
              timestamp: timestamp,
              shared_memory_enabled: memoryEnabled
            };
          }
        }
      }

      // ÊÅ¢Â§çËæìÂÖ•Ê°ÜÂà∞Ê≠£Â∏∏‰ΩçÁΩÆÔºàÂ¶ÇÊûú‰πãÂâçÊòØÂ±Ö‰∏≠ÁöÑÔºâ
      restoreInputBox();
      
      // Ê∏ÖÈô§Á©∫Áä∂ÊÄÅÔºàÂ¶ÇÊûúÂ≠òÂú®Ôºâ
      clearEmptyState();
      
      // Ê∑ªÂä†Áî®Êà∑Ê∂àÊÅØÂà∞ÁïåÈù¢
      addMessageToUI('user', message);
      
      // Á´ãÂç≥ÊªöÂä®Âà∞Â∫ïÈÉ®ÔºåÁ°Æ‰øùËÉΩÁúãÂà∞Êñ∞ÂèëÈÄÅÁöÑÊ∂àÊÅØ
      setTimeout(() => {
        if (chatMessages) {
          chatMessages.scrollTop = chatMessages.scrollHeight;
        }
      }, 50); // Áü≠ÊöÇÂª∂ËøüÁ°Æ‰øùDOMÂ∑≤Êõ¥Êñ∞
      
      chatInput.value = '';
      chatInput.style.height = 'auto';

      // üî• Â¶ÇÊûúÊòØÊñ∞ÂØπËØùÔºåÁ´ãÂç≥Âú®Â∑¶‰æßÂàõÂª∫ÂØπËØùÈ°π
      if (isNewChat) {
        addNewChatToSidebar(currentChatId, message);
      }

      // ÈöêËóèÂèëÈÄÅÊåâÈíÆÔºåÊòæÁ§∫ÂÅúÊ≠¢ÊåâÈíÆ
      sendBtn.disabled = true;
      sendBtn.classList.add('hidden');
      stopBtn.classList.add('show');
      
      // ÂàõÂª∫ AbortController Áî®‰∫éÁªàÊ≠¢ËØ∑Ê±Ç
      currentAbortController = new AbortController();

      // üî• ÂàõÂª∫ÊµÅÂºèÊ∂àÊÅØUIÔºàÂèñ‰ª£Âä†ËΩΩÊ∂àÊÅØÔºâ
      const streamingMessageDiv = createStreamingMessageUI();
      
      let responseCompleted = false; // Ë∑üË∏™ÂìçÂ∫îÊòØÂê¶Â∑≤ÂÆåÊàêÔºåÈúÄË¶ÅÂú®finallyÂùó‰∏≠ËÆøÈóÆ

      try {
        // ÂáÜÂ§áËØ∑Ê±ÇÊï∞ÊçÆ
        const requestData = {
          username: currentUsername,
          message: message,
          model: selectedModel,
          conversation_id: currentChatId,
          shared_memory_enabled: sharedMemoryEnabled,
          personal_memory_enabled: personalMemoryEnabled,
          mcp_enabled: mcpToolsEnabled  // üõ†Ô∏è MCP Â∑•ÂÖ∑Ë∞ÉÁî®ÂºÄÂÖ≥
        };
        
        // Â¶ÇÊûúÊòØ‰ªéÂàÜ‰∫´ÈìæÊé•ËÆøÈóÆÔºåÊ∑ªÂä†ÂàÜ‰∫´Ê∂àÊÅØ‰ø°ÊÅØ
        if (window.pendingSharedMessage) {
          requestData.shared_message_content = window.pendingSharedMessage.content;
          requestData.shared_message_timestamp = window.pendingSharedMessage.timestamp;
          requestData.shared_message_memory_enabled = window.pendingSharedMessage.shared_memory_enabled;
          // Ê∏ÖÈô§ÂæÖÂ§ÑÁêÜÁöÑÂàÜ‰∫´Ê∂àÊÅØÔºà‰ΩÜ‰øùÁïôshareTokenÔºåÁî®‰∫éÂêéÁª≠Âà§Êñ≠Ôºâ
          delete window.pendingSharedMessage;
        }
        
        // üî• ‰ΩøÁî®ÊµÅÂºèAPIÔºàÂéüÊé•Âè£Â∑≤Êîπ‰∏∫ÊµÅÂºèËæìÂá∫Ôºâ
        const response = await fetch(`${backendUrl}/chat_direct`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          credentials: 'include',
          body: JSON.stringify(requestData),
          signal: currentAbortController.signal  // Ê∑ªÂä†ÁªàÊ≠¢‰ø°Âè∑
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        // üî• ËØªÂèñÊµÅÂºèÂìçÂ∫î
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let fullResponse = '';
        let buffer = '';

        while (true) {
          const { done, value } = await reader.read();
          
          if (done) {
            // üî• Â§ÑÁêÜÊúÄÂêéÂâ©‰ΩôÁöÑbufferÂÜÖÂÆπ
            if (buffer.trim()) {
              const lines = buffer.split('\n');
              for (const line of lines) {
                if (line.startsWith('data: ')) {
                  try {
                    const data = JSON.parse(line.substring(6));

                    // üõ†Ô∏è Â§ÑÁêÜÂ∑•ÂÖ∑Ë∞ÉÁî®‰∫ã‰ª∂
                    if (data.tool_status) {
                      if (data.tool_status === 'start') {
                        showToolCallIndicator(data.tool_name, 'start');
                      } else if (data.tool_status === 'end') {
                        showToolCallIndicator(data.tool_name, 'end');
                      }
                      continue;
                    }

                    // üí≠ Â§ÑÁêÜÊÄùËÄÉÁä∂ÊÄÅ
                    if (data.thinking) {
                      continue;
                    }

                    if (data.error) {
                      hideToolCallIndicator();
                      updateStreamingMessage(streamingMessageDiv, `ÈîôËØØ: ${data.error}`, true);
                      break;
                    }

                    // üî• ÂÖàÂ§ÑÁêÜcontent
                    if (data.content) {
                      fullResponse += data.content;
                      updateStreamingMessage(streamingMessageDiv, fullResponse, false);
                    }
                    
                if (data.conversation_id) {
                  currentChatId = data.conversation_id;
                  // Â¶ÇÊûúÊòØ‰ªéÂàÜ‰∫´ÈìæÊé•ËÆøÈóÆÔºå‰∏îÂØπËØùÂ∑≤ÂàõÂª∫ÔºåÊõ¥Êñ∞ÂàÜ‰∫´Ê∂àÊÅØÁä∂ÊÄÅ
                  if (window.shareToken && window.sharedMessageSaved === false) {
                    setTimeout(() => {
                      const firstAssistantMsg = chatMessages.querySelector('.message.assistant[data-is-shared-message="true"]');
                      if (firstAssistantMsg) {
                        firstAssistantMsg.dataset.isSharedMessage = 'false';
                        window.sharedMessageSaved = true;
                      }
                    }, 500);
                  }
                }
                    
                    // üî• ÊúÄÂêéÊ£ÄÊü•done
                    if (data.done) {
                      hideToolCallIndicator();  // ÈöêËóèÂ∑•ÂÖ∑Ë∞ÉÁî®ÊåáÁ§∫Âô®
                      updateStreamingMessage(streamingMessageDiv, fullResponse, true, sharedMemoryEnabled);

                      responseCompleted = true;
                      sendBtn.classList.remove('hidden');
                      sendBtn.disabled = false;
                      stopBtn.classList.remove('show');
                      currentAbortController = null;
                      chatInput.focus();
                      break;
                    }
                  } catch (e) {
                  }
                }
              }
            }
            break;
          }
          
          // Ëß£Á†ÅÊï∞ÊçÆÂùó
          buffer += decoder.decode(value, { stream: true });
          const lines = buffer.split('\n');
          
          // ‰øùÁïôÊúÄÂêé‰∏Ä‰∏™ÂèØËÉΩ‰∏çÂÆåÊï¥ÁöÑË°å
          buffer = lines.pop() || '';
          
          for (const line of lines) {
            if (line.startsWith('data: ')) {
              try {
                const data = JSON.parse(line.substring(6));

                // üõ†Ô∏è Â§ÑÁêÜÂ∑•ÂÖ∑Ë∞ÉÁî®‰∫ã‰ª∂
                if (data.tool_status) {
                  if (data.tool_status === 'start') {
                    showToolCallIndicator(data.tool_name, 'start');
                    console.log('üîß Â∑•ÂÖ∑Ë∞ÉÁî®ÂºÄÂßã:', data.tool_name, data.arguments);
                  } else if (data.tool_status === 'end') {
                    showToolCallIndicator(data.tool_name, 'end');
                    console.log('‚úÖ Â∑•ÂÖ∑Ë∞ÉÁî®ÂÆåÊàê:', data.tool_name, `ËÄóÊó∂ ${data.elapsed_time?.toFixed(2)}s`);
                  }
                  continue;  // ÁªßÁª≠Â§ÑÁêÜ‰∏ã‰∏Ä‰∏™‰∫ã‰ª∂
                }

                // üí≠ Â§ÑÁêÜÊÄùËÄÉÁä∂ÊÄÅ
                if (data.thinking) {
                  console.log('üí≠', data.thinking);
                  continue;
                }

                if (data.error) {
                  // ÊòæÁ§∫ÈîôËØØ
                  hideToolCallIndicator();
                  updateStreamingMessage(streamingMessageDiv, `ÈîôËØØ: ${data.error}`, true);
                  break;
                }
                
                // üî• ÂÖàÂ§ÑÁêÜcontentÔºåÂÜçÊ£ÄÊü•doneÔºàÁ°Æ‰øùÊâÄÊúâÂÜÖÂÆπÈÉΩË¢´Ê∑ªÂä†Ôºâ
                if (data.content) {
                  fullResponse += data.content;
                  updateStreamingMessage(streamingMessageDiv, fullResponse, false);
                }
                
                if (data.conversation_id) {
                  currentChatId = data.conversation_id;
                  // Â¶ÇÊûúÊòØ‰ªéÂàÜ‰∫´ÈìæÊé•ËÆøÈóÆÔºå‰∏îÂØπËØùÂ∑≤ÂàõÂª∫ÔºåÊõ¥Êñ∞ÂàÜ‰∫´Ê∂àÊÅØÁä∂ÊÄÅ
                  if (window.shareToken && window.sharedMessageSaved === false) {
                    setTimeout(() => {
                      const firstAssistantMsg = chatMessages.querySelector('.message.assistant[data-is-shared-message="true"]');
                      if (firstAssistantMsg) {
                        firstAssistantMsg.dataset.isSharedMessage = 'false';
                        window.sharedMessageSaved = true;
                      }
                    }, 500);
                  }
                }
                
                // ÊúÄÂêéÊ£ÄÊü•done‰ø°Âè∑
                if (data.done) {
                  // ÊúÄÁªàÊ∏≤ÊüìÔºåÂ∫îÁî®ËØ≠Ê≥ïÈ´ò‰∫ÆÔºåÊ∑ªÂä†ËÆ∞ÂøÜÊ†áËÆ∞
                  hideToolCallIndicator();  // ÈöêËóèÂ∑•ÂÖ∑Ë∞ÉÁî®ÊåáÁ§∫Âô®
                  updateStreamingMessage(streamingMessageDiv, fullResponse, true, sharedMemoryEnabled);

                  // üöÄ Á´ãÂç≥ÊòæÁ§∫ÂèëÈÄÅÊåâÈíÆÔºåÈöêËóèÂÅúÊ≠¢ÊåâÈíÆ
                  responseCompleted = true;
                  sendBtn.classList.remove('hidden');
                  sendBtn.disabled = false;
                  stopBtn.classList.remove('show');
                  currentAbortController = null;
                  chatInput.focus();
                  break; // Ë∑≥Âá∫Âæ™ÁéØÔºåÁ´ãÂç≥ÁªìÊùü
                }
              } catch (e) {
              }
            }
          }
        }
        
        // ÂÆåÊàêÂêéÊõ¥Êñ∞ÂØπËØùÂéÜÂè≤
        updateChatHistoryWithoutInterruption();
        
        // Â¶ÇÊûúÊòØ‰ªéÂàÜ‰∫´ÈìæÊé•ËÆøÈóÆÔºå‰∏îÂ∑≤‰øùÂ≠òÂàÜ‰∫´Ê∂àÊÅØÔºåÊõ¥Êñ∞Ê∂àÊÅØÁä∂ÊÄÅ
        if (window.shareToken && responseCompleted && currentChatId) {
          // Âª∂Ëøü‰∏ÄÁÇπÊó∂Èó¥ÔºåÁ°Æ‰øùÂêéÁ´ØÂ∑≤‰øùÂ≠òÂÆåÊàê
          setTimeout(() => {
            const firstAssistantMsg = chatMessages.querySelector('.message.assistant[data-is-shared-message="true"]');
            if (firstAssistantMsg) {
              // Ê∂àÊÅØÂ∑≤‰øùÂ≠òÂà∞Áî®Êà∑ÂØπËØù‰∏≠ÔºåÊ∏ÖÈô§ÂàÜ‰∫´Ê†áËÆ∞Ôºå‰∏ãÊ¨°ÁÇπÂáªÂàÜ‰∫´Êó∂‰ªéÁî®Êà∑ÂØπËØù‰∏≠Êü•Êâæ
              firstAssistantMsg.dataset.isSharedMessage = 'false';
              // ‰øùÁïôÂéüÂßãÂàÜ‰∫´ÈìæÊé•‰Ωú‰∏∫Â§áÁî®
            }
          }, 500);
        }
        
      } catch (error) {
        // Ê£ÄÊü•ÊòØÂê¶ÊòØÁî®Êà∑‰∏ªÂä®ÁªàÊ≠¢
        if (error.name === 'AbortError') {
          // ‰∏çÊòæÁ§∫ÈîôËØØÊ∂àÊÅØÔºåÂõ†‰∏∫ËøôÊòØÁî®Êà∑‰∏ªÂä®Êìç‰Ωú
          // ÁªôÂêéÁ´Ø‰∏Ä‰∫õÊó∂Èó¥Êù•ÂÆåÊàê‰øùÂ≠òÊìç‰Ωú
          await new Promise(resolve => setTimeout(resolve, 100));
        } else {
          updateStreamingMessage(streamingMessageDiv, 'Êä±Ê≠âÔºåÂèëÈÄÅÊ∂àÊÅØÊó∂Âá∫Áé∞ÈîôËØØ„ÄÇËØ∑Á®çÂêéÈáçËØï„ÄÇ', true);
        }
      } finally {
        // Á´ãÂç≥ÈáçÊñ∞ÊòæÁ§∫ÂèëÈÄÅÊåâÈíÆÔºåÈöêËóèÂÅúÊ≠¢ÊåâÈíÆÔºåÁ°Æ‰øùUIÁä∂ÊÄÅÂÆåÂÖ®ÊÅ¢Â§ç
        sendBtn.classList.remove('hidden');
        sendBtn.disabled = false;
        stopBtn.classList.remove('show');
        currentAbortController = null;
        
        // Á°Æ‰øùUIÂÆåÂÖ®ÂìçÂ∫îÔºåÂÖÅËÆ∏Á´ãÂç≥ÂàáÊç¢ÂØπËØù
        chatInput.focus();
      }
    }

    // Ê£ÄÊü•Áî®Êà∑ÊòØÂê¶Âú®ËÅäÂ§©Âå∫ÂüüÂ∫ïÈÉ®ÈôÑËøëÔºàÂÖÅËÆ∏Áî®Êà∑Âêë‰∏äÊªöÂä®Êü•ÁúãÂéÜÂè≤Ôºâ
    function isNearBottom(threshold = 100) {
      const chatMessages = document.getElementById('chatMessages');
      if (!chatMessages) return true;
      const scrollTop = chatMessages.scrollTop;
      const scrollHeight = chatMessages.scrollHeight;
      const clientHeight = chatMessages.clientHeight;
      return (scrollHeight - scrollTop - clientHeight) < threshold;
    }

    // Êô∫ËÉΩÊªöÂä®ÔºöÂè™Âú®Áî®Êà∑Êé•ËøëÂ∫ïÈÉ®Êó∂ÊâçËá™Âä®ÊªöÂä®
    function smartScrollToBottom() {
      const chatMessages = document.getElementById('chatMessages');
      if (!chatMessages) return;
      
      // Â¶ÇÊûúÁî®Êà∑Âú®Â∫ïÈÉ®ÈôÑËøëÔºåÊâçËá™Âä®ÊªöÂä®
      if (isNearBottom(150)) {
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }
    }

    // üî• ÂàõÂª∫ÊµÅÂºèÊ∂àÊÅØUI
    function createStreamingMessageUI() {
      const messageDiv = document.createElement('div');
      messageDiv.className = 'message assistant';
      
      const avatar = document.createElement('div');
      avatar.className = 'message-avatar';
      avatar.textContent = 'AI';
      
      const messageContent = document.createElement('div');
      messageContent.className = 'message-content';
      // üî• Á´ãÂç≥ÊòæÁ§∫"Ê≠£Âú®ÊÄùËÄÉ..."
      messageContent.innerHTML = '<span style="color: #999; font-style: italic;">Ê≠£Âú®ÊÄùËÄÉ<span class="thinking-dots">...</span></span>';
      messageContent.style.opacity = '0.8';
      
      messageDiv.appendChild(avatar);
      messageDiv.appendChild(messageContent);
      
      chatMessages.appendChild(messageDiv);
      smartScrollToBottom(); // ‰ΩøÁî®Êô∫ËÉΩÊªöÂä®
      
      return messageDiv;
    }

    // üî• Êõ¥Êñ∞ÊµÅÂºèÊ∂àÊÅØÂÜÖÂÆπ
    function updateStreamingMessage(messageDiv, content, isFinal = false, sharedMemoryEnabled = null) {
      const messageContent = messageDiv.querySelector('.message-content');
      
      if (isFinal) {
        // üî• ÊúÄÁªàÊ∏≤ÊüìÂâçÔºåÂÖàÊ∏ÖÈô§ÊâÄÊúâpendingÁöÑÂª∂ËøüÊ∏≤ÊüìÔºåÈÅøÂÖçÊóßÂÜÖÂÆπË¶ÜÁõñÊñ∞ÂÜÖÂÆπ
        if (pendingRenderTimer !== null) {
          clearTimeout(pendingRenderTimer);
          cancelAnimationFrame(pendingRenderTimer);
          pendingRenderTimer = null;
        }
        markdownRenderScheduled = false;
        
        // ÊúÄÁªàÊ∏≤ÊüìÔºö‰ΩøÁî®Markdown
        messageContent.style.opacity = '1';
        marked.setOptions({
          breaks: true,
          gfm: true,
          headerIds: false,
          mangle: false
        });
        
        // üî• Á°Æ‰øùÊ∏≤ÊüìÂÆåÊï¥ÁöÑÊúÄÊñ∞ÂÜÖÂÆπ
        messageContent.innerHTML = marked.parse(content);
        
        // Â∫îÁî®ËØ≠Ê≥ïÈ´ò‰∫Æ
        messageContent.querySelectorAll('pre code').forEach((block) => {
          hljs.highlightElement(block);
        });
        
        // Ê∑ªÂä†ËÆ∞ÂøÜÊ†áËÆ∞
        if (sharedMemoryEnabled !== null) {
          // ÂÖàÁßªÈô§ÊóßÁöÑÊ†áËÆ∞ÔºàÂ¶ÇÊûúÂ≠òÂú®Ôºâ
          const existingTags = messageDiv.querySelector('.message-memory-tags');
          if (existingTags) {
            existingTags.remove();
          }
          
          // ËÆ°ÁÆóÂΩìÂâçÊ∂àÊÅØÂú®ÂØπËØù‰∏≠ÁöÑÁ¥¢Âºï
          const messageIndex = Array.from(chatMessages.children).indexOf(messageDiv);
          const memoryTags = createMemoryTag(sharedMemoryEnabled, messageIndex, []);
          messageDiv.appendChild(memoryTags);
        }

        // Ê∑ªÂä†Â§çÂà∂ÊåâÈíÆÂíåÂàÜ‰∫´ÊåâÈíÆ
        appendCopyAction(messageDiv);
        
        // ÊµÅÂºèÁîüÊàêÂÆåÊàêÂêéÔºåÂ∞ùËØï‰ªéÂØπËØù‰∏≠Ëé∑Âèñ‰ΩøÁî®ÁöÑÂÖ±‰∫´ËÆ∞ÂøÜID
        if (currentChatId && !messageDiv.dataset.usedSharedMemories) {
          loadUsedSharedMemoriesFromConversation(messageDiv);
        }
        
        // ‰øùÂ≠òÊó∂Èó¥Êà≥Ôºà‰ªéÂΩìÂâçÊó∂Èó¥ÁîüÊàêÔºâ
        const now = new Date();
        const timestamp = now.getFullYear() + '-' + 
          String(now.getMonth() + 1).padStart(2, '0') + '-' + 
          String(now.getDate()).padStart(2, '0') + ' ' + 
          String(now.getHours()).padStart(2, '0') + ':' + 
          String(now.getMinutes()).padStart(2, '0') + ':' + 
          String(now.getSeconds()).padStart(2, '0');
        messageDiv.dataset.timestamp = timestamp;
      } else {
        // ÊµÅÂºèËæìÂá∫Êó∂ÔºöËøõË°åËΩªÈáèÁ∫ßÁöÑMarkdownÂ¢ûÈáèÊ∏≤ÊüìÔºà‰∏çÂÅöËØ≠Ê≥ïÈ´ò‰∫ÆÔºåÈÅøÂÖçÂç°È°øÔºâ
        // ‰ΩøÁî®ËäÇÊµÅÔºå‰øùËØÅÊ†áÈ¢òÁ≠âMarkdownËØ≠Ê≥ïËÉΩËæπËæìÂá∫ËæπÊ∏≤Êüì
        messageContent.style.opacity = '1';

        const now = performance.now();
        // üî• ‰ΩøÁî®ÁÆ≠Â§¥ÂáΩÊï∞ÊçïËé∑ÂΩìÂâçcontentÔºåÈÅøÂÖçÈó≠ÂåÖÈóÆÈ¢ò
        const currentContent = content;
        const doRender = () => {
          marked.setOptions({
            breaks: true,
            gfm: true,
            headerIds: false,
            mangle: false
          });
          // üî• ‰ΩøÁî®ÊçïËé∑ÁöÑcurrentContentËÄå‰∏çÊòØÂ§ñÂ±ÇÁöÑcontent
          messageContent.innerHTML = marked.parse(currentContent);
          markdownRenderScheduled = false;
          pendingRenderTimer = null;
          lastMarkdownRenderAt = performance.now();
        };

        if (!markdownRenderScheduled && (now - lastMarkdownRenderAt) >= MARKDOWN_RENDER_INTERVAL_MS) {
          // Á´ãÂç≥Ê∏≤Êüì‰∏ÄÊ¨°
          doRender();
        } else if (!markdownRenderScheduled) {
          // Âª∂ËøüÂà∞‰∏ã‰∏ÄÂ∏ßÊàñËäÇÊµÅÈó¥ÈöîÂà∞ËææÂÜçÊ∏≤Êüì
          markdownRenderScheduled = true;
          const delay = Math.max(0, MARKDOWN_RENDER_INTERVAL_MS - (now - lastMarkdownRenderAt));
          if (typeof requestAnimationFrame === 'function' && delay < 16) {
            pendingRenderTimer = requestAnimationFrame(doRender);
          } else {
            pendingRenderTimer = setTimeout(doRender, delay);
          }
        }
      }
      
      // Êô∫ËÉΩÊªöÂä®ÔºöÂè™Âú®Áî®Êà∑Êé•ËøëÂ∫ïÈÉ®Êó∂ÊâçËá™Âä®ÊªöÂä®
      smartScrollToBottom();
    }

    // Ê∑ªÂä†Âä†ËΩΩÊ∂àÊÅØ
    function addLoadingMessage() {
      const messageDiv = document.createElement('div');
      messageDiv.className = 'message assistant loading-message';
      messageDiv.id = `loading-${Date.now()}`; // ‰ΩøÁî®Êó∂Èó¥Êà≥‰Ωú‰∏∫ÂîØ‰∏ÄID
      
      const avatar = document.createElement('div');
      avatar.className = 'message-avatar loading-avatar';
      avatar.innerHTML = '<span class="loading-dots"></span>';
      
      const messageContent = document.createElement('div');
      messageContent.className = 'message-content';
      messageContent.textContent = 'Ê≠£Âú®ÊÄùËÄÉ...';
      
      messageDiv.appendChild(avatar);
      messageDiv.appendChild(messageContent);
      
      chatMessages.appendChild(messageDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      
      // Áî±‰∫éÊâÄÊúâÊñáÊú¨ÈÉΩÊòØÁõ∏ÂêåÁöÑÔºå‰∏çÈúÄË¶ÅÂä®ÊÄÅÂàáÊç¢
      // ‰øùÊåÅÈùôÊÄÅÁöÑ"Ê≠£Âú®ÊÄùËÄÉ..."ÊñáÊú¨
      
      return messageDiv.id;
    }

    // ÁßªÈô§Âä†ËΩΩÊ∂àÊÅØ
    function removeLoadingMessage(loadingMessageId) {
      const loadingMessage = document.getElementById(loadingMessageId);
      if (loadingMessage) {
        loadingMessage.remove();
      }
    }

    // Ê∑ªÂä†Ê∂àÊÅØÂà∞UI
    function addMessageToUI(type, content, sharedMemoryEnabled = null, usedSharedMemories = [], timestamp = null) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${type}`;
      
      // ‰øùÂ≠òÊó∂Èó¥Êà≥Âà∞dataÂ±ûÊÄß
      if (timestamp) {
        messageDiv.dataset.timestamp = timestamp;
      }
      
      const avatar = document.createElement('div');
      avatar.className = 'message-avatar';
      avatar.textContent = type === 'user' ? 'U' : 'AI';
      
      const messageContent = document.createElement('div');
      messageContent.className = 'message-content';
      
      // AIÊ∂àÊÅØ‰ΩøÁî®MarkdownÊ∏≤ÊüìÔºåÁî®Êà∑Ê∂àÊÅØ‰øùÊåÅÁ∫ØÊñáÊú¨
      if (type === 'assistant') {
        // ÈÖçÁΩÆmarkedÈÄâÈ°π
        marked.setOptions({
          breaks: true,  // ÊîØÊåÅGFMÊç¢Ë°å
          gfm: true,     // ÂêØÁî®GitHubÈ£éÊ†ºÁöÑMarkdown
          headerIds: false,
          mangle: false
        });
        
        // Ê∏≤ÊüìMarkdown
        messageContent.innerHTML = marked.parse(content);
        
        // ÂØπ‰ª£Á†ÅÂùóÂ∫îÁî®ËØ≠Ê≥ïÈ´ò‰∫Æ
        messageContent.querySelectorAll('pre code').forEach((block) => {
          hljs.highlightElement(block);
        });
      } else {
        // Áî®Êà∑Ê∂àÊÅØ‰øùÊåÅÁ∫ØÊñáÊú¨
        messageContent.textContent = content;
      }
      
      messageDiv.appendChild(avatar);
      messageDiv.appendChild(messageContent);
      
      // Â¶ÇÊûúÊòØAIÊ∂àÊÅØ‰∏îÊúâËÆ∞ÂøÜ‰ø°ÊÅØÔºåÊ∑ªÂä†ËÆ∞ÂøÜÊ†áËÆ∞
      if (type === 'assistant' && sharedMemoryEnabled !== null) {
        // Â∞Ü‰ΩøÁî®ÁöÑÂÖ±‰∫´ËÆ∞ÂøÜ‰øùÂ≠òÂà∞Ê∂àÊÅØdivÁöÑdataÂ±ûÊÄß‰∏≠ÔºåÊñπ‰æøÁÇπÂáªÊó∂ËØªÂèñ
        if (usedSharedMemories && usedSharedMemories.length > 0) {
          messageDiv.dataset.usedSharedMemories = JSON.stringify(usedSharedMemories);
        }
        // ËÆ°ÁÆóÂΩìÂâçÊ∂àÊÅØÂú®ÂØπËØù‰∏≠ÁöÑÁ¥¢Âºï
        const messageIndex = chatMessages.children.length;
        const memoryTags = createMemoryTag(sharedMemoryEnabled, messageIndex, usedSharedMemories);
        messageDiv.appendChild(memoryTags);
      }

      // ‰∏∫AIÊ∂àÊÅØÊ∑ªÂä†Â§çÂà∂ÊåâÈíÆ
      if (type === 'assistant') {
        appendCopyAction(messageDiv);
      }
      
      chatMessages.appendChild(messageDiv);
      smartScrollToBottom(); // ‰ΩøÁî®Êô∫ËÉΩÊªöÂä®
      
      return messageDiv;
    }

    // Âú®Ê∂àÊÅØ‰∏ãÊñπËøΩÂä†Â§çÂà∂ÊåâÈíÆÂíåÂàÜ‰∫´ÊåâÈíÆ
    function appendCopyAction(messageDiv) {
      // ‰ºòÂÖàÊîæÂÖ•ËÆ∞ÂøÜÊ†áÁ≠æÂÆπÂô®Ôºå‰ΩøÂÖ∂‰∏é"ËÆ∞ÂøÜÂ∑≤ÂºÄÂêØ"Âêå‰∏ÄË°å
      let container = messageDiv.querySelector('.message-memory-tags');
      
      // Â§çÂà∂ÊåâÈíÆ
      const copyBtn = document.createElement('button');
      copyBtn.type = 'button';
      copyBtn.className = 'copy-btn';
      copyBtn.innerHTML = `
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="9" y="9" width="13" height="13" rx="2"/>
          <rect x="2" y="2" width="13" height="13" rx="2"/>
        </svg>
        Â§çÂà∂
      `;
      copyBtn.addEventListener('click', async () => {
        const contentEl = messageDiv.querySelector('.message-content');
        const text = contentEl ? contentEl.innerText : '';
        try {
          await navigator.clipboard.writeText(text);
          const old = copyBtn.innerHTML;
          copyBtn.innerHTML = `
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M20 6L9 17l-5-5"/>
            </svg>
            Â∑≤Â§çÂà∂
          `;
          setTimeout(() => { copyBtn.innerHTML = old; }, 1600);
        } catch (e) {
        }
      });
      
      if (!container) {
        container = document.createElement('div');
        container.className = 'message-memory-tags';
        messageDiv.appendChild(container);
      }
      container.appendChild(copyBtn);
      
      // ÂßãÁªàÊòæÁ§∫ÂàÜ‰∫´ÊåâÈíÆÔºàÂåÖÊã¨ÂàÜ‰∫´ÈìæÊé•È°µÈù¢Ôºâ
      const shareBtn = document.createElement('button');
      shareBtn.type = 'button';
      shareBtn.className = 'share-btn';
      shareBtn.innerHTML = `
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="18" cy="5" r="3"/>
          <circle cx="6" cy="12" r="3"/>
          <circle cx="18" cy="19" r="3"/>
          <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/>
          <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
        </svg>
        ÂàÜ‰∫´
      `;
      shareBtn.addEventListener('click', () => {
        openShareModal(messageDiv);
      });
      container.appendChild(shareBtn);
      
      // Ê£ÄÊü•Êú¨Ê¨°ÂõûÂ§çÊòØÂê¶‰ΩøÁî®‰∫ÜÂΩìÂâçÁî®Êà∑ÁöÑËÆ∞ÂøÜ
      if (messageDiv.dataset.usedSharedMemories) {
        checkAndShowUserMemoryHint(messageDiv, container);
      }
    }
    
    // Ê£ÄÊü•Âπ∂ÊòæÁ§∫Áî®Êà∑ËÆ∞ÂøÜÊèêÁ§∫
    async function checkAndShowUserMemoryHint(messageDiv, container) {
      try {
        const usedSharedMemories = JSON.parse(messageDiv.dataset.usedSharedMemories);
        if (!usedSharedMemories || usedSharedMemories.length === 0 || !currentUsername) {
          return;
        }
        
        // Ê£ÄÊü•ÊòØÂê¶ÊúâÂΩìÂâçÁî®Êà∑ÁöÑËÆ∞ÂøÜ
        const hasUserMemory = await checkIfUserMemoryUsed(usedSharedMemories);
        if (hasUserMemory) {
          // Âú®ÂàÜ‰∫´ÊåâÈíÆÊóÅËæπÊ∑ªÂä†ÊèêÁ§∫
          const memoryHint = document.createElement('span');
          memoryHint.className = 'memory-hint';
          memoryHint.style.cssText = 'font-size: 12px; color: #667eea; margin-left: 8px; display: inline-flex; align-items: center; gap: 4px;';
          memoryHint.innerHTML = ``
            // <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;">
            //   <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
            //   <circle cx="9" cy="7" r="4"/>
            //   <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
            //   <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
            // </svg>
            // Êú¨Ê¨°ÂõûÂ§çÁªìÂêà‰∫ÜÊÇ®ÁöÑËÆ∞ÂøÜ
          ;
          container.appendChild(memoryHint);
        }
      } catch (e) {
        console.error('Ê£ÄÊü•Áî®Êà∑ËÆ∞ÂøÜÂ§±Ë¥•:', e);
      }
    }
    
    // Ê£ÄÊü•‰ΩøÁî®ÁöÑÂÖ±‰∫´ËÆ∞ÂøÜÊòØÂê¶ÂåÖÂê´ÂΩìÂâçÁî®Êà∑ÁöÑËÆ∞ÂøÜ
    async function checkIfUserMemoryUsed(memoryIds) {
      if (!memoryIds || memoryIds.length === 0 || !currentUsername) {
        return false;
      }
      
      try {
        const response = await fetch(`${backendUrl}/api/get_used_shared_memories`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          credentials: 'include',
          body: JSON.stringify({
            username: currentUsername,
            conversation_id: currentChatId,
            used_shared_memories: memoryIds
          })
        });
        
        if (response.ok) {
          const data = await response.json();
          if (data.success && data.memories) {
            // Ê£ÄÊü•ÊòØÂê¶Êúâ‰ªª‰ΩïËÆ∞ÂøÜÁöÑmerged_usersÂåÖÂê´ÂΩìÂâçÁî®Êà∑
            for (const memory of data.memories) {
              const mergedUsers = memory.merged_users || [];
              if (mergedUsers.includes(currentUsername)) {
                return true;
              }
            }
          }
        }
      } catch (error) {
        console.error('Ê£ÄÊü•Áî®Êà∑ËÆ∞ÂøÜÂ§±Ë¥•:', error);
      }
      
      return false;
    }
    
    // ‰ªéÂØπËØù‰∏≠Âä†ËΩΩ‰ΩøÁî®ÁöÑÂÖ±‰∫´ËÆ∞ÂøÜIDÔºàÁî®‰∫éÊµÅÂºèÁîüÊàêÂÆåÊàêÂêéÁöÑÊ£ÄÊü•Ôºâ
    async function loadUsedSharedMemoriesFromConversation(messageDiv) {
      if (!currentChatId || !currentUsername) return;
      
      try {
        const response = await fetch(`${backendUrl}/get_chat_messages`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          credentials: 'include',
          body: JSON.stringify({
            username: currentUsername,
            conversation_id: currentChatId
          })
        });
        
        if (response.ok) {
          const data = await response.json();
          if (data.success && data.conversation && data.conversation.messages) {
            // ÊâæÂà∞ÊúÄÂêé‰∏ÄÊù°AIÊ∂àÊÅØÔºàÂ∫îËØ•ÊòØÂàöÂÆåÊàêÁöÑËøôÊù°Ôºâ
            const messages = data.conversation.messages;
            const lastAssistantMsg = messages.filter(m => m.type === 'assistant').pop();
            if (lastAssistantMsg && lastAssistantMsg.used_shared_memories) {
              const usedSharedMemories = lastAssistantMsg.used_shared_memories;
              if (usedSharedMemories.length > 0) {
                // ËÆæÁΩÆÂà∞messageDivÁöÑdataset‰∏≠
                messageDiv.dataset.usedSharedMemories = JSON.stringify(usedSharedMemories);
                
                // Ê£ÄÊü•Âπ∂ÊòæÁ§∫ÊèêÁ§∫
                const container = messageDiv.querySelector('.message-memory-tags');
                if (container) {
                  checkAndShowUserMemoryHint(messageDiv, container);
                }
              }
            }
          }
        }
      } catch (error) {
        console.error('Âä†ËΩΩ‰ΩøÁî®ÁöÑÂÖ±‰∫´ËÆ∞ÂøÜIDÂ§±Ë¥•:', error);
      }
    }
    
    // ÂàõÂª∫ËÆ∞ÂøÜÊ†áËÆ∞
    function createMemoryTag(sharedMemoryEnabled, messageIndex = null, usedSharedMemories = []) {
      const tagsContainer = document.createElement('div');
      tagsContainer.className = 'message-memory-tags';
      
      const memoryTag = document.createElement('span');
      memoryTag.className = `memory-tag ${sharedMemoryEnabled ? 'enabled' : 'disabled'}`;
      
      if (sharedMemoryEnabled) {
        memoryTag.innerHTML = `
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
            <circle cx="9" cy="7" r="4"/>
            <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
            <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
          </svg>
          ËÆ∞ÂøÜÂ∑≤ÂºÄÂêØ
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-left:4px;">
            <path d="M9 18l6-6-6-6"/>
          </svg>
        `;
        
        // ‰∏∫Â∑≤ÂºÄÂêØËÆ∞ÂøÜÁöÑÊ†áÁ≠æÊ∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂Ôºå‰º†ÈÄíÊ∂àÊÅØÁ¥¢ÂºïÂíå‰ΩøÁî®ÁöÑËÆ∞ÂøÜID
        memoryTag.style.cursor = 'pointer';
        memoryTag.addEventListener('click', function(e) {
          e.stopPropagation();
          // ‰ºòÂÖà‰ªéÊ∂àÊÅØdivÁöÑdataÂ±ûÊÄß‰∏≠ËØªÂèñusedSharedMemoriesÔºåÂ¶ÇÊûú‰∏çÂ≠òÂú®Âàô‰ΩøÁî®‰º†ÈÄíÁöÑÂèÇÊï∞
          let finalUsedSharedMemories = usedSharedMemories;
          const messageDiv = this.closest('.message');
          if (messageDiv && messageDiv.dataset.usedSharedMemories) {
            try {
              finalUsedSharedMemories = JSON.parse(messageDiv.dataset.usedSharedMemories);
            } catch (err) {
              // Ëß£ÊûêÂ§±Ë¥•Ôºå‰ΩøÁî®‰º†ÈÄíÁöÑÂèÇÊï∞
            }
          }
          toggleMemoryContentPanel(messageIndex, finalUsedSharedMemories);
        });
      } else {
        memoryTag.innerHTML = `
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <line x1="15" y1="9" x2="9" y2="15"/>
            <line x1="9" y1="9" x2="15" y2="15"/>
          </svg>
          ÂºÄÂêØËÆ∞ÂøÜ
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-left:4px;">
            <path d="M9 18l6-6-6-6"/>
          </svg>
        `;
      }
      
      tagsContainer.appendChild(memoryTag);
      return tagsContainer;
    }

    // ÂàõÂª∫Êñ∞ÂØπËØù
    function createNewChat() {
      // üîí ÁôªÂΩïÊã¶Êà™
      if (!requireLogin()) return;
      
      // Ê∏ÖÈô§ÂΩìÂâçËÅäÂ§©Ê∂àÊÅØ
      chatMessages.innerHTML = '';
      
      // ÈáçÁΩÆÂΩìÂâçÂØπËØùID‰∏∫nullÔºåËøôÊ†∑‰∏ãÊ¨°ÂèëÈÄÅÊ∂àÊÅØÊó∂‰ºöËá™Âä®ÂàõÂª∫Êñ∞ÂØπËØù
      currentChatId = null;
      
      // Ê∏ÖÁ©∫ËæìÂÖ•Ê°Ü
      chatInput.value = '';
      
      // Â±Ö‰∏≠ËæìÂÖ•Ê°ÜÔºàÊñ∞Âª∫ÂØπËØùÊó∂ÊòæÁ§∫Â±Ö‰∏≠Áä∂ÊÄÅÔºâ
      centerInputBox();
      
      // ÊòæÁ§∫Á©∫Áä∂ÊÄÅ
      showEmptyState();
      
      // Êõ¥Êñ∞ËÅäÂ§©ÂéÜÂè≤
      updateChatHistoryWithoutInterruption();
      
    }

    // ÊòæÁ§∫Á©∫Áä∂ÊÄÅ
    function showEmptyState() {
      chatMessages.innerHTML = `
        <div class="empty-state">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
          </svg>
          <h3>ÂºÄÂßãÊñ∞ÁöÑÂØπËØù</h3>
          <p>Âú®‰∏ãÊñπËæìÂÖ•Ê°Ü‰∏≠ËæìÂÖ•ÊÇ®ÁöÑÈóÆÈ¢òÔºåÂºÄÂßã‰∏éExperience ChatÂØπËØù</p>
        </div>
      `;
    }

    // Â±Ö‰∏≠ËæìÂÖ•Ê°Ü
    function centerInputBox() {
      const inputContainer = document.querySelector('.chat-input-container');
      inputContainer.classList.add('centered');
      setTimeout(() => {
        chatInput.focus();
      }, 100);
    }

    // ÊÅ¢Â§çËæìÂÖ•Ê°ÜÂà∞Ê≠£Â∏∏‰ΩçÁΩÆ
    function restoreInputBox() {
      const inputContainer = document.querySelector('.chat-input-container');
      inputContainer.classList.remove('centered');
    }

    // Ê∏ÖÈô§Á©∫Áä∂ÊÄÅ
    function clearEmptyState() {
      const emptyState = document.querySelector('.empty-state');
      if (emptyState) {
        emptyState.remove();
      }
    }

    // ÊòæÁ§∫Êñ∞Âª∫ÂØπËØùÁïåÈù¢
    function showNewChatInterface() {
      // Ê∏ÖÁ©∫ÂΩìÂâçËÅäÂ§©ID
      currentChatId = null;
      
      // ÊòæÁ§∫Á©∫Áä∂ÊÄÅ
      showEmptyState();
      
      // Â±Ö‰∏≠ËæìÂÖ•Ê°Ü
      centerInputBox();
      
      // Ê∏ÖÈô§ÊâÄÊúâÊ¥ªË∑ÉÁä∂ÊÄÅ
      document.querySelectorAll('.chat-history-item').forEach(item => {
        item.classList.remove('active');
      });
    }

    // Âä†ËΩΩËÅäÂ§©ÂéÜÂè≤
    async function loadChatHistory() {
      // üîí ÁôªÂΩïÊã¶Êà™
      if (!requireLogin()) return;
      
      try {
        const response = await fetch(`${backendUrl}/get_chat_conversations`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            username: currentUsername
          })
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        
        if (data.success) {
          chatHistory = data.conversations;
          chatHistoryContainer.innerHTML = '';
          
          data.conversations.forEach(chat => {
            const chatItem = document.createElement('div');
            chatItem.className = 'chat-history-item';
            if (chat.id === currentChatId) {
              chatItem.classList.add('active');
            }
            const starHtml = chat.contributed_shared_memory
              ? `
              <span class="chat-history-flag" title="Êú¨Ê¨°ÂØπËØùÂèÇ‰∏éÊûÑÂª∫ÂÖ±‰∫´ËÆ∞ÂøÜ">
                <svg viewBox="0 0 24 24" stroke="none">
                  <path d="M12 2l2.91 5.88 6.49.94-4.7 4.58 1.11 6.46L12 17.77l-5.81 3.06 1.11-6.46-4.7-4.58 6.49-.94L12 2z"/>
                </svg>
              </span>
            `
              : '';
            
            chatItem.innerHTML = `
              <div class="chat-history-item-title">${chat.title || 'Êñ∞ÂØπËØù'}</div>
              <div class="chat-history-item-time">${formatTime(chat.updated_at)}</div>
              ${starHtml}
              <div class="chat-history-item-actions">
                <button class="delete-btn" onclick="deleteChat('${chat.id}')">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3,6 5,6 21,6"/>
                    <path d="M19,6v14a2,2 0 0,1 -2,2H7a2,2 0 0,1 -2,-2V6m3,0V4a2,2 0 0,1 2,-2h4a2,2 0 0,1 2,2v2"/>
                  </svg>
                </button>
              </div>
            `;
            
            chatItem.addEventListener('click', function() {
              loadChat(chat.id, this);
            });
            chatHistoryContainer.appendChild(chatItem);
          });
          
          // Â¶ÇÊûúÊ≤°ÊúâÂΩìÂâçÂØπËØùÔºåÊòæÁ§∫Â±Ö‰∏≠ËæìÂÖ•Ê°ÜÔºàÊó†ËÆ∫ÊòØÊ≤°ÊúâÂéÜÂè≤ÂØπËØùËøòÊòØÂàöËøõÂÖ•È°µÈù¢Ôºâ
          if (!currentChatId) {
            showNewChatInterface();
          }
        } else {
          // Âç≥‰ΩøÂä†ËΩΩÂ§±Ë¥•ÔºåÂ¶ÇÊûúÊ≤°Êúâ‰ªª‰ΩïÂØπËØùÔºå‰πüÂ∫îËØ•ÊòæÁ§∫Â±Ö‰∏≠ËæìÂÖ•Ê°Ü
          if (!currentChatId) {
            showNewChatInterface();
          }
        }
      } catch (error) {
        // Âç≥‰ΩøÂá∫ÈîôÔºåÂ¶ÇÊûúÊ≤°Êúâ‰ªª‰ΩïÂØπËØùÔºå‰πüÂ∫îËØ•ÊòæÁ§∫Â±Ö‰∏≠ËæìÂÖ•Ê°Ü
        if (!currentChatId) {
          showNewChatInterface();
        }
      }
    }

    // Á´ãÂç≥Âú®Â∑¶‰æßÊ∑ªÂä†Êñ∞ÂØπËØùÈ°πÔºàÁî®‰∫éÊñ∞Âª∫ÂØπËØùÊó∂ÁöÑÂç≥Êó∂ÂèçÈ¶àÔºâ
    function addNewChatToSidebar(chatId, firstMessage) {
      // ÁîüÊàêÂØπËØùÊ†áÈ¢òÔºàÂèñÂâç30‰∏™Â≠óÁ¨¶Ôºâ
      const title = firstMessage.length > 30 ? firstMessage.substring(0, 30) + '...' : firstMessage;
      const now = new Date().toISOString();
      
      // Ê∏ÖÈô§ÊâÄÊúâÊ¥ªË∑ÉÁä∂ÊÄÅ
      document.querySelectorAll('.chat-history-item').forEach(item => {
        item.classList.remove('active');
      });
      
      // ÂàõÂª∫Êñ∞ÁöÑÂØπËØùÈ°πÂÖÉÁ¥†
      const chatItem = document.createElement('div');
      chatItem.className = 'chat-history-item active';
      chatItem.dataset.chatId = chatId;
      
      chatItem.innerHTML = `
        <div class="chat-history-item-title">${title}</div>
        <div class="chat-history-item-time">ÂàöÂàö</div>
        <div class="chat-history-item-actions">
          <button class="delete-btn" onclick="deleteChat('${chatId}')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="3,6 5,6 21,6"/>
              <path d="M19,6v14a2,2 0 0,1 -2,2H7a2,2 0 0,1 -2,-2V6m3,0V4a2,2 0 0,1 2,-2h4a2,2 0 0,1 2,2v2"/>
            </svg>
          </button>
        </div>
      `;
      
      chatItem.addEventListener('click', function() {
        loadChat(chatId, this);
      });
      
      // Ê∑ªÂä†Âà∞ÂàóË°®È°∂ÈÉ®
      chatHistoryContainer.insertBefore(chatItem, chatHistoryContainer.firstChild);
      
    }

    // Êõ¥Êñ∞ËÅäÂ§©ÂéÜÂè≤ËÄå‰∏ç‰∏≠Êñ≠ÂΩìÂâçÂØπËØù
    async function updateChatHistoryWithoutInterruption() {
      if (!currentUsername) return;
      
      try {
        const response = await fetch(`${backendUrl}/get_chat_conversations`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            username: currentUsername
          })
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        
        if (data.success) {
          chatHistory = data.conversations;
          
          // ‰øùÂ≠òÂΩìÂâçÊ¥ªË∑ÉÁöÑÂØπËØùID
          const activeChatId = currentChatId;
          
          chatHistoryContainer.innerHTML = '';
          
          data.conversations.forEach(chat => {
            const chatItem = document.createElement('div');
            chatItem.className = 'chat-history-item';
            if (chat.id === activeChatId) {
              chatItem.classList.add('active');
            }
            const starHtml = chat.contributed_shared_memory
              ? `
              <span class="chat-history-flag" title="Êú¨Ê¨°ÂØπËØùÂèÇ‰∏éÊûÑÂª∫ÂÖ±‰∫´ËÆ∞ÂøÜ">
                <svg viewBox="0 0 24 24" stroke="none">
                  <path d="M12 2l2.91 5.88 6.49.94-4.7 4.58 1.11 6.46L12 17.77l-5.81 3.06 1.11-6.46-4.7-4.58 6.49-.94L12 2z"/>
                </svg>
              </span>
            `
              : '';
            
            chatItem.innerHTML = `
              <div class="chat-history-item-title">${chat.title || 'Êñ∞ÂØπËØù'}</div>
              <div class="chat-history-item-time">${formatTime(chat.updated_at)}</div>
              ${starHtml}
              <div class="chat-history-item-actions">
                <button class="delete-btn" onclick="deleteChat('${chat.id}')">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3,6 5,6 21,6"/>
                    <path d="M19,6v14a2,2 0 0,1 -2,2H7a2,2 0 0,1 -2,-2V6m3,0V4a2,2 0 0,1 2,-2h4a2,2 0 0,1 2,2v2"/>
                  </svg>
                </button>
              </div>
            `;
            
            chatItem.addEventListener('click', function() {
              loadChat(chat.id, this);
            });
            chatHistoryContainer.appendChild(chatItem);
          });
          
          // Á°Æ‰øùÂΩìÂâçÂØπËØù‰øùÊåÅÊ¥ªË∑ÉÁä∂ÊÄÅ
          currentChatId = activeChatId;
        } else {
        }
      } catch (error) {
      }
    }

    // Âä†ËΩΩÊåáÂÆöËÅäÂ§©
    async function loadChat(chatId, clickedElement, retryCount = 0) {
      // üîí ÁôªÂΩïÊã¶Êà™
      if (!requireLogin()) return;
      
      // üö´ Â¶ÇÊûúAIÊ≠£Âú®ÂõûÂ§çÔºåÂÖàÁªàÊ≠¢ÂÆÉÔºåÁ°Æ‰øùÂèØ‰ª•Á´ãÂç≥ÂàáÊç¢ÂØπËØù
      if (currentAbortController || sendBtn.disabled) {
        if (currentAbortController) {
          currentAbortController.abort();
          currentAbortController = null;
        }
        sendBtn.classList.remove('hidden');
        sendBtn.disabled = false;
        stopBtn.classList.remove('show');
      }
      
      try {
        const response = await fetch(`${backendUrl}/get_chat_messages`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            username: currentUsername,
            conversation_id: chatId
          })
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        
        if (data.success) {
          currentChatId = chatId;
          chatMessages.innerHTML = '';
          
          // ÊÅ¢Â§çËæìÂÖ•Ê°ÜÂà∞Ê≠£Â∏∏‰ΩçÁΩÆ
          restoreInputBox();
          
          // Ê∏ÖÈô§Á©∫Áä∂ÊÄÅ
          clearEmptyState();
          
          // Âä†ËΩΩËÅäÂ§©Ê∂àÊÅØ
          data.conversation.messages.forEach(msg => {
            // ‰ªéÊ∂àÊÅØ‰∏≠ËØªÂèñshared_memory_enabled‰ø°ÊÅØ
            const sharedMemoryEnabled = msg.shared_memory_enabled !== undefined ? msg.shared_memory_enabled : null;
            const usedSharedMemories = msg.used_shared_memories || [];
            addMessageToUI(msg.type, msg.content, sharedMemoryEnabled, usedSharedMemories, msg.timestamp);
          });
          
          // Âä†ËΩΩÂÆåÊ∂àÊÅØÂêéÔºåÊªöÂä®Âà∞Â∫ïÈÉ®
          setTimeout(() => {
            if (chatMessages) {
              chatMessages.scrollTop = chatMessages.scrollHeight;
            }
          }, 100); // Âª∂Ëøü‰∏ÄÁÇπÁ°Æ‰øùDOMÂ∑≤Êõ¥Êñ∞
          
          // Êõ¥Êñ∞Ê¥ªË∑ÉÁä∂ÊÄÅ
          document.querySelectorAll('.chat-history-item').forEach(item => {
            item.classList.remove('active');
          });
          if (clickedElement) {
            clickedElement.classList.add('active');
          }
        } else {
          // Â¶ÇÊûúÊòØ"ÂØπËØù‰∏çÂ≠òÂú®"ÈîôËØØ‰∏îÈáçËØïÊ¨°Êï∞Â∞ë‰∫é3Ê¨°ÔºåÂàôÈáçËØï
          if (data.error && data.error.includes('ÂØπËØù‰∏çÂ≠òÂú®') && retryCount < 3) {
            // Á≠âÂæÖ500msÂêéÈáçËØï
            setTimeout(() => {
              loadChat(chatId, clickedElement, retryCount + 1);
            }, 500);
            return;
          } else {
            // Â¶ÇÊûúÈáçËØïÊ¨°Êï∞Â∑≤Ëææ‰∏äÈôêÔºåÊòæÁ§∫ÈîôËØØ‰ø°ÊÅØ
            if (retryCount >= 3) {
            }
          }
        }
      } catch (error) {
      }
    }


    // Âà†Èô§ËÅäÂ§©
    async function deleteChat(chatId) {
      if (confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™ÂØπËØùÂêóÔºü')) {
        try {
          // ËøôÈáåÂèØ‰ª•Ê∑ªÂä†ÊúçÂä°Âô®Á´ØÂà†Èô§API
          // ÊöÇÊó∂Âè™Âú®ÂâçÁ´ØÂà†Èô§
          chatHistory = chatHistory.filter(c => c.id !== chatId);
          
          if (currentChatId === chatId) {
            createNewChat();
          }
          
          loadChatHistory();
        } catch (error) {
        }
      }
    }

    // ÊâìÂºÄËÆæÁΩÆ
    function openSettings() {
      // üîí ÁôªÂΩïÊã¶Êà™
      if (!requireLogin()) return;
      
      // ÊòæÁ§∫ÂΩìÂâçÁî®Êà∑Âêç
      const currentUserDisplay = document.getElementById('currentUserDisplay');
      if (currentUserDisplay && currentUsername) {
        currentUserDisplay.textContent = currentUsername;
      }
      
      // Âä†ËΩΩÈ¢ùÂ∫¶Âπ∂Ê†πÊçÆÈ¢ùÂ∫¶ÊòæÁ§∫/ÈöêËóèOpenAIÈÖçÁΩÆÔºåÂêåÊó∂Â°´ÂÖÖÁî®Êà∑ÈÖçÁΩÆ
      Promise.all([
        loadAndRenderQuota(),
        loadUserConfig()
      ]).finally(() => {
        settingsModal.classList.add('show');
      });
    }

    // ÂÖ≥Èó≠ËÆæÁΩÆ
    function closeSettings() {
      settingsModal.classList.remove('show');
    }

    // ÊâìÂºÄËÆ∞ÂøÜÊü•Áúã
    function openMemory() {
      memoryModal.classList.add('show');
      loadPersonalMemory();
    }

    // ÂÖ≥Èó≠ËÆ∞ÂøÜÊü•Áúã
    function closeMemory() {
      memoryModal.classList.remove('show');
    }

    // ÊâìÂºÄÂàÜ‰∫´ÂºπÁ™ó
    function openShareModal(messageDiv) {
      // Ê£ÄÊü•ÊòØÂê¶ÊòØÊù•Ëá™ÂàÜ‰∫´ÈìæÊé•ÁöÑÊ∂àÊÅØÔºàËøòÊ≤°ÊúâÊ∑ªÂä†Âà∞Áî®Êà∑ÂØπËØù‰∏≠Ôºâ
      const isSharedMessage = messageDiv.dataset.isSharedMessage === 'true';
      const originalShareLink = messageDiv.dataset.originalShareLink;
      
      // Â¶ÇÊûúÊòØÂàÜ‰∫´ÁöÑÊ∂àÊÅØ‰∏îËøòÊ≤°ÊúâÊ∑ªÂä†Âà∞Áî®Êà∑ÂØπËØù‰∏≠ÔºåÁõ¥Êé•ÊòæÁ§∫ÂéüÂßãÂàÜ‰∫´ÈìæÊé•
      if (isSharedMessage && originalShareLink && !currentChatId) {
        shareLinkInput.value = originalShareLink;
        shareModal.classList.add('show');
        return;
      }
      
      // Â¶ÇÊûúÊ∂àÊÅØÂ∑≤ÁªèÊ∑ªÂä†Âà∞Áî®Êà∑ÂØπËØù‰∏≠ÔºåÊàñËÄÖÊúâcurrentChatIdÔºåÂàô‰ªéÁî®Êà∑ÂØπËØù‰∏≠Êü•Êâæ
      if (!currentChatId) {
        // Â¶ÇÊûúÊó¢Ê≤°ÊúâcurrentChatIdÔºå‰πüÊ≤°ÊúâÂéüÂßãÂàÜ‰∫´ÈìæÊé•Ôºå‰ΩøÁî®ÂéüÂßãÂàÜ‰∫´ÈìæÊé•
        if (originalShareLink) {
          shareLinkInput.value = originalShareLink;
          shareModal.classList.add('show');
        } else {
          alert('Êó†Ê≥ïÂàÜ‰∫´ÔºöÂΩìÂâçÂØπËØùID‰∏çÂ≠òÂú®');
        }
        return;
      }

      // Â∞ùËØï‰ªéÊ∂àÊÅØdivÁöÑdataÂ±ûÊÄß‰∏≠Ëé∑ÂèñÊó∂Èó¥Êà≥
      let timestamp = messageDiv.dataset.timestamp;
      
      // Â¶ÇÊûúÊ≤°ÊúâÔºåÂ∞ùËØï‰ªéÂ∑≤Âä†ËΩΩÁöÑÊ∂àÊÅØ‰∏≠Ëé∑Âèñ
      if (!timestamp) {
        // ÈÄöËøáAPIËé∑ÂèñÊ∂àÊÅØ
        fetch(`${backendUrl}/get_chat_messages`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          credentials: 'include',
          body: JSON.stringify({
            username: currentUsername,
            conversation_id: currentChatId
          })
        }).then(response => response.json()).then(data => {
          if (data.success && data.conversation && data.conversation.messages) {
            // ÊâæÂà∞ÂØπÂ∫îÁöÑAIÊ∂àÊÅØ
            const assistantMessages = data.conversation.messages.filter(msg => msg.type === 'assistant');
            const messagePosition = Array.from(chatMessages.children)
              .filter(div => div.classList.contains('assistant'))
              .indexOf(messageDiv);
            
            if (messagePosition >= 0 && messagePosition < assistantMessages.length) {
              const message = assistantMessages[messagePosition];
              timestamp = message.timestamp || '';
              generateAndShowShareLink(timestamp);
            } else {
              // Â¶ÇÊûúÂú®Áî®Êà∑ÂØπËØù‰∏≠Êâæ‰∏çÂà∞Ôºå‰ΩøÁî®ÂéüÂßãÂàÜ‰∫´ÈìæÊé•
              if (originalShareLink) {
                shareLinkInput.value = originalShareLink;
                shareModal.classList.add('show');
              } else {
                alert('Êó†Ê≥ïËé∑ÂèñÊ∂àÊÅØÊó∂Èó¥Êà≥');
              }
            }
          } else {
            // APIÂ§±Ë¥•Ôºå‰ΩøÁî®ÂéüÂßãÂàÜ‰∫´ÈìæÊé•
            if (originalShareLink) {
              shareLinkInput.value = originalShareLink;
              shareModal.classList.add('show');
            } else {
              alert('Êó†Ê≥ïËé∑ÂèñÊ∂àÊÅØ‰ø°ÊÅØ');
            }
          }
        }).catch(err => {
          // Âá∫ÈîôÊó∂‰ΩøÁî®ÂéüÂßãÂàÜ‰∫´ÈìæÊé•
          if (originalShareLink) {
            shareLinkInput.value = originalShareLink;
            shareModal.classList.add('show');
          } else {
            alert('Êó†Ê≥ïËé∑ÂèñÊ∂àÊÅØ‰ø°ÊÅØ');
          }
        });
      } else {
        // ÊúâÊó∂Èó¥Êà≥ÔºåÊ£ÄÊü•ËØ•Ê∂àÊÅØÊòØÂê¶Â∑≤ÁªèÂú®Áî®Êà∑ÂØπËØù‰∏≠
        checkMessageInConversationAndShare(messageDiv, timestamp, originalShareLink);
      }
    }

    // Ê£ÄÊü•Ê∂àÊÅØÊòØÂê¶Âú®ÂØπËØù‰∏≠ÔºåÂπ∂ÁîüÊàêÁõ∏Â∫îÁöÑÂàÜ‰∫´ÈìæÊé•
    async function checkMessageInConversationAndShare(messageDiv, timestamp, originalShareLink) {
      if (!currentChatId || !currentUsername) {
        // Ê≤°ÊúâÂØπËØùIDÔºå‰ΩøÁî®ÂéüÂßãÂàÜ‰∫´ÈìæÊé•
        if (originalShareLink) {
          shareLinkInput.value = originalShareLink;
          shareModal.classList.add('show');
        } else {
          alert('Êó†Ê≥ïÂàÜ‰∫´ÔºöÂΩìÂâçÂØπËØùID‰∏çÂ≠òÂú®');
        }
        return;
      }
      
      try {
        // Ê£ÄÊü•ËØ•Ê∂àÊÅØÊòØÂê¶Â∑≤ÁªèÂú®Áî®Êà∑ÂØπËØù‰∏≠
        const response = await fetch(`${backendUrl}/get_chat_messages`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          credentials: 'include',
          body: JSON.stringify({
            username: currentUsername,
            conversation_id: currentChatId
          })
        });
        
        const data = await response.json();
        if (data.success && data.conversation && data.conversation.messages) {
          // Ê£ÄÊü•ÂØπËØù‰∏≠ÊòØÂê¶ÊúâËØ•Êó∂Èó¥Êà≥ÁöÑÊ∂àÊÅØ
          const messageExists = data.conversation.messages.some(
            msg => msg.type === 'assistant' && msg.timestamp === timestamp
          );
          
          if (messageExists) {
            // Ê∂àÊÅØÂ∑≤Âú®Áî®Êà∑ÂØπËØù‰∏≠ÔºåÁîüÊàêÊñ∞ÁöÑÂàÜ‰∫´ÈìæÊé•
            generateAndShowShareLink(timestamp);
          } else {
            // Ê∂àÊÅØ‰∏çÂú®Áî®Êà∑ÂØπËØù‰∏≠Ôºå‰ΩøÁî®ÂéüÂßãÂàÜ‰∫´ÈìæÊé•
            if (originalShareLink) {
              shareLinkInput.value = originalShareLink;
              shareModal.classList.add('show');
            } else {
              generateAndShowShareLink(timestamp);
            }
          }
        } else {
          // Ëé∑ÂèñÂØπËØùÂ§±Ë¥•Ôºå‰ΩøÁî®ÂéüÂßãÂàÜ‰∫´ÈìæÊé•
          if (originalShareLink) {
            shareLinkInput.value = originalShareLink;
            shareModal.classList.add('show');
          } else {
            generateAndShowShareLink(timestamp);
          }
        }
      } catch (error) {
        // Âá∫ÈîôÊó∂‰ΩøÁî®ÂéüÂßãÂàÜ‰∫´ÈìæÊé•
        if (originalShareLink) {
          shareLinkInput.value = originalShareLink;
          shareModal.classList.add('show');
        } else {
          generateAndShowShareLink(timestamp);
        }
      }
    }

    // ÁîüÊàêÂπ∂ÊòæÁ§∫ÂàÜ‰∫´ÈìæÊé•
    function generateAndShowShareLink(timestamp) {
      if (!currentChatId || !timestamp) {
        alert('Êó†Ê≥ïÁîüÊàêÂàÜ‰∫´ÈìæÊé•ÔºöÁº∫Â∞ëÂøÖË¶Å‰ø°ÊÅØ');
        return;
      }

      // Â∞ÜÊó∂Èó¥Êà≥‰∏≠ÁöÑÁ¨¶Âè∑ÂéªÊéâÔºåÂè™ÁïôÊï∞Â≠ó
      // Êó∂Èó¥Êà≥Ê†ºÂºè: "2025-10-31 19:20:12"
      const timestampNumeric = timestamp.replace(/[^0-9]/g, '');
      
      // ÁîüÊàêÂàÜ‰∫´ÈìæÊé•
      const shareLink = `https://baijia.online/agent-share/${currentChatId}${timestampNumeric}`;
      
      // ÊòæÁ§∫Âú®ËæìÂÖ•Ê°Ü‰∏≠
      shareLinkInput.value = shareLink;
      shareModal.classList.add('show');
    }

    // ÂÖ≥Èó≠ÂàÜ‰∫´ÂºπÁ™ó
    function closeShareModal() {
      shareModal.classList.remove('show');
    }

    // Âä†ËΩΩÂπ∂Ê∏≤ÊüìÈ¢ùÂ∫¶‰ø°ÊÅØ
    async function loadAndRenderQuota() {
      if (!currentUsername) return;
      try {
        const resp = await fetch(`${backendUrl}/api/get_quota?username=${encodeURIComponent(currentUsername)}`, { credentials: 'include' });
        const data = await resp.json();
        if (!data.success) throw new Error(data.error || 'Ëé∑ÂèñÈ¢ùÂ∫¶Â§±Ë¥•');
        const total = Number(data.quota_total || 100000);
        const used = Number(data.quota_used || 0);
        const percent = Math.min(100, Math.round((used / total) * 100));
        const quotaText = document.getElementById('quotaText');
        const quotaBar = document.getElementById('quotaBar');
        if (quotaText) quotaText.textContent = `${used}/${total}`;
        if (quotaBar) quotaBar.style.width = `${percent}%`;

        const keyGroup = document.getElementById('openaiKeyGroup');
        const baseGroup = document.getElementById('openaiBaseUrlGroup');
        const saveSettingsBtn = document.getElementById('saveSettingsBtn');
        const quotaLabel = document.getElementById('quotaLabel');
        const quotaStatus = document.getElementById('quotaStatus');
        // Êú™ËææÂà∞ÊÄªÈ¢ùÂ∫¶ÂâçÈöêËóèOpenAIÈÖçÁΩÆÔºåËææÂà∞(>=)ÂêéÊòæÁ§∫
        const reached = used >= total;
        if (quotaLabel && quotaStatus) {
          // ‰ªÖËÆ©‚ÄúÔºàÂ∑≤Êª°Ôºâ‚ÄùÂèòÁ∫¢ÔºåÂÖ∂‰Ωô‰øùÊåÅÈªòËÆ§
          quotaLabel.firstChild && (quotaLabel.firstChild.textContent = 'Â∑≤Áî®È¢ùÂ∫¶ ');
          quotaStatus.textContent = reached ? 'ÔºàÂ∑≤Êª°Ôºâ' : 'ÔºàÂÖçË¥πÈ¢ùÂ∫¶Ôºâ';
          quotaStatus.style.color = reached ? '#dc2626' : '#6b7280';
        }
        if (quotaText) quotaText.style.color = '#374151';
        if (quotaBar) quotaBar.style.background = 'linear-gradient(90deg, #60a5fa, #818cf8)';
        if (keyGroup) keyGroup.style.display = reached ? '' : 'none';
        if (baseGroup) baseGroup.style.display = reached ? '' : 'none';
        if (saveSettingsBtn) saveSettingsBtn.style.display = reached ? '' : 'none';
      } catch (e) {
      }
    }

    // ÂàáÊç¢ËÆ∞ÂøÜÊ†áÁ≠æÈ°µ
    function switchMemoryTab(tab) {
      // ÁßªÈô§ÊâÄÊúâÊ¥ªÂä®Áä∂ÊÄÅ
      personalMemoryTab.classList.remove('active');
      sharedMemoryTab.classList.remove('active');
      personalMemoryContent.classList.remove('active');
      sharedMemoryContent.classList.remove('active');

      if (tab === 'personal') {
        personalMemoryTab.classList.add('active');
        personalMemoryContent.classList.add('active');
        loadPersonalMemory();
      } else if (tab === 'shared') {
        sharedMemoryTab.classList.add('active');
        sharedMemoryContent.classList.add('active');
        // ÂÖ±‰∫´ËÆ∞ÂøÜÊöÇÊó∂‰∏çÂä†ËΩΩÂÜÖÂÆπ
      }
    }

    // Âä†ËΩΩ‰∏™‰∫∫ËÆ∞ÂøÜ
    async function loadPersonalMemory() {
      if (!currentUsername) return;
      
      const memoryType = memoryTypeSelect.value; // short, mid, long
      
      try {
        let url;
        if (memoryType === 'short') {
          url = `${backendUrl}/chat/users/${currentUsername}/short_term.json`;
        } else if (memoryType === 'mid') {
          url = `${backendUrl}/chat/users/${currentUsername}/mid_term.json`;
        } else if (memoryType === 'long') {
          url = `${backendUrl}/chat/users/${currentUsername}/long_term_user.json`;
        }
        
        if (!url) {
          personalMemoryList.innerHTML = '<div class="empty-state">Êó†ÊïàÁöÑËÆ∞ÂøÜÁ±ªÂûã</div>';
          return;
        }
        
        const response = await fetch(url, { credentials: 'include' });
        if (response.ok) {
          const memories = await response.json();
          displayPersonalMemories(personalMemoryList, memories, memoryType);
        } else {
          personalMemoryList.innerHTML = `<div class="empty-state">ÊöÇÊó†${getMemoryTypeName(memoryType)}</div>`;
        }
      } catch (error) {
        personalMemoryList.innerHTML = '<div class="empty-state">Âä†ËΩΩÂ§±Ë¥•</div>';
      }
    }

    // ÊòæÁ§∫‰∏™‰∫∫ËÆ∞ÂøÜÂàóË°®
    function displayPersonalMemories(container, memories, memoryType) {
      if (!memories) {
        container.innerHTML = '<div class="empty-state">ÊöÇÊó†ËÆ∞ÂøÜ</div>';
        return;
      }

      container.innerHTML = '';
      
      if (memoryType === 'short') {
        // Áü≠ÊúüËÆ∞ÂøÜÊòØÊï∞ÁªÑÊ†ºÂºè
        if (!Array.isArray(memories)) {
          container.innerHTML = '<div class="empty-state">Áü≠ÊúüËÆ∞ÂøÜÊï∞ÊçÆÊ†ºÂºèÈîôËØØ</div>';
          return;
        }
        
        if (memories.length === 0) {
          container.innerHTML = '<div class="empty-state">ÊöÇÊó†Áü≠ÊúüËÆ∞ÂøÜ</div>';
          return;
        }
        
        memories.forEach((memory, index) => {
          const memoryItem = document.createElement('div');
          memoryItem.className = 'memory-item';
          
          // ÂÆâÂÖ®Âú∞Ëé∑ÂèñÂ±ûÊÄßÔºåÈÅøÂÖç 'get' ÊñπÊ≥ïÈîôËØØ
          const time = memory.timestamp || 'Êú™Áü•Êó∂Èó¥';
          const conversationId = memory.conversation_id || 'Êú™Áü•‰ºöËØù';
          const userInput = memory.user_input || 'Êó†Áî®Êà∑ËæìÂÖ•';
          const agentResponse = memory.agent_response || 'Êó†AIÂõûÂ§ç';
          
          memoryItem.innerHTML = `
            <div class="memory-item-header">
              <span class="memory-item-time">${time}</span>
              <span class="memory-item-conversation">${conversationId}</span>
            </div>
            <div class="memory-item-content">
              <div class="memory-item-user">Áî®Êà∑: ${userInput}</div>
              <div class="memory-item-assistant">AI: ${agentResponse}</div>
            </div>
          `;
          
          container.appendChild(memoryItem);
        });
      } else if (memoryType === 'mid') {
        // ‰∏≠ÊúüËÆ∞ÂøÜÊòØÂØπË±°Ê†ºÂºèÔºåÂåÖÂê´sessions
        if (!memories || typeof memories !== 'object') {
          container.innerHTML = '<div class="empty-state">‰∏≠ÊúüËÆ∞ÂøÜÊï∞ÊçÆÊ†ºÂºèÈîôËØØ</div>';
          return;
        }
        
        const sessions = memories.sessions || {};
        const sessionKeys = Object.keys(sessions);
        
        if (sessionKeys.length === 0) {
          container.innerHTML = '<div class="empty-state">ÊöÇÊó†‰∏≠ÊúüËÆ∞ÂøÜ</div>';
          return;
        }
        
        sessionKeys.forEach(sid => {
          const session = sessions[sid] || {};
          const memoryItem = document.createElement('div');
          memoryItem.className = 'memory-item';
          
          const sessionId = session.id || sid;
          const summary = session.summary || 'ÊöÇÊó†ÊëòË¶Å';
          const keywords = session.summary_keywords || [];
          const details = session.details || [];
          
          // ÊûÑÂª∫ËØ¶ÊÉÖÂÜÖÂÆπ
          let detailsHtml = '';
          if (details.length > 0) {
            details.forEach(page => {
              detailsHtml += `
                <div style="margin-bottom: 10px; padding: 12px; background: rgba(255,255,255,0.9); border-radius: 12px; box-shadow: 0 2px 8px rgba(31,38,135,0.08); border: 1px solid rgba(255,255,255,0.3);">
                  <div style="margin-bottom: 6px;"><b style="color: #667eea;">‰Ω†Ôºö</b>${page.user_input || ''}</div>
                  <div style="margin-bottom: 6px;"><b style="color: #667eea;">AIÔºö</b>${page.agent_response || ''}</div>
                  <div style="color: #888; font-size: 0.9em; margin-top: 4px;">${page.timestamp || ''}</div>
                  ${page.meta_info ? `<div style="color: #888; font-size: 0.9em; margin-top: 2px;">${page.meta_info}</div>` : ''}
                  ${page.page_keywords && page.page_keywords.length > 0 ? `<div style="color: #667eea; font-size: 0.9em; margin-top: 2px; font-weight: 600;">ÂÖ≥ÈîÆËØçÔºö${page.page_keywords.join('„ÄÅ')}</div>` : ''}
                </div>
              `;
            });
          }
          
          memoryItem.innerHTML = `
            <div class="memory-item-header">
              <span class="memory-item-time">‰ºöËØùID: ${sessionId}</span>
              <span class="memory-item-time">ÂØπËØùÊï∞Èáè: ${details.length}</span>
            </div>
            <div class="memory-item-content">
              <div class="memory-item-user">ÊëòË¶Å: ${summary}</div>
              ${keywords.length > 0 ? `<div class="memory-item-assistant">ÂÖ≥ÈîÆËØç: ${keywords.join('„ÄÅ')}</div>` : ''}
              ${details.length > 0 ? `<div style="margin-top: 12px;"><div style="font-weight: 600; margin-bottom: 8px; color: #2a3a5a;">ÂØπËØùËØ¶ÊÉÖ:</div>${detailsHtml}</div>` : ''}
            </div>
          `;
          
          container.appendChild(memoryItem);
        });
      } else if (memoryType === 'long') {
        // ÈïøÊúüËÆ∞ÂøÜÊòØÂØπË±°Ê†ºÂºèÔºåÂåÖÂê´user_profiles
        if (!memories || typeof memories !== 'object') {
          container.innerHTML = '<div class="empty-state">ÈïøÊúüËÆ∞ÂøÜÊï∞ÊçÆÊ†ºÂºèÈîôËØØ</div>';
          return;
        }
        
        const userProfiles = memories.user_profiles || {};
        const profileKeys = Object.keys(userProfiles);
        
        if (profileKeys.length === 0) {
          container.innerHTML = '<div class="empty-state">ÊöÇÊó†ÈïøÊúüËÆ∞ÂøÜ</div>';
          return;
        }
        
        profileKeys.forEach(profileKey => {
          const profile = userProfiles[profileKey] || {};
          const memoryItem = document.createElement('div');
          memoryItem.className = 'memory-item';
          
          const data = profile.data || 'ÊöÇÊó†Êï∞ÊçÆ';
          const lastUpdated = profile.last_updated || 'Êú™Áü•Êó∂Èó¥';
          
          // Â§ÑÁêÜÁî®Êà∑ÁîªÂÉèÊï∞ÊçÆÔºåÂú®ÊØè‰∏™Âè•Âè∑ÂêéÊ∑ªÂä†Êç¢Ë°å
          const formattedData = data.replace(/„ÄÇ/g, '„ÄÇ<br>');
          
          // ‰ªÖ‰øùÁïôÊõ¥Êñ∞Êó∂Èó¥Á≠âÂÖÉ‰ø°ÊÅØÔºå‰∏çÂÜçÂ±ïÁ§∫ÂéüÂßã‚ÄúÁî®Êà∑ÁîªÂÉè‚ÄùÂÖ®Êñá
          memoryItem.innerHTML = `
            <div class="memory-item-header">
              <span class="memory-item-time">Áî®Êà∑: ${profileKey}</span>
              <span class="memory-item-time">Êõ¥Êñ∞Êó∂Èó¥: ${lastUpdated}</span>
            </div>
          `;

          container.appendChild(memoryItem);
        });
        
        // ËøΩÂä†ÔºöÁîªÂÉèÁª¥Â∫¶ÊäòÂè†Èù¢ÊùøÔºàÊåâ‰∏âÂ§ßÁ±ªÔºåÊòæÁ§∫Â∑≤Â≠òÂú®ÁöÑÂ∞èÁª¥Â∫¶Ôºâ
        renderUserDimensionsCollapsible(container);

        // ÊòæÁ§∫Áü•ËØÜÂ∫ìÂÜÖÂÆπ
        const knowledgeBase = memories.knowledge_base || [];
        if (knowledgeBase.length > 0) {
          const knowledgeItem = document.createElement('div');
          knowledgeItem.className = 'memory-item';
          
          // Â§ÑÁêÜÁü•ËØÜÂ∫ìÂÜÖÂÆπÔºàÂÖºÂÆπÂØπË±°/Â≠óÁ¨¶‰∏≤ÔºâÔºåÂú®ÊØè‰∏™Âè•Âè∑ÂêéÊ∑ªÂä†Êç¢Ë°å
          const formattedKnowledge = knowledgeBase.slice(0, 3).map(item => {
            const knowledgeText = typeof item === 'object' ? (item.knowledge || JSON.stringify(item)) : item;
            return String(knowledgeText).replace(/„ÄÇ/g, '„ÄÇ<br>');
          }).join('<br><br>');
          
          knowledgeItem.innerHTML = `
            <div class="memory-item-header">
              <span class="memory-item-time">Áü•ËØÜÂ∫ì</span>
            </div>
            <div class="memory-item-content">
              <div class="memory-item-user">Áü•ËØÜÊù°ÁõÆÊï∞Èáè: ${knowledgeBase.length}</div>
              <div class="memory-item-assistant">${formattedKnowledge}${knowledgeBase.length > 3 ? '<br>...' : ''}</div>
            </div>
          `;
          container.appendChild(knowledgeItem);
        }
        
        // ÊòæÁ§∫Âä©ÊâãÁü•ËØÜÂÜÖÂÆπ
        const assistantKnowledge = memories.assistant_knowledge || [];
        if (assistantKnowledge.length > 0) {
          const assistantItem = document.createElement('div');
          assistantItem.className = 'memory-item';
          
          // Â§ÑÁêÜÂä©ÊâãÁü•ËØÜÂÜÖÂÆπÔºàÂÖºÂÆπÂØπË±°/Â≠óÁ¨¶‰∏≤ÔºâÔºåÂú®ÊØè‰∏™Âè•Âè∑ÂêéÊ∑ªÂä†Êç¢Ë°å
          const formattedAssistantKnowledge = assistantKnowledge.slice(0, 3).map(item => {
            const knowledgeText = typeof item === 'object' ? (item.knowledge || JSON.stringify(item)) : item;
            return String(knowledgeText).replace(/„ÄÇ/g, '„ÄÇ<br>');
          }).join('<br><br>');
          
          assistantItem.innerHTML = `
            <div class="memory-item-header">
              <span class="memory-item-time">Âä©ÊâãÁü•ËØÜ</span>
            </div>
            <div class="memory-item-content">
              <div class="memory-item-user">Áü•ËØÜÊù°ÁõÆÊï∞Èáè: ${assistantKnowledge.length}</div>
              <div class="memory-item-assistant">${formattedAssistantKnowledge}${assistantKnowledge.length > 3 ? '<br>...' : ''}</div>
            </div>
          `;
          container.appendChild(assistantItem);
        }
      }
    }

    // Ëé∑ÂèñËÆ∞ÂøÜÁ±ªÂûãÂêçÁß∞
    function getMemoryTypeName(memoryType) {
      const names = {
        'short': 'Áü≠ÊúüËÆ∞ÂøÜ',
        'mid': '‰∏≠ÊúüËÆ∞ÂøÜ',
        'long': 'ÈïøÊúüËÆ∞ÂøÜ'
      };
      return names[memoryType] || 'ËÆ∞ÂøÜ';
    }

    // Ê∏≤ÊüìÁî®Êà∑ÁîªÂÉèÁª¥Â∫¶ÊäòÂè†Èù¢ÊùøÔºàË∞ÉÁî®ÂêéÁ´ØÁªü‰∏ÄAPIÔºâ
    async function renderUserDimensionsCollapsible(parentContainer) {
      try {
        const resp = await fetch(`${backendUrl}/api/get_user_dimensions?username=${currentUsername}`, { credentials: 'include' });
        if (!resp.ok) return;
        const data = await resp.json();
        if (!data.success) return;
        const dims = data.dimensions || {};
        const groups = data.groups || {};

        const section = document.createElement('div');
        section.className = 'memory-item';
        section.innerHTML = `
          <div class="memory-item-header">
            <span class="memory-item-time">üß© Áî®Êà∑ÁîªÂÉèÁª¥Â∫¶</span>
          </div>
        `;

        const wrapper = document.createElement('div');
        const groupOrder = [groups.basic_info || 'Âü∫Á°Ä‰ø°ÊÅØ', groups.psych || 'ÂøÉÁêÜÊ®°Âûã', groups.align || 'AIÂØπÈΩêÁª¥Â∫¶', groups.interest || 'ÂÜÖÂÆπÂÖ¥Ë∂£Ê†áÁ≠æ'];
        groupOrder.forEach(groupName => {
          const entries = dims[groupName] || {};
          const keys = Object.keys(entries);
          const details = document.createElement('details');
          details.open = true;
          const summary = document.createElement('summary');
          summary.textContent = `${groupName}Ôºà${keys.length} È°πÔºâ`;
          summary.style.cursor = 'pointer';
          summary.style.fontWeight = '600';
          summary.style.margin = '6px 0';
          details.appendChild(summary);
          const list = document.createElement('div');
          list.style.display = 'flex';
          list.style.flexDirection = 'column';
          list.style.gap = '8px';
          if (keys.length === 0) {
            const empty = document.createElement('div');
            empty.className = 'memory-item-assistant';
            empty.textContent = 'ÊöÇÊó†ÁîªÂÉèÊù°ÁõÆ';
            list.appendChild(empty);
          } else {
            keys.forEach(k => {
              const item = document.createElement('div');
              item.className = 'memory-item-assistant';
              const level = entries[k];
              item.textContent = `${k}: ${level}`;
              list.appendChild(item);
            });
          }
          details.appendChild(list);
          wrapper.appendChild(details);
        });
        section.appendChild(wrapper);
        parentContainer.appendChild(section);
      } catch (e) {
      }
    }

    // Âä†ËΩΩÁî®Êà∑ÈÖçÁΩÆ
    async function loadUserConfig() {
      if (!currentUsername) return;
      
      try {
        // ÂÖàÂ∞ùËØï‰ªéchatÁõÆÂΩïÂä†ËΩΩÈÖçÁΩÆ
        const response = await fetch(`${backendUrl}/get_chat_conversations`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          credentials: 'include',
          body: JSON.stringify({ username: currentUsername })
        });
        
        if (response.ok) {
          // ‰ªéchatÁõÆÂΩïÂä†ËΩΩÈÖçÁΩÆ
          const configResponse = await fetch(`${backendUrl}/chat/users/${currentUsername}/config.json`);
          if (configResponse.ok) {
            const data = await configResponse.json();
            
            // Â°´ÂÖÖË°®Âçï
            if (data.openai_api_key) document.getElementById('openaiApiKey').value = data.openai_api_key;
            if (data.openai_base_url) document.getElementById('openaiBaseUrl').value = data.openai_base_url;
            
            return;
          }
        }
        
        // Â¶ÇÊûúchatÁõÆÂΩïÊ≤°ÊúâÈÖçÁΩÆÔºåÂ∞ùËØï‰ªéÂéüÊù•ÁöÑÊé•Âè£Âä†ËΩΩ
        const response2 = await fetch('/gt', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ username: currentUsername })
        });
        
        if (response2.ok) {
          const data = await response2.json();
          
          // Â°´ÂÖÖË°®Âçï
          if (data.openai_api_key) document.getElementById('openaiApiKey').value = data.openai_api_key;
          if (data.openai_base_url) document.getElementById('openaiBaseUrl').value = data.openai_base_url;
        }
      } catch (error) {
      }
    }

    // ‰øùÂ≠òËÆæÁΩÆ
    async function saveSettings(e) {
      e.preventDefault();
      
      if (!currentUsername) {
        alert('ËØ∑ÂÖàËÆæÁΩÆÁî®Êà∑Âêç');
        return;
      }
      
      const formData = new FormData(settingsForm);
      const settings = Object.fromEntries(formData.entries());
      
      // È™åËØÅÂøÖË¶ÅÂ≠óÊÆµ
      if (!settings.openai_api_key || settings.openai_api_key.trim() === '') {
        alert('ËØ∑ËæìÂÖ•OpenAI API Key');
        document.getElementById('openaiApiKey').focus();
        return;
      }
      
      settings.username = currentUsername;
      
      try {
        const response = await fetch(`${backendUrl}/save_chat_user_config`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(settings)
        });
        
        if (response.ok) {
          const data = await response.json();
          if (data.success) {
            alert('ËÆæÁΩÆ‰øùÂ≠òÊàêÂäüÔºÅ');
            closeSettings();
          } else {
            alert('ËÆæÁΩÆ‰øùÂ≠òÂ§±Ë¥•Ôºö' + (data.error || 'Êú™Áü•ÈîôËØØ'));
          }
        } else {
          alert('ËÆæÁΩÆ‰øùÂ≠òÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
        }
      } catch (error) {
        alert('ËÆæÁΩÆ‰øùÂ≠òÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
      }
    }

    // Ëé∑Âèñ‰ºöËØùÁî®Êà∑Âêç
    function getSessionUsername() {
      // Â∞ùËØï‰ªélocalStorageËé∑Âèñ
      let username = localStorage.getItem('username');
      if (username) return username;
      
      // Â∞ùËØï‰ªéURLÂèÇÊï∞Ëé∑Âèñ
      const urlParams = new URLSearchParams(window.location.search);
      username = urlParams.get('username');
      if (username) {
        localStorage.setItem('username', username);
        return username;
      }
      
      return null;
    }

    // Ê†ºÂºèÂåñÊó∂Èó¥
    function formatTime(timestamp) {
      if (!timestamp) return '';

      let date = new Date(timestamp);

      if (Number.isNaN(date.getTime()) && typeof timestamp === 'string') {
        const normalized = timestamp.replace(' ', 'T');
        date = new Date(normalized);
      }

      if (Number.isNaN(date.getTime())) {
        return timestamp;
      }

      const now = new Date();
      const diff = now - date;
      
      if (diff < 60000) { // 1ÂàÜÈíüÂÜÖ
        return 'ÂàöÂàö';
      } else if (diff < 3600000) { // 1Â∞èÊó∂ÂÜÖ
        return Math.floor(diff / 60000) + 'ÂàÜÈíüÂâç';
      } else if (diff < 86400000) { // 1Â§©ÂÜÖ
        return Math.floor(diff / 3600000) + 'Â∞èÊó∂Ââç';
      } else {
        return date.toLocaleDateString();
      }
    }

    // Ëá™Âä®Ë∞ÉÊï¥ËæìÂÖ•Ê°ÜÈ´òÂ∫¶
    chatInput.addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = Math.min(this.scrollHeight, 250) + 'px';
    });

    // ÂàùÂßãÂåñËÆ∞ÂøÜÊåâÈíÆÁä∂ÊÄÅ
    function initializeSharedMemoryButton() {
      // ÈªòËÆ§ÊÉÖÂÜµ‰∏ãÔºå‰∏™‰∫∫ËÆ∞ÂøÜÊòØÂêØÁî®ÁöÑ
      updateMemoryButtonDisplay();
    }

    // Êõ¥Êñ∞ËÆ∞ÂøÜÊåâÈíÆÊòæÁ§∫
    function updateMemoryButtonDisplay() {
      if (personalMemoryEnabled) {
        sharedMemoryBtn.classList.add('active');
        sharedMemoryBtn.innerHTML = `
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
            <circle cx="9" cy="7" r="4"/>
            <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
            <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
          </svg>
          ËÆ∞ÂøÜÂ∑≤ÂºÄÂêØ
        `;
      } else {
        sharedMemoryBtn.classList.remove('active');
        sharedMemoryBtn.innerHTML = `
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
            <circle cx="9" cy="7" r="4"/>
            <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
            <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
          </svg>
          ÂºÄÂêØËÆ∞ÂøÜ
        `;
      }
    }

    // ÂàáÊç¢‰∏™‰∫∫ËÆ∞ÂøÜÁä∂ÊÄÅ
    function toggleSharedMemory() {
      personalMemoryEnabled = !personalMemoryEnabled;

      // ÂΩì‰∏™‰∫∫ËÆ∞ÂøÜÂÖ≥Èó≠Êó∂ÔºåÂÖ±‰∫´ËÆ∞ÂøÜ‰πüËá™Âä®ÂÖ≥Èó≠
      if (!personalMemoryEnabled) {
        sharedMemoryEnabled = false;
      } else {
        // ÂΩì‰∏™‰∫∫ËÆ∞ÂøÜÂºÄÂêØÊó∂ÔºåÂÖ±‰∫´ËÆ∞ÂøÜ‰πüËá™Âä®ÂºÄÂêØ
        sharedMemoryEnabled = true;
      }

      updateMemoryButtonDisplay();

      if (personalMemoryEnabled) {
      } else {
      }
    }

    // ÂàáÊç¢ MCP Â∑•ÂÖ∑Ë∞ÉÁî®
    function toggleMcpTools() {
      mcpToolsEnabled = !mcpToolsEnabled;
      updateMcpButtonDisplay();

      if (mcpToolsEnabled) {
        console.log('üõ†Ô∏è MCP Â∑•ÂÖ∑Ë∞ÉÁî®Â∑≤ÂêØÁî®');
      } else {
        console.log('üí¨ MCP Â∑•ÂÖ∑Ë∞ÉÁî®Â∑≤Á¶ÅÁî®');
      }
    }

    // Êõ¥Êñ∞ MCP ÊåâÈíÆÊòæÁ§∫
    function updateMcpButtonDisplay() {
      if (mcpToolsEnabled) {
        mcpToolsBtn.classList.add('active');
        mcpToolsBtn.innerHTML = `
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>
          </svg>
          Â∑•ÂÖ∑Â∑≤ÂêØÁî®
        `;
      } else {
        mcpToolsBtn.classList.remove('active');
        mcpToolsBtn.innerHTML = `
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>
          </svg>
          Â∑•ÂÖ∑Ë∞ÉÁî®
        `;
      }
    }

    // ÊòæÁ§∫Â∑•ÂÖ∑Ë∞ÉÁî®ÊåáÁ§∫Âô®
    function showToolCallIndicator(toolName, status = 'start') {
      if (status === 'start') {
        toolCallStatus.textContent = `Ê≠£Âú®Ë∞ÉÁî®: ${toolName}`;
        toolCallIndicator.classList.add('active');
      } else if (status === 'end') {
        toolCallStatus.textContent = `ÂÆåÊàê: ${toolName}`;
        setTimeout(() => {
          toolCallIndicator.classList.remove('active');
        }, 2000);
      }
    }

    // ÈöêËóèÂ∑•ÂÖ∑Ë∞ÉÁî®ÊåáÁ§∫Âô®
    function hideToolCallIndicator() {
      toolCallIndicator.classList.remove('active');
    }

    // ÂΩìÂâçÊòæÁ§∫ÁöÑËÆ∞ÂøÜÊ∂àÊÅØÁ¥¢Âºï
    let currentMemoryMessageIndex = null;

    // ÂàáÊç¢ËÆ∞ÂøÜÂÜÖÂÆπÈù¢Êùø
    function toggleMemoryContentPanel(messageIndex = null, usedSharedMemories = []) {
      const panel = document.getElementById('memoryContentPanel');
      
      // Â¶ÇÊûúÈù¢ÊùøÂ∑≤ÁªèÊâìÂºÄ
      if (panel.classList.contains('open')) {
        // Â¶ÇÊûúÁÇπÂáªÁöÑÊòØÂêå‰∏Ä‰∏™Ê∂àÊÅØÔºåÂàôÂÖ≥Èó≠Èù¢Êùø
        if (currentMemoryMessageIndex === messageIndex) {
          closeMemoryContentPanel();
          currentMemoryMessageIndex = null;
        } else {
          // Â¶ÇÊûúÁÇπÂáªÁöÑÊòØ‰∏çÂêåÁöÑÊ∂àÊÅØÔºåÁõ¥Êé•ÂàáÊç¢Âà∞Êñ∞Ê∂àÊÅØÁöÑËÆ∞ÂøÜÂÜÖÂÆπ
          currentMemoryMessageIndex = messageIndex;
          loadUsedMemories(messageIndex, usedSharedMemories);
        }
      } else {
        // Â¶ÇÊûúÈù¢ÊùøÊú™ÊâìÂºÄÔºåÊâìÂºÄÂπ∂ÊòæÁ§∫ÂΩìÂâçÊ∂àÊÅØÁöÑËÆ∞ÂøÜ
        currentMemoryMessageIndex = messageIndex;
        openMemoryContentPanel(messageIndex, usedSharedMemories);
      }
    }

    // ÊâìÂºÄËÆ∞ÂøÜÂÜÖÂÆπÈù¢Êùø
    function openMemoryContentPanel(messageIndex = null, usedSharedMemories = []) {
      const panel = document.getElementById('memoryContentPanel');
      const appContainer = document.querySelector('.app-container');
      
      // Ê∑ªÂä†openÁ±ªÂà∞Èù¢Êùø
      panel.classList.add('open');
      
      // Ê∑ªÂä†memory-panel-openÁ±ªÂà∞app-containerÔºåËß¶ÂèëÂπ∂ÊéíÂ∏ÉÂ±Ä
      if (appContainer) {
        appContainer.classList.add('memory-panel-open');
      }
      
      loadUsedMemories(messageIndex, usedSharedMemories);
    }

    // ÂÖ≥Èó≠ËÆ∞ÂøÜÂÜÖÂÆπÈù¢Êùø
    function closeMemoryContentPanel() {
      const panel = document.getElementById('memoryContentPanel');
      const appContainer = document.querySelector('.app-container');
      
      // ÁßªÈô§openÁ±ª
      panel.classList.remove('open');
      
      // ÁßªÈô§memory-panel-openÁ±ªÔºåÊÅ¢Â§çÂéüÂßãÂ∏ÉÂ±Ä
      if (appContainer) {
        appContainer.classList.remove('memory-panel-open');
      }
      
      // Ê∏ÖÈô§ÂΩìÂâçÊòæÁ§∫ÁöÑÊ∂àÊÅØÁ¥¢Âºï
      currentMemoryMessageIndex = null;
    }

    // Âä†ËΩΩÂÆûÈôÖ‰ΩøÁî®ÁöÑËÆ∞ÂøÜÂÜÖÂÆπ
    async function loadUsedMemories(messageIndex = null, usedSharedMemories = []) {
      const body = document.getElementById('memoryContentBody');
      
      // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
      body.innerHTML = `
        <div class="memory-loading">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <path d="M12 6v6l4 2"/>
          </svg>
          <p>Ê≠£Âú®Âä†ËΩΩ‰ΩøÁî®ÁöÑËÆ∞ÂøÜÂÜÖÂÆπ...</p>
        </div>
      `;

      try {
        // Ëé∑ÂèñÂΩìÂâçÂØπËØùÁöÑÂÖ±‰∫´ËÆ∞ÂøÜ‰ΩøÁî®ÊÉÖÂÜµ
        const response = await fetch(`${backendUrl}/api/get_used_shared_memories`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          credentials: 'include',
          body: JSON.stringify({
            username: currentUsername,
            conversation_id: currentChatId,
            message_index: messageIndex,
            used_shared_memories: usedSharedMemories
          })
        });

        if (response.ok) {
          const data = await response.json();
          if (data.success && data.memories) {
            displayUsedMemories(data.memories);
          } else {
            showMemoryEmpty();
          }
        } else {
          showMemoryError('Âä†ËΩΩÂ§±Ë¥•');
        }
      } catch (error) {
        showMemoryError('Âä†ËΩΩÂ§±Ë¥•: ' + error.message);
      }
    }

    // ÊòæÁ§∫ÂÆûÈôÖ‰ΩøÁî®ÁöÑËÆ∞ÂøÜÂÜÖÂÆπ
    function displayUsedMemories(memories) {
      const body = document.getElementById('memoryContentBody');
      
      if (!memories || memories.length === 0) {
        showMemoryEmpty();
        return;
      }

      const memoryItems = memories.map((memory, index) => {
        // ‰ºòÂÖà‰ΩøÁî®merged_usersÂ≠óÊÆµÔºåÂ¶ÇÊûúÊ≤°ÊúâÂàô‰ΩøÁî®user_id‰Ωú‰∏∫fallback
        let mergedUsers = [];
        if (memory.merged_users && Array.isArray(memory.merged_users)) {
          mergedUsers = memory.merged_users;
        } else if (memory.meta && memory.meta.merged_users && Array.isArray(memory.meta.merged_users)) {
          // Â¶ÇÊûúmerged_usersÂú®metaÂØπË±°‰∏≠
          mergedUsers = memory.meta.merged_users;
        }
        
        const userDisplay = mergedUsers.length > 0 
          ? mergedUsers.join(', ') 
          : (memory.user_id || 'Êú™Áü•');
        
        // Ë∞ÉËØïÊó•Âøó
        if (index === 0) {
          console.log('ÊòæÁ§∫ËÆ∞ÂøÜÊï∞ÊçÆ:', {
            id: memory.id,
            user_id: memory.user_id,
            merged_users: memory.merged_users,
            meta: memory.meta,
            final_display: userDisplay
          });
        }
        
        return `
        <div class="memory-item" style="animation-delay: ${index * 0.1}s;">
          <div class="memory-item-header">
            <span class="memory-item-user">Áî®Êà∑: ${userDisplay}</span>
            <span class="memory-item-time">${formatMemoryTime(memory.timestamp)}</span>
          </div>
          ${memory.focus_query ? `
            <div class="memory-item-focus" style="margin-bottom: 12px; padding: 8px 12px; background: #f0f9ff; border-left: 3px solid #3b82f6; border-radius: 6px;">
              <div style="font-size: 12px; color: #3b82f6; font-weight: 600; margin-bottom: 4px;">Focus Query:</div>
              <div style="font-size: 13px; color: #1e40af; line-height: 1.4;">${memory.focus_query}</div>
            </div>
          ` : ''}
          <div class="memory-item-content">${memory.content || 'Êó†ÂÜÖÂÆπ'}</div>
        </div>
      `;
      }).join('');

      body.innerHTML = memoryItems;
      
      // Ê∑ªÂä†Ê∑°ÂÖ•Âä®Áîª
      const items = body.querySelectorAll('.memory-item');
      items.forEach((item, index) => {
        item.style.opacity = '0';
        item.style.transform = 'translateY(20px)';
        setTimeout(() => {
          item.style.transition = 'all 0.3s ease';
          item.style.opacity = '1';
          item.style.transform = 'translateY(0)';
        }, index * 100);
      });
    }

    // ÊòæÁ§∫Á©∫Áä∂ÊÄÅ
    function showMemoryEmpty() {
      const body = document.getElementById('memoryContentBody');
      body.innerHTML = `
        <div class="memory-empty">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <path d="M12 6v6l4 2"/>
          </svg>
          <p>Êú¨Ê¨°ÂõûÂ§çÊú™‰ΩøÁî®ÂÖ±‰∫´ËÆ∞ÂøÜ</p>
        </div>
      `;
    }

    // ÊòæÁ§∫ÈîôËØØÁä∂ÊÄÅ
    function showMemoryError(message) {
      const body = document.getElementById('memoryContentBody');
      body.innerHTML = `
        <div class="memory-empty">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <line x1="15" y1="9" x2="9" y2="15"/>
            <line x1="9" y1="9" x2="15" y2="15"/>
          </svg>
          <p>${message}</p>
        </div>
      `;
    }

    // Ê†ºÂºèÂåñËÆ∞ÂøÜÊó∂Èó¥
    function formatMemoryTime(timestamp) {
      if (!timestamp) return 'Êú™Áü•Êó∂Èó¥';
      
      const date = new Date(timestamp);
      const now = new Date();
      const diff = now - date;
      
      if (diff < 60000) { // 1ÂàÜÈíüÂÜÖ
        return 'ÂàöÂàö';
      } else if (diff < 3600000) { // 1Â∞èÊó∂ÂÜÖ
        return Math.floor(diff / 60000) + 'ÂàÜÈíüÂâç';
      } else if (diff < 86400000) { // 1Â§©ÂÜÖ
        return Math.floor(diff / 3600000) + 'Â∞èÊó∂Ââç';
      } else {
        return date.toLocaleDateString();
      }
    }
  </script>
</body>
</html>
