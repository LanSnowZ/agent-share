<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Memory OS Chat</title>
  <!-- å¼•å…¥marked.jsç”¨äºMarkdownæ¸²æŸ“ -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <!-- å¼•å…¥highlight.jsç”¨äºä»£ç é«˜äº® -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', Arial, sans-serif;
      background: #f7f8fa;
      height: 100vh;
      overflow: hidden;
    }

    .app-container {
      display: flex;
      height: 100vh;
      background: #f7f8fa;
    }

    /* å·¦ä¾§è¾¹æ  */
    .sidebar {
      width: 280px;
      background: #ffffff;
      border-right: 1px solid #e5e7eb;
      display: flex;
      flex-direction: column;
      height: 100vh;
      position: relative;
    }

    .sidebar-header {
      padding: 20px;
      border-bottom: 1px solid #e5e7eb;
    }

    .new-chat-btn {
      width: 100%;
      padding: 12px 16px;
      background: #165dff;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .new-chat-btn:hover {
      background: #0f4cd1;
    }

    .new-chat-btn svg {
      width: 16px;
      height: 16px;
    }

    .chat-history {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }

    .chat-history-item {
      padding: 12px 16px;
      margin-bottom: 8px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid transparent;
      position: relative;
    }

    .chat-history-item:hover {
      background: #f3f4f6;
    }

    .chat-history-item.active {
      background: #eef2ff;
      border-color: #165dff;
      border-width: 2px;
      box-shadow: 0 2px 8px rgba(22, 93, 255, 0.2);
      transform: translateX(2px);
    }

    .chat-history-item.active .chat-history-item-title {
      color: #165dff;
      font-weight: 600;
    }

    .chat-history-item.active .chat-history-item-time {
      color: #165dff;
      font-weight: 500;
    }

    .chat-history-item-title {
      font-size: 14px;
      font-weight: 500;
      color: #1f2937;
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .chat-history-item-time {
      font-size: 12px;
      color: #6b7280;
    }

    .chat-history-item-actions {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      opacity: 0;
      transition: opacity 0.2s;
    }

    .chat-history-item:hover .chat-history-item-actions {
      opacity: 1;
    }

    .delete-btn {
      background: none;
      border: none;
      color: #ef4444;
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
    }

    .delete-btn:hover {
      background: #fef2f2;
    }

    /* ä¸»èŠå¤©åŒºåŸŸ */
    .chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      height: 100vh;
      position: relative;
    }

    .floating-header-actions {
      position: fixed;
      top: 5px;
      right: 24px;
      display: flex;
      align-items: center;
      gap: 12px;
      z-index: 100;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 12px;
      padding: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(229, 231, 235, 0.5);
    }

    .settings-btn {
      width: 40px;
      height: 40px;
      border: none;
      background: #f3f4f6;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .settings-btn:hover {
      background: #e5e7eb;
    }

    .settings-btn svg {
      width: 20px;
      height: 20px;
      color: #6b7280;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 24px 24px 24px 24px;
      background: #f7f8fa;
      margin-top: 40px;
    }

    .message {
      margin-bottom: 24px;
      display: flex;
      gap: 12px;
    }

    .message.user {
      flex-direction: row-reverse;
    }

    .message-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 600;
      flex-shrink: 0;
    }

    .message.user .message-avatar {
      background: #165dff;
      color: white;
    }

    .message.assistant .message-avatar {
      background: #10b981;
      color: white;
    }

    /* åŠ è½½åŠ¨ç”»æ ·å¼ */
    .loading-avatar {
      background: #10b981 !important;
      color: white !important;
      position: relative;
      overflow: hidden;
    }

    .loading-avatar::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.6), transparent);
      animation: loading-shimmer 2s infinite;
    }

    @keyframes loading-shimmer {
      0% {
        left: -100%;
      }
      100% {
        left: 100%;
      }
    }

    /* è„‰å†²åŠ¨ç”» */
    .loading-avatar {
      animation: loading-pulse 2s infinite ease-in-out;
    }

    @keyframes loading-pulse {
      0%, 100% {
        transform: scale(1);
        opacity: 1;
      }
      50% {
        transform: scale(1.05);
        opacity: 0.8;
      }
    }

    .loading-dots {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 3px;
    }

    .loading-dots::before,
    .loading-dots::after {
      content: '';
      width: 5px;
      height: 5px;
      border-radius: 50%;
      background: currentColor;
      animation: loading-bounce 1.4s infinite ease-in-out both;
    }

    .loading-dots::before {
      animation-delay: -0.32s;
    }

    .loading-dots::after {
      animation-delay: -0.16s;
    }

    @keyframes loading-bounce {
      0%, 80%, 100% {
        transform: scale(0);
        opacity: 0.5;
      }
      40% {
        transform: scale(1);
        opacity: 1;
      }
    }

    /* æ€è€ƒåŠ¨ç”» - ç‚¹ç‚¹åŠ¨ç”» */
    .thinking-dots {
      display: inline-block;
      animation: thinking-blink 1.4s infinite;
    }

    @keyframes thinking-blink {
      0%, 20% { opacity: 0.2; }
      40% { opacity: 1; }
      60%, 100% { opacity: 0.2; }
    }

    /* åŠ è½½æ¶ˆæ¯çš„æ ·å¼ */
    .loading-message .message-content {
      background: #f3f4f6;
      color: #6b7280;
      font-style: italic;
    }

    .message-content {
      max-width: 75%;
      padding: 12px 16px;
      border-radius: 12px;
      font-size: 14px;
      line-height: 1.5;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }

    .message.assistant .message-content {
      max-width: 80%;
    }

    .message.user .message-content {
      background: #165dff;
      color: white;
      border-bottom-right-radius: 4px;
    }

    .message.assistant .message-content {
      background: #ffffff;
      color: #1f2937;
      border: 1px solid #e5e7eb;
      border-bottom-left-radius: 4px;
    }

    /* Markdownæ ·å¼ */
    .message-content h1,
    .message-content h2,
    .message-content h3,
    .message-content h4,
    .message-content h5,
    .message-content h6 {
      margin-top: 16px;
      margin-bottom: 8px;
      font-weight: 600;
      line-height: 1.25;
    }

    .message-content h1 {
      font-size: 1.5em;
      border-bottom: 2px solid #e5e7eb;
      padding-bottom: 8px;
    }

    .message-content h2 {
      font-size: 1.3em;
      border-bottom: 1px solid #e5e7eb;
      padding-bottom: 6px;
    }

    .message-content h3 {
      font-size: 1.15em;
    }

    .message-content ul,
    .message-content ol {
      margin: 12px 0;
      padding-left: 24px;
    }

    .message-content li {
      margin: 6px 0;
      line-height: 1.6;
    }

    .message-content p {
      margin: 8px 0;
      line-height: 1.6;
    }

    .message-content code {
      background: #f3f4f6;
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
      font-size: 0.9em;
      color: #e83e8c;
    }

    .message-content pre {
      background: #f6f8fa;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      padding: 12px;
      margin: 12px 0;
      overflow-x: auto;
    }

    .message-content pre code {
      background: transparent;
      padding: 0;
      color: inherit;
      font-size: 0.875em;
      line-height: 1.5;
    }

    .message-content blockquote {
      border-left: 4px solid #165dff;
      padding-left: 12px;
      margin: 12px 0;
      color: #6b7280;
      font-style: italic;
    }

    .message-content a {
      color: #165dff;
      text-decoration: none;
    }

    .message-content a:hover {
      text-decoration: underline;
    }

    .message-content strong {
      font-weight: 600;
      color: #1f2937;
    }

    .message-content em {
      font-style: italic;
    }

    .message-content table {
      border-collapse: collapse;
      width: 100%;
      margin: 12px 0;
    }

    .message-content table th,
    .message-content table td {
      border: 1px solid #e5e7eb;
      padding: 8px 12px;
      text-align: left;
    }

    .message-content table th {
      background: #f3f4f6;
      font-weight: 600;
    }

    .message-content hr {
      border: none;
      border-top: 2px solid #e5e7eb;
      margin: 16px 0;
    }

    /* ä¼˜åŒ–é¦–å°¾å…ƒç´ è¾¹è· */
    .message-content > *:first-child {
      margin-top: 0 !important;
    }

    .message-content > *:last-child {
      margin-bottom: 0 !important;
    }

    /* ä»£ç å¤åˆ¶æŒ‰é’®æ ·å¼ */
    .message-content pre {
      position: relative;
    }

    .chat-input-container {
      padding: 20px 24px;
      background: #ffffff;
      border-top: 1px solid #e5e7eb;
      transition: all 0.3s ease;
    }

    .chat-input-container.centered {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 90%;
      max-width: 800px;
      background: transparent;
      border-top: none;
      z-index: 10;
    }

    .chat-input-container.centered::before {
      content: "ç™¾å®¶AI: é›†ä¼—äººä¹‹æ™º";
      display: block;
      text-align: center;
      font-size: 24px;
      font-weight: 700;
      color: #165dff;
      margin-bottom: 16px;
      letter-spacing: 2px;
    }

    .chat-input-container.centered .chat-input {
      background: #ffffff;
      border: 2px solid #e5e7eb;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .chat-input-container.centered .chat-input:focus {
      border-color: #165dff;
      box-shadow: 0 0 0 3px rgba(22, 93, 255, 0.1), 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .chat-input-wrapper {
      position: relative;
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }


    .model-label {
      font-size: 12px;
      color: #6b7280;
      font-weight: 500;
    }

    .ai-model-selector {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      padding: 6px 10px;
      font-size: 12px;
      color: #374151;
      cursor: pointer;
      transition: all 0.2s;
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      min-width: 100px;
      font-weight: 500;
    }

    .ai-model-selector:hover {
      background: #e5e7eb;
      border-color: #9ca3af;
    }

    .ai-model-selector:focus {
      outline: none;
      border-color: #165dff;
      box-shadow: 0 0 0 2px rgba(22, 93, 255, 0.1);
    }

    .shared-memory-btn {
      background: #f9fafb;
      color: #374151;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      padding: 6px 12px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
    }

    .shared-memory-btn:hover {
      background: #e5e7eb;
      border-color: #9ca3af;
    }

    .shared-memory-btn:focus {
      outline: none;
      border-color: #165dff;
      box-shadow: 0 0 0 2px rgba(22, 93, 255, 0.1);
    }

    .shared-memory-btn.active {
      background: #dbeafe;
      color: #1e40af;
      border-color: #93c5fd;
    }

    .shared-memory-btn.active:hover {
      background: #bfdbfe;
      border-color: #60a5fa;
    }

    .chat-input {
      flex: 1;
      min-height: 120px;
      max-height: 250px;
      padding: 16px 16px 70px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 16px;
      font-size: 16px;
      line-height: 1.6;
      resize: vertical;
      outline: none;
      transition: all 0.3s;
      font-family: inherit;
      background: #ffffff;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      width: 100%;
    }

    .chat-input:focus {
      border-color: #165dff;
      box-shadow: 0 0 0 3px rgba(22, 93, 255, 0.1), 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .input-bottom-controls {
      position: absolute;
      bottom: 12px;
      left: 12px;
      right: 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 8px;
      padding: 8px 12px;
      border: 1px solid rgba(229, 231, 235, 0.5);
    }

    .input-controls-inner {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .send-btn, .stop-btn {
      width: 36px;
      height: 36px;
      border: none;
      color: white;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      flex-shrink: 0;
    }

    .send-btn {
      background: #165dff;
      box-shadow: 0 2px 8px rgba(22, 93, 255, 0.3);
    }
    
    .stop-btn {
      background: #ef4444;
      box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
      display: none;
    }
    
    .stop-btn.show {
      display: flex;
    }
    
    /* å½“å‘é€æŒ‰é’®éšè—æ—¶ï¼ˆAIå›å¤è¿‡ç¨‹ä¸­ï¼‰ */
    .send-btn.hidden {
      display: none;
    }

    .send-btn:hover {
      background: #0f4cd1;
    }
    
    .stop-btn:hover {
      background: #dc2626;
    }

    .send-btn:disabled {
      background: #d1d5db;
      cursor: not-allowed;
      opacity: 0.5;
    }
    
    .send-btn:disabled:hover {
      background: #d1d5db;
    }

    .send-btn svg, .stop-btn svg {
      width: 16px;
      height: 16px;
    }

    /* ç™»å½•å¼¹çª— */
    .login-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      backdrop-filter: blur(8px);
    }

    .login-modal.show {
      display: flex;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    .login-content {
      background: white;
      border-radius: 16px;
      width: 90%;
      max-width: 420px;
      padding: 40px;
      box-shadow: 0 24px 48px rgba(0, 0, 0, 0.2);
      animation: slideUp 0.4s ease;
    }

    @keyframes slideUp {
      from {
        transform: translateY(30px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .login-header {
      text-align: center;
      margin-bottom: 32px;
    }

    .login-logo {
      width: 64px;
      height: 64px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 16px;
      margin: 0 auto 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
    }

    .login-title {
      font-size: 24px;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 8px;
    }

    .login-subtitle {
      font-size: 14px;
      color: #6b7280;
    }

    .login-form {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .login-input-group {
      position: relative;
    }

    .login-input {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      font-size: 15px;
      transition: all 0.3s;
      background: #f9fafb;
    }

    .login-input:focus {
      outline: none;
      border-color: #667eea;
      background: white;
      box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
    }

    .login-input::placeholder {
      color: #9ca3af;
    }

    .login-btn {
      width: 100%;
      padding: 14px 16px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      margin-top: 8px;
    }

    .login-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(102, 126, 234, 0.4);
    }

    .login-btn:active {
      transform: translateY(0);
    }

    .login-footer {
      text-align: center;
      margin-top: 24px;
      font-size: 13px;
      color: #6b7280;
    }

    /* è®¾ç½®å¼¹çª— */
    .settings-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .settings-modal.show {
      display: flex;
    }

    .settings-content {
      background: white;
      border-radius: 12px;
      width: 90%;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    }

    .settings-header {
      padding: 24px 24px 0 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid #e5e7eb;
      margin-bottom: 24px;
    }

    .settings-title {
      font-size: 20px;
      font-weight: 600;
      color: #1f2937;
    }

    .close-btn {
      width: 32px;
      height: 32px;
      border: none;
      background: #f3f4f6;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .close-btn:hover {
      background: #e5e7eb;
    }

    .settings-body {
      padding: 0 24px 24px 24px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #374151;
      margin-bottom: 8px;
    }

    .form-input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 14px;
      transition: border-color 0.2s;
    }

    .form-input:focus {
      outline: none;
      border-color: #165dff;
      box-shadow: 0 0 0 3px rgba(22, 93, 255, 0.1);
    }

    .slider-container {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .slider {
      flex: 1;
      height: 4px;
      background: #d1d5db;
      border-radius: 2px;
      outline: none;
      -webkit-appearance: none;
    }

    .slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 16px;
      height: 16px;
      background: #165dff;
      border-radius: 50%;
      cursor: pointer;
    }

    .slider::-moz-range-thumb {
      width: 16px;
      height: 16px;
      background: #165dff;
      border-radius: 50%;
      cursor: pointer;
      border: none;
    }

    .slider-value {
      min-width: 40px;
      text-align: center;
      font-weight: 500;
      color: #165dff;
    }

    .save-btn {
      width: 100%;
      padding: 12px;
      background: #165dff;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }

    .save-btn:hover {
      background: #0f4cd1;
    }

    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: #6b7280;
      text-align: center;
    }

    .empty-state svg {
      width: 64px;
      height: 64px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .empty-state h3 {
      font-size: 18px;
      font-weight: 500;
      margin-bottom: 8px;
    }

    .empty-state p {
      font-size: 14px;
    }

    /* è®°å¿†å¼¹çª—æ ·å¼ */
    .memory-tabs {
      display: flex;
      border-bottom: 1px solid #e5e7eb;
      margin-bottom: 20px;
    }

    .memory-tab {
      flex: 1;
      padding: 12px 16px;
      background: none;
      border: none;
      border-bottom: 2px solid transparent;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      color: #6b7280;
      transition: all 0.2s;
    }

    .memory-tab.active {
      color: #165dff;
      border-bottom-color: #165dff;
    }

    .memory-tab:hover {
      color: #165dff;
    }

    .memory-panel {
      display: none;
    }

    .memory-panel.active {
      display: block;
    }

    .memory-list {
      max-height: 400px;
      overflow-y: auto;
    }

    .memory-item {
      padding: 16px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      margin-bottom: 12px;
      background: #f9fafb;
    }

    .memory-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .memory-item-time {
      font-size: 12px;
      color: #6b7280;
    }

    .memory-item-conversation {
      font-size: 12px;
      color: #165dff;
      background: #eef2ff;
      padding: 2px 8px;
      border-radius: 4px;
    }

    .memory-item-content {
      margin-bottom: 8px;
    }

    .memory-item-user {
      font-weight: 500;
      color: #1f2937;
      margin-bottom: 4px;
    }

    .memory-item-assistant {
      color: #4b5563;
      line-height: 1.5;
    }

    /* è®°å¿†ç±»å‹é€‰æ‹©å™¨æ ·å¼ */
    .memory-type-selector {
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .memory-type-selector label {
      font-size: 14px;
      font-weight: 500;
      color: #374151;
    }

    .memory-type-select {
      padding: 8px 12px;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      background: #ffffff;
      font-size: 14px;
      color: #374151;
      cursor: pointer;
      transition: all 0.2s;
      min-width: 120px;
    }

    .memory-type-select:hover {
      border-color: #9ca3af;
    }

    .memory-type-select:focus {
      outline: none;
      border-color: #165dff;
      box-shadow: 0 0 0 2px rgba(22, 93, 255, 0.1);
    }

    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 768px) {
      .sidebar {
        width: 100%;
        position: absolute;
        z-index: 100;
        transform: translateX(-100%);
        transition: transform 0.3s;
      }

      .sidebar.open {
        transform: translateX(0);
      }

      .chat-container {
        width: 100%;
      }

      .message-content {
        max-width: 85%;
      }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- å·¦ä¾§è¾¹æ  -->
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <button class="new-chat-btn" id="newChatBtn">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 5v14M5 12h14"/>
          </svg>
          æ–°å»ºå¯¹è¯
        </button>
      </div>
      <div class="chat-history" id="chatHistory">
        <!-- å†å²èŠå¤©åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
      </div>
    </div>

    <!-- ä¸»èŠå¤©åŒºåŸŸ -->
    <div class="chat-container">
      <!-- æ‚¬æµ®çš„å¤´éƒ¨æŒ‰é’® -->
      <div class="floating-header-actions">
        <button class="settings-btn" id="memoryBtn" title="è®°å¿†ä»ªè¡¨ç›˜">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 12l2 2 4-4"/>
            <path d="M21 12c.552 0 1-.448 1-1V5c0-.552-.448-1-1-1H3c-.552 0-1 .448-1 1v6c0 .552.448 1 1 1h18z"/>
            <path d="M3 12v6c0 .552.448 1 1 1h16c.552 0 1-.448 1-1v-6H3z"/>
          </svg>
        </button>
        <button class="settings-btn" id="settingsBtn" title="è®¾ç½®">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="3"/>
            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1 1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
          </svg>
        </button>
      </div>

      <div class="chat-messages" id="chatMessages">
        <div class="empty-state">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
          </svg>
          <h3>å¼€å§‹æ–°çš„å¯¹è¯</h3>
          <p>åœ¨ä¸‹æ–¹è¾“å…¥æ¡†ä¸­è¾“å…¥æ‚¨çš„é—®é¢˜ï¼Œå¼€å§‹ä¸Memory OSå¯¹è¯</p>
        </div>
      </div>

      <div class="chat-input-container">
        <div class="chat-input-wrapper">
          <div style="position: relative;">
            <textarea 
              class="chat-input" 
              id="chatInput" 
              placeholder="å°½ç®¡é—®..."
              rows="4"
            ></textarea>
            <div class="input-bottom-controls">
              <div class="input-controls-inner">
                <label class="model-label" for="aiModelSelector">AIæ¨¡å‹:</label>
                <select class="ai-model-selector" id="aiModelSelector">
                  <option value="gpt-4o-mini">GPT-4o Mini</option>
                  <option value="doubao-seed-1-6-thinking-250715">Doubao Seed 1.6 Thinking</option>
                  <option value="qwen-turbo">Qwen Turbo</option>
                  <option value="gpt-5-chat-latest">GPT-5 Chat</option>
                </select>
                <button class="shared-memory-btn" id="sharedMemoryBtn">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                    <circle cx="9" cy="7" r="4"/>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                  </svg>
                  å¼€å¯è®°å¿†
                </button>
              </div>
              <button class="send-btn" id="sendBtn">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="22" y1="2" x2="11" y2="13"/>
                  <polygon points="22,2 15,22 11,13 2,9 22,2"/>
                </svg>
              </button>
              <button class="stop-btn" id="stopBtn">
                <svg viewBox="0 0 24 24" fill="currentColor">
                  <rect x="6" y="6" width="12" height="12" rx="1"/>
                </svg>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ç™»å½•å¼¹çª— -->
  <div class="login-modal" id="loginModal">
    <div class="login-content">
      <div class="login-header">
        <div class="login-logo">ğŸ§ </div>
        <h2 class="login-title">æ¬¢è¿ä½¿ç”¨ Memory OS</h2>
        <p class="login-subtitle">è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ç™»å½•</p>
      </div>
      <form class="login-form" id="loginForm">
        <div class="login-input-group">
          <input 
            type="text" 
            class="login-input" 
            id="loginUsername" 
            placeholder="è¯·è¾“å…¥ç”¨æˆ·å"
            autocomplete="username"
            required
          />
        </div>
        <div class="login-input-group">
          <input 
            type="password" 
            class="login-input" 
            id="loginPassword" 
            placeholder="è¯·è¾“å…¥å¯†ç "
            autocomplete="current-password"
            required
          />
        </div>
        <button type="submit" class="login-btn" id="loginSubmitBtn">
          ç™»å½•
        </button>
      </form>
      <div class="login-footer" id="loginError" style="color: #ef4444; display: none; margin-top: 12px;">
      </div>

    </div>
  </div>

  <!-- è®¾ç½®å¼¹çª— -->
  <div class="settings-modal" id="settingsModal">
    <div class="settings-content">
      <div class="settings-header">
        <h2 class="settings-title">è®¾ç½®</h2>
        <button class="close-btn" id="closeSettingsBtn">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>
      <div class="settings-body">
        <form id="settingsForm">
          <div class="form-group">
            <label class="form-label" for="openaiApiKey">OpenAI API Key</label>
            <input type="password" class="form-input" id="openaiApiKey" name="openai_api_key" placeholder="è¯·è¾“å…¥OpenAI API Key" />
          </div>
          
          <div class="form-group">
            <label class="form-label" for="openaiBaseUrl">OpenAI Base URL</label>
            <input type="text" class="form-input" id="openaiBaseUrl" name="openai_base_url" placeholder="https://api.openai.com/v1" />
          </div>
          
          <button type="submit" class="save-btn">ä¿å­˜è®¾ç½®</button>
        </form>
      </div>
    </div>
  </div>

  <!-- è®°å¿†æŸ¥çœ‹å¼¹çª— -->
  <div class="settings-modal" id="memoryModal">
    <div class="settings-content">
      <div class="settings-header">
        <h2 class="settings-title">è®°å¿†æŸ¥çœ‹</h2>
        <button class="close-btn" id="closeMemoryBtn">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>
      <div class="settings-body">
        <div class="memory-tabs">
          <button class="memory-tab active" id="personalMemoryTab">ä¸ªäººè®°å¿†</button>
          <button class="memory-tab" id="sharedMemoryTab">å…±äº«è®°å¿†</button>
        </div>
        <div class="memory-content">
          <div id="personalMemoryContent" class="memory-panel active">
            <div class="memory-type-selector">
              <label for="memoryTypeSelect">è®°å¿†ç±»å‹ï¼š</label>
              <select id="memoryTypeSelect" class="memory-type-select">
                <option value="short">çŸ­æœŸè®°å¿†</option>
                <option value="mid">ä¸­æœŸè®°å¿†</option>
                <option value="long">é•¿æœŸè®°å¿†</option>
              </select>
            </div>
            <div class="memory-list" id="personalMemoryList">
              <!-- ä¸ªäººè®°å¿†åˆ—è¡¨å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>
          </div>
          <div id="sharedMemoryContent" class="memory-panel">
            <div class="memory-list" id="sharedMemoryList">
              <!-- å…±äº«è®°å¿†æš‚æ—¶ä¸ºç©º -->
              <div class="empty-state">å…±äº«è®°å¿†åŠŸèƒ½æš‚æœªå¼€æ”¾</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // å…¨å±€å˜é‡
    let currentChatId = null;
    let chatHistory = [];
    let currentUsername = null;
    let selectedModel = 'gpt-4o-mini';
    let sharedMemoryEnabled = true;  // é»˜è®¤å¼€å¯å…±äº«è®°å¿†
    let personalMemoryEnabled = true;  // ä¸ªäººè®°å¿†é»˜è®¤å¯ç”¨
    let currentAbortController = null;  // ç”¨äºç»ˆæ­¢å½“å‰è¯·æ±‚

    // DOMå…ƒç´ 
    const sidebar = document.getElementById('sidebar');
    const chatHistoryContainer = document.getElementById('chatHistory');
    const chatMessages = document.getElementById('chatMessages');
    const chatInput = document.getElementById('chatInput');
    const sendBtn = document.getElementById('sendBtn');
    const stopBtn = document.getElementById('stopBtn');
    const newChatBtn = document.getElementById('newChatBtn');
    const settingsBtn = document.getElementById('settingsBtn');
    const settingsModal = document.getElementById('settingsModal');
    const closeSettingsBtn = document.getElementById('closeSettingsBtn');
    const settingsForm = document.getElementById('settingsForm');
    const aiModelSelector = document.getElementById('aiModelSelector');
    const memoryBtn = document.getElementById('memoryBtn');
    const memoryModal = document.getElementById('memoryModal');
    const closeMemoryBtn = document.getElementById('closeMemoryBtn');
    const personalMemoryTab = document.getElementById('personalMemoryTab');
    const sharedMemoryTab = document.getElementById('sharedMemoryTab');
    const memoryTypeSelect = document.getElementById('memoryTypeSelect');
    const personalMemoryContent = document.getElementById('personalMemoryContent');
    const sharedMemoryContent = document.getElementById('sharedMemoryContent');
    const personalMemoryList = document.getElementById('personalMemoryList');
    const sharedMemoryList = document.getElementById('sharedMemoryList');
    const sharedMemoryBtn = document.getElementById('sharedMemoryBtn');
    const loginModal = document.getElementById('loginModal');
    const loginForm = document.getElementById('loginForm');
    const loginUsername = document.getElementById('loginUsername');
    const loginPassword = document.getElementById('loginPassword');
    const loginSubmitBtn = document.getElementById('loginSubmitBtn');
    const loginError = document.getElementById('loginError');

    // ğŸ”’ ç™»å½•çŠ¶æ€æ ‡å¿—
    let isLoggedIn = false;

    // åˆå§‹åŒ–Markdownæ¸²æŸ“å™¨
    function initializeMarkdown() {
      if (typeof marked !== 'undefined') {
        marked.setOptions({
          breaks: true,
          gfm: true,
          headerIds: false,
          mangle: false,
          sanitize: false
        });
        console.log('âœ… Markdownæ¸²æŸ“å™¨åˆå§‹åŒ–å®Œæˆ');
      }
      
      if (typeof hljs !== 'undefined') {
        console.log('âœ… ä»£ç é«˜äº®åˆå§‹åŒ–å®Œæˆ');
      }
    }

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
      initializeMarkdown();
      checkLoginStatus(); // ğŸ”’ å…ˆæ£€æŸ¥ç™»å½•çŠ¶æ€
      initializeApp();
      initializeSharedMemoryButton();
      setupEventListeners();
      setupLoginHandlers(); // ğŸ”’ è®¾ç½®ç™»å½•ç›¸å…³äº‹ä»¶
    });

    // ğŸ”’ æ£€æŸ¥ç™»å½•çŠ¶æ€
    function checkLoginStatus() {
      const savedUsername = localStorage.getItem('username');
      if (savedUsername) {
        currentUsername = savedUsername;
        isLoggedIn = true;
        console.log('âœ… ç”¨æˆ·å·²ç™»å½•:', currentUsername);
      } else {
        // æœªç™»å½•ï¼Œæ˜¾ç¤ºç™»å½•å¼¹çª—
        showLoginModal();
      }
    }

    // ğŸ”’ æ˜¾ç¤ºç™»å½•å¼¹çª—
    function showLoginModal() {
      loginModal.classList.add('show');
      loginUsername.focus();
    }

    // ğŸ”’ éšè—ç™»å½•å¼¹çª—
    function hideLoginModal() {
      loginModal.classList.remove('show');
    }

    // ğŸ”’ å¤„ç†ç™»å½•
    async function handleLogin(username, password) {
      if (!username || username.trim() === '') {
        showLoginError('è¯·è¾“å…¥ç”¨æˆ·å');
        return false;
      }
      
      if (!password || password.trim() === '') {
        showLoginError('è¯·è¾“å…¥å¯†ç ');
        return false;
      }
      
      // ç¦ç”¨ç™»å½•æŒ‰é’®ï¼Œæ˜¾ç¤ºåŠ è½½çŠ¶æ€
      loginSubmitBtn.disabled = true;
      loginSubmitBtn.textContent = 'ç™»å½•ä¸­...';
      hideLoginError();
      
      try {
        // è°ƒç”¨åç«¯éªŒè¯API
        const response = await fetch('http://127.0.0.1:5002/api/login', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            username: username.trim(),
            password: password.trim()
          })
        });
        
        const data = await response.json();
        
        if (data.success) {
          // ç™»å½•æˆåŠŸ
          currentUsername = username.trim();
          localStorage.setItem('username', currentUsername);
          isLoggedIn = true;
          
          hideLoginModal();
          
          // ç™»å½•æˆåŠŸååˆå§‹åŒ–åº”ç”¨
          loadUserConfig();
          loadChatHistory();
          showNewChatInterface();
          
          console.log('âœ… ç™»å½•æˆåŠŸ:', currentUsername);
          
          // é‡ç½®è¡¨å•
          loginUsername.value = '';
          loginPassword.value = '';
          
          return true;
        } else {
          // ç™»å½•å¤±è´¥
          showLoginError(data.error || 'ç™»å½•å¤±è´¥');
          loginPassword.value = ''; // æ¸…ç©ºå¯†ç 
          loginPassword.focus();
          return false;
        }
      } catch (error) {
        console.error('ç™»å½•è¯·æ±‚å¤±è´¥:', error);
        showLoginError('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
        return false;
      } finally {
        // æ¢å¤ç™»å½•æŒ‰é’®çŠ¶æ€
        loginSubmitBtn.disabled = false;
        loginSubmitBtn.textContent = 'ç™»å½•';
      }
    }
    
    // ğŸ”’ æ˜¾ç¤ºç™»å½•é”™è¯¯
    function showLoginError(message) {
      loginError.textContent = message;
      loginError.style.display = 'block';
    }
    
    // ğŸ”’ éšè—ç™»å½•é”™è¯¯
    function hideLoginError() {
      loginError.style.display = 'none';
      loginError.textContent = '';
    }

    // ğŸ”’ è®¾ç½®ç™»å½•ç›¸å…³äº‹ä»¶å¤„ç†
    function setupLoginHandlers() {
      // ç™»å½•è¡¨å•æäº¤
      loginForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const username = loginUsername.value;
        const password = loginPassword.value;
        await handleLogin(username, password);
      });

      // é˜»æ­¢ç‚¹å‡»èƒŒæ™¯å…³é—­ç™»å½•å¼¹çª—
      loginModal.addEventListener('click', function(e) {
        if (e.target === loginModal && !isLoggedIn) {
          // æœªç™»å½•æ—¶ä¸å…è®¸å…³é—­
          loginUsername.focus();
        }
      });
    }

    // ğŸ”’ æ£€æŸ¥æ˜¯å¦éœ€è¦ç™»å½•ï¼ˆåŠŸèƒ½æ‹¦æˆªï¼‰
    function requireLogin() {
      if (!isLoggedIn) {
        showLoginModal();
        return false;
      }
      return true;
    }

    // åˆå§‹åŒ–åº”ç”¨
    function initializeApp() {
      // åªæœ‰ç™»å½•åæ‰æ‰§è¡Œ
      if (!isLoggedIn) {
        console.log('âš ï¸ æœªç™»å½•ï¼Œç­‰å¾…ç”¨æˆ·ç™»å½•...');
        return;
      }
      
      // åŠ è½½ç”¨æˆ·é…ç½®å’ŒèŠå¤©å†å²
      loadUserConfig();
      loadChatHistory();
      
      // æ£€æŸ¥ç”¨æˆ·é…ç½®
      checkUserConfig();
    }
    
    // æ£€æŸ¥ç”¨æˆ·é…ç½®
    async function checkUserConfig() {
      if (!currentUsername) return;
      
      try {
        const configResponse = await fetch(`http://127.0.0.1:5002/chat/users/${currentUsername}/config.json`);
        if (configResponse.ok) {
          const config = await configResponse.json();
          if (!config.openai_api_key || config.openai_api_key.trim() === '') {
            // å¦‚æœæ²¡æœ‰é…ç½®API Keyï¼Œè‡ªåŠ¨æ‰“å¼€è®¾ç½®çª—å£
            setTimeout(() => {
              alert('è¯·å…ˆé…ç½®OpenAI API Keyæ‰èƒ½å¼€å§‹èŠå¤©');
              openSettings();
            }, 1000);
          }
        } else {
          // å¦‚æœé…ç½®æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè‡ªåŠ¨æ‰“å¼€è®¾ç½®çª—å£
          setTimeout(() => {
            alert('è¯·å…ˆè¿›è¡ŒåŸºæœ¬é…ç½®æ‰èƒ½å¼€å§‹èŠå¤©');
            openSettings();
          }, 1000);
        }
      } catch (error) {
        console.error('æ£€æŸ¥ç”¨æˆ·é…ç½®å¤±è´¥:', error);
      }
    }

    // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
    function setupEventListeners() {
      // å‘é€æ¶ˆæ¯
      sendBtn.addEventListener('click', sendMessage);
      
      // åœæ­¢ç”Ÿæˆ
      stopBtn.addEventListener('click', stopGeneration);
      
      // è¾“å…¥æ¡†ç„¦ç‚¹æ‹¦æˆª
      chatInput.addEventListener('focus', function(e) {
        if (!requireLogin()) {
          e.target.blur(); // ç§»é™¤ç„¦ç‚¹
        }
      });

      chatInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      // æ–°å»ºå¯¹è¯
      newChatBtn.addEventListener('click', createNewChat);

      // è®¾ç½®ç›¸å…³
      settingsBtn.addEventListener('click', openSettings);
      closeSettingsBtn.addEventListener('click', closeSettings);
      settingsModal.addEventListener('click', function(e) {
        if (e.target === settingsModal) {
          closeSettings();
        }
      });

      // è®°å¿†ç›¸å…³ - è·³è½¬åˆ°dashboardé¡µé¢
      memoryBtn.addEventListener('click', function() {
        // ğŸ”’ ç™»å½•æ‹¦æˆª
        if (!requireLogin()) return;
        
        // ç¡®ä¿ç”¨æˆ·åå·²ä¿å­˜åˆ° localStorage
        localStorage.setItem('username', currentUsername);
        // è·³è½¬åˆ° dashboard
        window.location.href = '/dashboard';
      });

      // è®°å¿†æ ‡ç­¾é¡µåˆ‡æ¢
      personalMemoryTab.addEventListener('click', () => switchMemoryTab('personal'));
      sharedMemoryTab.addEventListener('click', () => switchMemoryTab('shared'));
      
      // è®°å¿†ç±»å‹é€‰æ‹©å™¨
      memoryTypeSelect.addEventListener('change', loadPersonalMemory);

      // è¡¨å•æäº¤
      settingsForm.addEventListener('submit', saveSettings);

      // AIæ¨¡å‹é€‰æ‹©å™¨
      aiModelSelector.addEventListener('change', function() {
        selectedModel = this.value;
        console.log('é€‰æ‹©çš„AIæ¨¡å‹:', selectedModel);
      });

      // å…±äº«è®°å¿†æŒ‰é’®
      sharedMemoryBtn.addEventListener('click', toggleSharedMemory);
    }

    // åœæ­¢ç”Ÿæˆ
    function stopGeneration() {
      if (currentAbortController) {
        console.log('ğŸ›‘ ç”¨æˆ·ç»ˆæ­¢AIå›å¤');
        currentAbortController.abort();
        currentAbortController = null;
        
        // ç«‹å³æ¸…ç†æ‰€æœ‰ç›¸å…³çŠ¶æ€
        sendBtn.classList.remove('hidden');
        sendBtn.disabled = false;
        stopBtn.classList.remove('show');
        chatInput.focus();
        
        // æ·»åŠ ä¸€æ¡æç¤ºæ¶ˆæ¯
        const lastMessage = chatMessages.lastElementChild;
        if (lastMessage && lastMessage.classList.contains('assistant')) {
          const messageContent = lastMessage.querySelector('.message-content');
          if (messageContent) {
            messageContent.innerHTML += '\n\n<em style="color: #6b7280; font-size: 0.9em;">ï¼ˆå›å¤å·²è¢«ç”¨æˆ·ç»ˆæ­¢ï¼‰</em>';
          }
        }
        
        // ç¡®ä¿UIçŠ¶æ€å®Œå…¨æ¢å¤ï¼Œå…è®¸ç«‹å³åˆ‡æ¢å¯¹è¯
        console.log('âœ… AIå›å¤çŠ¶æ€å·²å®Œå…¨æ¸…ç†ï¼Œå¯ä»¥ç«‹å³åˆ‡æ¢å¯¹è¯');
      }
    }

    // å‘é€æ¶ˆæ¯
    async function sendMessage() {
      // ğŸ”’ ç™»å½•æ‹¦æˆª
      if (!requireLogin()) return;
      
      // ğŸš« é˜²æ­¢åœ¨AIå›å¤æ—¶é‡å¤å‘é€ï¼ˆæ£€æŸ¥å‘é€æŒ‰é’®çŠ¶æ€ï¼‰
      if (sendBtn.disabled) {
        console.log('âš ï¸ AIæ­£åœ¨å›å¤ä¸­ï¼Œè¯·ç¨å€™...');
        return;
      }
      
      const message = chatInput.value.trim();
      if (!message) return;

      // è·å–é€‰æ‹©çš„æ¨¡å‹
      selectedModel = aiModelSelector.value;

      // åªæœ‰åœ¨æ²¡æœ‰å½“å‰å¯¹è¯æ—¶æ‰åˆ›å»ºæ–°å¯¹è¯ï¼ˆé€šå¸¸å‘ç”Ÿåœ¨é¦–æ¬¡ä½¿ç”¨æˆ–æ‰‹åŠ¨ç‚¹å‡»æ–°å»ºå¯¹è¯åï¼‰
      const isNewChat = !currentChatId;
      if (!currentChatId) {
        currentChatId = 'chat_' + Date.now();
        console.log('ğŸ†• è‡ªåŠ¨åˆ›å»ºæ–°å¯¹è¯:', currentChatId);
      }

      // æ¢å¤è¾“å…¥æ¡†åˆ°æ­£å¸¸ä½ç½®ï¼ˆå¦‚æœä¹‹å‰æ˜¯å±…ä¸­çš„ï¼‰
      restoreInputBox();
      
      // æ¸…é™¤ç©ºçŠ¶æ€ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
      clearEmptyState();
      
      // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°ç•Œé¢
      addMessageToUI('user', message);
      chatInput.value = '';
      chatInput.style.height = 'auto';

      // ğŸ”¥ å¦‚æœæ˜¯æ–°å¯¹è¯ï¼Œç«‹å³åœ¨å·¦ä¾§åˆ›å»ºå¯¹è¯é¡¹
      if (isNewChat) {
        addNewChatToSidebar(currentChatId, message);
      }

      // éšè—å‘é€æŒ‰é’®ï¼Œæ˜¾ç¤ºåœæ­¢æŒ‰é’®
      sendBtn.disabled = true;
      sendBtn.classList.add('hidden');
      stopBtn.classList.add('show');
      
      // åˆ›å»º AbortController ç”¨äºç»ˆæ­¢è¯·æ±‚
      currentAbortController = new AbortController();

      // ğŸ”¥ åˆ›å»ºæµå¼æ¶ˆæ¯UIï¼ˆå–ä»£åŠ è½½æ¶ˆæ¯ï¼‰
      const streamingMessageDiv = createStreamingMessageUI();
      
      let responseCompleted = false; // è·Ÿè¸ªå“åº”æ˜¯å¦å·²å®Œæˆï¼Œéœ€è¦åœ¨finallyå—ä¸­è®¿é—®

      try {
        // ğŸ”¥ ä½¿ç”¨æµå¼APIï¼ˆåŸæ¥å£å·²æ”¹ä¸ºæµå¼è¾“å‡ºï¼‰
        const response = await fetch('http://127.0.0.1:5002/chat_direct', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            username: currentUsername,
            message: message,
            model: selectedModel,
            conversation_id: currentChatId,
            shared_memory_enabled: sharedMemoryEnabled,
            personal_memory_enabled: personalMemoryEnabled
          }),
          signal: currentAbortController.signal  // æ·»åŠ ç»ˆæ­¢ä¿¡å·
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        // ğŸ”¥ è¯»å–æµå¼å“åº”
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let fullResponse = '';
        let buffer = '';

        while (true) {
          const { done, value } = await reader.read();
          
          if (done) break;
          
          // è§£ç æ•°æ®å—
          buffer += decoder.decode(value, { stream: true });
          const lines = buffer.split('\n');
          
          // ä¿ç•™æœ€åä¸€ä¸ªå¯èƒ½ä¸å®Œæ•´çš„è¡Œ
          buffer = lines.pop() || '';
          
          for (const line of lines) {
            if (line.startsWith('data: ')) {
              try {
                const data = JSON.parse(line.substring(6));
                
                if (data.error) {
                  // æ˜¾ç¤ºé”™è¯¯
                  updateStreamingMessage(streamingMessageDiv, `é”™è¯¯: ${data.error}`, true);
                  break;
                }
                
                if (data.content) {
                  // ğŸ”¥ é€å­—æ·»åŠ å†…å®¹ï¼ˆç¬¬ä¸€ä¸ªå­—åˆ°è¾¾æ—¶ä¼šè‡ªåŠ¨æ¸…é™¤"æ­£åœ¨æ€è€ƒ"ï¼‰
                  fullResponse += data.content;
                  updateStreamingMessage(streamingMessageDiv, fullResponse, false);
                }
                
                if (data.done) {
                  console.log('âœ… æµå¼è¾“å‡ºå®Œæˆ');
                  // æœ€ç»ˆæ¸²æŸ“ï¼Œåº”ç”¨è¯­æ³•é«˜äº®
                  updateStreamingMessage(streamingMessageDiv, fullResponse, true);
                  
                  // ğŸš€ ç«‹å³æ˜¾ç¤ºå‘é€æŒ‰é’®ï¼Œéšè—åœæ­¢æŒ‰é’®
                  responseCompleted = true;
                  sendBtn.classList.remove('hidden');
                  sendBtn.disabled = false;
                  stopBtn.classList.remove('show');
                  currentAbortController = null;
                  chatInput.focus();
                  break; // è·³å‡ºå¾ªç¯ï¼Œç«‹å³ç»“æŸ
                }
                
                if (data.conversation_id) {
                  currentChatId = data.conversation_id;
                }
              } catch (e) {
                console.error('è§£æSSEæ•°æ®å¤±è´¥:', e, line);
              }
            }
          }
        }
        
        // å®Œæˆåæ›´æ–°å¯¹è¯å†å²
        updateChatHistoryWithoutInterruption();
        
      } catch (error) {
        // æ£€æŸ¥æ˜¯å¦æ˜¯ç”¨æˆ·ä¸»åŠ¨ç»ˆæ­¢
        if (error.name === 'AbortError') {
          console.log('âœ… è¯·æ±‚å·²è¢«ç”¨æˆ·ç»ˆæ­¢');
          // ä¸æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯ï¼Œå› ä¸ºè¿™æ˜¯ç”¨æˆ·ä¸»åŠ¨æ“ä½œ
          // ç»™åç«¯ä¸€äº›æ—¶é—´æ¥å®Œæˆä¿å­˜æ“ä½œ
          await new Promise(resolve => setTimeout(resolve, 100));
        } else {
          console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);
          updateStreamingMessage(streamingMessageDiv, 'æŠ±æ­‰ï¼Œå‘é€æ¶ˆæ¯æ—¶å‡ºç°é”™è¯¯ã€‚è¯·ç¨åé‡è¯•ã€‚', true);
        }
      } finally {
        // ç«‹å³é‡æ–°æ˜¾ç¤ºå‘é€æŒ‰é’®ï¼Œéšè—åœæ­¢æŒ‰é’®ï¼Œç¡®ä¿UIçŠ¶æ€å®Œå…¨æ¢å¤
        sendBtn.classList.remove('hidden');
        sendBtn.disabled = false;
        stopBtn.classList.remove('show');
        currentAbortController = null;
        
        // ç¡®ä¿UIå®Œå…¨å“åº”ï¼Œå…è®¸ç«‹å³åˆ‡æ¢å¯¹è¯
        console.log('âœ… sendMessageçŠ¶æ€å·²å®Œå…¨æ¸…ç†ï¼ŒUIå¯ç«‹å³å“åº”');
        chatInput.focus();
      }
    }

    // ğŸ”¥ åˆ›å»ºæµå¼æ¶ˆæ¯UI
    function createStreamingMessageUI() {
      const messageDiv = document.createElement('div');
      messageDiv.className = 'message assistant';
      
      const avatar = document.createElement('div');
      avatar.className = 'message-avatar';
      avatar.textContent = 'AI';
      
      const messageContent = document.createElement('div');
      messageContent.className = 'message-content';
      // ğŸ”¥ ç«‹å³æ˜¾ç¤º"æ­£åœ¨æ€è€ƒ..."
      messageContent.innerHTML = '<span style="color: #999; font-style: italic;">æ­£åœ¨æ€è€ƒ<span class="thinking-dots">...</span></span>';
      messageContent.style.opacity = '0.8';
      
      messageDiv.appendChild(avatar);
      messageDiv.appendChild(messageContent);
      
      chatMessages.appendChild(messageDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      
      return messageDiv;
    }

    // ğŸ”¥ æ›´æ–°æµå¼æ¶ˆæ¯å†…å®¹
    function updateStreamingMessage(messageDiv, content, isFinal = false) {
      const messageContent = messageDiv.querySelector('.message-content');
      
      if (isFinal) {
        // æœ€ç»ˆæ¸²æŸ“ï¼šä½¿ç”¨Markdown
        messageContent.style.opacity = '1';
        marked.setOptions({
          breaks: true,
          gfm: true,
          headerIds: false,
          mangle: false
        });
        
        messageContent.innerHTML = marked.parse(content);
        
        // åº”ç”¨è¯­æ³•é«˜äº®
        messageContent.querySelectorAll('pre code').forEach((block) => {
          hljs.highlightElement(block);
        });
      } else {
        // æµå¼è¾“å‡ºæ—¶ï¼šçº¯æ–‡æœ¬æ˜¾ç¤ºï¼ˆæ€§èƒ½æ›´å¥½ï¼‰
        // ğŸ”¥ ç¬¬ä¸€ä¸ªå­—åˆ°è¾¾æ—¶ï¼Œè‡ªåŠ¨æ¸…é™¤"æ­£åœ¨æ€è€ƒ"çŠ¶æ€
        messageContent.style.opacity = '1';
        messageContent.textContent = content;
      }
      
      // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // æ·»åŠ åŠ è½½æ¶ˆæ¯
    function addLoadingMessage() {
      const messageDiv = document.createElement('div');
      messageDiv.className = 'message assistant loading-message';
      messageDiv.id = `loading-${Date.now()}`; // ä½¿ç”¨æ—¶é—´æˆ³ä½œä¸ºå”¯ä¸€ID
      
      const avatar = document.createElement('div');
      avatar.className = 'message-avatar loading-avatar';
      avatar.innerHTML = '<span class="loading-dots"></span>';
      
      const messageContent = document.createElement('div');
      messageContent.className = 'message-content';
      messageContent.textContent = 'æ­£åœ¨æ€è€ƒ...';
      
      messageDiv.appendChild(avatar);
      messageDiv.appendChild(messageContent);
      
      chatMessages.appendChild(messageDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      
      // ç”±äºæ‰€æœ‰æ–‡æœ¬éƒ½æ˜¯ç›¸åŒçš„ï¼Œä¸éœ€è¦åŠ¨æ€åˆ‡æ¢
      // ä¿æŒé™æ€çš„"æ­£åœ¨æ€è€ƒ..."æ–‡æœ¬
      
      return messageDiv.id;
    }

    // ç§»é™¤åŠ è½½æ¶ˆæ¯
    function removeLoadingMessage(loadingMessageId) {
      const loadingMessage = document.getElementById(loadingMessageId);
      if (loadingMessage) {
        loadingMessage.remove();
      }
    }

    // æ·»åŠ æ¶ˆæ¯åˆ°UI
    function addMessageToUI(type, content) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${type}`;
      
      const avatar = document.createElement('div');
      avatar.className = 'message-avatar';
      avatar.textContent = type === 'user' ? 'U' : 'AI';
      
      const messageContent = document.createElement('div');
      messageContent.className = 'message-content';
      
      // AIæ¶ˆæ¯ä½¿ç”¨Markdownæ¸²æŸ“ï¼Œç”¨æˆ·æ¶ˆæ¯ä¿æŒçº¯æ–‡æœ¬
      if (type === 'assistant') {
        // é…ç½®markedé€‰é¡¹
        marked.setOptions({
          breaks: true,  // æ”¯æŒGFMæ¢è¡Œ
          gfm: true,     // å¯ç”¨GitHubé£æ ¼çš„Markdown
          headerIds: false,
          mangle: false
        });
        
        // æ¸²æŸ“Markdown
        messageContent.innerHTML = marked.parse(content);
        
        // å¯¹ä»£ç å—åº”ç”¨è¯­æ³•é«˜äº®
        messageContent.querySelectorAll('pre code').forEach((block) => {
          hljs.highlightElement(block);
        });
      } else {
        // ç”¨æˆ·æ¶ˆæ¯ä¿æŒçº¯æ–‡æœ¬
        messageContent.textContent = content;
      }
      
      messageDiv.appendChild(avatar);
      messageDiv.appendChild(messageContent);
      
      chatMessages.appendChild(messageDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // åˆ›å»ºæ–°å¯¹è¯
    function createNewChat() {
      // ğŸ”’ ç™»å½•æ‹¦æˆª
      if (!requireLogin()) return;
      
      // æ¸…é™¤å½“å‰èŠå¤©æ¶ˆæ¯
      chatMessages.innerHTML = '';
      
      // é‡ç½®å½“å‰å¯¹è¯IDä¸ºnullï¼Œè¿™æ ·ä¸‹æ¬¡å‘é€æ¶ˆæ¯æ—¶ä¼šè‡ªåŠ¨åˆ›å»ºæ–°å¯¹è¯
      currentChatId = null;
      
      // æ¸…ç©ºè¾“å…¥æ¡†
      chatInput.value = '';
      
      // å±…ä¸­è¾“å…¥æ¡†ï¼ˆæ–°å»ºå¯¹è¯æ—¶æ˜¾ç¤ºå±…ä¸­çŠ¶æ€ï¼‰
      centerInputBox();
      
      // æ˜¾ç¤ºç©ºçŠ¶æ€
      showEmptyState();
      
      // æ›´æ–°èŠå¤©å†å²
      updateChatHistoryWithoutInterruption();
      
      console.log('ğŸ†• å‡†å¤‡åˆ›å»ºæ–°å¯¹è¯ï¼Œç­‰å¾…ç”¨æˆ·è¾“å…¥');
    }

    // æ˜¾ç¤ºç©ºçŠ¶æ€
    function showEmptyState() {
      chatMessages.innerHTML = `
        <div class="empty-state">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
          </svg>
          <h3>å¼€å§‹æ–°çš„å¯¹è¯</h3>
          <p>åœ¨ä¸‹æ–¹è¾“å…¥æ¡†ä¸­è¾“å…¥æ‚¨çš„é—®é¢˜ï¼Œå¼€å§‹ä¸Memory OSå¯¹è¯</p>
        </div>
      `;
    }

    // å±…ä¸­è¾“å…¥æ¡†
    function centerInputBox() {
      const inputContainer = document.querySelector('.chat-input-container');
      inputContainer.classList.add('centered');
      setTimeout(() => {
        chatInput.focus();
      }, 100);
    }

    // æ¢å¤è¾“å…¥æ¡†åˆ°æ­£å¸¸ä½ç½®
    function restoreInputBox() {
      const inputContainer = document.querySelector('.chat-input-container');
      inputContainer.classList.remove('centered');
    }

    // æ¸…é™¤ç©ºçŠ¶æ€
    function clearEmptyState() {
      const emptyState = document.querySelector('.empty-state');
      if (emptyState) {
        emptyState.remove();
      }
    }

    // æ˜¾ç¤ºæ–°å»ºå¯¹è¯ç•Œé¢
    function showNewChatInterface() {
      // æ¸…ç©ºå½“å‰èŠå¤©ID
      currentChatId = null;
      
      // æ˜¾ç¤ºç©ºçŠ¶æ€
      showEmptyState();
      
      // å±…ä¸­è¾“å…¥æ¡†
      centerInputBox();
      
      // æ¸…é™¤æ‰€æœ‰æ´»è·ƒçŠ¶æ€
      document.querySelectorAll('.chat-history-item').forEach(item => {
        item.classList.remove('active');
      });
    }

    // åŠ è½½èŠå¤©å†å²
    async function loadChatHistory() {
      // ğŸ”’ ç™»å½•æ‹¦æˆª
      if (!requireLogin()) return;
      
      try {
        const response = await fetch('http://127.0.0.1:5002/get_chat_conversations', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            username: currentUsername
          })
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        
        if (data.success) {
          chatHistory = data.conversations;
          chatHistoryContainer.innerHTML = '';
          
          data.conversations.forEach(chat => {
            const chatItem = document.createElement('div');
            chatItem.className = 'chat-history-item';
            if (chat.id === currentChatId) {
              chatItem.classList.add('active');
            }
            
            chatItem.innerHTML = `
              <div class="chat-history-item-title">${chat.title || 'æ–°å¯¹è¯'}</div>
              <div class="chat-history-item-time">${formatTime(chat.updated_at)}</div>
              <div class="chat-history-item-actions">
                <button class="delete-btn" onclick="deleteChat('${chat.id}')">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3,6 5,6 21,6"/>
                    <path d="M19,6v14a2,2 0 0,1 -2,2H7a2,2 0 0,1 -2,-2V6m3,0V4a2,2 0 0,1 2,-2h4a2,2 0 0,1 2,2v2"/>
                  </svg>
                </button>
              </div>
            `;
            
            chatItem.addEventListener('click', function() {
              loadChat(chat.id, this);
            });
            chatHistoryContainer.appendChild(chatItem);
          });
          
          // å¦‚æœæ²¡æœ‰å½“å‰å¯¹è¯ï¼Œæ˜¾ç¤ºå±…ä¸­è¾“å…¥æ¡†ï¼ˆæ— è®ºæ˜¯æ²¡æœ‰å†å²å¯¹è¯è¿˜æ˜¯åˆšè¿›å…¥é¡µé¢ï¼‰
          if (!currentChatId) {
            showNewChatInterface();
          }
        } else {
          console.error('åŠ è½½èŠå¤©å†å²å¤±è´¥:', data.error);
          // å³ä½¿åŠ è½½å¤±è´¥ï¼Œå¦‚æœæ²¡æœ‰ä»»ä½•å¯¹è¯ï¼Œä¹Ÿåº”è¯¥æ˜¾ç¤ºå±…ä¸­è¾“å…¥æ¡†
          if (!currentChatId) {
            showNewChatInterface();
          }
        }
      } catch (error) {
        console.error('åŠ è½½èŠå¤©å†å²å¤±è´¥:', error);
        // å³ä½¿å‡ºé”™ï¼Œå¦‚æœæ²¡æœ‰ä»»ä½•å¯¹è¯ï¼Œä¹Ÿåº”è¯¥æ˜¾ç¤ºå±…ä¸­è¾“å…¥æ¡†
        if (!currentChatId) {
          showNewChatInterface();
        }
      }
    }

    // ç«‹å³åœ¨å·¦ä¾§æ·»åŠ æ–°å¯¹è¯é¡¹ï¼ˆç”¨äºæ–°å»ºå¯¹è¯æ—¶çš„å³æ—¶åé¦ˆï¼‰
    function addNewChatToSidebar(chatId, firstMessage) {
      // ç”Ÿæˆå¯¹è¯æ ‡é¢˜ï¼ˆå–å‰30ä¸ªå­—ç¬¦ï¼‰
      const title = firstMessage.length > 30 ? firstMessage.substring(0, 30) + '...' : firstMessage;
      const now = new Date().toISOString();
      
      // æ¸…é™¤æ‰€æœ‰æ´»è·ƒçŠ¶æ€
      document.querySelectorAll('.chat-history-item').forEach(item => {
        item.classList.remove('active');
      });
      
      // åˆ›å»ºæ–°çš„å¯¹è¯é¡¹å…ƒç´ 
      const chatItem = document.createElement('div');
      chatItem.className = 'chat-history-item active';
      chatItem.dataset.chatId = chatId;
      
      chatItem.innerHTML = `
        <div class="chat-history-item-title">${title}</div>
        <div class="chat-history-item-time">åˆšåˆš</div>
        <div class="chat-history-item-actions">
          <button class="delete-btn" onclick="deleteChat('${chatId}')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="3,6 5,6 21,6"/>
              <path d="M19,6v14a2,2 0 0,1 -2,2H7a2,2 0 0,1 -2,-2V6m3,0V4a2,2 0 0,1 2,-2h4a2,2 0 0,1 2,2v2"/>
            </svg>
          </button>
        </div>
      `;
      
      chatItem.addEventListener('click', function() {
        loadChat(chatId, this);
      });
      
      // æ·»åŠ åˆ°åˆ—è¡¨é¡¶éƒ¨
      chatHistoryContainer.insertBefore(chatItem, chatHistoryContainer.firstChild);
      
      console.log('âœ… ç«‹å³åœ¨å·¦ä¾§åˆ›å»ºå¯¹è¯:', chatId, title);
    }

    // æ›´æ–°èŠå¤©å†å²è€Œä¸ä¸­æ–­å½“å‰å¯¹è¯
    async function updateChatHistoryWithoutInterruption() {
      if (!currentUsername) return;
      
      try {
        const response = await fetch('http://127.0.0.1:5002/get_chat_conversations', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            username: currentUsername
          })
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        
        if (data.success) {
          chatHistory = data.conversations;
          
          // ä¿å­˜å½“å‰æ´»è·ƒçš„å¯¹è¯ID
          const activeChatId = currentChatId;
          
          chatHistoryContainer.innerHTML = '';
          
          data.conversations.forEach(chat => {
            const chatItem = document.createElement('div');
            chatItem.className = 'chat-history-item';
            if (chat.id === activeChatId) {
              chatItem.classList.add('active');
            }
            
            chatItem.innerHTML = `
              <div class="chat-history-item-title">${chat.title || 'æ–°å¯¹è¯'}</div>
              <div class="chat-history-item-time">${formatTime(chat.updated_at)}</div>
              <div class="chat-history-item-actions">
                <button class="delete-btn" onclick="deleteChat('${chat.id}')">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3,6 5,6 21,6"/>
                    <path d="M19,6v14a2,2 0 0,1 -2,2H7a2,2 0 0,1 -2,-2V6m3,0V4a2,2 0 0,1 2,-2h4a2,2 0 0,1 2,2v2"/>
                  </svg>
                </button>
              </div>
            `;
            
            chatItem.addEventListener('click', function() {
              loadChat(chat.id, this);
            });
            chatHistoryContainer.appendChild(chatItem);
          });
          
          // ç¡®ä¿å½“å‰å¯¹è¯ä¿æŒæ´»è·ƒçŠ¶æ€
          currentChatId = activeChatId;
        } else {
          console.error('æ›´æ–°èŠå¤©å†å²å¤±è´¥:', data.error);
        }
      } catch (error) {
        console.error('æ›´æ–°èŠå¤©å†å²å¤±è´¥:', error);
      }
    }

    // åŠ è½½æŒ‡å®šèŠå¤©
    async function loadChat(chatId, clickedElement, retryCount = 0) {
      // ğŸ”’ ç™»å½•æ‹¦æˆª
      if (!requireLogin()) return;
      
      // ğŸš« å¦‚æœAIæ­£åœ¨å›å¤ï¼Œå…ˆç»ˆæ­¢å®ƒï¼Œç¡®ä¿å¯ä»¥ç«‹å³åˆ‡æ¢å¯¹è¯
      if (currentAbortController || sendBtn.disabled) {
        console.log('ğŸ”„ æ£€æµ‹åˆ°AIæ­£åœ¨å›å¤ï¼Œå…ˆç»ˆæ­¢ä»¥ç¡®ä¿å¯¹è¯åˆ‡æ¢å“åº”');
        if (currentAbortController) {
          currentAbortController.abort();
          currentAbortController = null;
        }
        sendBtn.classList.remove('hidden');
        sendBtn.disabled = false;
        stopBtn.classList.remove('show');
      }
      
      try {
        const response = await fetch('http://127.0.0.1:5002/get_chat_messages', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            username: currentUsername,
            conversation_id: chatId
          })
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        
        if (data.success) {
          currentChatId = chatId;
          chatMessages.innerHTML = '';
          
          // æ¢å¤è¾“å…¥æ¡†åˆ°æ­£å¸¸ä½ç½®
          restoreInputBox();
          
          // æ¸…é™¤ç©ºçŠ¶æ€
          clearEmptyState();
          
          // åŠ è½½èŠå¤©æ¶ˆæ¯
          data.conversation.messages.forEach(msg => {
            addMessageToUI(msg.type, msg.content);
          });
          
          // æ›´æ–°æ´»è·ƒçŠ¶æ€
          document.querySelectorAll('.chat-history-item').forEach(item => {
            item.classList.remove('active');
          });
          if (clickedElement) {
            clickedElement.classList.add('active');
          }
        } else {
          // å¦‚æœæ˜¯"å¯¹è¯ä¸å­˜åœ¨"é”™è¯¯ä¸”é‡è¯•æ¬¡æ•°å°‘äº3æ¬¡ï¼Œåˆ™é‡è¯•
          if (data.error && data.error.includes('å¯¹è¯ä¸å­˜åœ¨') && retryCount < 3) {
            console.log(`ğŸ”„ å¯¹è¯å°šæœªä¿å­˜ï¼Œ${retryCount + 1}/3 æ¬¡é‡è¯•...`);
            // ç­‰å¾…500msåé‡è¯•
            setTimeout(() => {
              loadChat(chatId, clickedElement, retryCount + 1);
            }, 500);
            return;
          } else {
            console.error('åŠ è½½å¯¹è¯æ¶ˆæ¯å¤±è´¥:', data.error);
            // å¦‚æœé‡è¯•æ¬¡æ•°å·²è¾¾ä¸Šé™ï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
            if (retryCount >= 3) {
              console.log('âš ï¸ å¯¹è¯åŠ è½½å¤±è´¥ï¼Œå¯èƒ½æ­£åœ¨ä¿å­˜ä¸­ï¼Œè¯·ç¨åé‡è¯•');
            }
          }
        }
      } catch (error) {
        console.error('åŠ è½½å¯¹è¯æ¶ˆæ¯å¤±è´¥:', error);
      }
    }


    // åˆ é™¤èŠå¤©
    async function deleteChat(chatId) {
      if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¯¹è¯å—ï¼Ÿ')) {
        try {
          // è¿™é‡Œå¯ä»¥æ·»åŠ æœåŠ¡å™¨ç«¯åˆ é™¤API
          // æš‚æ—¶åªåœ¨å‰ç«¯åˆ é™¤
          chatHistory = chatHistory.filter(c => c.id !== chatId);
          
          if (currentChatId === chatId) {
            createNewChat();
          }
          
          loadChatHistory();
        } catch (error) {
          console.error('åˆ é™¤å¯¹è¯å¤±è´¥:', error);
        }
      }
    }

    // æ‰“å¼€è®¾ç½®
    function openSettings() {
      // ğŸ”’ ç™»å½•æ‹¦æˆª
      if (!requireLogin()) return;
      
      settingsModal.classList.add('show');
    }

    // å…³é—­è®¾ç½®
    function closeSettings() {
      settingsModal.classList.remove('show');
    }

    // æ‰“å¼€è®°å¿†æŸ¥çœ‹
    function openMemory() {
      memoryModal.classList.add('show');
      loadPersonalMemory();
    }

    // å…³é—­è®°å¿†æŸ¥çœ‹
    function closeMemory() {
      memoryModal.classList.remove('show');
    }

    // åˆ‡æ¢è®°å¿†æ ‡ç­¾é¡µ
    function switchMemoryTab(tab) {
      // ç§»é™¤æ‰€æœ‰æ´»åŠ¨çŠ¶æ€
      personalMemoryTab.classList.remove('active');
      sharedMemoryTab.classList.remove('active');
      personalMemoryContent.classList.remove('active');
      sharedMemoryContent.classList.remove('active');

      if (tab === 'personal') {
        personalMemoryTab.classList.add('active');
        personalMemoryContent.classList.add('active');
        loadPersonalMemory();
      } else if (tab === 'shared') {
        sharedMemoryTab.classList.add('active');
        sharedMemoryContent.classList.add('active');
        // å…±äº«è®°å¿†æš‚æ—¶ä¸åŠ è½½å†…å®¹
      }
    }

    // åŠ è½½ä¸ªäººè®°å¿†
    async function loadPersonalMemory() {
      if (!currentUsername) return;
      
      const memoryType = memoryTypeSelect.value; // short, mid, long
      
      try {
        let url;
        if (memoryType === 'short') {
          url = `http://127.0.0.1:5002/chat/users/${currentUsername}/short_term.json`;
        } else if (memoryType === 'mid') {
          url = `http://127.0.0.1:5002/chat/users/${currentUsername}/mid_term.json`;
        } else if (memoryType === 'long') {
          url = `http://127.0.0.1:5002/chat/users/${currentUsername}/long_term_user.json`;
        }
        
        if (!url) {
          personalMemoryList.innerHTML = '<div class="empty-state">æ— æ•ˆçš„è®°å¿†ç±»å‹</div>';
          return;
        }
        
        const response = await fetch(url);
        if (response.ok) {
          const memories = await response.json();
          displayPersonalMemories(personalMemoryList, memories, memoryType);
        } else {
          personalMemoryList.innerHTML = `<div class="empty-state">æš‚æ— ${getMemoryTypeName(memoryType)}</div>`;
        }
      } catch (error) {
        console.error(`åŠ è½½${getMemoryTypeName(memoryType)}å¤±è´¥:`, error);
        personalMemoryList.innerHTML = '<div class="empty-state">åŠ è½½å¤±è´¥</div>';
      }
    }

    // æ˜¾ç¤ºä¸ªäººè®°å¿†åˆ—è¡¨
    function displayPersonalMemories(container, memories, memoryType) {
      if (!memories) {
        container.innerHTML = '<div class="empty-state">æš‚æ— è®°å¿†</div>';
        return;
      }

      container.innerHTML = '';
      
      if (memoryType === 'short') {
        // çŸ­æœŸè®°å¿†æ˜¯æ•°ç»„æ ¼å¼
        if (!Array.isArray(memories)) {
          container.innerHTML = '<div class="empty-state">çŸ­æœŸè®°å¿†æ•°æ®æ ¼å¼é”™è¯¯</div>';
          return;
        }
        
        if (memories.length === 0) {
          container.innerHTML = '<div class="empty-state">æš‚æ— çŸ­æœŸè®°å¿†</div>';
          return;
        }
        
        memories.forEach((memory, index) => {
          const memoryItem = document.createElement('div');
          memoryItem.className = 'memory-item';
          
          // å®‰å…¨åœ°è·å–å±æ€§ï¼Œé¿å… 'get' æ–¹æ³•é”™è¯¯
          const time = memory.timestamp || 'æœªçŸ¥æ—¶é—´';
          const conversationId = memory.conversation_id || 'æœªçŸ¥ä¼šè¯';
          const userInput = memory.user_input || 'æ— ç”¨æˆ·è¾“å…¥';
          const agentResponse = memory.agent_response || 'æ— AIå›å¤';
          
          memoryItem.innerHTML = `
            <div class="memory-item-header">
              <span class="memory-item-time">${time}</span>
              <span class="memory-item-conversation">${conversationId}</span>
            </div>
            <div class="memory-item-content">
              <div class="memory-item-user">ç”¨æˆ·: ${userInput}</div>
              <div class="memory-item-assistant">AI: ${agentResponse}</div>
            </div>
          `;
          
          container.appendChild(memoryItem);
        });
      } else if (memoryType === 'mid') {
        // ä¸­æœŸè®°å¿†æ˜¯å¯¹è±¡æ ¼å¼ï¼ŒåŒ…å«sessions
        if (!memories || typeof memories !== 'object') {
          container.innerHTML = '<div class="empty-state">ä¸­æœŸè®°å¿†æ•°æ®æ ¼å¼é”™è¯¯</div>';
          return;
        }
        
        const sessions = memories.sessions || {};
        const sessionKeys = Object.keys(sessions);
        
        if (sessionKeys.length === 0) {
          container.innerHTML = '<div class="empty-state">æš‚æ— ä¸­æœŸè®°å¿†</div>';
          return;
        }
        
        sessionKeys.forEach(sid => {
          const session = sessions[sid] || {};
          const memoryItem = document.createElement('div');
          memoryItem.className = 'memory-item';
          
          const sessionId = session.id || sid;
          const summary = session.summary || 'æš‚æ— æ‘˜è¦';
          const keywords = session.summary_keywords || [];
          const details = session.details || [];
          
          // æ„å»ºè¯¦æƒ…å†…å®¹
          let detailsHtml = '';
          if (details.length > 0) {
            details.forEach(page => {
              detailsHtml += `
                <div style="margin-bottom: 10px; padding: 12px; background: rgba(255,255,255,0.9); border-radius: 12px; box-shadow: 0 2px 8px rgba(31,38,135,0.08); border: 1px solid rgba(255,255,255,0.3);">
                  <div style="margin-bottom: 6px;"><b style="color: #667eea;">ä½ ï¼š</b>${page.user_input || ''}</div>
                  <div style="margin-bottom: 6px;"><b style="color: #667eea;">AIï¼š</b>${page.agent_response || ''}</div>
                  <div style="color: #888; font-size: 0.9em; margin-top: 4px;">${page.timestamp || ''}</div>
                  ${page.meta_info ? `<div style="color: #888; font-size: 0.9em; margin-top: 2px;">${page.meta_info}</div>` : ''}
                  ${page.page_keywords && page.page_keywords.length > 0 ? `<div style="color: #667eea; font-size: 0.9em; margin-top: 2px; font-weight: 600;">å…³é”®è¯ï¼š${page.page_keywords.join('ã€')}</div>` : ''}
                </div>
              `;
            });
          }
          
          memoryItem.innerHTML = `
            <div class="memory-item-header">
              <span class="memory-item-time">ä¼šè¯ID: ${sessionId}</span>
              <span class="memory-item-time">å¯¹è¯æ•°é‡: ${details.length}</span>
            </div>
            <div class="memory-item-content">
              <div class="memory-item-user">æ‘˜è¦: ${summary}</div>
              ${keywords.length > 0 ? `<div class="memory-item-assistant">å…³é”®è¯: ${keywords.join('ã€')}</div>` : ''}
              ${details.length > 0 ? `<div style="margin-top: 12px;"><div style="font-weight: 600; margin-bottom: 8px; color: #2a3a5a;">å¯¹è¯è¯¦æƒ…:</div>${detailsHtml}</div>` : ''}
            </div>
          `;
          
          container.appendChild(memoryItem);
        });
      } else if (memoryType === 'long') {
        // é•¿æœŸè®°å¿†æ˜¯å¯¹è±¡æ ¼å¼ï¼ŒåŒ…å«user_profiles
        if (!memories || typeof memories !== 'object') {
          container.innerHTML = '<div class="empty-state">é•¿æœŸè®°å¿†æ•°æ®æ ¼å¼é”™è¯¯</div>';
          return;
        }
        
        const userProfiles = memories.user_profiles || {};
        const profileKeys = Object.keys(userProfiles);
        
        if (profileKeys.length === 0) {
          container.innerHTML = '<div class="empty-state">æš‚æ— é•¿æœŸè®°å¿†</div>';
          return;
        }
        
        profileKeys.forEach(profileKey => {
          const profile = userProfiles[profileKey] || {};
          const memoryItem = document.createElement('div');
          memoryItem.className = 'memory-item';
          
          const data = profile.data || 'æš‚æ— æ•°æ®';
          const lastUpdated = profile.last_updated || 'æœªçŸ¥æ—¶é—´';
          
          // å¤„ç†ç”¨æˆ·ç”»åƒæ•°æ®ï¼Œåœ¨æ¯ä¸ªå¥å·åæ·»åŠ æ¢è¡Œ
          const formattedData = data.replace(/ã€‚/g, 'ã€‚<br>');
          
          memoryItem.innerHTML = `
            <div class="memory-item-header">
              <span class="memory-item-time">ç”¨æˆ·: ${profileKey}</span>
              <span class="memory-item-time">æ›´æ–°æ—¶é—´: ${lastUpdated}</span>
            </div>
            <div class="memory-item-content">
              <div class="memory-item-user">ç”¨æˆ·ç”»åƒ:</div>
              <div class="memory-item-assistant">${formattedData}</div>
            </div>
          `;
          
          container.appendChild(memoryItem);
        });
        
        // æ˜¾ç¤ºçŸ¥è¯†åº“å†…å®¹
        const knowledgeBase = memories.knowledge_base || [];
        if (knowledgeBase.length > 0) {
          const knowledgeItem = document.createElement('div');
          knowledgeItem.className = 'memory-item';
          
          // å¤„ç†çŸ¥è¯†åº“å†…å®¹ï¼Œåœ¨æ¯ä¸ªå¥å·åæ·»åŠ æ¢è¡Œ
          const formattedKnowledge = knowledgeBase.slice(0, 3).map(item => 
            item.replace(/ã€‚/g, 'ã€‚<br>')
          ).join('<br><br>');
          
          knowledgeItem.innerHTML = `
            <div class="memory-item-header">
              <span class="memory-item-time">çŸ¥è¯†åº“</span>
            </div>
            <div class="memory-item-content">
              <div class="memory-item-user">çŸ¥è¯†æ¡ç›®æ•°é‡: ${knowledgeBase.length}</div>
              <div class="memory-item-assistant">${formattedKnowledge}${knowledgeBase.length > 3 ? '<br>...' : ''}</div>
            </div>
          `;
          container.appendChild(knowledgeItem);
        }
        
        // æ˜¾ç¤ºåŠ©æ‰‹çŸ¥è¯†å†…å®¹
        const assistantKnowledge = memories.assistant_knowledge || [];
        if (assistantKnowledge.length > 0) {
          const assistantItem = document.createElement('div');
          assistantItem.className = 'memory-item';
          
          // å¤„ç†åŠ©æ‰‹çŸ¥è¯†å†…å®¹ï¼Œåœ¨æ¯ä¸ªå¥å·åæ·»åŠ æ¢è¡Œ
          const formattedAssistantKnowledge = assistantKnowledge.slice(0, 3).map(item => 
            item.replace(/ã€‚/g, 'ã€‚<br>')
          ).join('<br><br>');
          
          assistantItem.innerHTML = `
            <div class="memory-item-header">
              <span class="memory-item-time">åŠ©æ‰‹çŸ¥è¯†</span>
            </div>
            <div class="memory-item-content">
              <div class="memory-item-user">çŸ¥è¯†æ¡ç›®æ•°é‡: ${assistantKnowledge.length}</div>
              <div class="memory-item-assistant">${formattedAssistantKnowledge}${assistantKnowledge.length > 3 ? '<br>...' : ''}</div>
            </div>
          `;
          container.appendChild(assistantItem);
        }
      }
    }

    // è·å–è®°å¿†ç±»å‹åç§°
    function getMemoryTypeName(memoryType) {
      const names = {
        'short': 'çŸ­æœŸè®°å¿†',
        'mid': 'ä¸­æœŸè®°å¿†',
        'long': 'é•¿æœŸè®°å¿†'
      };
      return names[memoryType] || 'è®°å¿†';
    }

    // åŠ è½½ç”¨æˆ·é…ç½®
    async function loadUserConfig() {
      if (!currentUsername) return;
      
      try {
        // å…ˆå°è¯•ä»chatç›®å½•åŠ è½½é…ç½®
        const response = await fetch('http://127.0.0.1:5002/get_chat_conversations', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ username: currentUsername })
        });
        
        if (response.ok) {
          // ä»chatç›®å½•åŠ è½½é…ç½®
          const configResponse = await fetch(`http://127.0.0.1:5002/chat/users/${currentUsername}/config.json`);
          if (configResponse.ok) {
            const data = await configResponse.json();
            
            // å¡«å……è¡¨å•
            if (data.openai_api_key) document.getElementById('openaiApiKey').value = data.openai_api_key;
            if (data.openai_base_url) document.getElementById('openaiBaseUrl').value = data.openai_base_url;
            
            return;
          }
        }
        
        // å¦‚æœchatç›®å½•æ²¡æœ‰é…ç½®ï¼Œå°è¯•ä»åŸæ¥çš„æ¥å£åŠ è½½
        const response2 = await fetch('/gt', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ username: currentUsername })
        });
        
        if (response2.ok) {
          const data = await response2.json();
          
          // å¡«å……è¡¨å•
          if (data.openai_api_key) document.getElementById('openaiApiKey').value = data.openai_api_key;
          if (data.openai_base_url) document.getElementById('openaiBaseUrl').value = data.openai_base_url;
        }
      } catch (error) {
        console.error('åŠ è½½ç”¨æˆ·é…ç½®å¤±è´¥:', error);
      }
    }

    // ä¿å­˜è®¾ç½®
    async function saveSettings(e) {
      e.preventDefault();
      
      if (!currentUsername) {
        alert('è¯·å…ˆè®¾ç½®ç”¨æˆ·å');
        return;
      }
      
      const formData = new FormData(settingsForm);
      const settings = Object.fromEntries(formData.entries());
      
      // éªŒè¯å¿…è¦å­—æ®µ
      if (!settings.openai_api_key || settings.openai_api_key.trim() === '') {
        alert('è¯·è¾“å…¥OpenAI API Key');
        document.getElementById('openaiApiKey').focus();
        return;
      }
      
      settings.username = currentUsername;
      
      try {
        const response = await fetch('http://127.0.0.1:5002/save_chat_user_config', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(settings)
        });
        
        if (response.ok) {
          const data = await response.json();
          if (data.success) {
            alert('è®¾ç½®ä¿å­˜æˆåŠŸï¼');
            closeSettings();
          } else {
            alert('è®¾ç½®ä¿å­˜å¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'));
          }
        } else {
          alert('è®¾ç½®ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
        }
      } catch (error) {
        console.error('ä¿å­˜è®¾ç½®å¤±è´¥:', error);
        alert('è®¾ç½®ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
      }
    }

    // è·å–ä¼šè¯ç”¨æˆ·å
    function getSessionUsername() {
      // å°è¯•ä»localStorageè·å–
      let username = localStorage.getItem('username');
      if (username) return username;
      
      // å°è¯•ä»URLå‚æ•°è·å–
      const urlParams = new URLSearchParams(window.location.search);
      username = urlParams.get('username');
      if (username) {
        localStorage.setItem('username', username);
        return username;
      }
      
      return null;
    }

    // æ ¼å¼åŒ–æ—¶é—´
    function formatTime(timestamp) {
      const date = new Date(timestamp);
      const now = new Date();
      const diff = now - date;
      
      if (diff < 60000) { // 1åˆ†é’Ÿå†…
        return 'åˆšåˆš';
      } else if (diff < 3600000) { // 1å°æ—¶å†…
        return Math.floor(diff / 60000) + 'åˆ†é’Ÿå‰';
      } else if (diff < 86400000) { // 1å¤©å†…
        return Math.floor(diff / 3600000) + 'å°æ—¶å‰';
      } else {
        return date.toLocaleDateString();
      }
    }

    // è‡ªåŠ¨è°ƒæ•´è¾“å…¥æ¡†é«˜åº¦
    chatInput.addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = Math.min(this.scrollHeight, 250) + 'px';
    });

    // åˆå§‹åŒ–è®°å¿†æŒ‰é’®çŠ¶æ€
    function initializeSharedMemoryButton() {
      // é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸ªäººè®°å¿†æ˜¯å¯ç”¨çš„
      updateMemoryButtonDisplay();
      console.log('è®°å¿†ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ - ä¸ªäººè®°å¿†å·²å¯ç”¨');
    }

    // æ›´æ–°è®°å¿†æŒ‰é’®æ˜¾ç¤º
    function updateMemoryButtonDisplay() {
      if (personalMemoryEnabled) {
        sharedMemoryBtn.classList.add('active');
        sharedMemoryBtn.innerHTML = `
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
            <circle cx="9" cy="7" r="4"/>
            <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
            <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
          </svg>
          è®°å¿†å·²å¼€å¯
        `;
      } else {
        sharedMemoryBtn.classList.remove('active');
        sharedMemoryBtn.innerHTML = `
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
            <circle cx="9" cy="7" r="4"/>
            <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
            <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
          </svg>
          å¼€å¯è®°å¿†
        `;
      }
    }

    // åˆ‡æ¢ä¸ªäººè®°å¿†çŠ¶æ€
    function toggleSharedMemory() {
      personalMemoryEnabled = !personalMemoryEnabled;
      
      // å½“ä¸ªäººè®°å¿†å…³é—­æ—¶ï¼Œå…±äº«è®°å¿†ä¹Ÿè‡ªåŠ¨å…³é—­
      if (!personalMemoryEnabled) {
        sharedMemoryEnabled = false;
        console.log('ä¸ªäººè®°å¿†å·²å…³é—­ï¼Œå…±äº«è®°å¿†ä¹Ÿè‡ªåŠ¨å…³é—­');
      } else {
        // å½“ä¸ªäººè®°å¿†å¼€å¯æ—¶ï¼Œå…±äº«è®°å¿†ä¹Ÿè‡ªåŠ¨å¼€å¯
        sharedMemoryEnabled = true;
        console.log('ä¸ªäººè®°å¿†å·²å¼€å¯ï¼Œå…±äº«è®°å¿†ä¹Ÿè‡ªåŠ¨å¼€å¯');
      }
      
      updateMemoryButtonDisplay();
      
      if (personalMemoryEnabled) {
        console.log('è®°å¿†å·²å¼€å¯ - å°†ä½¿ç”¨ä¸ªäººè®°å¿†å’Œå…±äº«è®°å¿†è¿›è¡Œå¯¹è¯');
      } else {
        console.log('è®°å¿†å·²å…³é—­ - å°†åªä½¿ç”¨å½“å‰å¯¹è¯ä¸Šä¸‹æ–‡ï¼Œä¸æä¾›ä»»ä½•å…¶ä»–ä¿¡æ¯');
      }
    }
  </script>
</body>
</html>
