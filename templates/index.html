<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Experience Chat</title>
  <!-- å¼•å…¥marked.jsç”¨äºMarkdownæ¸²æŸ“ -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <!-- å¼•å…¥highlight.jsç”¨äºä»£ç é«˜äº® -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', Arial, sans-serif;
      background: #f7f8fa;
      height: 100vh;
      overflow: hidden;
    }

    .app-container {
      display: flex;
      height: 100vh;
      background: #f7f8fa;
    }

    /* å·¦ä¾§è¾¹æ  */
    .sidebar {
      width: 280px;
      background: #ffffff;
      border-right: 1px solid #e5e7eb;
      display: flex;
      flex-direction: column;
      height: 100vh;
      position: relative;
    }

    .sidebar-header {
      padding: 20px;
      border-bottom: 1px solid #e5e7eb;
    }

    .new-chat-btn {
      width: 100%;
      padding: 12px 16px;
      background: #165dff;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .new-chat-btn:hover {
      background: #0f4cd1;
    }

    .new-chat-btn svg {
      width: 16px;
      height: 16px;
    }

    .chat-history {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }

    .chat-history-item {
      padding: 12px 16px;
      margin-bottom: 8px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid transparent;
      position: relative;
    }

    .chat-history-item:hover {
      background: #f3f4f6;
    }

    .chat-history-item.active {
      background: #eef2ff;
      border-color: #165dff;
      border-width: 2px;
      box-shadow: 0 2px 8px rgba(22, 93, 255, 0.2);
      transform: translateX(2px);
    }

    .chat-history-item.active .chat-history-item-title {
      color: #165dff;
      font-weight: 600;
    }

    .chat-history-item.active .chat-history-item-time {
      color: #165dff;
      font-weight: 500;
    }

    .chat-history-item-title {
      font-size: 14px;
      font-weight: 500;
      color: #1f2937;
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .chat-history-item-time {
      font-size: 12px;
      color: #6b7280;
    }

    .chat-history-item-actions {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      opacity: 0;
      transition: opacity 0.2s;
    }

    .chat-history-item:hover .chat-history-item-actions {
      opacity: 1;
    }

    .chat-history-flag {
      position: absolute;
      right: 40px;
      top: 50%;
      transform: translateY(-50%);
      color: #f59e0b;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: help;
    }

    .chat-history-flag svg {
      width: 16px;
      height: 16px;
      fill: currentColor;
      stroke: currentColor;
    }

    .chat-history-item:hover .chat-history-flag {
      color: #f97316;
    }

    .delete-btn {
      background: none;
      border: none;
      color: #ef4444;
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
    }

    .delete-btn:hover {
      background: #fef2f2;
    }

    /* ä¸»èŠå¤©åŒºåŸŸ */
    .chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      height: 100vh;
      position: relative;
    }

    .floating-header-actions {
      position: fixed;
      top: 5px;
      right: 24px;
      display: flex;
      align-items: center;
      gap: 12px;
      z-index: 100;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 12px;
      padding: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(229, 231, 235, 0.5);
    }

    .settings-btn {
      width: 40px;
      height: 40px;
      border: none;
      background: #f3f4f6;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .settings-btn:hover {
      background: #e5e7eb;
    }

    .settings-btn svg {
      width: 20px;
      height: 20px;
      color: #6b7280;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 24px 24px 24px 24px;
      background: #f7f8fa;
      margin-top: 40px;
    }

    .message {
      margin-bottom: 24px;
      display: flex;
      gap: 12px;
      flex-wrap: wrap; /* å…è®¸æ¢è¡Œ */
    }

    .message.user {
      flex-direction: row-reverse;
    }

    .message-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 600;
      flex-shrink: 0;
    }

    .message.user .message-avatar {
      background: #165dff;
      color: white;
    }

    .message.assistant .message-avatar {
      background: #10b981;
      color: white;
    }

    /* åŠ è½½åŠ¨ç”»æ ·å¼ */
    .loading-avatar {
      background: #10b981 !important;
      color: white !important;
      position: relative;
      overflow: hidden;
    }

    .loading-avatar::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.6), transparent);
      animation: loading-shimmer 2s infinite;
    }

    @keyframes loading-shimmer {
      0% {
        left: -100%;
      }
      100% {
        left: 100%;
      }
    }

    /* è„‰å†²åŠ¨ç”» */
    .loading-avatar {
      animation: loading-pulse 2s infinite ease-in-out;
    }

    @keyframes loading-pulse {
      0%, 100% {
        transform: scale(1);
        opacity: 1;
      }
      50% {
        transform: scale(1.05);
        opacity: 0.8;
      }
    }

    .loading-dots {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 3px;
    }

    .loading-dots::before,
    .loading-dots::after {
      content: '';
      width: 5px;
      height: 5px;
      border-radius: 50%;
      background: currentColor;
      animation: loading-bounce 1.4s infinite ease-in-out both;
    }

    .loading-dots::before {
      animation-delay: -0.32s;
    }

    .loading-dots::after {
      animation-delay: -0.16s;
    }

    @keyframes loading-bounce {
      0%, 80%, 100% {
        transform: scale(0);
        opacity: 0.5;
      }
      40% {
        transform: scale(1);
        opacity: 1;
      }
    }

    /* æ€è€ƒåŠ¨ç”» - ç‚¹ç‚¹åŠ¨ç”» */
    .thinking-dots {
      display: inline-block;
      animation: thinking-blink 1.4s infinite;
    }

    @keyframes thinking-blink {
      0%, 20% { opacity: 0.2; }
      40% { opacity: 1; }
      60%, 100% { opacity: 0.2; }
    }

    /* åŠ è½½æ¶ˆæ¯çš„æ ·å¼ */
    .loading-message .message-content {
      background: #f3f4f6;
      color: #6b7280;
      font-style: italic;
    }

    .message-content {
      max-width: 75%;
      padding: 12px 16px;
      border-radius: 12px;
      font-size: 14px;
      line-height: 1.5;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }

    .message.assistant .message-content {
      max-width: 80%;
    }

    .message.user .message-content {
      background: #165dff;
      color: white;
      border-bottom-right-radius: 4px;
    }

    .message.assistant .message-content {
      background: #ffffff;
      color: #1f2937;
      border: 1px solid #e5e7eb;
      border-bottom-left-radius: 4px;
    }

    /* æ¶ˆæ¯ä¸‹æ–¹æ“ä½œåŒºï¼ˆå¤åˆ¶ç­‰ï¼‰ */
    .message-actions {
      margin-top: 6px;
      margin-left: 44px; /* ä¸avatarå¯¹é½ */
      display: flex;
      gap: 8px;
      align-items: center;
      width: fit-content;
    }

    .message.user .message-actions {
      margin-left: 0;
      margin-right: 44px;
      justify-content: flex-end;
    }

    .copy-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      font-size: 12px;
      color: #374151;
      background: #f3f4f6;
      border: 1px solid #e5e7eb;
      border-radius: 999px;
      cursor: pointer;
      user-select: none;
      transition: background 0.2s, border-color 0.2s;
    }

    .copy-btn:hover {
      background: #eef2ff;
      border-color: #c7d2fe;
    }

    .copy-btn svg {
      width: 14px;
      height: 14px;
    }

    .share-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      font-size: 12px;
      color: #374151;
      background: #f3f4f6;
      border: 1px solid #e5e7eb;
      border-radius: 999px;
      cursor: pointer;
      user-select: none;
      transition: background 0.2s, border-color 0.2s;
    }

    .share-btn:hover {
      background: #eef2ff;
      border-color: #c7d2fe;
    }

    .share-btn svg {
      width: 14px;
      height: 14px;
    }

    /* è®°å¿†æ ‡è®°æ ·å¼ */
    .message-memory-tags {
      margin-top: 8px;
      margin-left: 44px; /* ä¸æ¶ˆæ¯avatarå®½åº¦å¯¹é½ (32px avatar + 12px gap) */
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      width: fit-content;
      flex-basis: 100%; /* å¼ºåˆ¶æ¢è¡Œåˆ°æ–°è¡Œ */
    }

    .message.user .message-memory-tags {
      margin-left: 0;
      margin-right: 44px;
      justify-content: flex-end;
    }


    .memory-tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 500;
      line-height: 1;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      cursor: pointer;
    }

    .memory-tag.enabled {
      background: #f1f5ff;
      color: #1e40af;
      border-color: #c7d2fe;
    }

    .memory-tag.disabled {
      background: #f3f4f6;
      color: #6b7280;
    }

    .memory-tag svg {
      width: 12px;
      height: 12px;
    }

    /* è®°å¿†å†…å®¹é¢æ¿æ ·å¼ */
    .memory-content-panel {
      position: fixed;
      right: 0;
      top: 0;
      width: 450px;
      height: 100vh;
      background: #ffffff;
      border-left: 1px solid #e5e7eb;
      box-shadow: -4px 0 20px rgba(0, 0, 0, 0.15);
      transform: translateX(100%);
      transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 1000;
      overflow-y: auto;
      backdrop-filter: blur(10px);
      display: none; /* é»˜è®¤éšè— */
    }

    /* å½“è®°å¿†é¢æ¿æ‰“å¼€æ—¶ï¼Œéšè—ä¾§è¾¹æ  */
    .app-container.memory-panel-open .sidebar {
      display: none;
      transition: opacity 0.3s ease;
    }

    /* å½“è®°å¿†é¢æ¿æ‰“å¼€æ—¶ï¼Œè°ƒæ•´èŠå¤©å®¹å™¨ä¸ºGridå¸ƒå±€ */
    .app-container.memory-panel-open .chat-container {
      display: grid;
      grid-template-columns: 1fr 450px;
      grid-template-rows: auto 1fr auto;
      grid-template-areas: 
        "messages memory"
        "messages memory"
        "input memory";
      flex: 1;
      min-width: 0;
      position: relative;
    }

    /* å½“è®°å¿†é¢æ¿æ‰“å¼€æ—¶ï¼Œæµ®åŠ¨å¤´éƒ¨æŒ‰é’®ä½ç½®ï¼ˆåªè¦†ç›–æ¶ˆæ¯åŒºåŸŸï¼‰ */
    .app-container.memory-panel-open .floating-header-actions {
      right: calc(450px + 24px);
      position: fixed;
    }

    /* å½“è®°å¿†é¢æ¿æ‰“å¼€æ—¶ï¼ŒèŠå¤©æ¶ˆæ¯åŒºåŸŸå æ®å·¦ä¾§ */
    .app-container.memory-panel-open .chat-messages {
      grid-area: messages;
      flex: 1;
      min-width: 0;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }

    /* å½“è®°å¿†é¢æ¿æ‰“å¼€æ—¶ï¼Œè®°å¿†é¢æ¿å æ®å³ä¾§å¹¶æ’æ˜¾ç¤º */
    .app-container.memory-panel-open .memory-content-panel {
      grid-area: memory;
      position: relative;
      display: flex;
      flex-direction: column;
      width: 450px;
      flex-shrink: 0;
      transform: translateX(0);
      box-shadow: none;
      z-index: 1;
      transition: none; /* å¹¶æ’å¸ƒå±€æ—¶ä¸éœ€è¦è¿‡æ¸¡åŠ¨ç”» */
    }

    /* å½“è®°å¿†é¢æ¿æ‰“å¼€æ—¶ï¼Œè¾“å…¥æ¡†å®¹å™¨åªåœ¨èŠå¤©åŒºåŸŸ */
    .app-container.memory-panel-open .chat-input-container {
      grid-area: input;
      width: 100%;
      flex-shrink: 0;
      /* ç¡®ä¿è¾“å…¥æ¡†åœ¨èŠå¤©åŒºåŸŸåº•éƒ¨ï¼Œä¸è·¨è¶Šåˆ°è®°å¿†é¢æ¿ */
    }

    .memory-content-header {
      padding: 20px 24px;
      border-bottom: 1px solid #e5e7eb;
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .memory-content-title {
      font-size: 18px;
      font-weight: 700;
      color: #1e293b;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .memory-content-title svg {
      width: 20px;
      height: 20px;
      color: #3b82f6;
    }

    .memory-content-close {
      background: none;
      border: none;
      cursor: pointer;
      padding: 8px;
      border-radius: 8px;
      color: #6b7280;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .memory-content-close:hover {
      background: #f3f4f6;
      color: #374151;
      transform: scale(1.05);
    }

    .memory-content-close svg {
      width: 18px;
      height: 18px;
    }

    .memory-content-body {
      padding: 24px;
      background: #ffffff;
    }

    .memory-item {
      padding: 20px;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      margin-bottom: 16px;
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      transition: all 0.2s ease;
      position: relative;
      overflow: hidden;
    }

    .memory-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 4px;
      height: 100%;
      background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
    }

    .memory-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
      border-color: #3b82f6;
    }

    .memory-item:last-child {
      margin-bottom: 0;
    }

    .memory-item-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid #f1f5f9;
    }

    .memory-item-user {
      font-size: 13px;
      color: #3b82f6;
      font-weight: 600;
      background: #eff6ff;
      padding: 4px 8px;
      border-radius: 6px;
    }

    .memory-item-time {
      font-size: 12px;
      color: #64748b;
      font-weight: 500;
    }

    .memory-item-content {
      font-size: 14px;
      line-height: 1.6;
      color: #334155;
      background: #f8fafc;
      padding: 12px;
      border-radius: 8px;
      border-left: 3px solid #3b82f6;
    }

    .memory-loading {
      text-align: center;
      padding: 60px 20px;
      color: #64748b;
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      border-radius: 12px;
      margin: 20px 0;
    }

    .memory-loading svg {
      width: 32px;
      height: 32px;
      margin-bottom: 16px;
      color: #3b82f6;
      animation: spin 2s linear infinite;
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    .memory-empty {
      text-align: center;
      padding: 60px 20px;
      color: #64748b;
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      border-radius: 12px;
      margin: 20px 0;
      border: 2px dashed #cbd5e1;
    }

    .memory-empty svg {
      width: 48px;
      height: 48px;
      margin-bottom: 16px;
      opacity: 0.6;
      color: #94a3b8;
    }

    .memory-empty p {
      font-size: 16px;
      font-weight: 500;
      margin: 0;
    }

    /* Markdownæ ·å¼ */
    .message-content h1,
    .message-content h2,
    .message-content h3,
    .message-content h4,
    .message-content h5,
    .message-content h6 {
      margin-top: 16px;
      margin-bottom: 8px;
      font-weight: 600;
      line-height: 1.25;
    }

    .message-content h1 {
      font-size: 1.5em;
      border-bottom: 2px solid #e5e7eb;
      padding-bottom: 8px;
    }

    .message-content h2 {
      font-size: 1.3em;
      border-bottom: 1px solid #e5e7eb;
      padding-bottom: 6px;
    }

    .message-content h3 {
      font-size: 1.15em;
    }

    .message-content ul,
    .message-content ol {
      margin: 12px 0;
      padding-left: 24px;
    }

    .message-content li {
      margin: 6px 0;
      line-height: 1.6;
    }

    .message-content p {
      margin: 8px 0;
      line-height: 1.6;
    }

    .message-content code {
      background: #f3f4f6;
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
      font-size: 0.9em;
      color: #e83e8c;
    }

    .message-content pre {
      background: #f6f8fa;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      padding: 12px;
      margin: 12px 0;
      overflow-x: auto;
    }

    .message-content pre code {
      background: transparent;
      padding: 0;
      color: inherit;
      font-size: 0.875em;
      line-height: 1.5;
    }

    .message-content blockquote {
      border-left: 4px solid #165dff;
      padding-left: 12px;
      margin: 12px 0;
      color: #6b7280;
      font-style: italic;
    }

    .message-content a {
      color: #165dff;
      text-decoration: none;
    }

    .message-content a:hover {
      text-decoration: underline;
    }

    .message-content strong {
      font-weight: 600;
      color: #1f2937;
    }

    .message-content em {
      font-style: italic;
    }

    .message-content table {
      border-collapse: collapse;
      width: 100%;
      margin: 12px 0;
    }

    .message-content table th,
    .message-content table td {
      border: 1px solid #e5e7eb;
      padding: 8px 12px;
      text-align: left;
    }

    .message-content table th {
      background: #f3f4f6;
      font-weight: 600;
    }

    .message-content hr {
      border: none;
      border-top: 2px solid #e5e7eb;
      margin: 16px 0;
    }

    /* ä¼˜åŒ–é¦–å°¾å…ƒç´ è¾¹è· */
    .message-content > *:first-child {
      margin-top: 0 !important;
    }

    .message-content > *:last-child {
      margin-bottom: 0 !important;
    }

    /* ä»£ç å¤åˆ¶æŒ‰é’®æ ·å¼ */
    .message-content pre {
      position: relative;
    }

    .chat-input-container {
      padding: 20px 24px;
      background: #ffffff;
      border-top: 1px solid #e5e7eb;
      transition: all 0.3s ease;
    }

    .chat-input-container.centered {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 90%;
      max-width: 800px;
      background: transparent;
      border-top: none;
      z-index: 10;
    }

    .chat-input-container.centered::before {
      content: "ç™¾å®¶AIç»éªŒæœç´¢: é›†ä¼—äººä¹‹æ™º";
      display: block;
      text-align: center;
      font-size: 24px;
      font-weight: 700;
      color: #165dff;
      margin-bottom: 16px;
      letter-spacing: 2px;
    }

    .chat-input-container.centered .chat-input {
      background: #ffffff;
      border: 2px solid #e5e7eb;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .chat-input-container.centered .chat-input:focus {
      border-color: #165dff;
      box-shadow: 0 0 0 3px rgba(22, 93, 255, 0.1), 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .chat-input-wrapper {
      position: relative;
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }


    .model-label {
      font-size: 12px;
      color: #6b7280;
      font-weight: 500;
    }

    .ai-model-selector {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      padding: 6px 10px;
      font-size: 12px;
      color: #374151;
      cursor: pointer;
      transition: all 0.2s;
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      min-width: 100px;
      font-weight: 500;
    }

    .ai-model-selector:hover {
      background: #e5e7eb;
      border-color: #9ca3af;
    }

    .ai-model-selector:focus {
      outline: none;
      border-color: #165dff;
      box-shadow: 0 0 0 2px rgba(22, 93, 255, 0.1);
    }

    .shared-memory-btn {
      background: #f9fafb;
      color: #374151;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      padding: 6px 12px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
    }

    .shared-memory-btn:hover {
      background: #e5e7eb;
      border-color: #9ca3af;
    }

    .shared-memory-btn:focus {
      outline: none;
      border-color: #165dff;
      box-shadow: 0 0 0 2px rgba(22, 93, 255, 0.1);
    }

    .shared-memory-btn.active {
      background: #dbeafe;
      color: #1e40af;
      border-color: #93c5fd;
    }

    .shared-memory-btn.active:hover {
      background: #bfdbfe;
      border-color: #60a5fa;
    }

    /* MCP å·¥å…·è°ƒç”¨æŒ‰é’®æ ·å¼ */
    .mcp-tools-btn {
      background: #f9fafb;
      color: #374151;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      padding: 6px 12px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
    }

    .mcp-tools-btn:hover {
      background: #e5e7eb;
      border-color: #9ca3af;
    }

    .mcp-tools-btn:focus {
      outline: none;
      border-color: #f59e0b;
      box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.1);
    }

    .mcp-tools-btn.active {
      background: #fef3c7;
      color: #92400e;
      border-color: #fbbf24;
    }

    .mcp-tools-btn.active:hover {
      background: #fde68a;
      border-color: #f59e0b;
    }

    .mcp-tools-btn svg {
      width: 14px;
      height: 14px;
    }

    /* å·¥å…·è°ƒç”¨çŠ¶æ€æŒ‡ç¤ºå™¨ */
    .tool-call-indicator {
      display: none;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: #fffbeb;
      border: 1px solid #fbbf24;
      border-radius: 6px;
      font-size: 12px;
      color: #92400e;
      margin-top: 8px;
    }

    .tool-call-indicator.active {
      display: flex;
    }

    .tool-call-indicator .spinner {
      width: 14px;
      height: 14px;
      border: 2px solid #fbbf24;
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .chat-input {
      flex: 1;
      min-height: 120px;
      max-height: 250px;
      padding: 16px 16px 70px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 16px;
      font-size: 16px;
      line-height: 1.6;
      resize: vertical;
      outline: none;
      transition: all 0.3s;
      font-family: inherit;
      background: #ffffff;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      width: 100%;
    }

    .chat-input:focus {
      border-color: #165dff;
      box-shadow: 0 0 0 3px rgba(22, 93, 255, 0.1), 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .input-bottom-controls {
      position: absolute;
      bottom: 12px;
      left: 12px;
      right: 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 8px;
      padding: 8px 12px;
      border: 1px solid rgba(229, 231, 235, 0.5);
    }

    .input-controls-inner {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .send-btn, .stop-btn {
      width: 36px;
      height: 36px;
      border: none;
      color: white;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      flex-shrink: 0;
    }

    .send-btn {
      background: #165dff;
      box-shadow: 0 2px 8px rgba(22, 93, 255, 0.3);
    }
    
    .stop-btn {
      background: #ef4444;
      box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
      display: none;
    }
    
    .stop-btn.show {
      display: flex;
    }
    
    /* å½“å‘é€æŒ‰é’®éšè—æ—¶ï¼ˆAIå›å¤è¿‡ç¨‹ä¸­ï¼‰ */
    .send-btn.hidden {
      display: none;
    }

    .send-btn:hover {
      background: #0f4cd1;
    }
    
    .stop-btn:hover {
      background: #dc2626;
    }

    .send-btn:disabled {
      background: #d1d5db;
      cursor: not-allowed;
      opacity: 0.5;
    }
    
    .send-btn:disabled:hover {
      background: #d1d5db;
    }

    .send-btn svg, .stop-btn svg {
      width: 16px;
      height: 16px;
    }

    /* ç™»å½•å¼¹çª— */
    .login-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      backdrop-filter: blur(8px);
    }

    .login-modal.show {
      display: flex;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    .login-content {
      background: white;
      border-radius: 16px;
      width: 90%;
      max-width: 420px;
      padding: 40px;
      box-shadow: 0 24px 48px rgba(0, 0, 0, 0.2);
      animation: slideUp 0.4s ease;
    }

    @keyframes slideUp {
      from {
        transform: translateY(30px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .login-header {
      text-align: center;
      margin-bottom: 32px;
    }

    .login-logo {
      width: 64px;
      height: 64px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 16px;
      margin: 0 auto 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
    }

    .login-title {
      font-size: 24px;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 8px;
    }

    .login-subtitle {
      font-size: 14px;
      color: #6b7280;
    }

    .login-form {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .login-input-group {
      position: relative;
      margin-bottom: 16px;
    }

    .login-input {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      font-size: 15px;
      transition: all 0.3s;
      background: #f9fafb;
    }

    .login-input:focus {
      outline: none;
      border-color: #667eea;
      background: white;
      box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
    }

    .login-input::placeholder {
      color: #9ca3af;
    }

    .login-btn {
      width: 100%;
      padding: 14px 16px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      margin-top: 8px;
    }

    .send-code-btn {
      transition: all 0.3s;
      font-size: 14px;
    }
    
    .send-code-btn:hover:not(:disabled) {
      background: #5568d3;
      transform: translateY(-1px);
    }
    
    .send-code-btn:disabled {
      background: #9ca3af;
      cursor: not-allowed;
      opacity: 0.7;
    }
    
    .login-switch a {
      transition: all 0.2s;
    }
    
    .login-switch a:hover {
      color: #5568d3;
      text-decoration: underline;
    }

    .login-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(102, 126, 234, 0.4);
    }

    .login-btn:active {
      transform: translateY(0);
    }

    .login-footer {
      text-align: center;
      margin-top: 24px;
      font-size: 13px;
      color: #6b7280;
    }

    /* è®¾ç½®å¼¹çª— */
    .settings-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .settings-modal.show {
      display: flex;
    }

    /* åˆ†äº«å¼¹çª— */
    .share-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .share-modal.show {
      display: flex;
    }

    .share-content {
      background: white;
      border-radius: 12px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    }

    .share-header {
      padding: 24px 24px 0 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid #e5e7eb;
      margin-bottom: 24px;
    }

    .share-title {
      font-size: 20px;
      font-weight: 600;
      color: #1f2937;
    }

    .share-body {
      padding: 0 24px 24px 24px;
    }

    .share-link-container {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }

    .share-link-input {
      flex: 1;
      padding: 10px 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 14px;
      font-family: monospace;
      background: #f9fafb;
    }

    .share-link-input:focus {
      outline: none;
      border-color: #165dff;
      box-shadow: 0 0 0 3px rgba(22, 93, 255, 0.1);
    }

    .copy-link-btn {
      padding: 10px 16px;
      background: #165dff;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .copy-link-btn:hover {
      background: #0f4cd1;
    }

    .share-note {
      font-size: 12px;
      color: #6b7280;
      line-height: 1.5;
    }

    .settings-content {
      background: white;
      border-radius: 12px;
      width: 90%;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    }

    .settings-header {
      padding: 24px 24px 0 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid #e5e7eb;
      margin-bottom: 24px;
    }

    .settings-title {
      font-size: 20px;
      font-weight: 600;
      color: #1f2937;
    }

    .close-btn {
      width: 32px;
      height: 32px;
      border: none;
      background: #f3f4f6;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .close-btn:hover {
      background: #e5e7eb;
    }

    .settings-body {
      padding: 0 24px 24px 24px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #374151;
      margin-bottom: 8px;
    }

    .form-input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 14px;
      transition: border-color 0.2s;
    }

    .form-input:focus {
      outline: none;
      border-color: #165dff;
      box-shadow: 0 0 0 3px rgba(22, 93, 255, 0.1);
    }

    .slider-container {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .slider {
      flex: 1;
      height: 4px;
      background: #d1d5db;
      border-radius: 2px;
      outline: none;
      -webkit-appearance: none;
    }

    .slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 16px;
      height: 16px;
      background: #165dff;
      border-radius: 50%;
      cursor: pointer;
    }

    .slider::-moz-range-thumb {
      width: 16px;
      height: 16px;
      background: #165dff;
      border-radius: 50%;
      cursor: pointer;
      border: none;
    }

    .slider-value {
      min-width: 40px;
      text-align: center;
      font-weight: 500;
      color: #165dff;
    }

    .save-btn {
      width: 100%;
      padding: 12px;
      background: #165dff;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }

    .save-btn:hover {
      background: #0f4cd1;
    }
    
    #logoutBtn:hover {
      background: #dc2626 !important;
    }

    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: #6b7280;
      text-align: center;
    }

    .empty-state svg {
      width: 64px;
      height: 64px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .empty-state h3 {
      font-size: 18px;
      font-weight: 500;
      margin-bottom: 8px;
    }

    .empty-state p {
      font-size: 14px;
    }

    /* è®°å¿†å¼¹çª—æ ·å¼ */
    .memory-tabs {
      display: flex;
      border-bottom: 1px solid #e5e7eb;
      margin-bottom: 20px;
    }

    .memory-tab {
      flex: 1;
      padding: 12px 16px;
      background: none;
      border: none;
      border-bottom: 2px solid transparent;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      color: #6b7280;
      transition: all 0.2s;
    }

    .memory-tab.active {
      color: #165dff;
      border-bottom-color: #165dff;
    }

    .memory-tab:hover {
      color: #165dff;
    }

    .memory-panel {
      display: none;
    }

    .memory-panel.active {
      display: block;
    }

    .memory-list {
      max-height: 400px;
      overflow-y: auto;
    }

    .memory-item {
      padding: 16px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      margin-bottom: 12px;
      background: #f9fafb;
    }

    .memory-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .memory-item-time {
      font-size: 12px;
      color: #6b7280;
    }

    .memory-item-conversation {
      font-size: 12px;
      color: #165dff;
      background: #eef2ff;
      padding: 2px 8px;
      border-radius: 4px;
    }

    .memory-item-content {
      margin-bottom: 8px;
    }

    .memory-item-user {
      font-weight: 500;
      color: #1f2937;
      margin-bottom: 4px;
    }

    .memory-item-assistant {
      color: #4b5563;
      line-height: 1.5;
    }

    /* è®°å¿†ç±»å‹é€‰æ‹©å™¨æ ·å¼ */
    .memory-type-selector {
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .memory-type-selector label {
      font-size: 14px;
      font-weight: 500;
      color: #374151;
    }

    .memory-type-select {
      padding: 8px 12px;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      background: #ffffff;
      font-size: 14px;
      color: #374151;
      cursor: pointer;
      transition: all 0.2s;
      min-width: 120px;
    }

    .memory-type-select:hover {
      border-color: #9ca3af;
    }

    .memory-type-select:focus {
      outline: none;
      border-color: #165dff;
      box-shadow: 0 0 0 2px rgba(22, 93, 255, 0.1);
    }

    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 768px) {
      .sidebar {
        width: 100%;
        position: absolute;
        z-index: 100;
        transform: translateX(-100%);
        transition: transform 0.3s;
      }

      .sidebar.open {
        transform: translateX(0);
      }

      .chat-container {
        width: 100%;
      }

      .message-content {
        max-width: 85%;
      }
    }
  </style>
  <script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?a96829078f110de9737d670712e925a5";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
</head>
<body>
  <div class="app-container">
    <!-- å·¦ä¾§è¾¹æ  -->
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <button class="new-chat-btn" id="newChatBtn">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 5v14M5 12h14"/>
          </svg>
          æ–°å»ºå¯¹è¯
        </button>
      </div>
      <div class="chat-history" id="chatHistory">
        <!-- å†å²èŠå¤©åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
      </div>
    </div>

    <!-- ä¸»èŠå¤©åŒºåŸŸ -->
    <div class="chat-container">
      <!-- è®°å¿†å†…å®¹é¢æ¿ -->
      <div class="memory-content-panel" id="memoryContentPanel">
        <div class="memory-content-header">
          <div class="memory-content-title">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
              <circle cx="9" cy="7" r="4"/>
              <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
              <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
            </svg>
            ä½¿ç”¨çš„å…±äº«è®°å¿†
          </div>
          <button class="memory-content-close" id="memoryContentClose">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"/>
              <line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
          </button>
        </div>
        <div class="memory-content-body" id="memoryContentBody">
          <div class="memory-loading">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <path d="M12 6v6l4 2"/>
            </svg>
            <p>æ­£åœ¨åŠ è½½è®°å¿†å†…å®¹...</p>
          </div>
        </div>
      </div>
      
      <!-- æ‚¬æµ®çš„å¤´éƒ¨æŒ‰é’® -->
      <div class="floating-header-actions">
        <button class="settings-btn" id="memoryBtn" title="è®°å¿†ä»ªè¡¨ç›˜">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 12l2 2 4-4"/>
            <path d="M21 12c.552 0 1-.448 1-1V5c0-.552-.448-1-1-1H3c-.552 0-1 .448-1 1v6c0 .552.448 1 1 1h18z"/>
            <path d="M3 12v6c0 .552.448 1 1 1h16c.552 0 1-.448 1-1v-6H3z"/>
          </svg>
        </button>
        <button class="settings-btn" id="settingsBtn" title="è®¾ç½®">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="3"/>
            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1 1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
          </svg>
        </button>
      </div>

      <div class="chat-messages" id="chatMessages">
        <div class="empty-state">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
          </svg>
          <h3>å¼€å§‹æ–°çš„å¯¹è¯</h3>
          <p>åœ¨ä¸‹æ–¹è¾“å…¥æ¡†ä¸­è¾“å…¥æ‚¨çš„é—®é¢˜ï¼Œå¼€å§‹ä¸Experience Chatå¯¹è¯</p>
        </div>
      </div>

      <div class="chat-input-container">
        <div class="chat-input-wrapper">
          <div style="position: relative;">
            <textarea 
              class="chat-input" 
              id="chatInput" 
              placeholder="å°½ç®¡é—®..."
              rows="4"
            ></textarea>
            <div class="input-bottom-controls">
              <div class="input-controls-inner">
                <label class="model-label" for="aiModelSelector">AIæ¨¡å‹:</label>
                <select class="ai-model-selector" id="aiModelSelector">
                  <option value="gpt-5-chat-latest">GPT-5 Chat</option>
                  <option value="ark-deepseek-r1-250528">DeepSeek R1</option>
                  <option value="ark-kimi-k2-250711">Kimi K2</option>
                  <option value="ark-doubao-seed-1.6-vision-250815">Doubao Seed 1.6</option>
                  <option value="TA/Qwen/Qwen2.5-72B-Instruct-Turbo">Qwen2.5-72B-Instruct-Turbo</option>
                  <option value="gpt-4o-mini">GPT-4o Mini</option>
                  
                  
                </select>
                <button class="shared-memory-btn" id="sharedMemoryBtn">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                    <circle cx="9" cy="7" r="4"/>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                  </svg>
                  å¼€å¯è®°å¿†
                </button>
                <button class="mcp-tools-btn" id="mcpToolsBtn" title="å¯ç”¨ MCP å·¥å…·è°ƒç”¨ï¼ˆç½‘é¡µçˆ¬å–ã€æ–‡ä»¶æ“ä½œç­‰ï¼‰">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>
                  </svg>
                  è”ç½‘æœç´¢
                </button>
              </div>
              <!-- å·¥å…·è°ƒç”¨çŠ¶æ€æŒ‡ç¤ºå™¨ -->
              <div class="tool-call-indicator" id="toolCallIndicator">
                <div class="spinner"></div>
                <span id="toolCallStatus">å·¥å…·è°ƒç”¨ä¸­...</span>
              </div>
              <button class="send-btn" id="sendBtn">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="22" y1="2" x2="11" y2="13"/>
                  <polygon points="22,2 15,22 11,13 2,9 22,2"/>
                </svg>
              </button>
              <button class="stop-btn" id="stopBtn">
                <svg viewBox="0 0 24 24" fill="currentColor">
                  <rect x="6" y="6" width="12" height="12" rx="1"/>
                </svg>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ç™»å½•å¼¹çª— -->
  <div class="login-modal" id="loginModal">
    <div class="login-content">
      <div class="login-header">
        <div class="login-logo">ğŸ§ </div>
        <h2 class="login-title" id="loginTitle">æ¬¢è¿ä½¿ç”¨ Experience Chat</h2>
        <p class="login-subtitle" id="loginSubtitle">è¯·è¾“å…¥é‚®ç®±å’Œå¯†ç ç™»å½•</p>
      </div>
      
      <!-- ç™»å½•è¡¨å• -->
      <form class="login-form" id="loginForm" style="display: block;">
        <div class="login-input-group">
          <input 
            type="email" 
            class="login-input" 
            id="loginUsername" 
            placeholder="è¯·è¾“å…¥é‚®ç®±"
            autocomplete="email"
            required
          />
        </div>
        <div class="login-input-group">
          <input 
            type="password" 
            class="login-input" 
            id="loginPassword" 
            placeholder="è¯·è¾“å…¥å¯†ç "
            autocomplete="current-password"
            required
          />
        </div>
        <button type="submit" class="login-btn" id="loginSubmitBtn">
          ç™»å½•
        </button>
        <div class="login-switch" style="text-align: center; margin-top: 16px; display: flex; justify-content: center; gap: 16px;">
          <a href="#" id="switchToRegister" style="color: #667eea; text-decoration: none; font-weight: 600;">ç«‹å³æ³¨å†Œ</a>
          <a href="#" id="switchToEmailLogin" style="color: #667eea; text-decoration: none; font-weight: 600;">å¿˜è®°å¯†ç </a>
        </div>
      </form>
      
      <!-- å¿˜è®°å¯†ç è¡¨å•ï¼ˆé‚®ç®±+éªŒè¯ç +æ–°å¯†ç ï¼‰ -->
      <form class="login-form" id="emailLoginForm" style="display: none;">
        <div class="login-input-group">
          <input 
            type="email" 
            class="login-input" 
            id="emailLoginEmail" 
            placeholder="è¯·è¾“å…¥æ³¨å†Œé‚®ç®±"
            autocomplete="email"
            required
          />
        </div>
        <div class="login-input-group" style="display: flex; gap: 8px;">
          <input 
            type="text" 
            class="login-input" 
            id="emailLoginCode" 
            placeholder="è¯·è¾“å…¥éªŒè¯ç "
            style="flex: 1;"
            required
          />
          <button type="button" class="send-code-btn" id="emailLoginSendCodeBtn" style="white-space: nowrap; padding: 14px 20px; background: #667eea; color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 14px; font-weight: 600;">
            å‘é€éªŒè¯ç 
          </button>
        </div>
        <div class="login-input-group">
          <input 
            type="password" 
            class="login-input" 
            id="emailResetNewPassword" 
            placeholder="è¯·è¾“å…¥æ–°å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰"
            autocomplete="new-password"
            required
          />
        </div>
        <div class="login-input-group">
          <input 
            type="password" 
            class="login-input" 
            id="emailResetConfirmPassword" 
            placeholder="è¯·å†æ¬¡è¾“å…¥æ–°å¯†ç "
            autocomplete="new-password"
            required
          />
        </div>
        <button type="submit" class="login-btn" id="emailLoginSubmitBtn">
          é‡ç½®å¯†ç 
        </button>
        <div class="login-switch" style="text-align: center; margin-top: 16px;">
          <a href="#" id="switchToPasswordLogin" style="color: #667eea; text-decoration: none; font-weight: 600; margin-left: 4px;">è¿”å›ç™»å½•</a>
        </div>
      </form>
      
      <!-- æ³¨å†Œè¡¨å• -->
      <form class="login-form" id="registerForm" style="display: none;">
        <div class="login-input-group">
          <input 
            type="text" 
            class="login-input" 
            id="registerUsername" 
            placeholder="è¯·è¾“å…¥ç”¨æˆ·å"
            autocomplete="username"
            required
          />
        </div>
        <div class="login-input-group">
          <input 
            type="email" 
            class="login-input" 
            id="registerEmail" 
            placeholder="è¯·è¾“å…¥é‚®ç®±åœ°å€"
            autocomplete="email"
            required
          />
        </div>
        <div class="login-input-group" style="display: flex; gap: 8px;">
          <input 
            type="text" 
            class="login-input" 
            id="registerCode" 
            placeholder="è¯·è¾“å…¥éªŒè¯ç "
            style="flex: 1;"
            required
          />
          <button type="button" class="send-code-btn" id="sendCodeBtn" style="white-space: nowrap; padding: 14px 20px; background: #667eea; color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 14px; font-weight: 600;">
            å‘é€éªŒè¯ç 
          </button>
        </div>
        <div class="login-input-group">
          <input 
            type="password" 
            class="login-input" 
            id="registerPassword" 
            placeholder="è¯·è®¾ç½®å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰"
            autocomplete="new-password"
            required
          />
        </div>
        <div class="login-input-group">
          <input 
            type="password" 
            class="login-input" 
            id="registerPasswordConfirm" 
            placeholder="è¯·å†æ¬¡è¾“å…¥å¯†ç "
            autocomplete="new-password"
            required
          />
        </div>
        <button type="submit" class="login-btn" id="registerSubmitBtn">
          æ³¨å†Œ
        </button>
        <div class="login-switch" style="text-align: center; margin-top: 16px;">
          <span style="color: #6b7280;">å·²æœ‰è´¦å·ï¼Ÿ</span>
          <a href="#" id="switchToLogin" style="color: #667eea; text-decoration: none; font-weight: 600; margin-left: 4px;">ç«‹å³ç™»å½•</a>
        </div>
      </form>
      
      <div class="login-footer" id="loginError" style="color: #ef4444; display: none; margin-top: 12px; text-align: center;">
      </div>
      <div class="login-footer" id="registerError" style="color: #ef4444; display: none; margin-top: 12px; text-align: center;">
      </div>
      <div class="login-footer" id="registerSuccess" style="color: #10b981; display: none; margin-top: 12px; text-align: center;">
      </div>

    </div>
  </div>

  <!-- è®¾ç½®å¼¹çª— -->
  <div class="settings-modal" id="settingsModal">
    <div class="settings-content">
      <div class="settings-header">
        <h2 class="settings-title">è®¾ç½®</h2>
        <button class="close-btn" id="closeSettingsBtn">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>
      <div class="settings-body">
        <!-- å½“å‰ç”¨æˆ·ä¿¡æ¯ -->
        <div class="form-group" style="background: #f9fafb; padding: 12px 16px; border-radius: 8px; margin-bottom: 20px;">
          <label class="form-label" style="margin-bottom: 8px;">å½“å‰ç™»å½•ç”¨æˆ·</label>
          <div id="currentUserDisplay" style="font-size: 16px; font-weight: 600; color: #667eea;">
            åŠ è½½ä¸­...
          </div>
        </div>
        <!-- é¢åº¦æ˜¾ç¤º -->
        <div class="form-group" id="quotaGroup" style="margin-bottom: 20px;">
          <label class="form-label" id="quotaLabel">å·²ç”¨é¢åº¦ <span id="quotaStatus" style="color: #6b7280;">ï¼ˆå…è´¹é¢åº¦ï¼‰</span></label>
          <div id="quotaText" style="font-size: 14px; color: #374151; margin-bottom: 8px;">0/100000</div>
          <div class="progress" style="height: 10px; background: #f3f4f6; border-radius: 999px; overflow: hidden;">
            <div id="quotaBar" style="height: 100%; width: 0%; background: linear-gradient(90deg, #60a5fa, #818cf8);"></div>
          </div>
        </div>
        
        <form id="settingsForm">
          <div class="form-group" id="openaiKeyGroup">
            <label class="form-label" for="openaiApiKey">OpenAI API Key</label>
            <input type="password" class="form-input" id="openaiApiKey" name="openai_api_key" placeholder="è¯·è¾“å…¥OpenAI API Key" />
          </div>
          
          <div class="form-group" id="openaiBaseUrlGroup">
            <label class="form-label" for="openaiBaseUrl">OpenAI Base URL</label>
            <input type="text" class="form-input" id="openaiBaseUrl" name="openai_base_url" placeholder="https://api.openai.com/v1" />
          </div>
          
          <button type="submit" class="save-btn" id="saveSettingsBtn">ä¿å­˜è®¾ç½®</button>
        </form>
        
        <!-- é€€å‡ºç™»å½•æŒ‰é’® -->
        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e5e7eb;">
          <button type="button" class="save-btn" id="logoutBtn" style="background: #ef4444;">
            é€€å‡ºç™»å½•
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- åˆ†äº«å¼¹çª— -->
  <div class="share-modal" id="shareModal">
    <div class="share-content">
      <div class="share-header">
        <h2 class="share-title">åˆ†äº«å¯¹è¯</h2>
        <button class="close-btn" id="closeShareBtn">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>
      <div class="share-body">
        <div class="share-link-container">
          <input type="text" class="share-link-input" id="shareLinkInput" readonly>
          <button class="copy-link-btn" id="copyShareLinkBtn">å¤åˆ¶é“¾æ¥</button>
        </div>
        <div class="share-note">
          å…¶ä»–äººå¯ä»¥é€šè¿‡æ­¤é“¾æ¥æŸ¥çœ‹è¿™æ¡å›å¤ï¼Œå¹¶ç»§ç»­å¯¹è¯ã€‚
        </div>
      </div>
    </div>
  </div>

  <!-- è®°å¿†æŸ¥çœ‹å¼¹çª— -->
  <div class="settings-modal" id="memoryModal">
    <div class="settings-content">
      <div class="settings-header">
        <h2 class="settings-title">è®°å¿†æŸ¥çœ‹</h2>
        <button class="close-btn" id="closeMemoryBtn">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>
      <div class="settings-body">
        <div class="memory-tabs">
          <button class="memory-tab active" id="personalMemoryTab">ä¸ªäººè®°å¿†</button>
          <button class="memory-tab" id="sharedMemoryTab">å…±äº«è®°å¿†</button>
        </div>
        <div class="memory-content">
          <div id="personalMemoryContent" class="memory-panel active">
            <div class="memory-type-selector">
              <label for="memoryTypeSelect">è®°å¿†ç±»å‹ï¼š</label>
              <select id="memoryTypeSelect" class="memory-type-select">
                <option value="short">çŸ­æœŸè®°å¿†</option>
                <option value="mid">ä¸­æœŸè®°å¿†</option>
                <option value="long">é•¿æœŸè®°å¿†</option>
              </select>
            </div>
            <div class="memory-list" id="personalMemoryList">
              <!-- ä¸ªäººè®°å¿†åˆ—è¡¨å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>
          </div>
          <div id="sharedMemoryContent" class="memory-panel">
            <div class="memory-list" id="sharedMemoryList">
              <!-- å…±äº«è®°å¿†æš‚æ—¶ä¸ºç©º -->
              <div class="empty-state">å…±äº«è®°å¿†åŠŸèƒ½æš‚æœªå¼€æ”¾</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>


  <script>
    // å…¨å±€å˜é‡
    let currentChatId = null;
    let chatHistory = [];
    let currentUsername = null;
    let selectedModel = 'gpt-4o-mini';
    let sharedMemoryEnabled = true;  // é»˜è®¤å¼€å¯å…±äº«è®°å¿†
    let personalMemoryEnabled = true;  // ä¸ªäººè®°å¿†é»˜è®¤å¯ç”¨
    let mcpToolsEnabled = false;  // MCP å·¥å…·è°ƒç”¨é»˜è®¤å…³é—­
    let currentAbortController = null;  // ç”¨äºç»ˆæ­¢å½“å‰è¯·æ±‚
    let backendUrl = 'https://baijia.online/agent-share/'; // åç«¯URL

    // æµå¼Markdownå¢é‡æ¸²æŸ“èŠ‚æµçŠ¶æ€
    let lastMarkdownRenderAt = 0;
    let markdownRenderScheduled = false;
    let pendingRenderTimer = null;  // ğŸ”¥ ä¿å­˜pendingçš„æ¸²æŸ“ä»»åŠ¡ID
    const MARKDOWN_RENDER_INTERVAL_MS = 80; // èŠ‚æµé—´éš”ï¼Œå¹³è¡¡æµç•…åº¦ä¸æ€§èƒ½

    // DOMå…ƒç´ 
    const sidebar = document.getElementById('sidebar');
    const chatHistoryContainer = document.getElementById('chatHistory');
    const chatMessages = document.getElementById('chatMessages');
    const chatInput = document.getElementById('chatInput');
    const sendBtn = document.getElementById('sendBtn');
    const stopBtn = document.getElementById('stopBtn');
    const newChatBtn = document.getElementById('newChatBtn');
    const settingsBtn = document.getElementById('settingsBtn');
    const settingsModal = document.getElementById('settingsModal');
    const mcpToolsBtn = document.getElementById('mcpToolsBtn');
    const toolCallIndicator = document.getElementById('toolCallIndicator');
    const toolCallStatus = document.getElementById('toolCallStatus');
    const closeSettingsBtn = document.getElementById('closeSettingsBtn');
    const settingsForm = document.getElementById('settingsForm');
    const aiModelSelector = document.getElementById('aiModelSelector');
    const memoryBtn = document.getElementById('memoryBtn');
    const memoryModal = document.getElementById('memoryModal');
    const shareModal = document.getElementById('shareModal');
    const closeShareBtn = document.getElementById('closeShareBtn');
    const shareLinkInput = document.getElementById('shareLinkInput');
    const copyShareLinkBtn = document.getElementById('copyShareLinkBtn');
    const closeMemoryBtn = document.getElementById('closeMemoryBtn');
    const personalMemoryTab = document.getElementById('personalMemoryTab');
    const sharedMemoryTab = document.getElementById('sharedMemoryTab');
    const memoryTypeSelect = document.getElementById('memoryTypeSelect');
    const personalMemoryContent = document.getElementById('personalMemoryContent');
    const sharedMemoryContent = document.getElementById('sharedMemoryContent');
    const personalMemoryList = document.getElementById('personalMemoryList');
    const sharedMemoryList = document.getElementById('sharedMemoryList');
    const sharedMemoryBtn = document.getElementById('sharedMemoryBtn');
    const loginModal = document.getElementById('loginModal');
    const loginForm = document.getElementById('loginForm');
    const emailLoginForm = document.getElementById('emailLoginForm');
    const loginUsername = document.getElementById('loginUsername');
    const loginPassword = document.getElementById('loginPassword');
    const switchToEmailLogin = document.getElementById('switchToEmailLogin');
    const switchToPasswordLogin = document.getElementById('switchToPasswordLogin');
    const emailLoginEmail = document.getElementById('emailLoginEmail');
    const emailLoginCode = document.getElementById('emailLoginCode');
    const emailLoginSendCodeBtn = document.getElementById('emailLoginSendCodeBtn');
    const emailLoginSubmitBtn = document.getElementById('emailLoginSubmitBtn');
    const registerForm = document.getElementById('registerForm');
    const registerUsername = document.getElementById('registerUsername');
    const registerEmail = document.getElementById('registerEmail');
    const registerCode = document.getElementById('registerCode');
    const registerPassword = document.getElementById('registerPassword');
    const registerPasswordConfirm = document.getElementById('registerPasswordConfirm');
    const sendCodeBtn = document.getElementById('sendCodeBtn');
    const registerSubmitBtn = document.getElementById('registerSubmitBtn');
    const switchToRegister = document.getElementById('switchToRegister');
    const switchToLogin = document.getElementById('switchToLogin');
    const loginTitle = document.getElementById('loginTitle');
    const loginSubtitle = document.getElementById('loginSubtitle');
    const loginError = document.getElementById('loginError');
    const registerError = document.getElementById('registerError');
    const registerSuccess = document.getElementById('registerSuccess');
    const loginSubmitBtn = document.getElementById('loginSubmitBtn');
    
    // å‘é€éªŒè¯ç å€’è®¡æ—¶çŠ¶æ€
    let sendCodeCountdown = 0;
    let sendCodeTimer = null;

    // ğŸ”’ ç™»å½•çŠ¶æ€æ ‡å¿—
    let isLoggedIn = false;

    // åˆå§‹åŒ–Markdownæ¸²æŸ“å™¨
    function initializeMarkdown() {
      if (typeof marked !== 'undefined') {
        marked.setOptions({
          breaks: true,
          gfm: true,
          headerIds: false,
          mangle: false,
          sanitize: false
        });
      }
      
      if (typeof hljs !== 'undefined') {
      }
    }

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', async function() {
      initializeMarkdown();
      await checkLoginStatus(); // ğŸ”’ å…ˆç¡®ä¿æ‹¿åˆ°ç™»å½•æ€
      // å¦‚æœæ˜¯åˆ†äº«é“¾æ¥ï¼ŒcheckLoginStatus ä¸­å·²ç»å¤„ç†äº†ï¼Œè¿™é‡Œä¸éœ€è¦å†è°ƒç”¨ initializeApp
      const shareToken = getShareTokenFromURL();
      if (!shareToken) {
        initializeApp();
      }
      initializeSharedMemoryButton();
      setupEventListeners();
      setupLoginHandlers(); // ğŸ”’ è®¾ç½®ç™»å½•ç›¸å…³äº‹ä»¶
    });

    // ğŸ”’ æ£€æŸ¥ç™»å½•çŠ¶æ€
    async function checkLoginStatus() {
      // å…ˆæ£€æŸ¥æ˜¯å¦æ˜¯åˆ†äº«é“¾æ¥ï¼Œå¦‚æœæ˜¯ï¼Œå³ä½¿æœªç™»å½•ä¹Ÿè¦åŠ è½½
      const shareToken = getShareTokenFromURL();
      if (shareToken) {
        // å¦‚æœæ˜¯åˆ†äº«é“¾æ¥ï¼Œå…ˆå°è¯•åŠ è½½åˆ†äº«æ¶ˆæ¯ï¼ˆä¸éœ€è¦ç™»å½•ï¼‰
        await loadSharedMessage(shareToken);
        // åŠ è½½å®Œåˆ†äº«æ¶ˆæ¯åï¼Œç»§ç»­æ£€æŸ¥ç™»å½•çŠ¶æ€ï¼ˆå¦‚æœå·²ç™»å½•ï¼Œä¼šæ˜¾ç¤ºç”¨æˆ·èŠå¤©å†å²ï¼‰
      }
      
      try {
        const resp = await fetch(`${backendUrl}/api/me`, { credentials: 'include' });
        if (resp.ok) {
          const data = await resp.json();
          if (data.authenticated) {
            currentUsername = data.username || localStorage.getItem('username');
            if (currentUsername) localStorage.setItem('username', currentUsername);
            isLoggedIn = true;
            hideLoginModal();
            
            // å¦‚æœå·²ç™»å½•ä¸”æ˜¯åˆ†äº«é“¾æ¥ï¼Œé‡æ–°åŠ è½½åˆ†äº«æ¶ˆæ¯ï¼ˆè¿™æ¬¡ä¼šæ˜¾ç¤ºç”¨æˆ·èŠå¤©å†å²ï¼‰
            if (shareToken) {
              await loadSharedMessage(shareToken);
            }
            
            return;
          }
        }
        // æœªç™»å½•æ—¶ï¼Œå¦‚æœæ˜¯åˆ†äº«é“¾æ¥ï¼Œä¸æ˜¾ç¤ºç™»å½•å¼¹çª—ï¼ˆå…è®¸æŸ¥çœ‹åˆ†äº«å†…å®¹ï¼‰
        if (!shareToken) {
          showLoginModal();
        }
      } catch (e) {
        // å‡ºé”™æ—¶ï¼Œå¦‚æœæ˜¯åˆ†äº«é“¾æ¥ï¼Œä¸æ˜¾ç¤ºç™»å½•å¼¹çª—ï¼ˆå…è®¸æŸ¥çœ‹åˆ†äº«å†…å®¹ï¼‰
        if (!shareToken) {
          showLoginModal();
        }
      }
    }

    // ğŸ”’ æ˜¾ç¤ºç™»å½•å¼¹çª—
    function showLoginModal() {
      loginModal.classList.add('show');
      loginUsername.focus();
    }

    // ğŸ”’ éšè—ç™»å½•å¼¹çª—
    function hideLoginModal() {
      loginModal.classList.remove('show');
    }

    // ğŸ”’ å¤„ç†ç™»å½•
    async function handleLogin(username, password) {
      if (!username || username.trim() === '') {
        showLoginError('è¯·è¾“å…¥é‚®ç®±');
        return false;
      }
      
      if (!password || password.trim() === '') {
        showLoginError('è¯·è¾“å…¥å¯†ç ');
        return false;
      }
      
      // ç¦ç”¨ç™»å½•æŒ‰é’®ï¼Œæ˜¾ç¤ºåŠ è½½çŠ¶æ€
      loginSubmitBtn.disabled = true;
      loginSubmitBtn.textContent = 'ç™»å½•ä¸­...';
      hideLoginError();
      
      try {
        // è°ƒç”¨åç«¯éªŒè¯API
        const response = await fetch(`${backendUrl}/api/login`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          credentials: 'include',
          body: JSON.stringify({
            email: username.trim(),
            password: password.trim()
          })
        });
        
        const data = await response.json();
        
        if (data.success) {
          // ç™»å½•æˆåŠŸ
          currentUsername = data.username || username.trim();
          // ä»…ç”¨äºå±•ç¤ºç”¨æˆ·åï¼Œä¸ä½œä¸ºè®¤è¯ä¾æ®
          localStorage.setItem('username', currentUsername);
          isLoggedIn = true;
          
          hideLoginModal();
          
          // æ£€æŸ¥æ˜¯å¦æ˜¯åˆ†äº«é“¾æ¥é¡µé¢
          const shareToken = getShareTokenFromURL();
          if (shareToken) {
            // å¦‚æœæ˜¯åˆ†äº«é“¾æ¥ï¼Œé‡æ–°åŠ è½½åˆ†äº«æ¶ˆæ¯ï¼ˆè¿™æ¬¡ä¼šæ˜¾ç¤ºç”¨æˆ·èŠå¤©å†å²ï¼‰
            await loadSharedMessage(shareToken);
          } else {
            // ç™»å½•æˆåŠŸååˆå§‹åŒ–åº”ç”¨
            loadUserConfig();
            loadChatHistory();
            showNewChatInterface();
          }
          
          
          // é‡ç½®è¡¨å•
          loginUsername.value = '';
          loginPassword.value = '';
          
          return true;
        } else {
          // ç™»å½•å¤±è´¥
          showLoginError(data.error || 'ç™»å½•å¤±è´¥');
          loginPassword.value = ''; // æ¸…ç©ºå¯†ç 
          loginPassword.focus();
          return false;
        }
      } catch (error) {
        showLoginError('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
        return false;
      } finally {
        // æ¢å¤ç™»å½•æŒ‰é’®çŠ¶æ€
        loginSubmitBtn.disabled = false;
        loginSubmitBtn.textContent = 'ç™»å½•';
      }
    }
    
    // ğŸ”’ æ˜¾ç¤ºç™»å½•é”™è¯¯
    function showLoginError(message) {
      loginError.textContent = message;
      loginError.style.display = 'block';
    }
    
    // ğŸ”’ éšè—ç™»å½•é”™è¯¯
    function hideLoginError() {
      loginError.style.display = 'none';
      loginError.textContent = '';
    }
    
    // ğŸ”’ æ˜¾ç¤ºæ³¨å†Œé”™è¯¯
    function showRegisterError(message) {
      registerError.textContent = message;
      registerError.style.display = 'block';
      registerSuccess.style.display = 'none';
    }
    
    // ğŸ”’ éšè—æ³¨å†Œé”™è¯¯
    function hideRegisterError() {
      registerError.style.display = 'none';
      registerError.textContent = '';
    }
    
    // ğŸ”’ æ˜¾ç¤ºæ³¨å†ŒæˆåŠŸ
    function showRegisterSuccess(message) {
      registerSuccess.textContent = message;
      registerSuccess.style.display = 'block';
      registerError.style.display = 'none';
    }
    
    // ğŸ”’ åˆ‡æ¢åˆ°æ³¨å†Œè¡¨å•
    function switchToRegisterForm() {
      loginForm.style.display = 'none';
      registerForm.style.display = 'block';
      loginTitle.textContent = 'æ³¨å†Œè´¦å·';
      loginSubtitle.textContent = 'è¯·è¾“å…¥ç”¨æˆ·åå’Œé‚®ç®±è¿›è¡Œæ³¨å†Œ';
      hideLoginError();
      hideRegisterError();
      registerSuccess.style.display = 'none';
      registerUsername.focus();
    }
    
    // ğŸ”’ åˆ‡æ¢åˆ°ç™»å½•è¡¨å•
    function switchToLoginForm() {
      registerForm.style.display = 'none';
      emailLoginForm.style.display = 'none';
      loginForm.style.display = 'block';
      loginTitle.textContent = 'æ¬¢è¿ä½¿ç”¨ Experience Chat';
      loginSubtitle.textContent = 'è¯·è¾“å…¥é‚®ç®±å’Œå¯†ç ç™»å½•';
      hideLoginError();
      hideRegisterError();
      registerSuccess.style.display = 'none';
      // æ¸…ç©ºæ³¨å†Œè¡¨å•
      registerUsername.value = '';
      registerEmail.value = '';
      registerCode.value = '';
      registerPassword.value = '';
      registerPasswordConfirm.value = '';
      loginUsername.focus();
    }

    // ğŸ”’ åˆ‡æ¢åˆ°å¿˜è®°å¯†ç 
    function switchToEmailLoginForm() {
      loginForm.style.display = 'none';
      registerForm.style.display = 'none';
      emailLoginForm.style.display = 'block';
      loginTitle.textContent = 'å¿˜è®°å¯†ç ';
      loginSubtitle.textContent = 'è¯·è¾“å…¥æ³¨å†Œé‚®ç®±ã€éªŒè¯ç å’Œæ–°å¯†ç ä»¥é‡ç½®';
      hideLoginError();
      emailLoginEmail.focus();
    }
    
    // ğŸ”’ å‘é€éªŒè¯ç 
    async function sendVerificationCode() {
      const username = registerUsername.value.trim();
      const email = registerEmail.value.trim();
      
      if (!username) {
        showRegisterError('è¯·è¾“å…¥ç”¨æˆ·å');
        return;
      }
      
      if (!email) {
        showRegisterError('è¯·è¾“å…¥é‚®ç®±åœ°å€');
        return;
      }
      
      // ç®€å•çš„é‚®ç®±æ ¼å¼éªŒè¯
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        showRegisterError('é‚®ç®±æ ¼å¼ä¸æ­£ç¡®');
        return;
      }
      
      // ç¦ç”¨å‘é€æŒ‰é’®ï¼Œæ˜¾ç¤ºåŠ è½½çŠ¶æ€
      sendCodeBtn.disabled = true;
      sendCodeBtn.textContent = 'å‘é€ä¸­...';
      hideRegisterError();
      
      try {
        const response = await fetch(`${backendUrl}/api/send_verification_code`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            username: username,
            email: email
          })
        });
        
        const data = await response.json();
        
        if (data.success) {
          showRegisterSuccess(data.message || 'éªŒè¯ç å·²å‘é€ï¼Œè¯·æŸ¥æ”¶é‚®ä»¶');
          // å¼€å§‹å€’è®¡æ—¶ï¼ˆ60ç§’ï¼‰
          startSendCodeCountdown(60);
        } else {
          showRegisterError(data.error || 'éªŒè¯ç å‘é€å¤±è´¥');
          sendCodeBtn.disabled = false;
          sendCodeBtn.textContent = 'å‘é€éªŒè¯ç ';
        }
      } catch (error) {
        showRegisterError('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
        sendCodeBtn.disabled = false;
        sendCodeBtn.textContent = 'å‘é€éªŒè¯ç ';
      }
    }
    
    // ğŸ”’ å¼€å§‹å‘é€éªŒè¯ç å€’è®¡æ—¶
    function startSendCodeCountdown(seconds) {
      sendCodeCountdown = seconds;
      sendCodeBtn.disabled = true;
      
      if (sendCodeTimer) {
        clearInterval(sendCodeTimer);
      }
      
      sendCodeBtn.textContent = `${sendCodeCountdown}ç§’åé‡è¯•`;
      
      sendCodeTimer = setInterval(() => {
        sendCodeCountdown--;
        if (sendCodeCountdown > 0) {
          sendCodeBtn.textContent = `${sendCodeCountdown}ç§’åé‡è¯•`;
        } else {
          clearInterval(sendCodeTimer);
          sendCodeTimer = null;
          sendCodeBtn.disabled = false;
          sendCodeBtn.textContent = 'å‘é€éªŒè¯ç ';
        }
      }, 1000);
    }
    
    // ğŸ”’ å¤„ç†æ³¨å†Œ
    async function handleRegister() {
      const username = registerUsername.value.trim();
      const email = registerEmail.value.trim();
      const code = registerCode.value.trim();
      const password = registerPassword.value;
      const passwordConfirm = registerPasswordConfirm.value;
      
      if (!username) {
        showRegisterError('è¯·è¾“å…¥ç”¨æˆ·å');
        return false;
      }
      
      if (!email) {
        showRegisterError('è¯·è¾“å…¥é‚®ç®±åœ°å€');
        return false;
      }
      
      if (!code) {
        showRegisterError('è¯·è¾“å…¥éªŒè¯ç ');
        return false;
      }

      if (!password || password.length < 6) {
        showRegisterError('è¯·è®¾ç½®è‡³å°‘6ä½å¯†ç ');
        return false;
      }

      if (password !== passwordConfirm) {
        showRegisterError('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´');
        return false;
      }
      
      // ç¦ç”¨æ³¨å†ŒæŒ‰é’®ï¼Œæ˜¾ç¤ºåŠ è½½çŠ¶æ€
      registerSubmitBtn.disabled = true;
      registerSubmitBtn.textContent = 'æ³¨å†Œä¸­...';
      hideRegisterError();
      
      try {
        const response = await fetch(`${backendUrl}/api/register`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            username: username,
            email: email,
            verification_code: code,
            password: password
          })
        });
        
        const data = await response.json();
        
        if (data.success) {
          showRegisterSuccess(data.message || 'æ³¨å†ŒæˆåŠŸï¼');
          // 2ç§’åè‡ªåŠ¨åˆ‡æ¢åˆ°ç™»å½•è¡¨å•
          setTimeout(() => {
            switchToLoginForm();
            // åœ¨ç™»å½•è¡¨å•ä¸­å¡«å……ç”¨æˆ·å
            loginUsername.value = username;
            // è½»æç¤º
            showLoginError('æ³¨å†ŒæˆåŠŸï¼è¯·ä½¿ç”¨åˆšè®¾ç½®çš„å¯†ç ç™»å½•');
          }, 2000);
          return true;
        } else {
          showRegisterError(data.error || 'æ³¨å†Œå¤±è´¥');
          registerCode.value = ''; // æ¸…ç©ºéªŒè¯ç 
          registerCode.focus();
          return false;
        }
      } catch (error) {
        showRegisterError('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
        return false;
      } finally {
        // æ¢å¤æ³¨å†ŒæŒ‰é’®çŠ¶æ€
        registerSubmitBtn.disabled = false;
        registerSubmitBtn.textContent = 'æ³¨å†Œ';
      }
    }

    // ğŸ”’ è®¾ç½®ç™»å½•ç›¸å…³äº‹ä»¶å¤„ç†
    function setupLoginHandlers() {
      // ç™»å½•è¡¨å•æäº¤
      loginForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const username = loginUsername.value;
        const password = loginPassword.value;
        await handleLogin(username, password);
      });
      
      // æ³¨å†Œè¡¨å•æäº¤
      registerForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        await handleRegister();
      });
      
      // åˆ‡æ¢åˆ°æ³¨å†Œè¡¨å•
      switchToRegister.addEventListener('click', function(e) {
        e.preventDefault();
        switchToRegisterForm();
      });
      
      // åˆ‡æ¢åˆ°ç™»å½•è¡¨å•
      switchToLogin.addEventListener('click', function(e) {
        e.preventDefault();
        switchToLoginForm();
      });

      // åˆ‡æ¢åˆ°é‚®ç®±éªŒè¯ç ç™»å½•
      switchToEmailLogin.addEventListener('click', function(e) {
        e.preventDefault();
        switchToEmailLoginForm();
      });

      // åˆ‡æ¢å›è´¦å·å¯†ç ç™»å½•
      switchToPasswordLogin.addEventListener('click', function(e) {
        e.preventDefault();
        switchToLoginForm();
      });

      // å‘é€å¿˜è®°å¯†ç éªŒè¯ç 
      emailLoginSendCodeBtn.addEventListener('click', async function(e) {
        e.preventDefault();
        const email = emailLoginEmail.value.trim();
        if (!email) {
          showLoginError('è¯·è¾“å…¥æ³¨å†Œé‚®ç®±');
          return;
        }
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
          showLoginError('é‚®ç®±æ ¼å¼ä¸æ­£ç¡®');
          return;
        }
        // ç®€å•é˜²é‡å¤ç‚¹å‡»
        emailLoginSendCodeBtn.disabled = true;
        emailLoginSendCodeBtn.textContent = 'å‘é€ä¸­...';
        hideLoginError();
        try {
          const resp = await fetch(`${backendUrl}/api/send_reset_code`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email })
          });
          const data = await resp.json();
          if (data.success) {
            showLoginError('éªŒè¯ç å·²å‘é€ï¼Œè¯·æŸ¥æ”¶é‚®ç®±');
            // ç®€æ˜“å€’è®¡æ—¶
            let left = 60;
            const timer = setInterval(() => {
              left--;
              if (left > 0) {
                emailLoginSendCodeBtn.textContent = `${left}ç§’åé‡è¯•`;
              } else {
                clearInterval(timer);
                emailLoginSendCodeBtn.disabled = false;
                emailLoginSendCodeBtn.textContent = 'å‘é€éªŒè¯ç ';
              }
            }, 1000);
          } else {
            showLoginError(data.error || 'å‘é€éªŒè¯ç å¤±è´¥');
            emailLoginSendCodeBtn.disabled = false;
            emailLoginSendCodeBtn.textContent = 'å‘é€éªŒè¯ç ';
          }
        } catch (err) {
          showLoginError('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
          emailLoginSendCodeBtn.disabled = false;
          emailLoginSendCodeBtn.textContent = 'å‘é€éªŒè¯ç ';
        }
      });

      // æäº¤é‡ç½®å¯†ç 
      emailLoginForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const email = emailLoginEmail.value.trim();
        const code = emailLoginCode.value.trim();
        const newPassword = emailResetNewPassword.value.trim();
        const confirmPassword = emailResetConfirmPassword.value.trim();
        if (!email || !code || !newPassword || !confirmPassword) {
          showLoginError('è¯·è¾“å…¥é‚®ç®±ã€éªŒè¯ç å’Œæ–°å¯†ç ');
          return;
        }
        if (newPassword.length < 6) {
          showLoginError('å¯†ç é•¿åº¦éœ€è‡³å°‘6ä½');
          return;
        }
        if (newPassword !== confirmPassword) {
          showLoginError('ä¸¤æ¬¡è¾“å…¥çš„æ–°å¯†ç ä¸ä¸€è‡´');
          return;
        }
        emailLoginSubmitBtn.disabled = true;
        emailLoginSubmitBtn.textContent = 'æäº¤ä¸­...';
        hideLoginError();
        try {
          const resp = await fetch(`${backendUrl}/api/reset_password`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, verification_code: code, new_password: newPassword, confirm_password: confirmPassword })
          });
          const data = await resp.json();
          if (data.success) {
            showLoginError('å¯†ç å·²é‡ç½®ï¼Œè¯·ä½¿ç”¨æ–°å¯†ç ç™»å½•');
            switchToLoginForm();
          } else {
            showLoginError(data.error || 'é‡ç½®å¯†ç å¤±è´¥');
          }
        } catch (err) {
          showLoginError('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
        } finally {
          emailLoginSubmitBtn.disabled = false;
          emailLoginSubmitBtn.textContent = 'é‡ç½®å¯†ç ';
        }
      });
      
      // å‘é€éªŒè¯ç æŒ‰é’®
      sendCodeBtn.addEventListener('click', function(e) {
        e.preventDefault();
        sendVerificationCode();
      });

      // é˜»æ­¢ç‚¹å‡»èƒŒæ™¯å…³é—­ç™»å½•å¼¹çª—
      loginModal.addEventListener('click', function(e) {
        if (e.target === loginModal && !isLoggedIn) {
          // æœªç™»å½•æ—¶ä¸å…è®¸å…³é—­
          if (loginForm.style.display !== 'none') {
            loginUsername.focus();
          } else {
            registerUsername.focus();
          }
        }
      });
    }

    // ğŸ”’ æ£€æŸ¥æ˜¯å¦éœ€è¦ç™»å½•ï¼ˆåŠŸèƒ½æ‹¦æˆªï¼‰
    function requireLogin() {
      if (!isLoggedIn) {
        showLoginModal();
        return false;
      }
      return true;
    }
    
    // ğŸ”’ å¤„ç†é€€å‡ºç™»å½•
    async function handleLogout() {
      if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
        try {
          await fetch(`${backendUrl}/api/logout`, { method: 'POST', credentials: 'include' });
        } catch (e) { }
        // æ¸…é™¤æœ¬åœ°å±•ç¤ºç”¨ç”¨æˆ·å
        localStorage.removeItem('username');
        currentUsername = null;
        isLoggedIn = false;
        closeSettings();
        location.reload();
      }
    }

    // åˆå§‹åŒ–åº”ç”¨
    async function initializeApp() {
      // æ£€æŸ¥æ˜¯å¦æ˜¯åˆ†äº«é“¾æ¥
      const shareToken = getShareTokenFromURL();
      if (shareToken) {
        // å¦‚æœæ˜¯åˆ†äº«é“¾æ¥ï¼ŒåŠ è½½åˆ†äº«çš„æ¶ˆæ¯ï¼ˆä¼šæ£€æŸ¥ç™»å½•çŠ¶æ€ï¼‰
        await loadSharedMessage(shareToken);
        return;
      }
      
      // åªæœ‰ç™»å½•åæ‰æ‰§è¡Œ
      if (!isLoggedIn) {
        return;
      }
      
      // åŠ è½½ç”¨æˆ·é…ç½®å’ŒèŠå¤©å†å²
      loadUserConfig();
      loadChatHistory();
      
      // æ£€æŸ¥ç”¨æˆ·é…ç½®
      checkUserConfig();
    }

    // ä» URL è·å–åˆ†äº«ä»¤ç‰Œ
    function getShareTokenFromURL() {
      const path = window.location.pathname;
      // æ£€æŸ¥æ˜¯å¦æ˜¯åˆ†äº«é“¾æ¥æ ¼å¼: /{chat_id}{timestamp_numeric} æˆ– /agent-share/{chat_id}{timestamp_numeric}
      // å…ˆå°è¯•åŒ¹é…å¸¦ /agent-share å‰ç¼€çš„è·¯å¾„
      let match = path.match(/^\/agent-share\/(chat_\d+\d{14})$/);
      if (match) {
        return match[1];
      }
      // å†å°è¯•åŒ¹é…ä¸å¸¦å‰ç¼€çš„è·¯å¾„ï¼ˆå…¼å®¹æ—§æ ¼å¼ï¼‰
      match = path.match(/^\/(chat_\d+\d{14})$/);
      if (match) {
        return match[1];
      }
      return null;
    }

    // åŠ è½½åˆ†äº«çš„æ¶ˆæ¯ï¼ˆä¸éœ€è¦ç™»å½•å³å¯æŸ¥çœ‹ï¼‰
    async function loadSharedMessage(shareToken) {
      try {
        // æ¸…é™¤å½“å‰å¯¹è¯
        chatMessages.innerHTML = '';
        currentChatId = null;
        
        // è°ƒç”¨ API è·å–åˆ†äº«çš„æ¶ˆæ¯ï¼ˆä¸éœ€è¦ç™»å½•ï¼‰
        const response = await fetch(`${backendUrl}/api/get_shared_message?share_token=${encodeURIComponent(shareToken)}`);
        const data = await response.json();
        
        if (!data.success) {
          alert('åŠ è½½åˆ†äº«æ¶ˆæ¯å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
          // è·³è½¬åˆ°ä¸»é¡µ
          window.location.href = '/';
          return;
        }
        
        const sharedMessage = data.message;
        const model = data.model;
        
        // ä¿å­˜åˆ†äº«ä¿¡æ¯ï¼Œç”¨äºåç»­å¯¹è¯
        window.shareToken = shareToken;
        window.originalUsername = data.original_username;
        // ä¿å­˜åŸå§‹åˆ†äº«é“¾æ¥ï¼ˆç¡®ä¿åŒ…å« /agent-share å‰ç¼€ï¼‰
        const basePath = window.location.pathname.includes('/agent-share') ? '/agent-share' : '';
        window.originalShareLink = `${window.location.origin}${basePath}/${shareToken}`;
        window.sharedMessageSaved = false; // æ ‡è®°åˆ†äº«æ¶ˆæ¯æ˜¯å¦å·²ä¿å­˜åˆ°ç”¨æˆ·å¯¹è¯ä¸­
        
        // æ˜¾ç¤ºåˆ†äº«çš„æ¶ˆæ¯ï¼ˆä½œä¸ºç¬¬ä¸€æ¡ AI æ¶ˆæ¯ï¼‰
        const messageDiv = addMessageToUI(
          'assistant',
          sharedMessage.content,
          sharedMessage.shared_memory_enabled || null,
          sharedMessage.used_shared_memories || [],
          sharedMessage.timestamp
        );
        
        // åœ¨æ¶ˆæ¯divä¸Šä¿å­˜åŸå§‹åˆ†äº«é“¾æ¥ä¿¡æ¯
        if (messageDiv) {
          messageDiv.dataset.originalShareLink = window.originalShareLink;
          messageDiv.dataset.isSharedMessage = 'true';
        }
        
        // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
        if (isLoggedIn && currentUsername) {
          // å·²ç™»å½•ï¼šåŠ è½½ç”¨æˆ·çš„èŠå¤©å†å²ï¼ˆåœ¨ä¾§è¾¹æ æ˜¾ç¤ºï¼‰
          await loadUserChatHistory();
        } else {
          // æœªç™»å½•ï¼šæ˜¾ç¤ºæç¤º
          const noticeDiv = document.createElement('div');
          noticeDiv.style.cssText = 'padding: 12px; margin: 16px; background: #fef3c7; border: 1px solid #fbbf24; border-radius: 8px; color: #92400e; font-size: 14px;';
          noticeDiv.textContent = 'ğŸ’¡ æç¤ºï¼šè¿™æ˜¯åˆ†äº«çš„å¯¹è¯å†…å®¹ã€‚ç™»å½•åå¯æŸ¥çœ‹æ‚¨çš„èŠå¤©å†å²å¹¶ç»§ç»­å¯¹è¯ã€‚';
          chatMessages.appendChild(noticeDiv);
        }
        
        // æ»šåŠ¨åˆ°åº•éƒ¨
        setTimeout(() => {
          if (chatMessages) {
            chatMessages.scrollTop = chatMessages.scrollHeight;
          }
        }, 100);
        
        // è®¾ç½®å½“å‰æ¨¡å‹
        selectedModel = model;
        if (aiModelSelector) {
          aiModelSelector.value = model;
        }
        
        // æ¢å¤è¾“å…¥æ¡†åˆ°æ­£å¸¸ä½ç½®
        restoreInputBox();
        clearEmptyState();
        
      } catch (error) {
        alert('åŠ è½½åˆ†äº«æ¶ˆæ¯å¤±è´¥ï¼Œè¯·é‡è¯•');
        window.location.href = '/';
      }
    }

    // åŠ è½½ç”¨æˆ·çš„èŠå¤©å†å²ï¼ˆä»…åœ¨å·²ç™»å½•æ—¶è°ƒç”¨ï¼‰
    async function loadUserChatHistory() {
      if (!isLoggedIn || !currentUsername) {
        return;
      }
      
      try {
        // åŠ è½½ç”¨æˆ·é…ç½®å’ŒèŠå¤©å†å²ï¼ˆä¸ä¼šè§¦å‘ç™»å½•æ‹¦æˆªï¼Œå› ä¸ºå·²ç»ç™»å½•ï¼‰
        await loadUserConfig();
        
        // ç›´æ¥è°ƒç”¨åŠ è½½èŠå¤©å†å²çš„é€»è¾‘ï¼Œé¿å… requireLogin æ£€æŸ¥
        try {
          const response = await fetch(`${backendUrl}/get_chat_conversations`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            credentials: 'include',
            body: JSON.stringify({
              username: currentUsername
            })
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();
          
          if (data.success) {
            chatHistory = data.conversations;
            chatHistoryContainer.innerHTML = '';
            
            data.conversations.forEach(chat => {
              const chatItem = document.createElement('div');
              chatItem.className = 'chat-history-item';
              if (chat.id === currentChatId) {
                chatItem.classList.add('active');
              }
              const starHtml = chat.contributed_shared_memory
                ? `
                <span class="chat-history-flag" title="æœ¬æ¬¡å¯¹è¯å‚ä¸æ„å»ºå…±äº«è®°å¿†">
                  <svg viewBox="0 0 24 24" stroke="none">
                    <path d="M12 2l2.91 5.88 6.49.94-4.7 4.58 1.11 6.46L12 17.77l-5.81 3.06 1.11-6.46-4.7-4.58 6.49-.94L12 2z"/>
                  </svg>
                </span>
              `
                : '';

              chatItem.innerHTML = `
                <div class="chat-history-item-title">${chat.title || 'æ–°å¯¹è¯'}</div>
                <div class="chat-history-item-time">${formatTime(chat.updated_at)}</div>
                ${starHtml}
                <div class="chat-history-item-actions">
                  <button class="delete-btn" onclick="deleteChat('${chat.id}')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polyline points="3,6 5,6 21,6"/>
                      <path d="M19,6v14a2,2 0 0,1 -2,2H7a2,2 0 0,1 -2,-2V6m3,0V4a2,2 0 0,1 2,-2h4a2,2 0 0,1 2,2v2"/>
                    </svg>
                  </button>
                </div>
              `;
              
              chatItem.addEventListener('click', function() {
                loadChat(chat.id, this);
              });
              chatHistoryContainer.appendChild(chatItem);
            });
            
          } else {
          }
        } catch (error) {
        }
      } catch (error) {
      }
    }
    
    // æ£€æŸ¥ç”¨æˆ·é…ç½®ï¼ˆå·²æ”¹ä¸ºä¸æ‹¦æˆªæ–°ç”¨æˆ·ï¼Œä¸å¼¹å‡ºè®¾ç½®å¼¹çª—ï¼‰
    async function checkUserConfig() {
      return; // ä½¿ç”¨å¹³å°å…¬å…±é¢åº¦æ—¶æ— éœ€å¼ºåˆ¶æç¤ºé…ç½®
    }

    // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
    function setupEventListeners() {
      // å‘é€æ¶ˆæ¯ï¼ˆå‰ç½®é¢åº¦æ£€æŸ¥ï¼‰
      sendBtn.addEventListener('click', async function() {
        const ok = await checkQuotaBeforeSend();
        if (!ok) return;
        sendMessage();
      });
      
      // åœæ­¢ç”Ÿæˆ
      stopBtn.addEventListener('click', stopGeneration);
      
      // è¾“å…¥æ¡†ç„¦ç‚¹æ‹¦æˆª
      chatInput.addEventListener('focus', function(e) {
        if (!requireLogin()) {
          e.target.blur(); // ç§»é™¤ç„¦ç‚¹
        }
      });

      chatInput.addEventListener('keydown', async function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          const ok = await checkQuotaBeforeSend();
          if (!ok) return;
          sendMessage();
        }
      });

      // æ–°å»ºå¯¹è¯
      newChatBtn.addEventListener('click', createNewChat);

      // è®¾ç½®ç›¸å…³
      settingsBtn.addEventListener('click', openSettings);
      closeSettingsBtn.addEventListener('click', closeSettings);
      settingsModal.addEventListener('click', function(e) {
        if (e.target === settingsModal) {
          closeSettings();
        }
      });

      // åˆ†äº«å¼¹çª—ç›¸å…³
      closeShareBtn.addEventListener('click', closeShareModal);
      shareModal.addEventListener('click', function(e) {
        if (e.target === shareModal) {
          closeShareModal();
        }
      });
      copyShareLinkBtn.addEventListener('click', async function() {
        const link = shareLinkInput.value;
        try {
          await navigator.clipboard.writeText(link);
          const oldText = copyShareLinkBtn.textContent;
          copyShareLinkBtn.textContent = 'å·²å¤åˆ¶';
          setTimeout(() => {
            copyShareLinkBtn.textContent = oldText;
          }, 1600);
        } catch (e) {
          alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
        }
      });

      // è®°å¿†ç›¸å…³ - è·³è½¬åˆ°dashboardé¡µé¢
      memoryBtn.addEventListener('click', function() {
        // ğŸ”’ ç™»å½•æ‹¦æˆª
        if (!requireLogin()) return;
        
        // ç¡®ä¿ç”¨æˆ·åå·²ä¿å­˜åˆ° localStorage
        localStorage.setItem('username', currentUsername);
        // åœ¨æ–°çª—å£ä¸­æ‰“å¼€ dashboard
        window.open('dashboard', '_blank');
      });

      // è®°å¿†æ ‡ç­¾é¡µåˆ‡æ¢
      personalMemoryTab.addEventListener('click', () => switchMemoryTab('personal'));
      sharedMemoryTab.addEventListener('click', () => switchMemoryTab('shared'));
      
      // è®°å¿†ç±»å‹é€‰æ‹©å™¨
      memoryTypeSelect.addEventListener('change', loadPersonalMemory);

      // è¡¨å•æäº¤
      settingsForm.addEventListener('submit', saveSettings);

      // AIæ¨¡å‹é€‰æ‹©å™¨
      aiModelSelector.addEventListener('change', function() {
        selectedModel = this.value;
      });

      // å…±äº«è®°å¿†æŒ‰é’®
      sharedMemoryBtn.addEventListener('click', toggleSharedMemory);

      // MCP å·¥å…·è°ƒç”¨æŒ‰é’®
      mcpToolsBtn.addEventListener('click', toggleMcpTools);

      // é€€å‡ºç™»å½•æŒ‰é’®
      const logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', handleLogout);
      }

      // è®°å¿†å†…å®¹é¢æ¿å…³é—­æŒ‰é’®
      const memoryContentClose = document.getElementById('memoryContentClose');
      if (memoryContentClose) {
        memoryContentClose.addEventListener('click', closeMemoryContentPanel);
      }
    }

    // åœæ­¢ç”Ÿæˆ
    function stopGeneration() {
      if (currentAbortController) {
        currentAbortController.abort();
        currentAbortController = null;
        
        // ç«‹å³æ¸…ç†æ‰€æœ‰ç›¸å…³çŠ¶æ€
        sendBtn.classList.remove('hidden');
        sendBtn.disabled = false;
        stopBtn.classList.remove('show');
        chatInput.focus();
        
        // æ·»åŠ ä¸€æ¡æç¤ºæ¶ˆæ¯
        const lastMessage = chatMessages.lastElementChild;
        if (lastMessage && lastMessage.classList.contains('assistant')) {
          const messageContent = lastMessage.querySelector('.message-content');
          if (messageContent) {
            messageContent.innerHTML += '\n\n<em style="color: #6b7280; font-size: 0.9em;">ï¼ˆå›å¤å·²è¢«ç”¨æˆ·ç»ˆæ­¢ï¼‰</em>';
          }
        }
        
        // ç¡®ä¿UIçŠ¶æ€å®Œå…¨æ¢å¤ï¼Œå…è®¸ç«‹å³åˆ‡æ¢å¯¹è¯
      }
    }

    // å‘é€å‰æ£€æŸ¥é¢åº¦ï¼Œå·²æ»¡åˆ™æ‰“å¼€è®¾ç½®å¹¶é˜»æ­¢å‘é€
    async function checkQuotaBeforeSend() {
      if (!currentUsername) return false;
      try {
        const resp = await fetch(`${backendUrl}/api/get_quota?username=${encodeURIComponent(currentUsername)}`, { credentials: 'include' });
        const data = await resp.json();
        if (!data.success) return true; // è·å–å¤±è´¥ä¸æ‹¦æˆª
        const total = Number(data.quota_total || 100000);
        const used = Number(data.quota_used || 0);
        if (used >= total) {
          // é¢åº¦å·²æ»¡æ—¶ï¼Œæ£€æŸ¥æ˜¯å¦å·²ä¿å­˜ä¸ªäºº OpenAI API Keyï¼Œå¦‚æœå·²é…ç½®åˆ™æ”¾è¡Œ
          try {
            const cfgResp = await fetch(`${backendUrl}/chat/users/${encodeURIComponent(currentUsername)}/config.json`, { credentials: 'include' });
            if (cfgResp.ok) {
              const cfg = await cfgResp.json();
              if (cfg && cfg.openai_api_key && String(cfg.openai_api_key).trim() !== '') {
                return true; // å·²é…ç½®ä¸ªäººKeyï¼Œå…è®¸å‘é€
              }
            }
          } catch (e) {
          }

          alert('é¢åº¦å·²ç”¨æ»¡ï¼Œè¯·åœ¨è®¾ç½®ä¸­é…ç½®ä¸ªäºº OpenAI API Key åç»§ç»­ä½¿ç”¨');
          openSettings();
          return false;
        }
        return true;
      } catch (e) {
        return true; // å¤±è´¥ä¸æ‹¦æˆª
      }
    }

    // å‘é€æ¶ˆæ¯
    async function sendMessage() {
      // ğŸ”’ ç™»å½•æ‹¦æˆª
      if (!requireLogin()) return;
      
      // ğŸš« é˜²æ­¢åœ¨AIå›å¤æ—¶é‡å¤å‘é€ï¼ˆæ£€æŸ¥å‘é€æŒ‰é’®çŠ¶æ€ï¼‰
      if (sendBtn.disabled) {
        return;
      }
      
      const message = chatInput.value.trim();
      if (!message) return;

      // è·å–é€‰æ‹©çš„æ¨¡å‹
      selectedModel = aiModelSelector.value;

      // æ£€æŸ¥æ˜¯å¦æ˜¯ä»åˆ†äº«é“¾æ¥è®¿é—®ï¼Œä¸”æ˜¯ç¬¬ä¸€æ¬¡å‘é€æ¶ˆæ¯
      const isFromShare = window.shareToken && !currentChatId;
      
      // åªæœ‰åœ¨æ²¡æœ‰å½“å‰å¯¹è¯æ—¶æ‰åˆ›å»ºæ–°å¯¹è¯ï¼ˆé€šå¸¸å‘ç”Ÿåœ¨é¦–æ¬¡ä½¿ç”¨æˆ–æ‰‹åŠ¨ç‚¹å‡»æ–°å»ºå¯¹è¯åï¼‰
      const isNewChat = !currentChatId;
      if (!currentChatId) {
        currentChatId = 'chat_' + Date.now();
      }
      
      // å¦‚æœæ˜¯ä»åˆ†äº«é“¾æ¥è®¿é—®ï¼Œåœ¨å‘é€æ¶ˆæ¯æ—¶ï¼Œéœ€è¦å…ˆä¿å­˜åˆ†äº«çš„AIæ¶ˆæ¯
      // é€šè¿‡æ·»åŠ ä¸€ä¸ªç‰¹æ®Šçš„æ ‡è®°ï¼Œè®©åç«¯çŸ¥é“éœ€è¦å…ˆä¿å­˜åˆ†äº«æ¶ˆæ¯
      if (isFromShare && window.shareToken) {
        // è·å–å½“å‰æ˜¾ç¤ºçš„ç¬¬ä¸€æ¡AIæ¶ˆæ¯ï¼ˆåˆ†äº«çš„æ¶ˆæ¯ï¼‰
        const firstAssistantMsg = chatMessages.querySelector('.message.assistant');
        if (firstAssistantMsg) {
          const messageContent = firstAssistantMsg.querySelector('.message-content');
          const timestamp = firstAssistantMsg.dataset.timestamp;
          const memoryTag = firstAssistantMsg.querySelector('.memory-tag');
          const memoryEnabled = memoryTag && memoryTag.classList.contains('enabled');
          
          if (messageContent && timestamp) {
            // åœ¨è¯·æ±‚ä¸­æ·»åŠ åˆ†äº«æ¶ˆæ¯ä¿¡æ¯ï¼Œè®©åç«¯å…ˆä¿å­˜åˆ†äº«æ¶ˆæ¯
            window.pendingSharedMessage = {
              content: messageContent.innerText,
              timestamp: timestamp,
              shared_memory_enabled: memoryEnabled
            };
          }
        }
      }

      // æ¢å¤è¾“å…¥æ¡†åˆ°æ­£å¸¸ä½ç½®ï¼ˆå¦‚æœä¹‹å‰æ˜¯å±…ä¸­çš„ï¼‰
      restoreInputBox();
      
      // æ¸…é™¤ç©ºçŠ¶æ€ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
      clearEmptyState();
      
      // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°ç•Œé¢
      addMessageToUI('user', message);
      
      // ç«‹å³æ»šåŠ¨åˆ°åº•éƒ¨ï¼Œç¡®ä¿èƒ½çœ‹åˆ°æ–°å‘é€çš„æ¶ˆæ¯
      setTimeout(() => {
        if (chatMessages) {
          chatMessages.scrollTop = chatMessages.scrollHeight;
        }
      }, 50); // çŸ­æš‚å»¶è¿Ÿç¡®ä¿DOMå·²æ›´æ–°
      
      chatInput.value = '';
      chatInput.style.height = 'auto';

      // ğŸ”¥ å¦‚æœæ˜¯æ–°å¯¹è¯ï¼Œç«‹å³åœ¨å·¦ä¾§åˆ›å»ºå¯¹è¯é¡¹
      if (isNewChat) {
        addNewChatToSidebar(currentChatId, message);
      }

      // éšè—å‘é€æŒ‰é’®ï¼Œæ˜¾ç¤ºåœæ­¢æŒ‰é’®
      sendBtn.disabled = true;
      sendBtn.classList.add('hidden');
      stopBtn.classList.add('show');
      
      // åˆ›å»º AbortController ç”¨äºç»ˆæ­¢è¯·æ±‚
      currentAbortController = new AbortController();

      // ğŸ”¥ åˆ›å»ºæµå¼æ¶ˆæ¯UIï¼ˆå–ä»£åŠ è½½æ¶ˆæ¯ï¼‰
      const streamingMessageDiv = createStreamingMessageUI();
      
      let responseCompleted = false; // è·Ÿè¸ªå“åº”æ˜¯å¦å·²å®Œæˆï¼Œéœ€è¦åœ¨finallyå—ä¸­è®¿é—®

      try {
        // å‡†å¤‡è¯·æ±‚æ•°æ®
        const requestData = {
          username: currentUsername,
          message: message,
          model: selectedModel,
          conversation_id: currentChatId,
          shared_memory_enabled: sharedMemoryEnabled,
          personal_memory_enabled: personalMemoryEnabled,
          mcp_enabled: mcpToolsEnabled  // ğŸ› ï¸ MCP å·¥å…·è°ƒç”¨å¼€å…³
        };
        
        // å¦‚æœæ˜¯ä»åˆ†äº«é“¾æ¥è®¿é—®ï¼Œæ·»åŠ åˆ†äº«æ¶ˆæ¯ä¿¡æ¯
        if (window.pendingSharedMessage) {
          requestData.shared_message_content = window.pendingSharedMessage.content;
          requestData.shared_message_timestamp = window.pendingSharedMessage.timestamp;
          requestData.shared_message_memory_enabled = window.pendingSharedMessage.shared_memory_enabled;
          // æ¸…é™¤å¾…å¤„ç†çš„åˆ†äº«æ¶ˆæ¯ï¼ˆä½†ä¿ç•™shareTokenï¼Œç”¨äºåç»­åˆ¤æ–­ï¼‰
          delete window.pendingSharedMessage;
        }
        
        // ğŸ”¥ ä½¿ç”¨æµå¼APIï¼ˆåŸæ¥å£å·²æ”¹ä¸ºæµå¼è¾“å‡ºï¼‰
        const response = await fetch(`${backendUrl}/chat_direct`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          credentials: 'include',
          body: JSON.stringify(requestData),
          signal: currentAbortController.signal  // æ·»åŠ ç»ˆæ­¢ä¿¡å·
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        // ğŸ”¥ è¯»å–æµå¼å“åº”
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let fullResponse = '';
        let buffer = '';

        while (true) {
          const { done, value } = await reader.read();
          
          if (done) {
            // ğŸ”¥ å¤„ç†æœ€åå‰©ä½™çš„bufferå†…å®¹
            if (buffer.trim()) {
              const lines = buffer.split('\n');
              for (const line of lines) {
                if (line.startsWith('data: ')) {
                  try {
                    const data = JSON.parse(line.substring(6));

                    // ğŸ› ï¸ å¤„ç†å·¥å…·è°ƒç”¨äº‹ä»¶
                    if (data.tool_status) {
                      if (data.tool_status === 'start') {
                        showToolCallIndicator(data.tool_name, 'start');
                      } else if (data.tool_status === 'end') {
                        showToolCallIndicator(data.tool_name, 'end');
                      }
                      continue;
                    }

                    // ğŸ’­ å¤„ç†æ€è€ƒçŠ¶æ€
                    if (data.thinking) {
                      continue;
                    }

                    if (data.error) {
                      hideToolCallIndicator();
                      updateStreamingMessage(streamingMessageDiv, `é”™è¯¯: ${data.error}`, true);
                      break;
                    }

                    // ğŸ”¥ å…ˆå¤„ç†content
                    if (data.content) {
                      fullResponse += data.content;
                      updateStreamingMessage(streamingMessageDiv, fullResponse, false);
                    }
                    
                if (data.conversation_id) {
                  currentChatId = data.conversation_id;
                  // å¦‚æœæ˜¯ä»åˆ†äº«é“¾æ¥è®¿é—®ï¼Œä¸”å¯¹è¯å·²åˆ›å»ºï¼Œæ›´æ–°åˆ†äº«æ¶ˆæ¯çŠ¶æ€
                  if (window.shareToken && window.sharedMessageSaved === false) {
                    setTimeout(() => {
                      const firstAssistantMsg = chatMessages.querySelector('.message.assistant[data-is-shared-message="true"]');
                      if (firstAssistantMsg) {
                        firstAssistantMsg.dataset.isSharedMessage = 'false';
                        window.sharedMessageSaved = true;
                      }
                    }, 500);
                  }
                }
                    
                    // ğŸ”¥ æœ€åæ£€æŸ¥done
                    if (data.done) {
                      hideToolCallIndicator();  // éšè—å·¥å…·è°ƒç”¨æŒ‡ç¤ºå™¨
                      updateStreamingMessage(streamingMessageDiv, fullResponse, true, sharedMemoryEnabled);

                      responseCompleted = true;
                      sendBtn.classList.remove('hidden');
                      sendBtn.disabled = false;
                      stopBtn.classList.remove('show');
                      currentAbortController = null;
                      chatInput.focus();
                      break;
                    }
                  } catch (e) {
                  }
                }
              }
            }
            break;
          }
          
          // è§£ç æ•°æ®å—
          buffer += decoder.decode(value, { stream: true });
          const lines = buffer.split('\n');
          
          // ä¿ç•™æœ€åä¸€ä¸ªå¯èƒ½ä¸å®Œæ•´çš„è¡Œ
          buffer = lines.pop() || '';
          
          for (const line of lines) {
            if (line.startsWith('data: ')) {
              try {
                const data = JSON.parse(line.substring(6));

                // ğŸ› ï¸ å¤„ç†å·¥å…·è°ƒç”¨äº‹ä»¶
                if (data.tool_status) {
                  if (data.tool_status === 'start') {
                    showToolCallIndicator(data.tool_name, 'start');
                    console.log('ğŸ”§ å·¥å…·è°ƒç”¨å¼€å§‹:', data.tool_name, data.arguments);
                  } else if (data.tool_status === 'end') {
                    showToolCallIndicator(data.tool_name, 'end');
                    console.log('âœ… å·¥å…·è°ƒç”¨å®Œæˆ:', data.tool_name, `è€—æ—¶ ${data.elapsed_time?.toFixed(2)}s`);
                  }
                  continue;  // ç»§ç»­å¤„ç†ä¸‹ä¸€ä¸ªäº‹ä»¶
                }

                // ğŸ’­ å¤„ç†æ€è€ƒçŠ¶æ€
                if (data.thinking) {
                  console.log('ğŸ’­', data.thinking);
                  continue;
                }

                if (data.error) {
                  // æ˜¾ç¤ºé”™è¯¯
                  hideToolCallIndicator();
                  updateStreamingMessage(streamingMessageDiv, `é”™è¯¯: ${data.error}`, true);
                  break;
                }
                
                // ğŸ”¥ å…ˆå¤„ç†contentï¼Œå†æ£€æŸ¥doneï¼ˆç¡®ä¿æ‰€æœ‰å†…å®¹éƒ½è¢«æ·»åŠ ï¼‰
                if (data.content) {
                  fullResponse += data.content;
                  updateStreamingMessage(streamingMessageDiv, fullResponse, false);
                }
                
                if (data.conversation_id) {
                  currentChatId = data.conversation_id;
                  // å¦‚æœæ˜¯ä»åˆ†äº«é“¾æ¥è®¿é—®ï¼Œä¸”å¯¹è¯å·²åˆ›å»ºï¼Œæ›´æ–°åˆ†äº«æ¶ˆæ¯çŠ¶æ€
                  if (window.shareToken && window.sharedMessageSaved === false) {
                    setTimeout(() => {
                      const firstAssistantMsg = chatMessages.querySelector('.message.assistant[data-is-shared-message="true"]');
                      if (firstAssistantMsg) {
                        firstAssistantMsg.dataset.isSharedMessage = 'false';
                        window.sharedMessageSaved = true;
                      }
                    }, 500);
                  }
                }
                
                // æœ€åæ£€æŸ¥doneä¿¡å·
                if (data.done) {
                  // æœ€ç»ˆæ¸²æŸ“ï¼Œåº”ç”¨è¯­æ³•é«˜äº®ï¼Œæ·»åŠ è®°å¿†æ ‡è®°
                  hideToolCallIndicator();  // éšè—å·¥å…·è°ƒç”¨æŒ‡ç¤ºå™¨
                  updateStreamingMessage(streamingMessageDiv, fullResponse, true, sharedMemoryEnabled);

                  // ğŸš€ ç«‹å³æ˜¾ç¤ºå‘é€æŒ‰é’®ï¼Œéšè—åœæ­¢æŒ‰é’®
                  responseCompleted = true;
                  sendBtn.classList.remove('hidden');
                  sendBtn.disabled = false;
                  stopBtn.classList.remove('show');
                  currentAbortController = null;
                  chatInput.focus();
                  break; // è·³å‡ºå¾ªç¯ï¼Œç«‹å³ç»“æŸ
                }
              } catch (e) {
              }
            }
          }
        }
        
        // å®Œæˆåæ›´æ–°å¯¹è¯å†å²
        updateChatHistoryWithoutInterruption();
        
        // å¦‚æœæ˜¯ä»åˆ†äº«é“¾æ¥è®¿é—®ï¼Œä¸”å·²ä¿å­˜åˆ†äº«æ¶ˆæ¯ï¼Œæ›´æ–°æ¶ˆæ¯çŠ¶æ€
        if (window.shareToken && responseCompleted && currentChatId) {
          // å»¶è¿Ÿä¸€ç‚¹æ—¶é—´ï¼Œç¡®ä¿åç«¯å·²ä¿å­˜å®Œæˆ
          setTimeout(() => {
            const firstAssistantMsg = chatMessages.querySelector('.message.assistant[data-is-shared-message="true"]');
            if (firstAssistantMsg) {
              // æ¶ˆæ¯å·²ä¿å­˜åˆ°ç”¨æˆ·å¯¹è¯ä¸­ï¼Œæ¸…é™¤åˆ†äº«æ ‡è®°ï¼Œä¸‹æ¬¡ç‚¹å‡»åˆ†äº«æ—¶ä»ç”¨æˆ·å¯¹è¯ä¸­æŸ¥æ‰¾
              firstAssistantMsg.dataset.isSharedMessage = 'false';
              // ä¿ç•™åŸå§‹åˆ†äº«é“¾æ¥ä½œä¸ºå¤‡ç”¨
            }
          }, 500);
        }
        
      } catch (error) {
        // æ£€æŸ¥æ˜¯å¦æ˜¯ç”¨æˆ·ä¸»åŠ¨ç»ˆæ­¢
        if (error.name === 'AbortError') {
          // ä¸æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯ï¼Œå› ä¸ºè¿™æ˜¯ç”¨æˆ·ä¸»åŠ¨æ“ä½œ
          // ç»™åç«¯ä¸€äº›æ—¶é—´æ¥å®Œæˆä¿å­˜æ“ä½œ
          await new Promise(resolve => setTimeout(resolve, 100));
        } else {
          updateStreamingMessage(streamingMessageDiv, 'æŠ±æ­‰ï¼Œå‘é€æ¶ˆæ¯æ—¶å‡ºç°é”™è¯¯ã€‚è¯·ç¨åé‡è¯•ã€‚', true);
        }
      } finally {
        // ç«‹å³é‡æ–°æ˜¾ç¤ºå‘é€æŒ‰é’®ï¼Œéšè—åœæ­¢æŒ‰é’®ï¼Œç¡®ä¿UIçŠ¶æ€å®Œå…¨æ¢å¤
        sendBtn.classList.remove('hidden');
        sendBtn.disabled = false;
        stopBtn.classList.remove('show');
        currentAbortController = null;
        
        // ç¡®ä¿UIå®Œå…¨å“åº”ï¼Œå…è®¸ç«‹å³åˆ‡æ¢å¯¹è¯
        chatInput.focus();
      }
    }

    // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦åœ¨èŠå¤©åŒºåŸŸåº•éƒ¨é™„è¿‘ï¼ˆå…è®¸ç”¨æˆ·å‘ä¸Šæ»šåŠ¨æŸ¥çœ‹å†å²ï¼‰
    function isNearBottom(threshold = 100) {
      const chatMessages = document.getElementById('chatMessages');
      if (!chatMessages) return true;
      const scrollTop = chatMessages.scrollTop;
      const scrollHeight = chatMessages.scrollHeight;
      const clientHeight = chatMessages.clientHeight;
      return (scrollHeight - scrollTop - clientHeight) < threshold;
    }

    // æ™ºèƒ½æ»šåŠ¨ï¼šåªåœ¨ç”¨æˆ·æ¥è¿‘åº•éƒ¨æ—¶æ‰è‡ªåŠ¨æ»šåŠ¨
    function smartScrollToBottom() {
      const chatMessages = document.getElementById('chatMessages');
      if (!chatMessages) return;
      
      // å¦‚æœç”¨æˆ·åœ¨åº•éƒ¨é™„è¿‘ï¼Œæ‰è‡ªåŠ¨æ»šåŠ¨
      if (isNearBottom(150)) {
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }
    }

    // ğŸ”¥ åˆ›å»ºæµå¼æ¶ˆæ¯UI
    function createStreamingMessageUI() {
      const messageDiv = document.createElement('div');
      messageDiv.className = 'message assistant';
      
      const avatar = document.createElement('div');
      avatar.className = 'message-avatar';
      avatar.textContent = 'AI';
      
      const messageContent = document.createElement('div');
      messageContent.className = 'message-content';
      // ğŸ”¥ ç«‹å³æ˜¾ç¤º"æ­£åœ¨æ€è€ƒ..."
      messageContent.innerHTML = '<span style="color: #999; font-style: italic;">æ­£åœ¨æ€è€ƒ<span class="thinking-dots">...</span></span>';
      messageContent.style.opacity = '0.8';
      
      messageDiv.appendChild(avatar);
      messageDiv.appendChild(messageContent);
      
      chatMessages.appendChild(messageDiv);
      smartScrollToBottom(); // ä½¿ç”¨æ™ºèƒ½æ»šåŠ¨
      
      return messageDiv;
    }

    // ğŸ”¥ æ›´æ–°æµå¼æ¶ˆæ¯å†…å®¹
    function updateStreamingMessage(messageDiv, content, isFinal = false, sharedMemoryEnabled = null) {
      const messageContent = messageDiv.querySelector('.message-content');
      
      if (isFinal) {
        // ğŸ”¥ æœ€ç»ˆæ¸²æŸ“å‰ï¼Œå…ˆæ¸…é™¤æ‰€æœ‰pendingçš„å»¶è¿Ÿæ¸²æŸ“ï¼Œé¿å…æ—§å†…å®¹è¦†ç›–æ–°å†…å®¹
        if (pendingRenderTimer !== null) {
          clearTimeout(pendingRenderTimer);
          cancelAnimationFrame(pendingRenderTimer);
          pendingRenderTimer = null;
        }
        markdownRenderScheduled = false;
        
        // æœ€ç»ˆæ¸²æŸ“ï¼šä½¿ç”¨Markdown
        messageContent.style.opacity = '1';
        marked.setOptions({
          breaks: true,
          gfm: true,
          headerIds: false,
          mangle: false
        });
        
        // ğŸ”¥ ç¡®ä¿æ¸²æŸ“å®Œæ•´çš„æœ€æ–°å†…å®¹
        messageContent.innerHTML = marked.parse(content);
        
        // åº”ç”¨è¯­æ³•é«˜äº®
        messageContent.querySelectorAll('pre code').forEach((block) => {
          hljs.highlightElement(block);
        });
        
        // æ·»åŠ è®°å¿†æ ‡è®°
        if (sharedMemoryEnabled !== null) {
          // å…ˆç§»é™¤æ—§çš„æ ‡è®°ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          const existingTags = messageDiv.querySelector('.message-memory-tags');
          if (existingTags) {
            existingTags.remove();
          }
          
          // è®¡ç®—å½“å‰æ¶ˆæ¯åœ¨å¯¹è¯ä¸­çš„ç´¢å¼•
          const messageIndex = Array.from(chatMessages.children).indexOf(messageDiv);
          const memoryTags = createMemoryTag(sharedMemoryEnabled, messageIndex, []);
          messageDiv.appendChild(memoryTags);
        }

        // æ·»åŠ å¤åˆ¶æŒ‰é’®å’Œåˆ†äº«æŒ‰é’®
        appendCopyAction(messageDiv);
        
        // æµå¼ç”Ÿæˆå®Œæˆåï¼Œå°è¯•ä»å¯¹è¯ä¸­è·å–ä½¿ç”¨çš„å…±äº«è®°å¿†ID
        if (currentChatId && !messageDiv.dataset.usedSharedMemories) {
          loadUsedSharedMemoriesFromConversation(messageDiv);
        }
        
        // ä¿å­˜æ—¶é—´æˆ³ï¼ˆä»å½“å‰æ—¶é—´ç”Ÿæˆï¼‰
        const now = new Date();
        const timestamp = now.getFullYear() + '-' + 
          String(now.getMonth() + 1).padStart(2, '0') + '-' + 
          String(now.getDate()).padStart(2, '0') + ' ' + 
          String(now.getHours()).padStart(2, '0') + ':' + 
          String(now.getMinutes()).padStart(2, '0') + ':' + 
          String(now.getSeconds()).padStart(2, '0');
        messageDiv.dataset.timestamp = timestamp;
      } else {
        // æµå¼è¾“å‡ºæ—¶ï¼šè¿›è¡Œè½»é‡çº§çš„Markdownå¢é‡æ¸²æŸ“ï¼ˆä¸åšè¯­æ³•é«˜äº®ï¼Œé¿å…å¡é¡¿ï¼‰
        // ä½¿ç”¨èŠ‚æµï¼Œä¿è¯æ ‡é¢˜ç­‰Markdownè¯­æ³•èƒ½è¾¹è¾“å‡ºè¾¹æ¸²æŸ“
        messageContent.style.opacity = '1';

        const now = performance.now();
        // ğŸ”¥ ä½¿ç”¨ç®­å¤´å‡½æ•°æ•è·å½“å‰contentï¼Œé¿å…é—­åŒ…é—®é¢˜
        const currentContent = content;
        const doRender = () => {
          marked.setOptions({
            breaks: true,
            gfm: true,
            headerIds: false,
            mangle: false
          });
          // ğŸ”¥ ä½¿ç”¨æ•è·çš„currentContentè€Œä¸æ˜¯å¤–å±‚çš„content
          messageContent.innerHTML = marked.parse(currentContent);
          markdownRenderScheduled = false;
          pendingRenderTimer = null;
          lastMarkdownRenderAt = performance.now();
        };

        if (!markdownRenderScheduled && (now - lastMarkdownRenderAt) >= MARKDOWN_RENDER_INTERVAL_MS) {
          // ç«‹å³æ¸²æŸ“ä¸€æ¬¡
          doRender();
        } else if (!markdownRenderScheduled) {
          // å»¶è¿Ÿåˆ°ä¸‹ä¸€å¸§æˆ–èŠ‚æµé—´éš”åˆ°è¾¾å†æ¸²æŸ“
          markdownRenderScheduled = true;
          const delay = Math.max(0, MARKDOWN_RENDER_INTERVAL_MS - (now - lastMarkdownRenderAt));
          if (typeof requestAnimationFrame === 'function' && delay < 16) {
            pendingRenderTimer = requestAnimationFrame(doRender);
          } else {
            pendingRenderTimer = setTimeout(doRender, delay);
          }
        }
      }
      
      // æ™ºèƒ½æ»šåŠ¨ï¼šåªåœ¨ç”¨æˆ·æ¥è¿‘åº•éƒ¨æ—¶æ‰è‡ªåŠ¨æ»šåŠ¨
      smartScrollToBottom();
    }

    // æ·»åŠ åŠ è½½æ¶ˆæ¯
    function addLoadingMessage() {
      const messageDiv = document.createElement('div');
      messageDiv.className = 'message assistant loading-message';
      messageDiv.id = `loading-${Date.now()}`; // ä½¿ç”¨æ—¶é—´æˆ³ä½œä¸ºå”¯ä¸€ID
      
      const avatar = document.createElement('div');
      avatar.className = 'message-avatar loading-avatar';
      avatar.innerHTML = '<span class="loading-dots"></span>';
      
      const messageContent = document.createElement('div');
      messageContent.className = 'message-content';
      messageContent.textContent = 'æ­£åœ¨æ€è€ƒ...';
      
      messageDiv.appendChild(avatar);
      messageDiv.appendChild(messageContent);
      
      chatMessages.appendChild(messageDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      
      // ç”±äºæ‰€æœ‰æ–‡æœ¬éƒ½æ˜¯ç›¸åŒçš„ï¼Œä¸éœ€è¦åŠ¨æ€åˆ‡æ¢
      // ä¿æŒé™æ€çš„"æ­£åœ¨æ€è€ƒ..."æ–‡æœ¬
      
      return messageDiv.id;
    }

    // ç§»é™¤åŠ è½½æ¶ˆæ¯
    function removeLoadingMessage(loadingMessageId) {
      const loadingMessage = document.getElementById(loadingMessageId);
      if (loadingMessage) {
        loadingMessage.remove();
      }
    }

    // æ·»åŠ æ¶ˆæ¯åˆ°UI
    function addMessageToUI(type, content, sharedMemoryEnabled = null, usedSharedMemories = [], timestamp = null) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${type}`;
      
      // ä¿å­˜æ—¶é—´æˆ³åˆ°dataå±æ€§
      if (timestamp) {
        messageDiv.dataset.timestamp = timestamp;
      }
      
      const avatar = document.createElement('div');
      avatar.className = 'message-avatar';
      avatar.textContent = type === 'user' ? 'U' : 'AI';
      
      const messageContent = document.createElement('div');
      messageContent.className = 'message-content';
      
      // AIæ¶ˆæ¯ä½¿ç”¨Markdownæ¸²æŸ“ï¼Œç”¨æˆ·æ¶ˆæ¯ä¿æŒçº¯æ–‡æœ¬
      if (type === 'assistant') {
        // é…ç½®markedé€‰é¡¹
        marked.setOptions({
          breaks: true,  // æ”¯æŒGFMæ¢è¡Œ
          gfm: true,     // å¯ç”¨GitHubé£æ ¼çš„Markdown
          headerIds: false,
          mangle: false
        });
        
        // æ¸²æŸ“Markdown
        messageContent.innerHTML = marked.parse(content);
        
        // å¯¹ä»£ç å—åº”ç”¨è¯­æ³•é«˜äº®
        messageContent.querySelectorAll('pre code').forEach((block) => {
          hljs.highlightElement(block);
        });
      } else {
        // ç”¨æˆ·æ¶ˆæ¯ä¿æŒçº¯æ–‡æœ¬
        messageContent.textContent = content;
      }
      
      messageDiv.appendChild(avatar);
      messageDiv.appendChild(messageContent);
      
      // å¦‚æœæ˜¯AIæ¶ˆæ¯ä¸”æœ‰è®°å¿†ä¿¡æ¯ï¼Œæ·»åŠ è®°å¿†æ ‡è®°
      if (type === 'assistant' && sharedMemoryEnabled !== null) {
        // å°†ä½¿ç”¨çš„å…±äº«è®°å¿†ä¿å­˜åˆ°æ¶ˆæ¯divçš„dataå±æ€§ä¸­ï¼Œæ–¹ä¾¿ç‚¹å‡»æ—¶è¯»å–
        if (usedSharedMemories && usedSharedMemories.length > 0) {
          messageDiv.dataset.usedSharedMemories = JSON.stringify(usedSharedMemories);
        }
        // è®¡ç®—å½“å‰æ¶ˆæ¯åœ¨å¯¹è¯ä¸­çš„ç´¢å¼•
        const messageIndex = chatMessages.children.length;
        const memoryTags = createMemoryTag(sharedMemoryEnabled, messageIndex, usedSharedMemories);
        messageDiv.appendChild(memoryTags);
      }

      // ä¸ºAIæ¶ˆæ¯æ·»åŠ å¤åˆ¶æŒ‰é’®
      if (type === 'assistant') {
        appendCopyAction(messageDiv);
      }
      
      chatMessages.appendChild(messageDiv);
      smartScrollToBottom(); // ä½¿ç”¨æ™ºèƒ½æ»šåŠ¨
      
      return messageDiv;
    }

    // åœ¨æ¶ˆæ¯ä¸‹æ–¹è¿½åŠ å¤åˆ¶æŒ‰é’®å’Œåˆ†äº«æŒ‰é’®
    function appendCopyAction(messageDiv) {
      // ä¼˜å…ˆæ”¾å…¥è®°å¿†æ ‡ç­¾å®¹å™¨ï¼Œä½¿å…¶ä¸"è®°å¿†å·²å¼€å¯"åŒä¸€è¡Œ
      let container = messageDiv.querySelector('.message-memory-tags');
      
      // å¤åˆ¶æŒ‰é’®
      const copyBtn = document.createElement('button');
      copyBtn.type = 'button';
      copyBtn.className = 'copy-btn';
      copyBtn.innerHTML = `
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="9" y="9" width="13" height="13" rx="2"/>
          <rect x="2" y="2" width="13" height="13" rx="2"/>
        </svg>
        å¤åˆ¶
      `;
      copyBtn.addEventListener('click', async () => {
        const contentEl = messageDiv.querySelector('.message-content');
        const text = contentEl ? contentEl.innerText : '';
        try {
          await navigator.clipboard.writeText(text);
          const old = copyBtn.innerHTML;
          copyBtn.innerHTML = `
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M20 6L9 17l-5-5"/>
            </svg>
            å·²å¤åˆ¶
          `;
          setTimeout(() => { copyBtn.innerHTML = old; }, 1600);
        } catch (e) {
        }
      });
      
      if (!container) {
        container = document.createElement('div');
        container.className = 'message-memory-tags';
        messageDiv.appendChild(container);
      }
      container.appendChild(copyBtn);
      
      // å§‹ç»ˆæ˜¾ç¤ºåˆ†äº«æŒ‰é’®ï¼ˆåŒ…æ‹¬åˆ†äº«é“¾æ¥é¡µé¢ï¼‰
      const shareBtn = document.createElement('button');
      shareBtn.type = 'button';
      shareBtn.className = 'share-btn';
      shareBtn.innerHTML = `
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="18" cy="5" r="3"/>
          <circle cx="6" cy="12" r="3"/>
          <circle cx="18" cy="19" r="3"/>
          <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/>
          <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
        </svg>
        åˆ†äº«
      `;
      shareBtn.addEventListener('click', () => {
        openShareModal(messageDiv);
      });
      container.appendChild(shareBtn);
      
      // æ£€æŸ¥æœ¬æ¬¡å›å¤æ˜¯å¦ä½¿ç”¨äº†å½“å‰ç”¨æˆ·çš„è®°å¿†
      if (messageDiv.dataset.usedSharedMemories) {
        checkAndShowUserMemoryHint(messageDiv, container);
      }
    }
    
    // æ£€æŸ¥å¹¶æ˜¾ç¤ºç”¨æˆ·è®°å¿†æç¤º
    async function checkAndShowUserMemoryHint(messageDiv, container) {
      try {
        const usedSharedMemories = JSON.parse(messageDiv.dataset.usedSharedMemories);
        if (!usedSharedMemories || usedSharedMemories.length === 0 || !currentUsername) {
          return;
        }
        
        // æ£€æŸ¥æ˜¯å¦æœ‰å½“å‰ç”¨æˆ·çš„è®°å¿†
        const hasUserMemory = await checkIfUserMemoryUsed(usedSharedMemories);
        if (hasUserMemory) {
          // åœ¨åˆ†äº«æŒ‰é’®æ—è¾¹æ·»åŠ æç¤º
          const memoryHint = document.createElement('span');
          memoryHint.className = 'memory-hint';
          memoryHint.style.cssText = 'font-size: 12px; color: #667eea; margin-left: 8px; display: inline-flex; align-items: center; gap: 4px;';
          memoryHint.innerHTML = ``
            // <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;">
            //   <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
            //   <circle cx="9" cy="7" r="4"/>
            //   <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
            //   <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
            // </svg>
            // æœ¬æ¬¡å›å¤ç»“åˆäº†æ‚¨çš„è®°å¿†
          ;
          container.appendChild(memoryHint);
        }
      } catch (e) {
        console.error('æ£€æŸ¥ç”¨æˆ·è®°å¿†å¤±è´¥:', e);
      }
    }
    
    // æ£€æŸ¥ä½¿ç”¨çš„å…±äº«è®°å¿†æ˜¯å¦åŒ…å«å½“å‰ç”¨æˆ·çš„è®°å¿†
    async function checkIfUserMemoryUsed(memoryIds) {
      if (!memoryIds || memoryIds.length === 0 || !currentUsername) {
        return false;
      }
      
      try {
        const response = await fetch(`${backendUrl}/api/get_used_shared_memories`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          credentials: 'include',
          body: JSON.stringify({
            username: currentUsername,
            conversation_id: currentChatId,
            used_shared_memories: memoryIds
          })
        });
        
        if (response.ok) {
          const data = await response.json();
          if (data.success && data.memories) {
            // æ£€æŸ¥æ˜¯å¦æœ‰ä»»ä½•è®°å¿†çš„merged_usersåŒ…å«å½“å‰ç”¨æˆ·
            for (const memory of data.memories) {
              const mergedUsers = memory.merged_users || [];
              if (mergedUsers.includes(currentUsername)) {
                return true;
              }
            }
          }
        }
      } catch (error) {
        console.error('æ£€æŸ¥ç”¨æˆ·è®°å¿†å¤±è´¥:', error);
      }
      
      return false;
    }
    
    // ä»å¯¹è¯ä¸­åŠ è½½ä½¿ç”¨çš„å…±äº«è®°å¿†IDï¼ˆç”¨äºæµå¼ç”Ÿæˆå®Œæˆåçš„æ£€æŸ¥ï¼‰
    async function loadUsedSharedMemoriesFromConversation(messageDiv) {
      if (!currentChatId || !currentUsername) return;
      
      try {
        const response = await fetch(`${backendUrl}/get_chat_messages`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          credentials: 'include',
          body: JSON.stringify({
            username: currentUsername,
            conversation_id: currentChatId
          })
        });
        
        if (response.ok) {
          const data = await response.json();
          if (data.success && data.conversation && data.conversation.messages) {
            // æ‰¾åˆ°æœ€åä¸€æ¡AIæ¶ˆæ¯ï¼ˆåº”è¯¥æ˜¯åˆšå®Œæˆçš„è¿™æ¡ï¼‰
            const messages = data.conversation.messages;
            const lastAssistantMsg = messages.filter(m => m.type === 'assistant').pop();
            if (lastAssistantMsg && lastAssistantMsg.used_shared_memories) {
              const usedSharedMemories = lastAssistantMsg.used_shared_memories;
              if (usedSharedMemories.length > 0) {
                // è®¾ç½®åˆ°messageDivçš„datasetä¸­
                messageDiv.dataset.usedSharedMemories = JSON.stringify(usedSharedMemories);
                
                // æ£€æŸ¥å¹¶æ˜¾ç¤ºæç¤º
                const container = messageDiv.querySelector('.message-memory-tags');
                if (container) {
                  checkAndShowUserMemoryHint(messageDiv, container);
                }
              }
            }
          }
        }
      } catch (error) {
        console.error('åŠ è½½ä½¿ç”¨çš„å…±äº«è®°å¿†IDå¤±è´¥:', error);
      }
    }
    
    // åˆ›å»ºè®°å¿†æ ‡è®°
    function createMemoryTag(sharedMemoryEnabled, messageIndex = null, usedSharedMemories = []) {
      const tagsContainer = document.createElement('div');
      tagsContainer.className = 'message-memory-tags';
      
      const memoryTag = document.createElement('span');
      memoryTag.className = `memory-tag ${sharedMemoryEnabled ? 'enabled' : 'disabled'}`;
      
      if (sharedMemoryEnabled) {
        memoryTag.innerHTML = `
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
            <circle cx="9" cy="7" r="4"/>
            <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
            <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
          </svg>
          è®°å¿†å·²å¼€å¯
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-left:4px;">
            <path d="M9 18l6-6-6-6"/>
          </svg>
        `;
        
        // ä¸ºå·²å¼€å¯è®°å¿†çš„æ ‡ç­¾æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼Œä¼ é€’æ¶ˆæ¯ç´¢å¼•å’Œä½¿ç”¨çš„è®°å¿†ID
        memoryTag.style.cursor = 'pointer';
        memoryTag.addEventListener('click', function(e) {
          e.stopPropagation();
          // ä¼˜å…ˆä»æ¶ˆæ¯divçš„dataå±æ€§ä¸­è¯»å–usedSharedMemoriesï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ä½¿ç”¨ä¼ é€’çš„å‚æ•°
          let finalUsedSharedMemories = usedSharedMemories;
          const messageDiv = this.closest('.message');
          if (messageDiv && messageDiv.dataset.usedSharedMemories) {
            try {
              finalUsedSharedMemories = JSON.parse(messageDiv.dataset.usedSharedMemories);
            } catch (err) {
              // è§£æå¤±è´¥ï¼Œä½¿ç”¨ä¼ é€’çš„å‚æ•°
            }
          }
          toggleMemoryContentPanel(messageIndex, finalUsedSharedMemories);
        });
      } else {
        memoryTag.innerHTML = `
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <line x1="15" y1="9" x2="9" y2="15"/>
            <line x1="9" y1="9" x2="15" y2="15"/>
          </svg>
          å¼€å¯è®°å¿†
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-left:4px;">
            <path d="M9 18l6-6-6-6"/>
          </svg>
        `;
      }
      
      tagsContainer.appendChild(memoryTag);
      return tagsContainer;
    }

    // åˆ›å»ºæ–°å¯¹è¯
    function createNewChat() {
      // ğŸ”’ ç™»å½•æ‹¦æˆª
      if (!requireLogin()) return;
      
      // æ¸…é™¤å½“å‰èŠå¤©æ¶ˆæ¯
      chatMessages.innerHTML = '';
      
      // é‡ç½®å½“å‰å¯¹è¯IDä¸ºnullï¼Œè¿™æ ·ä¸‹æ¬¡å‘é€æ¶ˆæ¯æ—¶ä¼šè‡ªåŠ¨åˆ›å»ºæ–°å¯¹è¯
      currentChatId = null;
      
      // æ¸…ç©ºè¾“å…¥æ¡†
      chatInput.value = '';
      
      // å±…ä¸­è¾“å…¥æ¡†ï¼ˆæ–°å»ºå¯¹è¯æ—¶æ˜¾ç¤ºå±…ä¸­çŠ¶æ€ï¼‰
      centerInputBox();
      
      // æ˜¾ç¤ºç©ºçŠ¶æ€
      showEmptyState();
      
      // æ›´æ–°èŠå¤©å†å²
      updateChatHistoryWithoutInterruption();
      
    }

    // æ˜¾ç¤ºç©ºçŠ¶æ€
    function showEmptyState() {
      chatMessages.innerHTML = `
        <div class="empty-state">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
          </svg>
          <h3>å¼€å§‹æ–°çš„å¯¹è¯</h3>
          <p>åœ¨ä¸‹æ–¹è¾“å…¥æ¡†ä¸­è¾“å…¥æ‚¨çš„é—®é¢˜ï¼Œå¼€å§‹ä¸Experience Chatå¯¹è¯</p>
        </div>
      `;
    }

    // å±…ä¸­è¾“å…¥æ¡†
    function centerInputBox() {
      const inputContainer = document.querySelector('.chat-input-container');
      inputContainer.classList.add('centered');
      setTimeout(() => {
        chatInput.focus();
      }, 100);
    }

    // æ¢å¤è¾“å…¥æ¡†åˆ°æ­£å¸¸ä½ç½®
    function restoreInputBox() {
      const inputContainer = document.querySelector('.chat-input-container');
      inputContainer.classList.remove('centered');
    }

    // æ¸…é™¤ç©ºçŠ¶æ€
    function clearEmptyState() {
      const emptyState = document.querySelector('.empty-state');
      if (emptyState) {
        emptyState.remove();
      }
    }

    // æ˜¾ç¤ºæ–°å»ºå¯¹è¯ç•Œé¢
    function showNewChatInterface() {
      // æ¸…ç©ºå½“å‰èŠå¤©ID
      currentChatId = null;
      
      // æ˜¾ç¤ºç©ºçŠ¶æ€
      showEmptyState();
      
      // å±…ä¸­è¾“å…¥æ¡†
      centerInputBox();
      
      // æ¸…é™¤æ‰€æœ‰æ´»è·ƒçŠ¶æ€
      document.querySelectorAll('.chat-history-item').forEach(item => {
        item.classList.remove('active');
      });
    }

    // åŠ è½½èŠå¤©å†å²
    async function loadChatHistory() {
      // ğŸ”’ ç™»å½•æ‹¦æˆª
      if (!requireLogin()) return;
      
      try {
        const response = await fetch(`${backendUrl}/get_chat_conversations`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            username: currentUsername
          })
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        
        if (data.success) {
          chatHistory = data.conversations;
          chatHistoryContainer.innerHTML = '';
          
          data.conversations.forEach(chat => {
            const chatItem = document.createElement('div');
            chatItem.className = 'chat-history-item';
            if (chat.id === currentChatId) {
              chatItem.classList.add('active');
            }
            const starHtml = chat.contributed_shared_memory
              ? `
              <span class="chat-history-flag" title="æœ¬æ¬¡å¯¹è¯å‚ä¸æ„å»ºå…±äº«è®°å¿†">
                <svg viewBox="0 0 24 24" stroke="none">
                  <path d="M12 2l2.91 5.88 6.49.94-4.7 4.58 1.11 6.46L12 17.77l-5.81 3.06 1.11-6.46-4.7-4.58 6.49-.94L12 2z"/>
                </svg>
              </span>
            `
              : '';
            
            chatItem.innerHTML = `
              <div class="chat-history-item-title">${chat.title || 'æ–°å¯¹è¯'}</div>
              <div class="chat-history-item-time">${formatTime(chat.updated_at)}</div>
              ${starHtml}
              <div class="chat-history-item-actions">
                <button class="delete-btn" onclick="deleteChat('${chat.id}')">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3,6 5,6 21,6"/>
                    <path d="M19,6v14a2,2 0 0,1 -2,2H7a2,2 0 0,1 -2,-2V6m3,0V4a2,2 0 0,1 2,-2h4a2,2 0 0,1 2,2v2"/>
                  </svg>
                </button>
              </div>
            `;
            
            chatItem.addEventListener('click', function() {
              loadChat(chat.id, this);
            });
            chatHistoryContainer.appendChild(chatItem);
          });
          
          // å¦‚æœæ²¡æœ‰å½“å‰å¯¹è¯ï¼Œæ˜¾ç¤ºå±…ä¸­è¾“å…¥æ¡†ï¼ˆæ— è®ºæ˜¯æ²¡æœ‰å†å²å¯¹è¯è¿˜æ˜¯åˆšè¿›å…¥é¡µé¢ï¼‰
          if (!currentChatId) {
            showNewChatInterface();
          }
        } else {
          // å³ä½¿åŠ è½½å¤±è´¥ï¼Œå¦‚æœæ²¡æœ‰ä»»ä½•å¯¹è¯ï¼Œä¹Ÿåº”è¯¥æ˜¾ç¤ºå±…ä¸­è¾“å…¥æ¡†
          if (!currentChatId) {
            showNewChatInterface();
          }
        }
      } catch (error) {
        // å³ä½¿å‡ºé”™ï¼Œå¦‚æœæ²¡æœ‰ä»»ä½•å¯¹è¯ï¼Œä¹Ÿåº”è¯¥æ˜¾ç¤ºå±…ä¸­è¾“å…¥æ¡†
        if (!currentChatId) {
          showNewChatInterface();
        }
      }
    }

    // ç«‹å³åœ¨å·¦ä¾§æ·»åŠ æ–°å¯¹è¯é¡¹ï¼ˆç”¨äºæ–°å»ºå¯¹è¯æ—¶çš„å³æ—¶åé¦ˆï¼‰
    function addNewChatToSidebar(chatId, firstMessage) {
      // ç”Ÿæˆå¯¹è¯æ ‡é¢˜ï¼ˆå–å‰30ä¸ªå­—ç¬¦ï¼‰
      const title = firstMessage.length > 30 ? firstMessage.substring(0, 30) + '...' : firstMessage;
      const now = new Date().toISOString();
      
      // æ¸…é™¤æ‰€æœ‰æ´»è·ƒçŠ¶æ€
      document.querySelectorAll('.chat-history-item').forEach(item => {
        item.classList.remove('active');
      });
      
      // åˆ›å»ºæ–°çš„å¯¹è¯é¡¹å…ƒç´ 
      const chatItem = document.createElement('div');
      chatItem.className = 'chat-history-item active';
      chatItem.dataset.chatId = chatId;
      
      chatItem.innerHTML = `
        <div class="chat-history-item-title">${title}</div>
        <div class="chat-history-item-time">åˆšåˆš</div>
        <div class="chat-history-item-actions">
          <button class="delete-btn" onclick="deleteChat('${chatId}')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="3,6 5,6 21,6"/>
              <path d="M19,6v14a2,2 0 0,1 -2,2H7a2,2 0 0,1 -2,-2V6m3,0V4a2,2 0 0,1 2,-2h4a2,2 0 0,1 2,2v2"/>
            </svg>
          </button>
        </div>
      `;
      
      chatItem.addEventListener('click', function() {
        loadChat(chatId, this);
      });
      
      // æ·»åŠ åˆ°åˆ—è¡¨é¡¶éƒ¨
      chatHistoryContainer.insertBefore(chatItem, chatHistoryContainer.firstChild);
      
    }

    // æ›´æ–°èŠå¤©å†å²è€Œä¸ä¸­æ–­å½“å‰å¯¹è¯
    async function updateChatHistoryWithoutInterruption() {
      if (!currentUsername) return;
      
      try {
        const response = await fetch(`${backendUrl}/get_chat_conversations`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            username: currentUsername
          })
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        
        if (data.success) {
          chatHistory = data.conversations;
          
          // ä¿å­˜å½“å‰æ´»è·ƒçš„å¯¹è¯ID
          const activeChatId = currentChatId;
          
          chatHistoryContainer.innerHTML = '';
          
          data.conversations.forEach(chat => {
            const chatItem = document.createElement('div');
            chatItem.className = 'chat-history-item';
            if (chat.id === activeChatId) {
              chatItem.classList.add('active');
            }
            const starHtml = chat.contributed_shared_memory
              ? `
              <span class="chat-history-flag" title="æœ¬æ¬¡å¯¹è¯å‚ä¸æ„å»ºå…±äº«è®°å¿†">
                <svg viewBox="0 0 24 24" stroke="none">
                  <path d="M12 2l2.91 5.88 6.49.94-4.7 4.58 1.11 6.46L12 17.77l-5.81 3.06 1.11-6.46-4.7-4.58 6.49-.94L12 2z"/>
                </svg>
              </span>
            `
              : '';
            
            chatItem.innerHTML = `
              <div class="chat-history-item-title">${chat.title || 'æ–°å¯¹è¯'}</div>
              <div class="chat-history-item-time">${formatTime(chat.updated_at)}</div>
              ${starHtml}
              <div class="chat-history-item-actions">
                <button class="delete-btn" onclick="deleteChat('${chat.id}')">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3,6 5,6 21,6"/>
                    <path d="M19,6v14a2,2 0 0,1 -2,2H7a2,2 0 0,1 -2,-2V6m3,0V4a2,2 0 0,1 2,-2h4a2,2 0 0,1 2,2v2"/>
                  </svg>
                </button>
              </div>
            `;
            
            chatItem.addEventListener('click', function() {
              loadChat(chat.id, this);
            });
            chatHistoryContainer.appendChild(chatItem);
          });
          
          // ç¡®ä¿å½“å‰å¯¹è¯ä¿æŒæ´»è·ƒçŠ¶æ€
          currentChatId = activeChatId;
        } else {
        }
      } catch (error) {
      }
    }

    // åŠ è½½æŒ‡å®šèŠå¤©
    async function loadChat(chatId, clickedElement, retryCount = 0) {
      // ğŸ”’ ç™»å½•æ‹¦æˆª
      if (!requireLogin()) return;
      
      // ğŸš« å¦‚æœAIæ­£åœ¨å›å¤ï¼Œå…ˆç»ˆæ­¢å®ƒï¼Œç¡®ä¿å¯ä»¥ç«‹å³åˆ‡æ¢å¯¹è¯
      if (currentAbortController || sendBtn.disabled) {
        if (currentAbortController) {
          currentAbortController.abort();
          currentAbortController = null;
        }
        sendBtn.classList.remove('hidden');
        sendBtn.disabled = false;
        stopBtn.classList.remove('show');
      }
      
      try {
        const response = await fetch(`${backendUrl}/get_chat_messages`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            username: currentUsername,
            conversation_id: chatId
          })
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        
        if (data.success) {
          currentChatId = chatId;
          chatMessages.innerHTML = '';
          
          // æ¢å¤è¾“å…¥æ¡†åˆ°æ­£å¸¸ä½ç½®
          restoreInputBox();
          
          // æ¸…é™¤ç©ºçŠ¶æ€
          clearEmptyState();
          
          // åŠ è½½èŠå¤©æ¶ˆæ¯
          data.conversation.messages.forEach(msg => {
            // ä»æ¶ˆæ¯ä¸­è¯»å–shared_memory_enabledä¿¡æ¯
            const sharedMemoryEnabled = msg.shared_memory_enabled !== undefined ? msg.shared_memory_enabled : null;
            const usedSharedMemories = msg.used_shared_memories || [];
            addMessageToUI(msg.type, msg.content, sharedMemoryEnabled, usedSharedMemories, msg.timestamp);
          });
          
          // åŠ è½½å®Œæ¶ˆæ¯åï¼Œæ»šåŠ¨åˆ°åº•éƒ¨
          setTimeout(() => {
            if (chatMessages) {
              chatMessages.scrollTop = chatMessages.scrollHeight;
            }
          }, 100); // å»¶è¿Ÿä¸€ç‚¹ç¡®ä¿DOMå·²æ›´æ–°
          
          // æ›´æ–°æ´»è·ƒçŠ¶æ€
          document.querySelectorAll('.chat-history-item').forEach(item => {
            item.classList.remove('active');
          });
          if (clickedElement) {
            clickedElement.classList.add('active');
          }
        } else {
          // å¦‚æœæ˜¯"å¯¹è¯ä¸å­˜åœ¨"é”™è¯¯ä¸”é‡è¯•æ¬¡æ•°å°‘äº3æ¬¡ï¼Œåˆ™é‡è¯•
          if (data.error && data.error.includes('å¯¹è¯ä¸å­˜åœ¨') && retryCount < 3) {
            // ç­‰å¾…500msåé‡è¯•
            setTimeout(() => {
              loadChat(chatId, clickedElement, retryCount + 1);
            }, 500);
            return;
          } else {
            // å¦‚æœé‡è¯•æ¬¡æ•°å·²è¾¾ä¸Šé™ï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
            if (retryCount >= 3) {
            }
          }
        }
      } catch (error) {
      }
    }


    // åˆ é™¤èŠå¤©
    async function deleteChat(chatId) {
      if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¯¹è¯å—ï¼Ÿ')) {
        try {
          // è¿™é‡Œå¯ä»¥æ·»åŠ æœåŠ¡å™¨ç«¯åˆ é™¤API
          // æš‚æ—¶åªåœ¨å‰ç«¯åˆ é™¤
          chatHistory = chatHistory.filter(c => c.id !== chatId);
          
          if (currentChatId === chatId) {
            createNewChat();
          }
          
          loadChatHistory();
        } catch (error) {
        }
      }
    }

    // æ‰“å¼€è®¾ç½®
    function openSettings() {
      // ğŸ”’ ç™»å½•æ‹¦æˆª
      if (!requireLogin()) return;
      
      // æ˜¾ç¤ºå½“å‰ç”¨æˆ·å
      const currentUserDisplay = document.getElementById('currentUserDisplay');
      if (currentUserDisplay && currentUsername) {
        currentUserDisplay.textContent = currentUsername;
      }
      
      // åŠ è½½é¢åº¦å¹¶æ ¹æ®é¢åº¦æ˜¾ç¤º/éšè—OpenAIé…ç½®ï¼ŒåŒæ—¶å¡«å……ç”¨æˆ·é…ç½®
      Promise.all([
        loadAndRenderQuota(),
        loadUserConfig()
      ]).finally(() => {
        settingsModal.classList.add('show');
      });
    }

    // å…³é—­è®¾ç½®
    function closeSettings() {
      settingsModal.classList.remove('show');
    }

    // æ‰“å¼€è®°å¿†æŸ¥çœ‹
    function openMemory() {
      memoryModal.classList.add('show');
      loadPersonalMemory();
    }

    // å…³é—­è®°å¿†æŸ¥çœ‹
    function closeMemory() {
      memoryModal.classList.remove('show');
    }

    // æ‰“å¼€åˆ†äº«å¼¹çª—
    function openShareModal(messageDiv) {
      // æ£€æŸ¥æ˜¯å¦æ˜¯æ¥è‡ªåˆ†äº«é“¾æ¥çš„æ¶ˆæ¯ï¼ˆè¿˜æ²¡æœ‰æ·»åŠ åˆ°ç”¨æˆ·å¯¹è¯ä¸­ï¼‰
      const isSharedMessage = messageDiv.dataset.isSharedMessage === 'true';
      const originalShareLink = messageDiv.dataset.originalShareLink;
      
      // å¦‚æœæ˜¯åˆ†äº«çš„æ¶ˆæ¯ä¸”è¿˜æ²¡æœ‰æ·»åŠ åˆ°ç”¨æˆ·å¯¹è¯ä¸­ï¼Œç›´æ¥æ˜¾ç¤ºåŸå§‹åˆ†äº«é“¾æ¥
      if (isSharedMessage && originalShareLink && !currentChatId) {
        shareLinkInput.value = originalShareLink;
        shareModal.classList.add('show');
        return;
      }
      
      // å¦‚æœæ¶ˆæ¯å·²ç»æ·»åŠ åˆ°ç”¨æˆ·å¯¹è¯ä¸­ï¼Œæˆ–è€…æœ‰currentChatIdï¼Œåˆ™ä»ç”¨æˆ·å¯¹è¯ä¸­æŸ¥æ‰¾
      if (!currentChatId) {
        // å¦‚æœæ—¢æ²¡æœ‰currentChatIdï¼Œä¹Ÿæ²¡æœ‰åŸå§‹åˆ†äº«é“¾æ¥ï¼Œä½¿ç”¨åŸå§‹åˆ†äº«é“¾æ¥
        if (originalShareLink) {
          shareLinkInput.value = originalShareLink;
          shareModal.classList.add('show');
        } else {
          alert('æ— æ³•åˆ†äº«ï¼šå½“å‰å¯¹è¯IDä¸å­˜åœ¨');
        }
        return;
      }

      // å°è¯•ä»æ¶ˆæ¯divçš„dataå±æ€§ä¸­è·å–æ—¶é—´æˆ³
      let timestamp = messageDiv.dataset.timestamp;
      
      // å¦‚æœæ²¡æœ‰ï¼Œå°è¯•ä»å·²åŠ è½½çš„æ¶ˆæ¯ä¸­è·å–
      if (!timestamp) {
        // é€šè¿‡APIè·å–æ¶ˆæ¯
        fetch(`${backendUrl}/get_chat_messages`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          credentials: 'include',
          body: JSON.stringify({
            username: currentUsername,
            conversation_id: currentChatId
          })
        }).then(response => response.json()).then(data => {
          if (data.success && data.conversation && data.conversation.messages) {
            // æ‰¾åˆ°å¯¹åº”çš„AIæ¶ˆæ¯
            const assistantMessages = data.conversation.messages.filter(msg => msg.type === 'assistant');
            const messagePosition = Array.from(chatMessages.children)
              .filter(div => div.classList.contains('assistant'))
              .indexOf(messageDiv);
            
            if (messagePosition >= 0 && messagePosition < assistantMessages.length) {
              const message = assistantMessages[messagePosition];
              timestamp = message.timestamp || '';
              generateAndShowShareLink(timestamp);
            } else {
              // å¦‚æœåœ¨ç”¨æˆ·å¯¹è¯ä¸­æ‰¾ä¸åˆ°ï¼Œä½¿ç”¨åŸå§‹åˆ†äº«é“¾æ¥
              if (originalShareLink) {
                shareLinkInput.value = originalShareLink;
                shareModal.classList.add('show');
              } else {
                alert('æ— æ³•è·å–æ¶ˆæ¯æ—¶é—´æˆ³');
              }
            }
          } else {
            // APIå¤±è´¥ï¼Œä½¿ç”¨åŸå§‹åˆ†äº«é“¾æ¥
            if (originalShareLink) {
              shareLinkInput.value = originalShareLink;
              shareModal.classList.add('show');
            } else {
              alert('æ— æ³•è·å–æ¶ˆæ¯ä¿¡æ¯');
            }
          }
        }).catch(err => {
          // å‡ºé”™æ—¶ä½¿ç”¨åŸå§‹åˆ†äº«é“¾æ¥
          if (originalShareLink) {
            shareLinkInput.value = originalShareLink;
            shareModal.classList.add('show');
          } else {
            alert('æ— æ³•è·å–æ¶ˆæ¯ä¿¡æ¯');
          }
        });
      } else {
        // æœ‰æ—¶é—´æˆ³ï¼Œæ£€æŸ¥è¯¥æ¶ˆæ¯æ˜¯å¦å·²ç»åœ¨ç”¨æˆ·å¯¹è¯ä¸­
        checkMessageInConversationAndShare(messageDiv, timestamp, originalShareLink);
      }
    }

    // æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦åœ¨å¯¹è¯ä¸­ï¼Œå¹¶ç”Ÿæˆç›¸åº”çš„åˆ†äº«é“¾æ¥
    async function checkMessageInConversationAndShare(messageDiv, timestamp, originalShareLink) {
      if (!currentChatId || !currentUsername) {
        // æ²¡æœ‰å¯¹è¯IDï¼Œä½¿ç”¨åŸå§‹åˆ†äº«é“¾æ¥
        if (originalShareLink) {
          shareLinkInput.value = originalShareLink;
          shareModal.classList.add('show');
        } else {
          alert('æ— æ³•åˆ†äº«ï¼šå½“å‰å¯¹è¯IDä¸å­˜åœ¨');
        }
        return;
      }
      
      try {
        // æ£€æŸ¥è¯¥æ¶ˆæ¯æ˜¯å¦å·²ç»åœ¨ç”¨æˆ·å¯¹è¯ä¸­
        const response = await fetch(`${backendUrl}/get_chat_messages`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          credentials: 'include',
          body: JSON.stringify({
            username: currentUsername,
            conversation_id: currentChatId
          })
        });
        
        const data = await response.json();
        if (data.success && data.conversation && data.conversation.messages) {
          // æ£€æŸ¥å¯¹è¯ä¸­æ˜¯å¦æœ‰è¯¥æ—¶é—´æˆ³çš„æ¶ˆæ¯
          const messageExists = data.conversation.messages.some(
            msg => msg.type === 'assistant' && msg.timestamp === timestamp
          );
          
          if (messageExists) {
            // æ¶ˆæ¯å·²åœ¨ç”¨æˆ·å¯¹è¯ä¸­ï¼Œç”Ÿæˆæ–°çš„åˆ†äº«é“¾æ¥
            generateAndShowShareLink(timestamp);
          } else {
            // æ¶ˆæ¯ä¸åœ¨ç”¨æˆ·å¯¹è¯ä¸­ï¼Œä½¿ç”¨åŸå§‹åˆ†äº«é“¾æ¥
            if (originalShareLink) {
              shareLinkInput.value = originalShareLink;
              shareModal.classList.add('show');
            } else {
              generateAndShowShareLink(timestamp);
            }
          }
        } else {
          // è·å–å¯¹è¯å¤±è´¥ï¼Œä½¿ç”¨åŸå§‹åˆ†äº«é“¾æ¥
          if (originalShareLink) {
            shareLinkInput.value = originalShareLink;
            shareModal.classList.add('show');
          } else {
            generateAndShowShareLink(timestamp);
          }
        }
      } catch (error) {
        // å‡ºé”™æ—¶ä½¿ç”¨åŸå§‹åˆ†äº«é“¾æ¥
        if (originalShareLink) {
          shareLinkInput.value = originalShareLink;
          shareModal.classList.add('show');
        } else {
          generateAndShowShareLink(timestamp);
        }
      }
    }

    // ç”Ÿæˆå¹¶æ˜¾ç¤ºåˆ†äº«é“¾æ¥
    function generateAndShowShareLink(timestamp) {
      if (!currentChatId || !timestamp) {
        alert('æ— æ³•ç”Ÿæˆåˆ†äº«é“¾æ¥ï¼šç¼ºå°‘å¿…è¦ä¿¡æ¯');
        return;
      }

      // å°†æ—¶é—´æˆ³ä¸­çš„ç¬¦å·å»æ‰ï¼Œåªç•™æ•°å­—
      // æ—¶é—´æˆ³æ ¼å¼: "2025-10-31 19:20:12"
      const timestampNumeric = timestamp.replace(/[^0-9]/g, '');
      
      // ç”Ÿæˆåˆ†äº«é“¾æ¥
      const shareLink = `https://baijia.online/agent-share/${currentChatId}${timestampNumeric}`;
      
      // æ˜¾ç¤ºåœ¨è¾“å…¥æ¡†ä¸­
      shareLinkInput.value = shareLink;
      shareModal.classList.add('show');
    }

    // å…³é—­åˆ†äº«å¼¹çª—
    function closeShareModal() {
      shareModal.classList.remove('show');
    }

    // åŠ è½½å¹¶æ¸²æŸ“é¢åº¦ä¿¡æ¯
    async function loadAndRenderQuota() {
      if (!currentUsername) return;
      try {
        const resp = await fetch(`${backendUrl}/api/get_quota?username=${encodeURIComponent(currentUsername)}`, { credentials: 'include' });
        const data = await resp.json();
        if (!data.success) throw new Error(data.error || 'è·å–é¢åº¦å¤±è´¥');
        const total = Number(data.quota_total || 100000);
        const used = Number(data.quota_used || 0);
        const percent = Math.min(100, Math.round((used / total) * 100));
        const quotaText = document.getElementById('quotaText');
        const quotaBar = document.getElementById('quotaBar');
        if (quotaText) quotaText.textContent = `${used}/${total}`;
        if (quotaBar) quotaBar.style.width = `${percent}%`;

        const keyGroup = document.getElementById('openaiKeyGroup');
        const baseGroup = document.getElementById('openaiBaseUrlGroup');
        const saveSettingsBtn = document.getElementById('saveSettingsBtn');
        const quotaLabel = document.getElementById('quotaLabel');
        const quotaStatus = document.getElementById('quotaStatus');
        // æœªè¾¾åˆ°æ€»é¢åº¦å‰éšè—OpenAIé…ç½®ï¼Œè¾¾åˆ°(>=)åæ˜¾ç¤º
        const reached = used >= total;
        if (quotaLabel && quotaStatus) {
          // ä»…è®©â€œï¼ˆå·²æ»¡ï¼‰â€å˜çº¢ï¼Œå…¶ä½™ä¿æŒé»˜è®¤
          quotaLabel.firstChild && (quotaLabel.firstChild.textContent = 'å·²ç”¨é¢åº¦ ');
          quotaStatus.textContent = reached ? 'ï¼ˆå·²æ»¡ï¼‰' : 'ï¼ˆå…è´¹é¢åº¦ï¼‰';
          quotaStatus.style.color = reached ? '#dc2626' : '#6b7280';
        }
        if (quotaText) quotaText.style.color = '#374151';
        if (quotaBar) quotaBar.style.background = 'linear-gradient(90deg, #60a5fa, #818cf8)';
        if (keyGroup) keyGroup.style.display = reached ? '' : 'none';
        if (baseGroup) baseGroup.style.display = reached ? '' : 'none';
        if (saveSettingsBtn) saveSettingsBtn.style.display = reached ? '' : 'none';
      } catch (e) {
      }
    }

    // åˆ‡æ¢è®°å¿†æ ‡ç­¾é¡µ
    function switchMemoryTab(tab) {
      // ç§»é™¤æ‰€æœ‰æ´»åŠ¨çŠ¶æ€
      personalMemoryTab.classList.remove('active');
      sharedMemoryTab.classList.remove('active');
      personalMemoryContent.classList.remove('active');
      sharedMemoryContent.classList.remove('active');

      if (tab === 'personal') {
        personalMemoryTab.classList.add('active');
        personalMemoryContent.classList.add('active');
        loadPersonalMemory();
      } else if (tab === 'shared') {
        sharedMemoryTab.classList.add('active');
        sharedMemoryContent.classList.add('active');
        // å…±äº«è®°å¿†æš‚æ—¶ä¸åŠ è½½å†…å®¹
      }
    }

    // åŠ è½½ä¸ªäººè®°å¿†
    async function loadPersonalMemory() {
      if (!currentUsername) return;
      
      const memoryType = memoryTypeSelect.value; // short, mid, long
      
      try {
        let url;
        if (memoryType === 'short') {
          url = `${backendUrl}/chat/users/${currentUsername}/short_term.json`;
        } else if (memoryType === 'mid') {
          url = `${backendUrl}/chat/users/${currentUsername}/mid_term.json`;
        } else if (memoryType === 'long') {
          url = `${backendUrl}/chat/users/${currentUsername}/long_term_user.json`;
        }
        
        if (!url) {
          personalMemoryList.innerHTML = '<div class="empty-state">æ— æ•ˆçš„è®°å¿†ç±»å‹</div>';
          return;
        }
        
        const response = await fetch(url, { credentials: 'include' });
        if (response.ok) {
          const memories = await response.json();
          displayPersonalMemories(personalMemoryList, memories, memoryType);
        } else {
          personalMemoryList.innerHTML = `<div class="empty-state">æš‚æ— ${getMemoryTypeName(memoryType)}</div>`;
        }
      } catch (error) {
        personalMemoryList.innerHTML = '<div class="empty-state">åŠ è½½å¤±è´¥</div>';
      }
    }

    // æ˜¾ç¤ºä¸ªäººè®°å¿†åˆ—è¡¨
    function displayPersonalMemories(container, memories, memoryType) {
      if (!memories) {
        container.innerHTML = '<div class="empty-state">æš‚æ— è®°å¿†</div>';
        return;
      }

      container.innerHTML = '';
      
      if (memoryType === 'short') {
        // çŸ­æœŸè®°å¿†æ˜¯æ•°ç»„æ ¼å¼
        if (!Array.isArray(memories)) {
          container.innerHTML = '<div class="empty-state">çŸ­æœŸè®°å¿†æ•°æ®æ ¼å¼é”™è¯¯</div>';
          return;
        }
        
        if (memories.length === 0) {
          container.innerHTML = '<div class="empty-state">æš‚æ— çŸ­æœŸè®°å¿†</div>';
          return;
        }
        
        memories.forEach((memory, index) => {
          const memoryItem = document.createElement('div');
          memoryItem.className = 'memory-item';
          
          // å®‰å…¨åœ°è·å–å±æ€§ï¼Œé¿å… 'get' æ–¹æ³•é”™è¯¯
          const time = memory.timestamp || 'æœªçŸ¥æ—¶é—´';
          const conversationId = memory.conversation_id || 'æœªçŸ¥ä¼šè¯';
          const userInput = memory.user_input || 'æ— ç”¨æˆ·è¾“å…¥';
          const agentResponse = memory.agent_response || 'æ— AIå›å¤';
          
          memoryItem.innerHTML = `
            <div class="memory-item-header">
              <span class="memory-item-time">${time}</span>
              <span class="memory-item-conversation">${conversationId}</span>
            </div>
            <div class="memory-item-content">
              <div class="memory-item-user">ç”¨æˆ·: ${userInput}</div>
              <div class="memory-item-assistant">AI: ${agentResponse}</div>
            </div>
          `;
          
          container.appendChild(memoryItem);
        });
      } else if (memoryType === 'mid') {
        // ä¸­æœŸè®°å¿†æ˜¯å¯¹è±¡æ ¼å¼ï¼ŒåŒ…å«sessions
        if (!memories || typeof memories !== 'object') {
          container.innerHTML = '<div class="empty-state">ä¸­æœŸè®°å¿†æ•°æ®æ ¼å¼é”™è¯¯</div>';
          return;
        }
        
        const sessions = memories.sessions || {};
        const sessionKeys = Object.keys(sessions);
        
        if (sessionKeys.length === 0) {
          container.innerHTML = '<div class="empty-state">æš‚æ— ä¸­æœŸè®°å¿†</div>';
          return;
        }
        
        sessionKeys.forEach(sid => {
          const session = sessions[sid] || {};
          const memoryItem = document.createElement('div');
          memoryItem.className = 'memory-item';
          
          const sessionId = session.id || sid;
          const summary = session.summary || 'æš‚æ— æ‘˜è¦';
          const keywords = session.summary_keywords || [];
          const details = session.details || [];
          
          // æ„å»ºè¯¦æƒ…å†…å®¹
          let detailsHtml = '';
          if (details.length > 0) {
            details.forEach(page => {
              detailsHtml += `
                <div style="margin-bottom: 10px; padding: 12px; background: rgba(255,255,255,0.9); border-radius: 12px; box-shadow: 0 2px 8px rgba(31,38,135,0.08); border: 1px solid rgba(255,255,255,0.3);">
                  <div style="margin-bottom: 6px;"><b style="color: #667eea;">ä½ ï¼š</b>${page.user_input || ''}</div>
                  <div style="margin-bottom: 6px;"><b style="color: #667eea;">AIï¼š</b>${page.agent_response || ''}</div>
                  <div style="color: #888; font-size: 0.9em; margin-top: 4px;">${page.timestamp || ''}</div>
                  ${page.meta_info ? `<div style="color: #888; font-size: 0.9em; margin-top: 2px;">${page.meta_info}</div>` : ''}
                  ${page.page_keywords && page.page_keywords.length > 0 ? `<div style="color: #667eea; font-size: 0.9em; margin-top: 2px; font-weight: 600;">å…³é”®è¯ï¼š${page.page_keywords.join('ã€')}</div>` : ''}
                </div>
              `;
            });
          }
          
          memoryItem.innerHTML = `
            <div class="memory-item-header">
              <span class="memory-item-time">ä¼šè¯ID: ${sessionId}</span>
              <span class="memory-item-time">å¯¹è¯æ•°é‡: ${details.length}</span>
            </div>
            <div class="memory-item-content">
              <div class="memory-item-user">æ‘˜è¦: ${summary}</div>
              ${keywords.length > 0 ? `<div class="memory-item-assistant">å…³é”®è¯: ${keywords.join('ã€')}</div>` : ''}
              ${details.length > 0 ? `<div style="margin-top: 12px;"><div style="font-weight: 600; margin-bottom: 8px; color: #2a3a5a;">å¯¹è¯è¯¦æƒ…:</div>${detailsHtml}</div>` : ''}
            </div>
          `;
          
          container.appendChild(memoryItem);
        });
      } else if (memoryType === 'long') {
        // é•¿æœŸè®°å¿†æ˜¯å¯¹è±¡æ ¼å¼ï¼ŒåŒ…å«user_profiles
        if (!memories || typeof memories !== 'object') {
          container.innerHTML = '<div class="empty-state">é•¿æœŸè®°å¿†æ•°æ®æ ¼å¼é”™è¯¯</div>';
          return;
        }
        
        const userProfiles = memories.user_profiles || {};
        const profileKeys = Object.keys(userProfiles);
        
        if (profileKeys.length === 0) {
          container.innerHTML = '<div class="empty-state">æš‚æ— é•¿æœŸè®°å¿†</div>';
          return;
        }
        
        profileKeys.forEach(profileKey => {
          const profile = userProfiles[profileKey] || {};
          const memoryItem = document.createElement('div');
          memoryItem.className = 'memory-item';
          
          const data = profile.data || 'æš‚æ— æ•°æ®';
          const lastUpdated = profile.last_updated || 'æœªçŸ¥æ—¶é—´';
          
          // å¤„ç†ç”¨æˆ·ç”»åƒæ•°æ®ï¼Œåœ¨æ¯ä¸ªå¥å·åæ·»åŠ æ¢è¡Œ
          const formattedData = data.replace(/ã€‚/g, 'ã€‚<br>');
          
          // ä»…ä¿ç•™æ›´æ–°æ—¶é—´ç­‰å…ƒä¿¡æ¯ï¼Œä¸å†å±•ç¤ºåŸå§‹â€œç”¨æˆ·ç”»åƒâ€å…¨æ–‡
          memoryItem.innerHTML = `
            <div class="memory-item-header">
              <span class="memory-item-time">ç”¨æˆ·: ${profileKey}</span>
              <span class="memory-item-time">æ›´æ–°æ—¶é—´: ${lastUpdated}</span>
            </div>
          `;

          container.appendChild(memoryItem);
        });
        
        // è¿½åŠ ï¼šç”»åƒç»´åº¦æŠ˜å é¢æ¿ï¼ˆæŒ‰ä¸‰å¤§ç±»ï¼Œæ˜¾ç¤ºå·²å­˜åœ¨çš„å°ç»´åº¦ï¼‰
        renderUserDimensionsCollapsible(container);

        // æ˜¾ç¤ºçŸ¥è¯†åº“å†…å®¹
        const knowledgeBase = memories.knowledge_base || [];
        if (knowledgeBase.length > 0) {
          const knowledgeItem = document.createElement('div');
          knowledgeItem.className = 'memory-item';
          
          // å¤„ç†çŸ¥è¯†åº“å†…å®¹ï¼ˆå…¼å®¹å¯¹è±¡/å­—ç¬¦ä¸²ï¼‰ï¼Œåœ¨æ¯ä¸ªå¥å·åæ·»åŠ æ¢è¡Œ
          const formattedKnowledge = knowledgeBase.slice(0, 3).map(item => {
            const knowledgeText = typeof item === 'object' ? (item.knowledge || JSON.stringify(item)) : item;
            return String(knowledgeText).replace(/ã€‚/g, 'ã€‚<br>');
          }).join('<br><br>');
          
          knowledgeItem.innerHTML = `
            <div class="memory-item-header">
              <span class="memory-item-time">çŸ¥è¯†åº“</span>
            </div>
            <div class="memory-item-content">
              <div class="memory-item-user">çŸ¥è¯†æ¡ç›®æ•°é‡: ${knowledgeBase.length}</div>
              <div class="memory-item-assistant">${formattedKnowledge}${knowledgeBase.length > 3 ? '<br>...' : ''}</div>
            </div>
          `;
          container.appendChild(knowledgeItem);
        }
        
        // æ˜¾ç¤ºåŠ©æ‰‹çŸ¥è¯†å†…å®¹
        const assistantKnowledge = memories.assistant_knowledge || [];
        if (assistantKnowledge.length > 0) {
          const assistantItem = document.createElement('div');
          assistantItem.className = 'memory-item';
          
          // å¤„ç†åŠ©æ‰‹çŸ¥è¯†å†…å®¹ï¼ˆå…¼å®¹å¯¹è±¡/å­—ç¬¦ä¸²ï¼‰ï¼Œåœ¨æ¯ä¸ªå¥å·åæ·»åŠ æ¢è¡Œ
          const formattedAssistantKnowledge = assistantKnowledge.slice(0, 3).map(item => {
            const knowledgeText = typeof item === 'object' ? (item.knowledge || JSON.stringify(item)) : item;
            return String(knowledgeText).replace(/ã€‚/g, 'ã€‚<br>');
          }).join('<br><br>');
          
          assistantItem.innerHTML = `
            <div class="memory-item-header">
              <span class="memory-item-time">åŠ©æ‰‹çŸ¥è¯†</span>
            </div>
            <div class="memory-item-content">
              <div class="memory-item-user">çŸ¥è¯†æ¡ç›®æ•°é‡: ${assistantKnowledge.length}</div>
              <div class="memory-item-assistant">${formattedAssistantKnowledge}${assistantKnowledge.length > 3 ? '<br>...' : ''}</div>
            </div>
          `;
          container.appendChild(assistantItem);
        }
      }
    }

    // è·å–è®°å¿†ç±»å‹åç§°
    function getMemoryTypeName(memoryType) {
      const names = {
        'short': 'çŸ­æœŸè®°å¿†',
        'mid': 'ä¸­æœŸè®°å¿†',
        'long': 'é•¿æœŸè®°å¿†'
      };
      return names[memoryType] || 'è®°å¿†';
    }

    // æ¸²æŸ“ç”¨æˆ·ç”»åƒç»´åº¦æŠ˜å é¢æ¿ï¼ˆè°ƒç”¨åç«¯ç»Ÿä¸€APIï¼‰
    async function renderUserDimensionsCollapsible(parentContainer) {
      try {
        const resp = await fetch(`${backendUrl}/api/get_user_dimensions?username=${currentUsername}`, { credentials: 'include' });
        if (!resp.ok) return;
        const data = await resp.json();
        if (!data.success) return;
        const dims = data.dimensions || {};
        const groups = data.groups || {};

        const section = document.createElement('div');
        section.className = 'memory-item';
        section.innerHTML = `
          <div class="memory-item-header">
            <span class="memory-item-time">ğŸ§© ç”¨æˆ·ç”»åƒç»´åº¦</span>
          </div>
        `;

        const wrapper = document.createElement('div');
        const groupOrder = [groups.basic_info || 'åŸºç¡€ä¿¡æ¯', groups.psych || 'å¿ƒç†æ¨¡å‹', groups.align || 'AIå¯¹é½ç»´åº¦', groups.interest || 'å†…å®¹å…´è¶£æ ‡ç­¾'];
        groupOrder.forEach(groupName => {
          const entries = dims[groupName] || {};
          const keys = Object.keys(entries);
          const details = document.createElement('details');
          details.open = true;
          const summary = document.createElement('summary');
          summary.textContent = `${groupName}ï¼ˆ${keys.length} é¡¹ï¼‰`;
          summary.style.cursor = 'pointer';
          summary.style.fontWeight = '600';
          summary.style.margin = '6px 0';
          details.appendChild(summary);
          const list = document.createElement('div');
          list.style.display = 'flex';
          list.style.flexDirection = 'column';
          list.style.gap = '8px';
          if (keys.length === 0) {
            const empty = document.createElement('div');
            empty.className = 'memory-item-assistant';
            empty.textContent = 'æš‚æ— ç”»åƒæ¡ç›®';
            list.appendChild(empty);
          } else {
            keys.forEach(k => {
              const item = document.createElement('div');
              item.className = 'memory-item-assistant';
              const level = entries[k];
              item.textContent = `${k}: ${level}`;
              list.appendChild(item);
            });
          }
          details.appendChild(list);
          wrapper.appendChild(details);
        });
        section.appendChild(wrapper);
        parentContainer.appendChild(section);
      } catch (e) {
      }
    }

    // åŠ è½½ç”¨æˆ·é…ç½®
    async function loadUserConfig() {
      if (!currentUsername) return;
      
      try {
        // å…ˆå°è¯•ä»chatç›®å½•åŠ è½½é…ç½®
        const response = await fetch(`${backendUrl}/get_chat_conversations`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          credentials: 'include',
          body: JSON.stringify({ username: currentUsername })
        });
        
        if (response.ok) {
          // ä»chatç›®å½•åŠ è½½é…ç½®
          const configResponse = await fetch(`${backendUrl}/chat/users/${currentUsername}/config.json`);
          if (configResponse.ok) {
            const data = await configResponse.json();
            
            // å¡«å……è¡¨å•
            if (data.openai_api_key) document.getElementById('openaiApiKey').value = data.openai_api_key;
            if (data.openai_base_url) document.getElementById('openaiBaseUrl').value = data.openai_base_url;
            
            return;
          }
        }
        
        // å¦‚æœchatç›®å½•æ²¡æœ‰é…ç½®ï¼Œå°è¯•ä»åŸæ¥çš„æ¥å£åŠ è½½
        const response2 = await fetch('/gt', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ username: currentUsername })
        });
        
        if (response2.ok) {
          const data = await response2.json();
          
          // å¡«å……è¡¨å•
          if (data.openai_api_key) document.getElementById('openaiApiKey').value = data.openai_api_key;
          if (data.openai_base_url) document.getElementById('openaiBaseUrl').value = data.openai_base_url;
        }
      } catch (error) {
      }
    }

    // ä¿å­˜è®¾ç½®
    async function saveSettings(e) {
      e.preventDefault();
      
      if (!currentUsername) {
        alert('è¯·å…ˆè®¾ç½®ç”¨æˆ·å');
        return;
      }
      
      const formData = new FormData(settingsForm);
      const settings = Object.fromEntries(formData.entries());
      
      // éªŒè¯å¿…è¦å­—æ®µ
      if (!settings.openai_api_key || settings.openai_api_key.trim() === '') {
        alert('è¯·è¾“å…¥OpenAI API Key');
        document.getElementById('openaiApiKey').focus();
        return;
      }
      
      settings.username = currentUsername;
      
      try {
        const response = await fetch(`${backendUrl}/save_chat_user_config`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(settings)
        });
        
        if (response.ok) {
          const data = await response.json();
          if (data.success) {
            alert('è®¾ç½®ä¿å­˜æˆåŠŸï¼');
            closeSettings();
          } else {
            alert('è®¾ç½®ä¿å­˜å¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'));
          }
        } else {
          alert('è®¾ç½®ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
        }
      } catch (error) {
        alert('è®¾ç½®ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
      }
    }

    // è·å–ä¼šè¯ç”¨æˆ·å
    function getSessionUsername() {
      // å°è¯•ä»localStorageè·å–
      let username = localStorage.getItem('username');
      if (username) return username;
      
      // å°è¯•ä»URLå‚æ•°è·å–
      const urlParams = new URLSearchParams(window.location.search);
      username = urlParams.get('username');
      if (username) {
        localStorage.setItem('username', username);
        return username;
      }
      
      return null;
    }

    // æ ¼å¼åŒ–æ—¶é—´
    function formatTime(timestamp) {
      if (!timestamp) return '';

      let date = new Date(timestamp);

      if (Number.isNaN(date.getTime()) && typeof timestamp === 'string') {
        const normalized = timestamp.replace(' ', 'T');
        date = new Date(normalized);
      }

      if (Number.isNaN(date.getTime())) {
        return timestamp;
      }

      const now = new Date();
      const diff = now - date;
      
      if (diff < 60000) { // 1åˆ†é’Ÿå†…
        return 'åˆšåˆš';
      } else if (diff < 3600000) { // 1å°æ—¶å†…
        return Math.floor(diff / 60000) + 'åˆ†é’Ÿå‰';
      } else if (diff < 86400000) { // 1å¤©å†…
        return Math.floor(diff / 3600000) + 'å°æ—¶å‰';
      } else {
        return date.toLocaleDateString();
      }
    }

    // è‡ªåŠ¨è°ƒæ•´è¾“å…¥æ¡†é«˜åº¦
    chatInput.addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = Math.min(this.scrollHeight, 250) + 'px';
    });

    // åˆå§‹åŒ–è®°å¿†æŒ‰é’®çŠ¶æ€
    function initializeSharedMemoryButton() {
      // é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸ªäººè®°å¿†æ˜¯å¯ç”¨çš„
      updateMemoryButtonDisplay();
    }

    // æ›´æ–°è®°å¿†æŒ‰é’®æ˜¾ç¤º
    function updateMemoryButtonDisplay() {
      if (personalMemoryEnabled) {
        sharedMemoryBtn.classList.add('active');
        sharedMemoryBtn.innerHTML = `
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
            <circle cx="9" cy="7" r="4"/>
            <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
            <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
          </svg>
          è®°å¿†å·²å¼€å¯
        `;
      } else {
        sharedMemoryBtn.classList.remove('active');
        sharedMemoryBtn.innerHTML = `
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
            <circle cx="9" cy="7" r="4"/>
            <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
            <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
          </svg>
          å¼€å¯è®°å¿†
        `;
      }
    }

    // åˆ‡æ¢ä¸ªäººè®°å¿†çŠ¶æ€
    function toggleSharedMemory() {
      personalMemoryEnabled = !personalMemoryEnabled;

      // å½“ä¸ªäººè®°å¿†å…³é—­æ—¶ï¼Œå…±äº«è®°å¿†ä¹Ÿè‡ªåŠ¨å…³é—­
      if (!personalMemoryEnabled) {
        sharedMemoryEnabled = false;
      } else {
        // å½“ä¸ªäººè®°å¿†å¼€å¯æ—¶ï¼Œå…±äº«è®°å¿†ä¹Ÿè‡ªåŠ¨å¼€å¯
        sharedMemoryEnabled = true;
      }

      updateMemoryButtonDisplay();

      if (personalMemoryEnabled) {
      } else {
      }
    }

    // åˆ‡æ¢ MCP å·¥å…·è°ƒç”¨
    function toggleMcpTools() {
      mcpToolsEnabled = !mcpToolsEnabled;
      updateMcpButtonDisplay();

      if (mcpToolsEnabled) {
        console.log('ğŸ› ï¸ MCP å·¥å…·è°ƒç”¨å·²å¯ç”¨');
      } else {
        console.log('ğŸ’¬ MCP å·¥å…·è°ƒç”¨å·²ç¦ç”¨');
      }
    }

    // æ›´æ–° MCP æŒ‰é’®æ˜¾ç¤º
    function updateMcpButtonDisplay() {
      if (mcpToolsEnabled) {
        mcpToolsBtn.classList.add('active');
        mcpToolsBtn.innerHTML = `
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>
          </svg>
          å·¥å…·å·²å¯ç”¨
        `;
      } else {
        mcpToolsBtn.classList.remove('active');
        mcpToolsBtn.innerHTML = `
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>
          </svg>
          å·¥å…·è°ƒç”¨
        `;
      }
    }

    // æ˜¾ç¤ºå·¥å…·è°ƒç”¨æŒ‡ç¤ºå™¨
    function showToolCallIndicator(toolName, status = 'start') {
      if (status === 'start') {
        toolCallStatus.textContent = `æ­£åœ¨è°ƒç”¨: ${toolName}`;
        toolCallIndicator.classList.add('active');
      } else if (status === 'end') {
        toolCallStatus.textContent = `å®Œæˆ: ${toolName}`;
        setTimeout(() => {
          toolCallIndicator.classList.remove('active');
        }, 2000);
      }
    }

    // éšè—å·¥å…·è°ƒç”¨æŒ‡ç¤ºå™¨
    function hideToolCallIndicator() {
      toolCallIndicator.classList.remove('active');
    }

    // å½“å‰æ˜¾ç¤ºçš„è®°å¿†æ¶ˆæ¯ç´¢å¼•
    let currentMemoryMessageIndex = null;

    // åˆ‡æ¢è®°å¿†å†…å®¹é¢æ¿
    function toggleMemoryContentPanel(messageIndex = null, usedSharedMemories = []) {
      const panel = document.getElementById('memoryContentPanel');
      
      // å¦‚æœé¢æ¿å·²ç»æ‰“å¼€
      if (panel.classList.contains('open')) {
        // å¦‚æœç‚¹å‡»çš„æ˜¯åŒä¸€ä¸ªæ¶ˆæ¯ï¼Œåˆ™å…³é—­é¢æ¿
        if (currentMemoryMessageIndex === messageIndex) {
          closeMemoryContentPanel();
          currentMemoryMessageIndex = null;
        } else {
          // å¦‚æœç‚¹å‡»çš„æ˜¯ä¸åŒçš„æ¶ˆæ¯ï¼Œç›´æ¥åˆ‡æ¢åˆ°æ–°æ¶ˆæ¯çš„è®°å¿†å†…å®¹
          currentMemoryMessageIndex = messageIndex;
          loadUsedMemories(messageIndex, usedSharedMemories);
        }
      } else {
        // å¦‚æœé¢æ¿æœªæ‰“å¼€ï¼Œæ‰“å¼€å¹¶æ˜¾ç¤ºå½“å‰æ¶ˆæ¯çš„è®°å¿†
        currentMemoryMessageIndex = messageIndex;
        openMemoryContentPanel(messageIndex, usedSharedMemories);
      }
    }

    // æ‰“å¼€è®°å¿†å†…å®¹é¢æ¿
    function openMemoryContentPanel(messageIndex = null, usedSharedMemories = []) {
      const panel = document.getElementById('memoryContentPanel');
      const appContainer = document.querySelector('.app-container');
      
      // æ·»åŠ openç±»åˆ°é¢æ¿
      panel.classList.add('open');
      
      // æ·»åŠ memory-panel-openç±»åˆ°app-containerï¼Œè§¦å‘å¹¶æ’å¸ƒå±€
      if (appContainer) {
        appContainer.classList.add('memory-panel-open');
      }
      
      loadUsedMemories(messageIndex, usedSharedMemories);
    }

    // å…³é—­è®°å¿†å†…å®¹é¢æ¿
    function closeMemoryContentPanel() {
      const panel = document.getElementById('memoryContentPanel');
      const appContainer = document.querySelector('.app-container');
      
      // ç§»é™¤openç±»
      panel.classList.remove('open');
      
      // ç§»é™¤memory-panel-openç±»ï¼Œæ¢å¤åŸå§‹å¸ƒå±€
      if (appContainer) {
        appContainer.classList.remove('memory-panel-open');
      }
      
      // æ¸…é™¤å½“å‰æ˜¾ç¤ºçš„æ¶ˆæ¯ç´¢å¼•
      currentMemoryMessageIndex = null;
    }

    // åŠ è½½å®é™…ä½¿ç”¨çš„è®°å¿†å†…å®¹
    async function loadUsedMemories(messageIndex = null, usedSharedMemories = []) {
      const body = document.getElementById('memoryContentBody');
      
      // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
      body.innerHTML = `
        <div class="memory-loading">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <path d="M12 6v6l4 2"/>
          </svg>
          <p>æ­£åœ¨åŠ è½½ä½¿ç”¨çš„è®°å¿†å†…å®¹...</p>
        </div>
      `;

      try {
        // è·å–å½“å‰å¯¹è¯çš„å…±äº«è®°å¿†ä½¿ç”¨æƒ…å†µ
        const response = await fetch(`${backendUrl}/api/get_used_shared_memories`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          credentials: 'include',
          body: JSON.stringify({
            username: currentUsername,
            conversation_id: currentChatId,
            message_index: messageIndex,
            used_shared_memories: usedSharedMemories
          })
        });

        if (response.ok) {
          const data = await response.json();
          if (data.success && data.memories) {
            displayUsedMemories(data.memories);
          } else {
            showMemoryEmpty();
          }
        } else {
          showMemoryError('åŠ è½½å¤±è´¥');
        }
      } catch (error) {
        showMemoryError('åŠ è½½å¤±è´¥: ' + error.message);
      }
    }

    // æ˜¾ç¤ºå®é™…ä½¿ç”¨çš„è®°å¿†å†…å®¹
    function displayUsedMemories(memories) {
      const body = document.getElementById('memoryContentBody');
      
      if (!memories || memories.length === 0) {
        showMemoryEmpty();
        return;
      }

      const memoryItems = memories.map((memory, index) => {
        // ä¼˜å…ˆä½¿ç”¨merged_userså­—æ®µï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨user_idä½œä¸ºfallback
        let mergedUsers = [];
        if (memory.merged_users && Array.isArray(memory.merged_users)) {
          mergedUsers = memory.merged_users;
        } else if (memory.meta && memory.meta.merged_users && Array.isArray(memory.meta.merged_users)) {
          // å¦‚æœmerged_usersåœ¨metaå¯¹è±¡ä¸­
          mergedUsers = memory.meta.merged_users;
        }
        
        const userDisplay = mergedUsers.length > 0 
          ? mergedUsers.join(', ') 
          : (memory.user_id || 'æœªçŸ¥');
        
        // è°ƒè¯•æ—¥å¿—
        if (index === 0) {
          console.log('æ˜¾ç¤ºè®°å¿†æ•°æ®:', {
            id: memory.id,
            user_id: memory.user_id,
            merged_users: memory.merged_users,
            meta: memory.meta,
            final_display: userDisplay
          });
        }
        
        return `
        <div class="memory-item" style="animation-delay: ${index * 0.1}s;">
          <div class="memory-item-header">
            <span class="memory-item-user">ç”¨æˆ·: ${userDisplay}</span>
            <span class="memory-item-time">${formatMemoryTime(memory.timestamp)}</span>
          </div>
          ${memory.focus_query ? `
            <div class="memory-item-focus" style="margin-bottom: 12px; padding: 8px 12px; background: #f0f9ff; border-left: 3px solid #3b82f6; border-radius: 6px;">
              <div style="font-size: 12px; color: #3b82f6; font-weight: 600; margin-bottom: 4px;">Focus Query:</div>
              <div style="font-size: 13px; color: #1e40af; line-height: 1.4;">${memory.focus_query}</div>
            </div>
          ` : ''}
          <div class="memory-item-content">${memory.content || 'æ— å†…å®¹'}</div>
        </div>
      `;
      }).join('');

      body.innerHTML = memoryItems;
      
      // æ·»åŠ æ·¡å…¥åŠ¨ç”»
      const items = body.querySelectorAll('.memory-item');
      items.forEach((item, index) => {
        item.style.opacity = '0';
        item.style.transform = 'translateY(20px)';
        setTimeout(() => {
          item.style.transition = 'all 0.3s ease';
          item.style.opacity = '1';
          item.style.transform = 'translateY(0)';
        }, index * 100);
      });
    }

    // æ˜¾ç¤ºç©ºçŠ¶æ€
    function showMemoryEmpty() {
      const body = document.getElementById('memoryContentBody');
      body.innerHTML = `
        <div class="memory-empty">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <path d="M12 6v6l4 2"/>
          </svg>
          <p>æœ¬æ¬¡å›å¤æœªä½¿ç”¨å…±äº«è®°å¿†</p>
        </div>
      `;
    }

    // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
    function showMemoryError(message) {
      const body = document.getElementById('memoryContentBody');
      body.innerHTML = `
        <div class="memory-empty">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <line x1="15" y1="9" x2="9" y2="15"/>
            <line x1="9" y1="9" x2="15" y2="15"/>
          </svg>
          <p>${message}</p>
        </div>
      `;
    }

    // æ ¼å¼åŒ–è®°å¿†æ—¶é—´
    function formatMemoryTime(timestamp) {
      if (!timestamp) return 'æœªçŸ¥æ—¶é—´';
      
      const date = new Date(timestamp);
      const now = new Date();
      const diff = now - date;
      
      if (diff < 60000) { // 1åˆ†é’Ÿå†…
        return 'åˆšåˆš';
      } else if (diff < 3600000) { // 1å°æ—¶å†…
        return Math.floor(diff / 60000) + 'åˆ†é’Ÿå‰';
      } else if (diff < 86400000) { // 1å¤©å†…
        return Math.floor(diff / 3600000) + 'å°æ—¶å‰';
      } else {
        return date.toLocaleDateString();
      }
    }
  </script>
</body>
</html>
